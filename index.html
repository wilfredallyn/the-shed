<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Shed - Jazz Piano Voicings</title>
    <meta name="description" content="Practice jazz piano voicings, chord progressions, and scales with your MIDI keyboard">
    <meta name="theme-color" content="#d97706">
    <link rel="icon" type="image/jpeg" href="icon-512.jpg">
    <link rel="apple-touch-icon" href="icon-512.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Piano key styling with depth */
        .key { transition: all 0.1s; }
        .key-white {
            fill: #fafafa;
            stroke: #d1d5db;
            stroke-width: 1px;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.05));
        }
        .key-white:hover { fill: #f5f5f5; }
        .key-black {
            fill: #1f2937;
            stroke: #111827;
            stroke-width: 1px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        .key-active { fill: #4ade80 !important; filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.5)) !important; }
        .key-wrong { fill: #f87171 !important; filter: drop-shadow(0 0 8px rgba(248, 113, 113, 0.5)) !important; }
        .correct { fill: #4ade80 !important; filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.5)) !important; }
        .key-correct { fill: #4ade80 !important; filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.5)) !important; }
        .incorrect { fill: #f87171 !important; }
        .wrong { fill: #f87171 !important; }
        .key-error { fill: #f87171 !important; }
        .key-start { fill: #fbbf24 !important; filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5)) !important; }
        .key-held { fill: #a78bfa !important; filter: drop-shadow(0 0 6px rgba(167, 139, 250, 0.4)) !important; }

        /* Feedback animations */
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        .feedback-anim { animation: float-up 1s ease-out forwards; }

        /* Timer colors */
        .timer-fast { color: #4ade80; }
        .timer-medium { color: #fbbf24; }
        .timer-slow { color: #f87171; }

        /* Mode buttons - amber accent */
        .mode-btn.active {
            background-color: #d97706;
            color: white;
            box-shadow: 0 0 12px rgba(217, 119, 6, 0.3);
        }
        .mode-btn:not(.active):not(:disabled) {
            background-color: #334155;
            color: #94a3b8;
            border: 1px solid #475569;
        }
        .mode-btn:not(.active):not(:disabled):hover {
            background-color: #3f4f63;
            color: #e2e8f0;
            border-color: #64748b;
        }

        /* Category tabs - amber accent */
        .category-btn { transition: all 0.15s; }
        .category-btn.active {
            background-color: #d97706;
            color: white;
        }
        .category-btn:not(.active) {
            background-color: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
        }
        .category-btn:not(.active):hover {
            background-color: #334155;
            color: white;
            border-color: #475569;
        }

        /* Brand title styling */
        .brand-title {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Stats number styling */
        .stat-number {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans">

    <div class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
            <a href="#" onclick="goHome(); return false;" class="flex items-center gap-3 hover:opacity-80 transition">
                <img src="icon-512.jpg" alt="The Shed" class="w-12 h-12 rounded-lg shadow-md">
                <div>
                    <h1 class="text-3xl font-bold brand-title tracking-tight">The Shed</h1>
                    <p class="text-xs text-slate-500 font-mono mt-1">Practice jazz voicings, progressions & scales</p>
                </div>
            </a>
            <div class="flex items-center gap-3">
                <!-- Collapsed MIDI settings (shown when connected) -->
                <button id="midiSettingsBtn" onclick="toggleMidiSettings()" class="hidden flex items-center gap-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm transition">
                    <span class="text-slate-400">MIDI:</span>
                    <span id="midiDeviceName" class="text-green-400 font-mono truncate max-w-32"></span>
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="connectionStatusArea" class="flex items-center gap-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span id="connectionText" class="text-sm font-mono">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- MIDI Connectivity -->
        <div id="midiSection" class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Connect MIDI</h2>
                <button id="midiCollapseBtn" onclick="collapseMidiSettings()" class="hidden flex items-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 hover:text-white text-sm font-medium transition">
                    <span>Close</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">MIDI Input</label>
                    <select id="midiInputSelect" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">Select Input Device</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-2">MIDI Output (optional)</label>
                    <select id="midiOutputSelect" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">Select Output Device</option>
                    </select>
                </div>
            </div>
            <p id="midiHint" class="text-xs text-slate-500 mt-3">Select your MIDI keyboard to start practicing.</p>

            <!-- Preview Piano (hidden by default since mode panels have pianos) -->
            <div id="previewPiano" class="hidden mt-6 pt-6 border-t border-slate-700">
                <p class="text-sm text-slate-400 mb-2">Test your keyboard:</p>
                <div class="w-full overflow-x-auto bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="previewPianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>
            </div>
        </div>

        <!-- Practice Mode Selection -->
        <div id="practiceSection" class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg">
            <div class="flex items-center gap-2 mb-3">
                <h2 class="text-xl font-semibold text-white">Practice Mode</h2>
                <button onclick="document.getElementById('modeInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About practice modes">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
            <!-- Category Tabs -->
            <div class="flex gap-2 mb-4 pb-3 border-b border-slate-700">
                <button id="categoryTraining" onclick="switchCategory('training')" class="category-btn active px-4 py-2 rounded font-semibold text-sm">Training</button>
                <button id="categoryCharts" onclick="switchCategory('charts')" class="category-btn px-4 py-2 rounded font-semibold text-sm">Charts</button>
            </div>
            <!-- Training Modes -->
            <div id="trainingModes" class="flex flex-wrap items-center gap-2">
                <button id="intervalsMode" onclick="switchMode('intervals')" title="Start here! Learn to quickly identify and play intervals (half steps, whole steps, 3rds, 5ths, etc.)" class="mode-btn active px-4 py-2 rounded text-sm font-semibold transition">
                    1. Intervals
                </button>
                <button id="chordsMode" onclick="switchMode('chords')" title="Build on intervals: play maj7, min7, and dom7 chords quickly in any key" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    2. 7th Chords
                </button>
                <button id="shellMode" onclick="switchMode('shell')" title="Shell voicings: Root + 3rd + 7th - the essential chord tones for any chord" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    3. Shell
                </button>
                <button id="iiviMode" onclick="switchMode('iivi')" title="The most important jazz progression: play ii-V-I in all 12 keys with various voicings" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    4. ii-V-I
                </button>
                <button id="minorIiviMode" onclick="switchMode('minorIivi')" title="Minor key version: iiø7 - V7 - imM7 progression in all 12 minor keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    5. Minor ii-V-i
                </button>
                <button id="dom7vMode" onclick="switchMode('dom7v')" title="Rootless Type A/B voicings (3-5-7-9 and 7-9-3-5) for Maj7, Min7, and Dom7 chords in all 12 keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    6. Rootless
                </button>
                <button id="extvMode" onclick="switchMode('extv')" title="6/9 voicings: Maj6/9, Min6/9, and Dom13 in all 12 keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    7. 6/9 Voicings
                </button>
                <button id="extMode" onclick="switchMode('ext')" title="Add color: practice 9th, 11th, and 13th extensions on 7th chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    9. Add 9/11/13
                </button>
                <button id="altMode" onclick="switchMode('alt')" title="Advanced harmony: practice altered tensions (b9, #9, #11, b13) on dominant chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    10. Altered
                </button>
                <button id="advMode" onclick="switchMode('adv')" title="Beyond basics: half-diminished, diminished 7th, minor-major 7th, and augmented chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    11. Adv Chords
                </button>
                <button id="kbMode" onclick="switchMode('kb')" title="Kenny Barron's signature voicing: stacked 5ths between hands for rich minor 11 and maj7#11 sounds" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    12. Kenny Barron
                </button>
                <button id="jtouMode" onclick="switchMode('jtou')" title="Classic progression from 'Just the Two of Us': bVImaj7 - V7#9 - im7 in all minor keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    13. JTOU
                </button>
                <button id="scalesMode" onclick="switchMode('scales')" title="Learn scales that work over each chord type using the chord tone + whole step approach" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    14. Jazz Scales
                </button>
                <button id="pentMode" onclick="switchMode('pent')" title="Pentatonic and blues scales: minor pentatonic, major pentatonic, and blues scale in all 12 keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    15. Pentatonic
                </button>
                <button id="bebopMode" onclick="switchMode('bebop')" title="Bebop scales: 8-note scales with chromatic passing tones for smooth jazz lines" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    16. Bebop
                </button>
                <button id="tritoneMode" onclick="switchMode('tritone')" title="Tritone substitution: replace V7 with bII7 (a tritone away)" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    17. Tritone Sub
                </button>
                <button id="upperMode" onclick="switchMode('upper')" title="Upper structure triads: play major/minor triads over dominant bass notes for altered and extended sounds" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    18. Upper Struct
                </button>
                <button id="freestyleMode" onclick="switchMode('freestyle')" title="Freestyle voicing: play any valid chord voicing containing the guide tones (3rd and 7th)" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    19. Freestyle
                </button>
                <button id="voiceleadMode" onclick="switchMode('voicelead')" title="Voice Leading Trainer: learn to find smooth voice leading between chords by identifying common tones and resolutions" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    20. Voice Leading
                </button>
            </div>
            <!-- Charts Modes -->
            <div id="chartsModes" class="hidden flex flex-wrap items-center gap-2">
                <button id="attyaMode" onclick="switchMode('attya')" title="All The Things You Are: practice voice-led rootless voicings through this classic standard" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    All The Things You Are
                </button>
            </div>
        </div>

        <!-- Chord Identifier (fixed at bottom) -->
        <div id="chordIdentifier" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-40">
            <div class="bg-slate-800 rounded-full px-4 py-2 shadow-lg border border-slate-700 flex items-center gap-3">
                <span class="text-xs text-slate-500">Playing:</span>
                <span id="chordIdentifierDisplay" class="text-sm font-semibold text-white min-w-[60px]">—</span>
                <button onclick="toggleChordIdentifier()" class="text-slate-400 hover:text-white transition p-1" title="Hide chord identifier">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <button id="chordIdentifierShowBtn" onclick="toggleChordIdentifier()" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 z-40 bg-slate-800 rounded-full px-3 py-2 shadow-lg border border-slate-700 text-slate-400 hover:text-white transition text-xs" title="Show chord identifier">
            Show chords
        </button>

        <!-- Mode Info Modal -->
        <div id="modeInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Practice Modes</h3>
                    <button onclick="document.getElementById('modeInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Foundations</div>
                        <p><strong>1-2:</strong> Intervals and 7th chords - the building blocks</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Progressions</div>
                        <p><strong>3-4:</strong> ii-V-I in major and minor keys - the essential jazz movements</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Voicings</div>
                        <p><strong>5-7:</strong> Rootless voicings (Type A/B), 6/9 voicings (Maj6/9, Min6/9, Dom13), and voice-led progressions</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Color Tones</div>
                        <p><strong>8-9:</strong> Add 9/11/13 to chords and altered tensions (b9, #9, #11, b13)</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Advanced</div>
                        <p><strong>10-11:</strong> Half-dim, dim, minMaj7 chords and Kenny Barron's stacked-5ths voicing</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Repertoire</div>
                        <p><strong>12:</strong> "Just the Two of Us" progression (bVImaj7 - V7#9 - im7)</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Scales</div>
                        <p><strong>13-15:</strong> Jazz scales, pentatonic & blues, bebop scales</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Reharmonization</div>
                        <p><strong>16:</strong> Tritone substitution - replace V7 with bII7</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Comping Fundamentals</div>
                        <p><strong>17:</strong> Shell voicings - Root + 3rd + 7th, the essential chord tones</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Advanced Voicings</div>
                        <p><strong>18:</strong> Upper structure triads - major triads over dominant bass for altered sounds</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-4">Hover over any mode button for a description.</p>
            </div>
        </div>

        <!-- WebMIDI Help Modal -->
        <div id="webMidiHelpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">WebMIDI Not Supported</h3>
                    <button onclick="document.getElementById('webMidiHelpModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <p>Your browser doesn't support the <strong class="text-amber-400">Web MIDI API</strong>, which is required to connect your MIDI keyboard.</p>
                    <div>
                        <p class="text-slate-400 mb-2">Safari and Firefox don't support WebMIDI. Try one of these browsers instead:</p>
                        <ul class="space-y-2">
                            <li class="flex items-center gap-2">
                                <span class="text-green-400">✓</span>
                                <strong>Google Chrome</strong> <span class="text-slate-500">(recommended)</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-400">✓</span>
                                <strong>Microsoft Edge</strong>
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-400">✓</span>
                                <strong>Opera</strong>
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="text-green-400">✓</span>
                                <strong>Brave</strong>
                            </li>
                        </ul>
                    </div>
                    <p class="text-xs text-slate-500 pt-2 border-t border-slate-700">Any Chromium-based browser will work. On mobile, Chrome for Android supports WebMIDI, but iOS browsers do not.</p>
                </div>
            </div>
        </div>

        <!-- Pentatonic & Blues Info Modal -->
        <div id="pentInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">When to Use These Scales</h3>
                    <button onclick="document.getElementById('pentInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Minor Pentatonic</div>
                        <p class="text-slate-400 mb-2">1 - b3 - 4 - 5 - b7</p>
                        <p>Works over <strong>minor chords</strong> (m7, m9) and <strong>dominant 7th chords</strong> in a blues context. The most versatile "safe" scale for improvisation. Example: A minor pentatonic over Am7 or A7 in blues.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Major Pentatonic</div>
                        <p class="text-slate-400 mb-2">1 - 2 - 3 - 5 - 6</p>
                        <p>Works over <strong>major chords</strong> (maj7, 6/9) and gives a bright, "country" sound. Also works over dominant 7th chords for a sweeter feel. Example: C major pentatonic over Cmaj7 or C7.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Blues Scale</div>
                        <p class="text-slate-400 mb-2">1 - b3 - 4 - b5 - 5 - b7</p>
                        <p>Minor pentatonic plus the <strong>"blue note"</strong> (b5). Essential for blues and rock improvisation. The b5 creates tension that resolves to either the 4 or 5. Example: G blues scale over a G7 blues progression.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: Start with minor pentatonic - it works over most chord types and is hard to make sound "wrong."</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jazz Scales Info Modal -->
        <div id="scalesInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">When to Use These Scales</h3>
                    <button onclick="document.getElementById('scalesInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Lydian (over Maj7)</div>
                        <p class="text-slate-400 mb-2">1 - 2 - 3 - #4 - 5 - 6 - 7</p>
                        <p>The #4 avoids the "avoid note" (natural 4) that clashes with the major 3rd. Gives a bright, modern sound. Use over any <strong>major 7th chord</strong>, especially when it's not the I chord.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Dorian (over Min7)</div>
                        <p class="text-slate-400 mb-2">1 - 2 - b3 - 4 - 5 - 6 - b7</p>
                        <p>The natural 6 (instead of b6) gives a lighter, jazzier sound than natural minor. The default choice for <strong>minor 7th chords</strong>, especially the ii chord in a ii-V-I.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Lydian Dominant (over Dom7)</div>
                        <p class="text-slate-400 mb-2">1 - 2 - 3 - #4 - 5 - 6 - b7</p>
                        <p>Mixolydian with a #4. Works over <strong>dominant 7th chords</strong> that don't resolve down a 5th (like bVII7, IV7, or tritone subs). The #4 adds color without clashing.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: These scales follow the "chord tone + whole step" principle - each note is either a chord tone (1-3-5-7) or a whole step above one.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== INTERVALS MODE ==================== -->
        <div id="intervalsPanel" class="mode-panel">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Interval Practice</h2>
                        <p class="text-sm text-slate-400">"What's a <span class="text-blue-400">fifth</span> above <span class="text-blue-400">Db</span>?" — Answer in under 2 seconds!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="int_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="int_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-2">Intervals to Practice:</label>
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="1" checked><span>Half step</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="2" checked><span>Whole step</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="3" checked><span>Minor 3rd</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="4" checked><span>Major 3rd</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="5" checked><span>Perfect 4th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="6" checked><span>Tritone</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="7" checked><span>Perfect 5th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="8" checked><span>Minor 6th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="9" checked><span>Major 6th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="10" checked><span>Minor 7th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="11" checked><span>Major 7th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="12" checked><span>Octave</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Direction:</label>
                            <select id="int_directionSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="up">Up only</option>
                                <option value="down">Down only</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="int_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Quick select:</label>
                            <div class="flex gap-2">
                                <button onclick="intSelectIntervals('all')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">All</button>
                                <button onclick="intSelectIntervals('thirds')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">3rds & 5ths</button>
                                <button onclick="intSelectIntervals('none')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">None</button>
                            </div>
                        </div>
                        <div class="flex items-center ml-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="int_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600 mr-2">
                                <span class="text-sm text-slate-400">Focus on problem areas</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Challenge Display -->
                <div id="int_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Find the note that is a...</p>
                    <p class="text-4xl font-bold mb-2">
                        <span id="int_intervalName" class="text-blue-400">Perfect 5th</span>
                        <span id="int_directionText" class="text-slate-300">above</span>
                    </p>
                    <p class="text-5xl font-bold text-white" id="int_startNote">C</p>
                </div>

                <!-- Game Complete Display -->
                <div id="int_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="int_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="int_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="int_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="int_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="int_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="int_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="int_startBtn" onclick="intStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="int_stopBtn" onclick="intStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="int_playAgainBtn" onclick="intPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="int_newGameBtn" onclick="intNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="int_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="int_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="int_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="int_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="int_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="int_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="intClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="int_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="int_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Interval Breakdown</h2>
                <div id="int_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== 7TH CHORDS MODE ==================== -->
        <div id="chordsPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">7th Chord Practice</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">F minor 7</span> — Answer in under 2 seconds!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="ch_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="ch_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-2">Chord Types to Practice:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="maj7" checked><span>Major 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="min7" checked><span>Minor 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="dom7" checked><span>Dominant 7</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="ch_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="36">36 (all chords)</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Hands:</label>
                            <select id="ch_handsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="one" selected>One Hand</option>
                                <option value="two">Two Hands</option>
                            </select>
                        </div>
                        <div class="flex items-center ml-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="ch_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600 mr-2">
                                <span class="text-sm text-slate-400">Focus on problem areas</span>
                            </label>
                        </div>
                    </div>
                    <p id="ch_settingsHint" class="text-xs text-slate-500 mt-3">Play all 4 notes of the chord (any octave, any voicing). Root + 3rd + 5th + 7th.</p>
                </div>

                <!-- Challenge Display -->
                <div id="ch_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2">
                        <span id="ch_chordRoot" class="text-blue-400">C</span>
                        <span id="ch_chordType">maj7</span>
                    </p>
                    <p id="ch_twoHandsIndicator" class="text-sm text-purple-400 hidden">Two Hands (2 octaves)</p>
                    <p id="ch_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="ch_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="ch_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="ch_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="ch_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="ch_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="ch_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="ch_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano (shared, but we'll use same SVG) -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="ch_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="ch_startBtn" onclick="chStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="ch_stopBtn" onclick="chStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="ch_playAgainBtn" onclick="chPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="ch_newGameBtn" onclick="chNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="ch_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="ch_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="ch_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="ch_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="ch_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="ch_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="chClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="ch_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="ch_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="ch_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== ii-V-I MODE ==================== -->
        <div id="iiviPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">ii-V-I Practice</h2>
                        <p class="text-sm text-slate-400">Play the <span class="text-blue-400">ii-V-I</span> progression in any key — under 2 seconds per chord!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="iivi_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="iivi_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="iivi_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full">Full Chords — R-3-5-7 (4 notes)</option>
                                <option value="shell">Shell Voicings — 3rd + 7th only (2 notes)</option>
                                <option value="rootless">Rootless Type A — 3-5-7-9 (4 notes)</option>
                                <option value="rootlessABA">Rootless A→B→A — smooth voice leading!</option>
                                <option value="rootlessBAB">Rootless B→A→B — smooth voice leading!</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="iivi_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12 (all keys)</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="iivi_twoHands" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="iivi_twoHands" class="text-sm text-slate-400">Two hands (add bass)</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="iivi_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="iivi_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="iivi_settingsHint" class="text-xs text-slate-500 mt-3">Play ii → V → I in sequence. Each chord needs all 4 notes (any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="iivi_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="iivi_challengeLabel" class="text-slate-400 mb-2">ii-V-I in the key of</p>
                    <p class="text-5xl font-bold text-white mb-4" id="iivi_keyDisplay">C</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="iivi_step_ii" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_ii" class="text-lg font-bold">Dm7</span>
                                <span id="iivi_shell_ii" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">ii</span>
                            <div id="iivi_time_ii" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="iivi_step_V" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_V" class="text-lg font-bold">G7</span>
                                <span id="iivi_shell_V" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">V</span>
                            <div id="iivi_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="iivi_step_I" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_I" class="text-lg font-bold">Cmaj7</span>
                                <span id="iivi_shell_I" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">I</span>
                            <div id="iivi_time_I" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="iivi_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="iivi_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="iivi_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="iivi_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="iivi_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="iivi_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="iivi_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="iivi_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="iivi_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="iivi_startBtn" onclick="iiviStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="iivi_stopBtn" onclick="iiviStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="iivi_playAgainBtn" onclick="iiviPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="iivi_newGameBtn" onclick="iiviNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="iivi_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="iivi_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Chords: <span id="iivi_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="iivi_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="iivi_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="iivi_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="iiviClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="iivi_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="iivi_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="iivi_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== JAZZ SCALES MODE ==================== -->
        <div id="scalesPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Jazz Scales</h2>
                            <button onclick="document.getElementById('scalesInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="When to use these scales">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Play scales using the <span class="text-blue-400">chord tone + whole step</span> principle</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="sc_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="sc_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Types:</label>
                            <select id="sc_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only (Lydian)</option>
                                <option value="min7">Minor 7 only (Dorian)</option>
                                <option value="dom7">Dominant 7 only (Lydian Dom)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="sc_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="sc_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="sc_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="sc_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="sc_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="sc_settingsHint" class="text-xs text-slate-500 mt-3">Lydian (maj7): 1 2 3 #4 5 6 7 | Dorian (min7): 1 2 b3 4 5 6 b7 | Mixolydian (dom7): 1 2 3 4 5 6 b7</p>
                </div>

                <!-- Challenge Display -->
                <div id="sc_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the scale for</p>
                    <p class="text-5xl font-bold text-white mb-2" id="sc_chordDisplay">C maj7</p>
                    <p class="text-2xl text-blue-400 mb-4" id="sc_scaleNameDisplay">Lydian</p>

                    <!-- Scale progress indicator -->
                    <div class="flex justify-center items-center gap-2 mb-4" id="sc_noteProgress">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_0"><span class="sc-hint">1</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_1"><span class="sc-hint">2</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_2"><span class="sc-hint">3</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_3"><span class="sc-hint">#4</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_4"><span class="sc-hint">5</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_5"><span class="sc-hint">6</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_6"><span class="sc-hint">7</span></div>
                    </div>

                    <p id="sc_expectedNote" class="text-sm text-slate-400 sc-hint">Next: <span class="text-white font-bold" id="sc_expectedNoteValue">C</span></p>
                </div>

                <!-- Game Complete Display -->
                <div id="sc_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="sc_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="sc_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="sc_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="sc_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per scale</p>
                        </div>
                    </div>
                    <div id="sc_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="sc_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="sc_startBtn" onclick="scStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="sc_stopBtn" onclick="scStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="sc_playAgainBtn" onclick="scPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="sc_newGameBtn" onclick="scNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="sc_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="sc_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Notes: <span id="sc_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="sc_mistakesDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="sc_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="scClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="sc_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="sc_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Scale Breakdown</h2>
                <div id="sc_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ EXTENSIONS MODE PANEL ============ -->
        <div id="extPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Chord Extensions</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">extended chords</span>: 9ths, 11ths, and 13ths</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="ext_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="ext_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Base Chord:</label>
                            <select id="ext_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Extension:</label>
                            <select id="ext_extensionSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Extensions</option>
                                <option value="9">9th only (5 notes)</option>
                                <option value="11">11th only (6 notes)</option>
                                <option value="13">13th only (7 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="ext_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="ext_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="ext_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="ext_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="ext_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Extensions add color tones above the 7th: 9 = +2, 11 = +5, 13 = +9 from root.</p>
                </div>

                <!-- Challenge Display -->
                <div id="ext_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2" id="ext_chordDisplay">Cmaj9</p>
                    <p class="text-sm text-slate-400 mb-4" id="ext_formulaLine">
                        <span id="ext_noteCount" class="text-blue-400 font-bold">5</span> notes<span id="ext_formulaHint">: <span id="ext_formulaDisplay" class="text-slate-300">1 - 3 - 5 - 7 - 9</span></span>
                    </p>
                    <p id="ext_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="ext_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="ext_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="ext_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="ext_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="ext_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="ext_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="ext_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="ext_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="ext_startBtn" onclick="extStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="ext_stopBtn" onclick="extStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="ext_playAgainBtn" onclick="extPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="ext_newGameBtn" onclick="extNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="ext_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="ext_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="ext_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="ext_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="ext_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="ext_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="extClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="ext_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="ext_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="ext_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ ALTERED EXTENSIONS MODE PANEL ============ -->
        <div id="altPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Altered Extensions</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-red-400">altered dominant</span> chords: b9, #9, #11, b13</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="alt_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="alt_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Alteration:</label>
                            <select id="alt_alterationSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Alterations</option>
                                <option value="b9">b9 only</option>
                                <option value="#9">#9 only</option>
                                <option value="#11">#11 only</option>
                                <option value="b13">b13 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="alt_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full" selected>Full (stacked)</option>
                                <option value="simple">Simplified</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="alt_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="alt_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="alt_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="alt_voicingHint" class="text-xs text-slate-500 mt-3">Full: #11 and b13 include the 9th (like extended chords). Simplified: only the altered note.</p>
                </div>

                <!-- Challenge Display -->
                <div id="alt_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2" id="alt_chordDisplay">C7b9</p>
                    <p class="text-sm text-slate-400 mb-4">
                        <span id="alt_noteCount" class="text-red-400 font-bold">5</span> notes:
                        <span id="alt_formulaDisplay" class="text-slate-300">1 - 3 - 5 - b7 - b9</span>
                    </p>
                    <p id="alt_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="alt_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="alt_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="alt_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="alt_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="alt_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="alt_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="alt_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="alt_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="alt_startBtn" onclick="altStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="alt_stopBtn" onclick="altStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="alt_playAgainBtn" onclick="altPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="alt_newGameBtn" onclick="altNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="alt_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="alt_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="alt_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="alt_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="alt_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="alt_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="altClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="alt_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="alt_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="alt_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ ADVANCED CHORDS MODE PANEL ============ -->
        <div id="advPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Advanced Chord Practice</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">C half-dim</span> — Master all jazz chord types!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="adv_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="adv_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm text-slate-400">Chord Types to Practice:</label>
                            <div class="flex gap-2">
                                <button onclick="advSelectChords('all')" class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">All</button>
                                <button onclick="advSelectChords('common')" class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">Common</button>
                                <button onclick="advSelectChords('dominant')" class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">Dominant</button>
                                <button onclick="advSelectChords('diminished')" class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">Diminished</button>
                                <button onclick="advSelectChords('none')" class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">None</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="halfdim" checked><span>Half-dim (ø7)</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dim7" checked><span>Dim 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="minMaj7" checked><span>Min-Maj 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="maj6" checked><span>Major 6</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="min6" checked><span>Minor 6</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom7sharp5" checked><span>7#5</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom13"><span>Dom 13</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom7alt"><span>7alt</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="sus4"><span>Sus4</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="7sus4"><span>7sus4</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="adv_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="36">36</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="adv_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="adv_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="adv_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="adv_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Play all notes of the chord (any octave, any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="adv_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2">
                        <span id="adv_chordRoot" class="text-blue-400">C</span>
                        <span id="adv_chordType">ø7</span>
                    </p>
                    <p id="adv_chordFormula" class="text-sm text-slate-500 mb-2">R b3 b5 b7</p>
                    <p id="adv_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="adv_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="adv_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="adv_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="adv_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="adv_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="adv_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="adv_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="adv_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="adv_startBtn" onclick="advStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="adv_stopBtn" onclick="advStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="adv_playAgainBtn" onclick="advPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="adv_newGameBtn" onclick="advNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="adv_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="adv_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="adv_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="adv_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="adv_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="adv_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="advClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="adv_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="adv_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="adv_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== MINOR ii-V-i MODE ==================== -->
        <div id="minorIiviPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Minor ii-V-i Practice</h2>
                        <p class="text-sm text-slate-400">Play the <span class="text-purple-400">minor ii-V-i</span> progression — iiø7 → V7 → imM7</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="miivi_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="miivi_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="miivi_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12 (all keys)</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="miivi_twoHands" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="miivi_twoHands" class="text-sm text-slate-400">Two hands (add bass)</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="miivi_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="miivi_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="miivi_settingsHint" class="text-xs text-slate-500 mt-3">Play iiø7 → V7 → imM7 in sequence. Each chord needs all 4 notes (any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="miivi_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="miivi_challengeLabel" class="text-slate-400 mb-2">Minor ii-V-i in</p>
                    <p class="text-5xl font-bold text-white mb-4" id="miivi_keyDisplay">C</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="miivi_step_ii" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_ii" class="text-lg font-bold">Dø7</span>
                                <span id="miivi_hint_ii" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">iiø7</span>
                            <div id="miivi_time_ii" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="miivi_step_V" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_V" class="text-lg font-bold">G7</span>
                                <span id="miivi_hint_V" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">V7</span>
                            <div id="miivi_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="miivi_step_i" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_i" class="text-lg font-bold">CmM7</span>
                                <span id="miivi_hint_i" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">imM7</span>
                            <div id="miivi_time_i" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="miivi_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="miivi_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="miivi_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="miivi_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="miivi_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="miivi_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="miivi_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="miivi_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="miivi_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="miivi_startBtn" onclick="miiviStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="miivi_stopBtn" onclick="miiviStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="miivi_playAgainBtn" onclick="miiviPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="miivi_newGameBtn" onclick="miiviNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="miivi_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="miivi_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Chords: <span id="miivi_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="miivi_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="miivi_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="miivi_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="miiviClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="miivi_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="miivi_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="miivi_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== KENNY BARRON MODE ==================== -->
        <div id="kbPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Kenny Barron Voicing</h2>
                            <button onclick="document.getElementById('kbInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About Kenny Barron voicings">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Play the <span class="text-teal-400">Kenny Barron</span> voicing — stacked 5ths!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="kb_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="kb_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="kb_chordType" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="minor">Minor 11 only</option>
                                <option value="major">Major 7#11 only</option>
                                <option value="both" selected>Both (random)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="kb_voicingType" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full" selected>Full (6 notes)</option>
                                <option value="sawnoff">Sawn-off (5 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="kb_rounds" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="12" selected>12 (all keys)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="kb_showHints" class="w-4 h-4 rounded">
                                <span>Show hints</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="kb_focusProblemAreas" class="w-4 h-4 rounded">
                                <span>Focus on problem areas</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Left Hand: R-5-9 (stacked 5ths) | Right Hand: 3-7-11 (stacked 5ths, half step up)</p>
                </div>

                <!-- Challenge Display -->
                <div id="kb_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this voicing:</p>
                    <p class="text-5xl font-bold text-teal-400 mb-4" id="kb_chordDisplay">Cm11</p>

                    <!-- Voicing Diagram -->
                    <div class="flex justify-center items-center gap-8 mb-4">
                        <div class="text-center">
                            <div class="w-24 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span class="text-xs text-slate-500">LEFT HAND</span>
                                <span id="kb_lhNotes" class="text-sm font-mono text-slate-300">R - 5 - 9</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-24 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span class="text-xs text-slate-500">RIGHT HAND</span>
                                <span id="kb_rhNotes" class="text-sm font-mono text-slate-300">b3 - b7 - 11</span>
                            </div>
                        </div>
                    </div>

                    <!-- Note Indicators -->
                    <div class="flex justify-center gap-2 mb-4">
                        <div id="kb_noteIndicators" class="flex gap-1"></div>
                    </div>

                    <p id="kb_heldNotes" class="text-sm text-slate-500">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="kb_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="kb_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="kb_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="kb_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="kb_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per voicing</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="kb_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="kb_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="kb_startBtn" onclick="kbStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="kb_stopBtn" onclick="kbStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="kb_playAgainBtn" onclick="kbPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="kb_newGameBtn" onclick="kbNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="kb_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="kb_totalRounds" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="kb_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="kb_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="kb_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="kb_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="kbClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="kb_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="kb_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="kb_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Kenny Barron Info Modal -->
        <div id="kbInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Kenny Barron Voicing</h3>
                    <button onclick="document.getElementById('kbInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-teal-400 font-semibold mb-1">What is it?</div>
                        <p>A signature voicing popularized by pianist Kenny Barron, built on <strong>stacked perfect 5ths</strong> between both hands. It creates a rich, open sound perfect for minor 11 and major 7#11 chords.</p>
                    </div>
                    <div>
                        <div class="text-teal-400 font-semibold mb-1">The formulas</div>
                        <p class="text-slate-400 mb-2"><strong>Minor 11:</strong></p>
                        <p class="text-slate-400 mb-1 pl-3">LH: Root - 5th - 9th (stacked 5ths)</p>
                        <p class="text-slate-400 mb-2 pl-3">RH: b3rd - b7th - 11th (stacked 5ths)</p>
                        <p class="text-slate-400 mb-2"><strong>Major 7#11:</strong></p>
                        <p class="text-slate-400 mb-1 pl-3">LH: Root - 5th - 9th (stacked 5ths)</p>
                        <p class="text-slate-400 pl-3">RH: 3rd - 7th - #11th (stacked 5ths)</p>
                    </div>
                    <div>
                        <div class="text-teal-400 font-semibold mb-1">When to use it</div>
                        <p>Perfect for ballads, modal jazz, and any time you want a lush, sustained chord. Works especially well on the im7 chord in minor keys or as a Lydian sound on major chords.</p>
                    </div>
                    <div>
                        <div class="text-teal-400 font-semibold mb-1">Voicing options</div>
                        <p class="text-slate-400 mb-1"><strong>Full (6 notes):</strong> The complete voicing with all stacked 5ths</p>
                        <p class="text-slate-400"><strong>Sawn-off (5 notes):</strong> Drops the 5th from LH, keeping R-9 in left hand. A lighter version that's easier to voice lead.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: Listen to Kenny Barron's recordings, especially ballads like "Voyage" or his work with Stan Getz, to hear these voicings in context.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== JUST THE TWO OF US MODE ==================== -->
        <div id="jtouPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Just the Two of Us</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-pink-400">bVImaj9 → V7#9 → im9</span> in every key!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="jtou_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="jtou_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="jtou_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="no5" selected>No 5th on V chord</option>
                                <option value="full">Full (with 5ths)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="jtou_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="12" selected>12 (all keys)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="jtou_showHints" class="w-4 h-4 rounded">
                                <span>Show hints</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="jtou_focusProblemAreas" class="w-4 h-4 rounded">
                                <span>Focus on problem areas</span>
                            </label>
                        </div>
                    </div>
                    <p id="jtou_settingsHint" class="text-xs text-slate-500 mt-3">The classic Grover Washington Jr. / Bill Withers progression. In Fm: Dbmaj9 → C7#9 → Fm9</p>
                </div>

                <!-- Challenge Display -->
                <div id="jtou_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="jtou_challengeLabel" class="text-slate-400 mb-2">Just the Two of Us in</p>
                    <p class="text-5xl font-bold text-white mb-4" id="jtou_keyDisplay">Fm</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="jtou_step_bVI" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_bVI" class="text-lg font-bold">Dbmaj7</span>
                                <span id="jtou_notes_bVI" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">bVImaj9</span>
                            <div id="jtou_time_bVI" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="jtou_step_V" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_V" class="text-lg font-bold">C7#9</span>
                                <span id="jtou_notes_V" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">V7#9</span>
                            <div id="jtou_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="jtou_step_i" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_i" class="text-lg font-bold">Fm7</span>
                                <span id="jtou_notes_i" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">im9</span>
                            <div id="jtou_time_i" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="jtou_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="jtou_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="jtou_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="jtou_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="jtou_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="jtou_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="jtou_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="jtou_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="jtou_startBtn" onclick="jtouStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="jtou_stopBtn" onclick="jtouStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="jtou_playAgainBtn" onclick="jtouPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="jtou_newGameBtn" onclick="jtouNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="jtou_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="jtou_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="jtou_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="jtou_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="jtou_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="jtou_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="jtouClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="jtou_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="jtou_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="jtou_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== ROOTLESS VOICINGS MODE ==================== -->
        <div id="dom7vPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Rootless Voicings</h2>
                        <p class="text-sm text-slate-400">Type A voicing: <span class="text-orange-400">3rd - 5th - 7th - 9th</span> (no root)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="dom7v_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="dom7v_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="dom7v_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all" selected>All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing Type:</label>
                            <select id="dom7v_voicingTypeSelect" onchange="dom7vUpdateSettingsHint()" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="A" selected>Type A (3-5-7-9)</option>
                                <option value="B">Type B (7-9-3-5)</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="dom7v_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                                <option value="36">36</option>
                                <option value="72">72 (all keys x types x voicings)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="dom7v_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="dom7v_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="dom7v_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="dom7v_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="dom7v_settingsHint" class="text-xs text-slate-500 mt-3">Type A: 3-5-7-9 (from bottom). Type B: 7-9-3-5 (inverted, voice-leads smoothly with A).</p>
                </div>

                <!-- Challenge Display -->
                <div id="dom7v_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the rootless voicing for</p>
                    <p class="text-5xl font-bold text-white mb-3">
                        <span id="dom7v_chordDisplay">CMaj7</span>
                        <span id="dom7v_voicingTypeDisplay" class="text-2xl text-orange-400 ml-2"></span>
                    </p>
                    <p id="dom7v_formulaLine" class="text-sm text-slate-400 mb-4">
                        <span class="text-orange-400 font-bold">4</span> notes:
                        <span id="dom7v_formulaHint" class="text-slate-300">3 - 5 - 7 - 9</span>
                    </p>
                    <p id="dom7v_noteHint" class="text-lg text-orange-300 mb-4 hidden">E - G - B - D</p>
                    <p id="dom7v_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="dom7v_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="dom7v_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="dom7v_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="dom7v_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="dom7v_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="dom7v_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="dom7v_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano Display -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="dom7v_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="dom7v_startBtn" onclick="dom7vStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="dom7v_stopBtn" onclick="dom7vStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="dom7v_playAgainBtn" onclick="dom7vPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="dom7v_newGameBtn" onclick="dom7vNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="dom7v_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="dom7v_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="dom7v_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="dom7v_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="dom7v_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="dom7v_feedbackFloat" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="dom7vClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="dom7v_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="dom7v_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Voicing Breakdown</h2>
                <div id="dom7v_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== EXTENDED VOICINGS MODE ==================== -->
        <div id="extvPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">6/9 Voicings Practice</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">Maj6/9</span>, <span class="text-blue-400">Min6/9</span>, and <span class="text-blue-400">Dom13</span> voicings in all 12 keys</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="extv_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="extv_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="extv_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all" selected>All Types</option>
                                <option value="maj69">Maj6/9 only</option>
                                <option value="min69">Min6/9 only</option>
                                <option value="dom13">Dom13 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="extv_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                                <option value="36">36 (all keys x 3 types)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="extv_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="extv_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="extv_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="extv_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="extv_settingsHint" class="text-xs text-slate-500 mt-3">Maj6/9: 3-5-6-9. Min6/9: b3-5-6-9. Dom13: 3-13-7-9 (soulful dominant sound).</p>
                </div>

                <!-- Challenge Display -->
                <div id="extv_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the extended voicing for</p>
                    <p class="text-5xl font-bold text-white mb-3" id="extv_chordDisplay">CMaj6/9</p>
                    <p id="extv_formulaLine" class="text-sm text-slate-400 mb-4">
                        <span class="text-orange-400 font-bold">4</span> notes:
                        <span id="extv_formulaHint" class="text-slate-300">3 - 5 - 6 - 9</span>
                    </p>
                    <p id="extv_noteHint" class="text-lg text-orange-300 mb-4 hidden">E - G - A - D</p>
                    <p id="extv_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="extv_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="extv_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="extv_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="extv_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="extv_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="extv_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="extv_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano Display -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="extv_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="extv_startBtn" onclick="extvStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="extv_stopBtn" onclick="extvStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="extv_playAgainBtn" onclick="extvPlayAgain()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="extv_newGameBtn" onclick="extvNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="extv_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="extv_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">1st Try: <span id="extv_scoreDisplay" class="font-mono">0%</span></span>
                            <span class="text-red-400">Mistakes: <span id="extv_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="extv_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="extv_feedbackFloat" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="extvClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="extv_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="extv_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Voicing Breakdown</h2>
                <div id="extv_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== PENTATONIC & BLUES MODE ==================== -->
        <div id="pentPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Pentatonic & Blues Scales</h2>
                            <button onclick="document.getElementById('pentInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="When to use these scales">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">pentatonic</span> and <span class="text-blue-400">blues</span> scales in all 12 keys</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="pent_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="pent_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Scale Type:</label>
                            <select id="pent_scaleTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="minPent">Minor Pentatonic only</option>
                                <option value="majPent">Major Pentatonic only</option>
                                <option value="blues">Blues Scale only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="pent_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="pent_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="pent_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="pent_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="pent_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="pent_settingsHint" class="text-xs text-slate-500 mt-3">Minor Pent: 1 b3 4 5 b7 | Major Pent: 1 2 3 5 6 | Blues: 1 b3 4 b5 5 b7</p>
                </div>

                <!-- Challenge Display -->
                <div id="pent_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the scale</p>
                    <p class="text-5xl font-bold text-white mb-2" id="pent_rootDisplay">C</p>
                    <p class="text-2xl text-blue-400 mb-4" id="pent_scaleNameDisplay">Minor Pentatonic</p>

                    <!-- Scale progress indicator (dynamic) -->
                    <div class="flex justify-center items-center gap-2 mb-4" id="pent_noteProgress"></div>

                    <p id="pent_expectedNote" class="text-sm text-slate-400">Next: <span class="text-white font-bold">C</span></p>
                </div>

                <!-- Game Complete Display -->
                <div id="pent_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="pent_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="pent_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="pent_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">wrong notes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="pent_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per scale</p>
                        </div>
                    </div>
                    <div id="pent_finalSlowCount" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="pent_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Feedback Float -->
                <div id="pent_feedbackFloat" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none z-50"></div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="pent_startBtn" onclick="pentStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="pent_currentRound" class="font-mono">0</span>/<span id="pent_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="pent_score" class="font-mono">0</span></span>
                        <span class="text-red-400">Mistakes: <span id="pent_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="pent_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="pent_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="pent_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Scale Breakdown</h2>
                <div id="pent_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== BEBOP SCALES MODE ==================== -->
        <div id="bebopPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Bebop Scales</h2>
                            <button onclick="document.getElementById('bebopInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="When to use bebop scales">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">8-note scales with <span class="text-blue-400">chromatic passing tones</span> for smooth jazz lines</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="bebop_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="bebop_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Scale Type:</label>
                            <select id="bebop_scaleTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="dominant">Bebop Dominant only</option>
                                <option value="major">Bebop Major only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="bebop_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="bebop_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="bebop_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="bebop_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="bebop_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="bebop_settingsHint" class="text-xs text-slate-500 mt-3">Dominant: 1 2 3 4 5 6 b7 7 | Major: 1 2 3 4 5 #5 6 7</p>
                </div>

                <!-- Challenge Display -->
                <div id="bebop_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the scale</p>
                    <p class="text-5xl font-bold text-white mb-2" id="bebop_rootDisplay">C</p>
                    <p class="text-2xl text-blue-400 mb-4" id="bebop_scaleNameDisplay">Bebop Dominant</p>

                    <!-- Scale progress indicator (dynamic - 8 notes) -->
                    <div class="flex justify-center items-center gap-2 mb-4" id="bebop_noteProgress"></div>

                    <p id="bebop_expectedNote" class="text-sm text-slate-400">Next: <span class="text-white font-bold">C</span></p>
                    <p id="bebop_feedbackText" class="text-lg font-semibold h-7"></p>
                </div>

                <!-- Game Complete Display -->
                <div id="bebop_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="bebop_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="bebop_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="bebop_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="bebop_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="bebop_finalSlow" class="text-2xl font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="bebop_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="bebop_startBtn" onclick="bebopStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="bebop_roundDisplay" class="font-mono">0</span>/<span id="bebop_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="bebop_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="bebop_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="bebop_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="bebop_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="bebop_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Scale Breakdown</h2>
                <div id="bebop_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Bebop Scales Info Modal -->
        <div id="bebopInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">When to Use Bebop Scales</h3>
                    <button onclick="document.getElementById('bebopInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Bebop Dominant</div>
                        <p class="text-slate-400 mb-2">1 - 2 - 3 - 4 - 5 - 6 - b7 - 7</p>
                        <p>Mixolydian with a passing tone (natural 7) between b7 and root. Use over <strong>dominant 7th chords</strong>. When you play 8th notes starting on a downbeat, all chord tones (1-3-5-b7) land on downbeats automatically.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Bebop Major</div>
                        <p class="text-slate-400 mb-2">1 - 2 - 3 - 4 - 5 - #5 - 6 - 7</p>
                        <p>Major scale with a passing tone (#5) between 5 and 6. Use over <strong>major 7th chords</strong>. The #5 adds chromatic movement while keeping chord tones on strong beats.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: The magic of bebop scales is the 8 notes - when playing continuous 8th notes, chord tones automatically fall on downbeats, creating strong harmonic clarity.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TRITONE SUBSTITUTION MODE ==================== -->
        <div id="tritonePanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Tritone Substitution</h2>
                            <button onclick="document.getElementById('tritoneInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About tritone substitution">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Replace <span class="text-blue-400">V7</span> with <span class="text-blue-400">bII7</span> (a tritone away)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="tritone_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="tritone_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="tritone_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="any">Any voicing (4 notes)</option>
                                <option value="shell">Shell voicing (R-3-7)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="tritone_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="tritone_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="tritone_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="tritone_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="tritone_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="tritone_settingsHint" class="text-xs text-slate-500 mt-3">Given a dom7 chord, play its tritone substitution (root + 6 semitones = new root)</p>
                </div>

                <!-- Challenge Display -->
                <div id="tritone_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the tritone sub for</p>
                    <p class="text-5xl font-bold text-white mb-4" id="tritone_chordDisplay">G7</p>
                    <p id="tritone_hint" class="text-lg text-blue-400 hidden"></p>
                    <p id="tritone_feedbackText" class="text-lg font-semibold h-7 mt-4"></p>
                </div>

                <!-- Game Complete Display -->
                <div id="tritone_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="tritone_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="tritone_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="tritone_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="tritone_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="tritone_finalSlow" class="text-2xl font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="tritone_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="tritone_startBtn" onclick="tritoneStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="tritone_roundDisplay" class="font-mono">0</span>/<span id="tritone_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="tritone_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="tritone_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="tritone_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="tritone_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="tritone_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="tritone_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Tritone Substitution Info Modal -->
        <div id="tritoneInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Tritone Substitution</h3>
                    <button onclick="document.getElementById('tritoneInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What is it?</div>
                        <p>Replace any dominant 7th chord with another dom7 chord whose root is a <strong>tritone (6 half steps)</strong> away. G7 → Db7, C7 → Gb7, etc.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Why does it work?</div>
                        <p>Both chords share the same <strong>tritone interval</strong> (the 3rd and 7th). In G7, the tritone is B-F. In Db7, it's F-Cb(B). Same notes, different context!</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">How to use it</div>
                        <p>In a ii-V-I: instead of Dm7 → G7 → Cmaj7, play Dm7 → <strong>Db7</strong> → Cmaj7. The bass moves chromatically (D → Db → C) for smooth voice leading.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Quick mental math</div>
                        <p>Add 6 semitones to the root: G + 6 = Db. Or think "up a tritone" or "down a tritone" (same note).</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: The tritone sub creates chromatic bass motion, making it a favorite tool for jazz reharmonization.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== SHELL VOICINGS MODE ==================== -->
        <div id="shellPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Shell Voicings</h2>
                            <button onclick="document.getElementById('shellInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About shell voicings">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">The essential chord tones: <span class="text-blue-400">Root + 3rd + 7th</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="shell_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="shell_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Types:</label>
                            <select id="shell_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="shell_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="shell_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="shell_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="shell_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="shell_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="shell_settingsHint" class="text-xs text-slate-500 mt-3">Maj7: R-3-7 | Min7: R-b3-b7 | Dom7: R-3-b7</p>
                </div>

                <!-- Challenge Display -->
                <div id="shell_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden relative">
                    <p class="text-slate-400 mb-2">Play the shell voicing</p>
                    <p class="text-5xl font-bold text-white mb-4" id="shell_chordDisplay">Cmaj7</p>
                    <p id="shell_hint" class="text-lg text-blue-400 hidden"></p>
                    <p id="shell_feedbackText" class="text-lg font-semibold h-7 mt-4"></p>
                    <div id="shell_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                </div>

                <!-- Game Complete Display -->
                <div id="shell_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="shell_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="shell_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="shell_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="shell_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="shell_finalSlow" class="text-2xl font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="shell_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="shell_startBtn" onclick="shellStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="shell_roundDisplay" class="font-mono">0</span>/<span id="shell_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="shell_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="shell_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="shell_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="shell_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="shell_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="shell_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Shell Voicings Info Modal -->
        <div id="shellInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Shell Voicings</h3>
                    <button onclick="document.getElementById('shellInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What is a shell voicing?</div>
                        <p>Just three notes: <strong>Root + 3rd + 7th</strong>. The 5th is omitted because it doesn't define the chord quality - the 3rd and 7th do all the work.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">The formulas</div>
                        <p class="text-slate-400 mb-1">Maj7: R + M3 + M7 (e.g., C-E-B)</p>
                        <p class="text-slate-400 mb-1">Min7: R + m3 + m7 (e.g., C-Eb-Bb)</p>
                        <p class="text-slate-400">Dom7: R + M3 + m7 (e.g., C-E-Bb)</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Why practice these?</div>
                        <p>Shell voicings are the foundation of jazz comping. They leave room for the bass player, voice-lead smoothly through changes, and are the building blocks for more complex voicings.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Peter Martin says...</div>
                        <p>"Nobody believes I practice this... I practice these all the time. Root, shell, pretty, melody - these are the building blocks."</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Tip: Once comfortable, practice voice-leading shells through ii-V-I progressions - the 7th of one chord becomes the 3rd of the next.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upper Structure Triads Panel -->
        <div id="upperPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Upper Structure Triads</h2>
                            <button onclick="document.getElementById('upperInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About upper structures">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Play triads over dominant bass for <span class="text-blue-400">altered/extended sounds</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="upper_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="upper_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Structure Type:</label>
                            <select id="upper_typeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="bII">bII (7b9)</option>
                                <option value="II">II (13#11)</option>
                                <option value="bIII">bIII (7#9)</option>
                                <option value="bVI">bVI (7alt)</option>
                                <option value="VI">VI (13b9)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="upper_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Hints:</label>
                            <select id="upper_hintLevel" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full">Full (show triad)</option>
                                <option value="interval">Interval (bVI)</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="upper_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="upper_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="upper_settingsHint" class="text-xs text-slate-500 mt-3">The root of the triad becomes the main tension color (b9, #9, #11, etc.)</p>
                </div>

                <!-- Challenge Display -->
                <div id="upper_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the upper structure</p>
                    <p class="text-5xl font-bold text-white mb-2" id="upper_chordDisplay">G7alt</p>
                    <p id="upper_hint" class="text-lg text-blue-400 hidden"></p>
                    <p id="upper_feedbackText" class="text-lg font-semibold h-7 mt-4"></p>
                </div>

                <!-- Game Complete Display -->
                <div id="upper_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="upper_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="upper_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="upper_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="upper_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="upper_finalSlow" class="text-2xl font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="upper_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="upper_startBtn" onclick="upperStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="upper_roundDisplay" class="font-mono">0</span>/<span id="upper_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="upper_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="upper_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="upper_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="upper_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="upper_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Structure Breakdown</h2>
                <div id="upper_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== FREESTYLE VOICING MODE ==================== -->
        <div id="freestylePanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Freestyle Voicing</h2>
                            <button onclick="document.getElementById('freestyleInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About freestyle voicing">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Play any voicing with <span class="text-blue-400">3rd + 7th</span> (guide tones)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="freestyle_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="freestyle_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Types:</label>
                            <select id="freestyle_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="freestyle_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="freestyle_requireRoot" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="freestyle_requireRoot" class="text-sm text-slate-400">Require root</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="freestyle_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="freestyle_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="freestyle_focusProblemAreas" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="freestyle_focusProblemAreas" class="text-sm text-slate-400">Focus on problem areas</label>
                        </div>
                    </div>
                    <p id="freestyle_settingsHint" class="text-xs text-slate-500 mt-3">Extensions & alterations welcome! Just include the 3rd and 7th.</p>
                </div>

                <!-- Challenge Display -->
                <div id="freestyle_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden relative">
                    <p class="text-slate-400 mb-2">Play any voicing for</p>
                    <p class="text-5xl font-bold text-white mb-4" id="freestyle_chordDisplay">Cmaj7</p>
                    <p id="freestyle_hint" class="text-lg text-blue-400 hidden"></p>
                    <p id="freestyle_recognized" class="text-lg text-slate-400 mb-2 h-7"></p>
                    <p id="freestyle_feedbackText" class="text-lg font-semibold h-7 mt-4"></p>
                    <div id="freestyle_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                </div>

                <!-- Game Complete Display -->
                <div id="freestyle_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-5 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="freestyle_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="freestyle_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="freestyle_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="freestyle_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="freestyle_finalSlow" class="text-2xl font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="freestyle_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="freestyle_startBtn" onclick="freestyleStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="freestyle_roundDisplay" class="font-mono">0</span>/<span id="freestyle_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="freestyle_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="freestyle_mistakes" class="font-mono">0</span></span>
                        <span class="text-yellow-400">Slow: <span id="freestyle_slow" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="freestyle_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>

            <!-- Breakdown Section -->
            <div id="freestyle_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="freestyle_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Freestyle Info Modal -->
        <div id="freestyleInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Freestyle Voicing</h3>
                    <button onclick="document.getElementById('freestyleInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What is this?</div>
                        <p>Practice reading chord charts like a real jazz pianist. You see a chord symbol and play <strong>any valid voicing</strong> - not a specific one.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What makes a voicing "valid"?</div>
                        <p>You must include the <strong>guide tones</strong> (3rd and 7th) - these define the chord's quality. Everything else is flexible:</p>
                        <ul class="list-disc list-inside text-slate-400 mt-2 space-y-1">
                            <li>Root - optional (bass often plays it)</li>
                            <li>5th - optional (commonly omitted)</li>
                            <li>9th, 11th, 13th - all valid extensions</li>
                            <li>Altered tensions (b9, #9, #11, b13) - allowed on dom7</li>
                        </ul>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Examples for Cmaj7</div>
                        <p class="text-slate-400">All of these work:</p>
                        <ul class="list-disc list-inside text-slate-400 mt-1 space-y-1">
                            <li>E + B (just guide tones)</li>
                            <li>C + E + G + B (full chord)</li>
                            <li>E + G + B + D (Cmaj9, no root)</li>
                            <li>E + F# + B + D (Cmaj9#11)</li>
                        </ul>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Why practice this?</div>
                        <p>This builds the skill of <strong>reading a chart and instantly playing something musical</strong> - not just reciting memorized voicings. It develops real-world comping fluency.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upper Structure Info Modal -->
        <div id="upperInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Upper Structure Triads</h3>
                    <button onclick="document.getElementById('upperInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What are upper structures?</div>
                        <p>A voicing technique where you play a <strong>major triad in your right hand</strong> over a <strong>dominant bass note in your left hand</strong>. This instantly creates altered and extended sounds.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">The key insight</div>
                        <p>The <strong>root of the triad becomes the main tension</strong>. Want a b9 sound? Play a triad whose root IS the b9.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">The mappings</div>
                        <p class="text-slate-400 mb-1">bII → 7b9 (Db major over C7)</p>
                        <p class="text-slate-400 mb-1">II → 13#11 (D major over C7)</p>
                        <p class="text-slate-400 mb-1">bIII → 7#9 (Eb major over C7)</p>
                        <p class="text-slate-400 mb-1">bVI → 7alt (Ab major over C7)</p>
                        <p class="text-slate-400">VI → 13b9 (A major over C7)</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Why practice this?</div>
                        <p>Learn 5 relationships that work in any key. Instead of thinking "b9, #11, b13", you just grab "Ab major triad" over a dominant bass. Fast, reliable access to complex sounds.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">Used by Herbie Hancock, Chick Corea, and many modern jazz pianists.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ALL THE THINGS YOU ARE MODE ==================== -->
        <div id="attyaPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">All The Things You Are</h2>
                            <button onclick="document.getElementById('attyaInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About this chart">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Jerome Kern • Key of Ab • 36 changes</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="attya_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="attya_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="attya_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="rootless">Rootless (optimal A/B)</option>
                                <option value="shell">Shell (3rd + 7th)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="attya_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600" checked>
                            <label for="attya_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Voicings are optimized for smooth voice leading through the changes.</p>
                </div>

                <!-- Chart Grid -->
                <div id="attya_chartGrid" class="mb-6 grid grid-cols-4 gap-1 text-center text-xs"></div>

                <!-- Current Chord Display -->
                <div id="attya_challengeDisplay" class="mb-6 p-6 bg-slate-900 rounded-lg text-center hidden">
                    <p id="attya_sectionLabel" class="text-slate-400 text-sm mb-1">Bar 1 • Section A</p>
                    <p id="attya_chordDisplay" class="text-5xl font-bold text-white mb-2">Fm7</p>
                    <p id="attya_voicingType" class="text-blue-400 mb-2">Type A</p>
                    <p id="attya_hint" class="text-lg text-blue-400"></p>
                    <p id="attya_feedbackText" class="text-lg font-semibold h-7 mt-2"></p>
                </div>

                <!-- Game Complete Display -->
                <div id="attya_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Chart Complete!</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Changes</p>
                            <p id="attya_finalChanges" class="text-2xl font-bold text-white">36</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="attya_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="attya_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="attya_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="attya_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="attya_startBtn" onclick="attyaStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Progress: <span id="attya_progress" class="font-mono">0</span>/<span id="attya_totalChanges" class="font-mono">36</span></span>
                        <span class="text-green-400">1st Try: <span id="attya_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="attya_mistakes" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="attya_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>
        </div>

        <!-- ATTYA Info Modal -->
        <div id="attyaInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">All The Things You Are</h3>
                    <button onclick="document.getElementById('attyaInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">About This Chart</div>
                        <p>One of the most performed jazz standards, written by Jerome Kern in 1939. The 36-bar AABA' form features beautiful chord movement through multiple key centers.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Voice Leading</div>
                        <p>The app computes optimal Type A/B voicing choices to maximize common tones between chords, minimizing hand movement while maintaining smooth voice leading.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Practice Tips</div>
                        <ul class="list-disc list-inside text-slate-400 mt-1 space-y-1">
                            <li>Start with hints ON to learn the voicings</li>
                            <li>Focus on the voice leading between chords</li>
                            <li>Notice how Type A and B alternate for smoothness</li>
                            <li>Once comfortable, try Shell voicings for a simpler feel</li>
                        </ul>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">This tune appears in every jazz musician's repertoire - essential vocabulary!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== VOICE LEADING TRAINER MODE ==================== -->
        <div id="voiceleadPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="text-xl font-semibold text-white">Voice Leading Trainer</h2>
                            <button onclick="document.getElementById('voiceleadInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About voice leading">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-sm text-slate-400">Find the <span class="text-green-400">common tones</span> and <span class="text-blue-400">smooth resolutions</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="vl_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="vl_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Progression:</label>
                            <select id="vl_progressionSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="iiV">ii → V (two chords)</option>
                                <option value="VI">V → I (two chords)</option>
                                <option value="iiVI" selected>ii → V → I (three chords)</option>
                                <option value="random">Random pairs</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="vl_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="guide" selected>Guide tones only (3-7)</option>
                                <option value="shell">Shell (R-3-7)</option>
                                <option value="full">Full rootless (4 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="vl_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="vl_showAnalysis" class="w-4 h-4 rounded bg-slate-700 border-slate-600" checked>
                            <label for="vl_showAnalysis" class="text-sm text-slate-400">Show voice leading analysis</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Learn to find smooth voice leading by keeping common tones and moving other notes by step.</p>
                </div>

                <!-- Challenge Display -->
                <div id="vl_challengeDisplay" class="mb-6 hidden">
                    <!-- Two-chord display -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Source Chord -->
                        <div id="vl_sourceBox" class="p-4 bg-slate-900 rounded-lg text-center transition-all">
                            <p class="text-slate-400 text-sm mb-1">FROM</p>
                            <p id="vl_sourceChord" class="text-3xl font-bold text-white mb-2">Dm7</p>
                            <p id="vl_sourceNotes" class="text-lg text-blue-400">Play: F C</p>
                        </div>
                        <!-- Target Chord -->
                        <div id="vl_targetBox" class="p-4 bg-slate-900 rounded-lg text-center transition-all opacity-50">
                            <p class="text-slate-400 text-sm mb-1">TO</p>
                            <p id="vl_targetChord" class="text-3xl font-bold text-white mb-2">G7</p>
                            <p id="vl_targetHint" class="text-lg text-blue-400"></p>
                        </div>
                    </div>

                    <!-- Voice Leading Analysis -->
                    <div id="vl_analysisPanel" class="mb-4 p-4 bg-slate-700/30 rounded-lg">
                        <div class="flex justify-center gap-8 text-sm">
                            <div id="vl_commonTones" class="text-center">
                                <p class="text-slate-400 mb-1">Common Tones</p>
                                <p class="text-green-400 font-mono text-lg">F stays</p>
                            </div>
                            <div id="vl_resolutions" class="text-center">
                                <p class="text-slate-400 mb-1">Resolutions</p>
                                <p class="text-blue-400 font-mono text-lg">C → B (½ step down)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback -->
                    <p id="vl_feedbackText" class="text-lg font-semibold text-center h-7 mb-4"></p>
                </div>

                <!-- Game Complete Display -->
                <div id="vl_completeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <h3 class="text-3xl font-bold text-green-400 mb-4">Practice Complete!</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4 text-center">
                        <div>
                            <p class="text-slate-400 text-sm">Rounds</p>
                            <p id="vl_finalRounds" class="text-2xl font-bold text-white">12</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="vl_finalAvgTime" class="text-2xl font-bold text-purple-400">--</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">1st Try</p>
                            <p id="vl_finalFirstTry" class="text-2xl font-bold text-green-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="vl_finalMistakes" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                    </div>
                </div>

                <!-- Piano Container -->
                <div class="flex justify-center mb-6">
                    <svg id="vl_pianoSvg" viewBox="0 0 700 150" class="max-w-full h-auto"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="vl_startBtn" onclick="vlStartGame()" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                    </div>
                    <div class="flex gap-4 text-xs text-slate-400">
                        <span>Round: <span id="vl_roundDisplay" class="font-mono">0</span>/<span id="vl_totalRounds" class="font-mono">12</span></span>
                        <span class="text-green-400">1st Try: <span id="vl_firstTry" class="font-mono">0%</span></span>
                        <span class="text-red-400">Mistakes: <span id="vl_mistakes" class="font-mono">0</span></span>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="vl_historyContent" class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6"></div>
        </div>

        <!-- Voice Leading Info Modal -->
        <div id="voiceleadInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Voice Leading Trainer</h3>
                    <button onclick="document.getElementById('voiceleadInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">What is voice leading?</div>
                        <p>Voice leading is the art of moving smoothly from one chord to the next. Instead of jumping around the keyboard, you <strong>keep common tones</strong> and <strong>move other notes by step</strong>.</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">The 7 → 3 Resolution</div>
                        <p>In jazz, there's a magic pattern: the <strong>7th of one chord becomes the 3rd of the next</strong> (or moves by half step to it). This is why ii-V-I progressions sound so smooth!</p>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">How to think about it</div>
                        <ol class="list-decimal list-inside text-slate-400 mt-1 space-y-1">
                            <li>Look at the source chord's notes</li>
                            <li>Which notes are also in the target chord? (Keep those!)</li>
                            <li>Which notes need to move? (Move by half/whole step)</li>
                            <li>Play the result - minimal hand movement!</li>
                        </ol>
                    </div>
                    <div>
                        <div class="text-blue-400 font-semibold mb-1">Example: Dm7 → G7</div>
                        <p class="text-slate-400">Dm7 guide tones: <span class="text-green-400">F</span> (b7) and C (b3)</p>
                        <p class="text-slate-400">G7 guide tones: <span class="text-green-400">F</span> (b7) and B (3)</p>
                        <p class="text-slate-400 mt-1">→ <span class="text-green-400">F stays!</span> C moves down ½ step to B.</p>
                    </div>
                    <div class="pt-2 border-t border-slate-700">
                        <p class="text-xs text-slate-500">This skill is foundational - once you see these patterns, you can voice-lead through any tune!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-slate-500 text-sm mt-8 pt-4 pb-16 border-t border-slate-700">
            <span class="font-semibold text-slate-400">The Shed</span> · Feedback? DM <a href="https://twitter.com/dksf" target="_blank" class="text-amber-400 hover:text-amber-300">@dksf</a> on Twitter/X
        </footer>

    </div>

    <script>
        // ============ CONFIGURATION ============
        const NOTE_NAMES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const INTERVAL_NAMES = {
            1: 'Half step', 2: 'Whole step', 3: 'Minor 3rd', 4: 'Major 3rd',
            5: 'Perfect 4th', 6: 'Tritone', 7: 'Perfect 5th', 8: 'Minor 6th',
            9: 'Major 6th', 10: 'Minor 7th', 11: 'Major 7th', 12: 'Octave'
        };
        const CHORD_TYPES = {
            'maj7': { name: 'maj7', display: 'maj7', intervals: [0, 4, 7, 11] }, // R, M3, P5, M7
            'min7': { name: 'min7', display: 'min7', intervals: [0, 3, 7, 10] }, // R, m3, P5, m7
            'dom7': { name: 'dom7', display: '7', intervals: [0, 4, 7, 10] }     // R, M3, P5, m7
        };

        // ============ CHART VOICINGS ============
        // Rootless Type A (3-5-7-9), Type B (7-9-3-5), and Shell (3-7) for all chord types
        const CHART_VOICINGS = {
            'maj7': {
                typeA: [4, 7, 11, 14],   // 3-5-7-9 (9 = 14 semitones = 2 octave)
                typeB: [11, 14, 16, 19], // 7-9-3-5 (higher octave for 3 and 5)
                shell: [4, 11],          // 3-7
                third: 4, seventh: 11
            },
            'm7': {
                typeA: [3, 7, 10, 14],   // b3-5-b7-9
                typeB: [10, 14, 15, 19], // b7-9-b3-5
                shell: [3, 10],          // b3-b7
                third: 3, seventh: 10
            },
            'dom7': {
                typeA: [4, 9, 10, 14],   // 3-13-b7-9 (uses 13 instead of 5)
                typeB: [10, 14, 16, 21], // b7-9-3-13
                shell: [4, 10],          // 3-b7
                third: 4, seventh: 10
            },
            'm7b5': {
                typeA: [3, 6, 10, 14],   // b3-b5-b7-9
                typeB: [10, 14, 15, 18], // b7-9-b3-b5
                shell: [3, 10],          // b3-b7
                third: 3, seventh: 10
            },
            '7b9': {
                typeA: [4, 9, 10, 13],   // 3-13-b7-b9
                typeB: [10, 13, 16, 21], // b7-b9-3-13
                shell: [4, 10],          // 3-b7
                third: 4, seventh: 10
            },
            '7#5': {
                typeA: [4, 8, 10, 14],   // 3-#5-b7-9
                typeB: [10, 14, 16, 20], // b7-9-3-#5
                shell: [4, 10],          // 3-b7
                third: 4, seventh: 10
            },
            'o7': {
                typeA: [3, 6, 9, 12],    // b3-b5-bb7-R (symmetric)
                typeB: [9, 12, 15, 18],  // bb7-R-b3-b5
                shell: [3, 9],           // b3-bb7
                third: 3, seventh: 9
            }
        };

        // "All The Things You Are" chord progression
        const ATTYA_CHART = {
            title: "All The Things You Are",
            composer: "Jerome Kern",
            key: "Ab",
            form: "AABA'",
            sections: [
                {
                    name: "A",
                    bars: [
                        { chord: "Fm7" },
                        { chord: "Bbm7" },
                        { chord: "Eb7" },
                        { chord: "Abmaj7" },
                        { chord: "Dbmaj7" },
                        { chords: ["Dm7b5", "G7b9"] },
                        { chord: "Cmaj7" },
                        { chord: "Cmaj7" }
                    ]
                },
                {
                    name: "A",
                    bars: [
                        { chord: "Cm7" },
                        { chord: "Fm7" },
                        { chord: "Bb7" },
                        { chord: "Ebmaj7" },
                        { chord: "Abmaj7" },
                        { chords: ["Am7b5", "D7b9"] },
                        { chord: "Gmaj7" },
                        { chord: "Gmaj7" }
                    ]
                },
                {
                    name: "B",
                    bars: [
                        { chord: "Am7" },
                        { chord: "D7" },
                        { chord: "Gmaj7" },
                        { chord: "Gmaj7" },
                        { chord: "F#m7b5" },
                        { chord: "B7b9" },
                        { chord: "Emaj7" },
                        { chord: "C7#5" }
                    ]
                },
                {
                    name: "A'",
                    bars: [
                        { chord: "Fm7" },
                        { chord: "Bbm7" },
                        { chord: "Eb7" },
                        { chord: "Abmaj7" },
                        { chord: "Dbmaj7" },
                        { chord: "Dbm7" },
                        { chord: "Cm7" },
                        { chord: "Bdim7" }
                    ]
                }
            ]
        };

        // Parse chord symbol to root and type
        function parseChordSymbol(symbol) {
            // Handle chord symbol parsing
            const noteMatch = symbol.match(/^([A-G][b#]?)/);
            if (!noteMatch) return null;

            const noteName = noteMatch[1];
            const root = NOTE_NAMES.indexOf(noteName.replace('#', 's').replace('b', 'b'));
            // Handle sharps (F# = Gb = 6, etc.)
            let rootPc = -1;
            for (let i = 0; i < NOTE_NAMES.length; i++) {
                if (NOTE_NAMES[i] === noteName ||
                    (noteName.includes('#') && NOTE_NAMES[(i+1)%12] === noteName.replace('#', 'b'))) {
                    rootPc = i;
                    break;
                }
            }
            // Manual mapping for sharps
            const sharpToFlat = { 'C#': 1, 'D#': 3, 'F#': 6, 'G#': 8, 'A#': 10 };
            if (sharpToFlat[noteName] !== undefined) rootPc = sharpToFlat[noteName];
            if (rootPc === -1) rootPc = NOTE_NAMES.indexOf(noteName);

            const rest = symbol.slice(noteMatch[0].length);

            // Determine chord type
            let type = 'maj7';
            if (rest.includes('dim7') || rest === 'o7') type = 'o7';
            else if (rest.includes('m7b5') || rest.includes('ø7')) type = 'm7b5';
            else if (rest.includes('7b9')) type = '7b9';
            else if (rest.includes('7#5')) type = '7#5';
            else if (rest.includes('m7') || rest === 'm7') type = 'm7';
            else if (rest.includes('maj7')) type = 'maj7';
            else if (rest === '7' || rest.match(/^7$/)) type = 'dom7';

            return { root: rootPc, type };
        }

        // Get pitch classes for a voicing
        function getVoicingPitchClasses(root, type, voicingType) {
            const voicing = CHART_VOICINGS[type];
            if (!voicing) return [];

            let intervals;
            if (voicingType === 'shell') {
                intervals = voicing.shell;
            } else if (voicingType === 'A') {
                intervals = voicing.typeA;
            } else {
                intervals = voicing.typeB;
            }

            return intervals.map(i => (root + i) % 12);
        }

        // Get note names for a voicing (from MIDI notes array)
        function getVoicingNoteNames(root, type, voicingType) {
            const pcs = getVoicingPitchClasses(root, type, voicingType);
            return pcs.map(pc => NOTE_NAMES[pc]).join(' ');
        }

        // Get note names from MIDI notes array
        function getMidiNoteNames(midiNotes) {
            return midiNotes.map(n => NOTE_NAMES[n % 12]).join(' ');
        }

        // Generate actual MIDI notes for a voicing at a given base octave
        // baseNote is the lowest note of the voicing (typically 48-60 range for LH comping)
        function getVoicingMidiNotes(root, type, voicingType, baseNote) {
            const voicing = CHART_VOICINGS[type];
            if (!voicing) return [];

            let intervals;
            if (voicingType === 'shell') {
                intervals = voicing.shell;
            } else if (voicingType === 'A') {
                intervals = voicing.typeA;
            } else {
                intervals = voicing.typeB;
            }

            // Find the base MIDI note for this root in the target octave
            const rootInOctave = baseNote - (baseNote % 12) + root;
            // Adjust if root would be below baseNote
            const adjustedRoot = rootInOctave < baseNote ? rootInOctave + 12 : rootInOctave;

            // Build the voicing from the root
            return intervals.map(interval => adjustedRoot + interval);
        }

        // Calculate hand movement cost between two voicings (lower = smoother)
        // Uses sum of absolute differences, with bonus for common tones
        function voicingMovementCost(voicing1, voicing2) {
            if (!voicing1 || !voicing2 || voicing1.length === 0 || voicing2.length === 0) {
                return 0;
            }

            // Sort both voicings to compare corresponding fingers
            const sorted1 = [...voicing1].sort((a, b) => a - b);
            const sorted2 = [...voicing2].sort((a, b) => a - b);

            // If different sizes, pad the shorter one
            const maxLen = Math.max(sorted1.length, sorted2.length);
            while (sorted1.length < maxLen) sorted1.push(sorted1[sorted1.length - 1]);
            while (sorted2.length < maxLen) sorted2.push(sorted2[sorted2.length - 1]);

            // Sum of absolute movements
            let totalMovement = 0;
            for (let i = 0; i < maxLen; i++) {
                totalMovement += Math.abs(sorted1[i] - sorted2[i]);
            }

            return totalMovement;
        }

        // Generate candidate voicings for a chord (Type A and B at different registers)
        function generateCandidateVoicings(chord) {
            const candidates = [];
            const { root, type } = chord;

            // Generate voicings at different base positions
            // Typical comping range: C3 (48) to C5 (72)
            const basePositions = [48, 54, 60]; // Different starting registers

            for (const baseNote of basePositions) {
                // Type A voicing
                const typeANotes = getVoicingMidiNotes(root, type, 'A', baseNote);
                // Only include if within reasonable range (not too high or low)
                const avgA = typeANotes.reduce((a, b) => a + b, 0) / typeANotes.length;
                if (avgA >= 52 && avgA <= 76) {
                    candidates.push({
                        type: 'A',
                        midiNotes: typeANotes,
                        pitchClasses: typeANotes.map(n => n % 12),
                        baseNote: baseNote
                    });
                }

                // Type B voicing
                const typeBNotes = getVoicingMidiNotes(root, type, 'B', baseNote);
                const avgB = typeBNotes.reduce((a, b) => a + b, 0) / typeBNotes.length;
                if (avgB >= 52 && avgB <= 76) {
                    candidates.push({
                        type: 'B',
                        midiNotes: typeBNotes,
                        pitchClasses: typeBNotes.map(n => n % 12),
                        baseNote: baseNote
                    });
                }
            }

            // Remove duplicates (same pitch classes in same octave)
            const unique = [];
            const seen = new Set();
            for (const c of candidates) {
                const key = c.midiNotes.sort((a,b) => a-b).join(',');
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(c);
                }
            }

            return unique.length > 0 ? unique : candidates.slice(0, 2); // Fallback
        }

        // Compute optimal voicings using dynamic programming with lookahead
        // This finds the smoothest path through all chords
        function computeOptimalVoicings(chords) {
            if (chords.length === 0) return [];

            // Generate all candidate voicings for each chord
            const allCandidates = chords.map(chord => generateCandidateVoicings(chord));

            // DP: for each chord position, track best cost to reach each candidate
            // dp[i][j] = { cost: number, prev: index } - minimum cost to reach chord i, candidate j
            const dp = [];
            const LOOKAHEAD = 3; // Look this many chords ahead

            // Initialize first chord - all candidates have cost 0
            dp[0] = allCandidates[0].map(() => ({ cost: 0, prev: -1 }));

            // Fill DP table
            for (let i = 1; i < chords.length; i++) {
                dp[i] = [];
                const prevCandidates = allCandidates[i - 1];
                const currCandidates = allCandidates[i];

                for (let j = 0; j < currCandidates.length; j++) {
                    let bestCost = Infinity;
                    let bestPrev = 0;

                    for (let k = 0; k < prevCandidates.length; k++) {
                        // Base cost: movement from previous to current
                        let cost = dp[i - 1][k].cost +
                            voicingMovementCost(prevCandidates[k].midiNotes, currCandidates[j].midiNotes);

                        // Lookahead bonus: consider future chords
                        if (i + 1 < chords.length) {
                            const futureCandidates = allCandidates[i + 1];
                            // Find minimum future cost from this candidate
                            let minFutureCost = Infinity;
                            for (const fc of futureCandidates) {
                                const futureCost = voicingMovementCost(currCandidates[j].midiNotes, fc.midiNotes);
                                minFutureCost = Math.min(minFutureCost, futureCost);
                            }
                            cost += minFutureCost * 0.5; // Weight future cost less
                        }

                        // Second level lookahead
                        if (i + 2 < chords.length) {
                            const future2Candidates = allCandidates[i + 2];
                            let minFuture2Cost = Infinity;
                            for (const fc of future2Candidates) {
                                const future2Cost = voicingMovementCost(currCandidates[j].midiNotes, fc.midiNotes);
                                minFuture2Cost = Math.min(minFuture2Cost, future2Cost);
                            }
                            cost += minFuture2Cost * 0.25; // Weight even less
                        }

                        if (cost < bestCost) {
                            bestCost = cost;
                            bestPrev = k;
                        }
                    }

                    dp[i][j] = { cost: bestCost, prev: bestPrev };
                }
            }

            // Backtrack to find optimal path
            const result = [];
            let currIdx = 0;
            let minFinalCost = Infinity;

            // Find best ending candidate
            for (let j = 0; j < dp[chords.length - 1].length; j++) {
                if (dp[chords.length - 1][j].cost < minFinalCost) {
                    minFinalCost = dp[chords.length - 1][j].cost;
                    currIdx = j;
                }
            }

            // Backtrack
            const path = [];
            for (let i = chords.length - 1; i >= 0; i--) {
                path.unshift({ chordIdx: i, candidateIdx: currIdx });
                if (i > 0) {
                    currIdx = dp[i][currIdx].prev;
                }
            }

            // Build result
            for (const p of path) {
                const chord = chords[p.chordIdx];
                const candidate = allCandidates[p.chordIdx][p.candidateIdx];
                result.push({
                    chord: chord,
                    voicingType: candidate.type,
                    pitchClasses: candidate.pitchClasses,
                    midiNotes: candidate.midiNotes // Include actual MIDI notes for display
                });
            }

            return result;
        }

        // Flatten chart to array of chord objects
        function flattenChart(chart) {
            const chords = [];
            let barNumber = 1;

            for (const section of chart.sections) {
                for (const bar of section.bars) {
                    if (bar.chords) {
                        // Multiple chords in one bar
                        for (const chordSymbol of bar.chords) {
                            const parsed = parseChordSymbol(chordSymbol);
                            if (parsed) {
                                chords.push({
                                    symbol: chordSymbol,
                                    root: parsed.root,
                                    type: parsed.type,
                                    section: section.name,
                                    bar: barNumber
                                });
                            }
                        }
                    } else {
                        const parsed = parseChordSymbol(bar.chord);
                        if (parsed) {
                            chords.push({
                                symbol: bar.chord,
                                root: parsed.root,
                                type: parsed.type,
                                section: section.name,
                                bar: barNumber
                            });
                        }
                    }
                    barNumber++;
                }
            }

            return chords;
        }

        // ============ MEDAL HELPER ============
        // Returns medal emoji for personal bests: 🥇 gold, 🥈 silver, 🥉 bronze
        function getMedals(history, accuracyField = 'firstTryPct', timeField = 'avgTime') {
            if (history.length === 0) return {};

            // Create array with original indices and sort by accuracy (desc) then time (asc)
            const ranked = history.map((game, idx) => ({
                idx,
                accuracy: game[accuracyField] || game.accuracy || 0,
                time: typeof game[timeField] === 'number' ? game[timeField] : parseFloat(game[timeField]) || Infinity
            })).sort((a, b) => {
                if (b.accuracy !== a.accuracy) return b.accuracy - a.accuracy; // Higher accuracy first
                return a.time - b.time; // Lower time first (tiebreaker)
            });

            const medals = {};
            const MEDAL_ICONS = ['🥇', '🥈', '🥉'];

            // Assign medals to top 3 unique scores
            let medalIdx = 0;
            let lastAccuracy = null;
            let lastTime = null;

            for (const entry of ranked) {
                if (medalIdx >= 3) break;

                // Check if this is a new rank (different score) or same rank (tie)
                if (lastAccuracy === null || entry.accuracy !== lastAccuracy || entry.time !== lastTime) {
                    medals[entry.idx] = MEDAL_ICONS[medalIdx];
                    medalIdx++;
                    lastAccuracy = entry.accuracy;
                    lastTime = entry.time;
                } else {
                    // Tie - same medal
                    medals[entry.idx] = MEDAL_ICONS[medalIdx - 1];
                }
            }

            return medals;
        }

        // ============ CHORD IDENTIFIER ============
        // Templates for chord detection, ordered by priority (more common first)
        const CHORD_TEMPLATES = [
            // Triads
            { intervals: [0, 4, 7], name: '', priority: 10 },           // major
            { intervals: [0, 3, 7], name: 'm', priority: 10 },          // minor
            { intervals: [0, 3, 6], name: 'dim', priority: 8 },         // diminished
            { intervals: [0, 4, 8], name: 'aug', priority: 7 },         // augmented
            { intervals: [0, 5, 7], name: 'sus4', priority: 6 },        // sus4
            { intervals: [0, 2, 7], name: 'sus2', priority: 6 },        // sus2

            // 7th chords
            { intervals: [0, 4, 7, 10], name: '7', priority: 15 },      // dominant 7
            { intervals: [0, 3, 7, 10], name: 'm7', priority: 14 },     // minor 7
            { intervals: [0, 4, 7, 11], name: 'maj7', priority: 13 },   // major 7
            { intervals: [0, 3, 6, 10], name: 'm7b5', priority: 11 },   // half-diminished
            { intervals: [0, 3, 6, 9], name: 'dim7', priority: 10 },    // diminished 7
            { intervals: [0, 3, 7, 11], name: 'mMaj7', priority: 9 },   // minor-major 7
            { intervals: [0, 4, 8, 10], name: '7#5', priority: 8 },     // augmented 7

            // 6th chords
            { intervals: [0, 4, 7, 9], name: '6', priority: 9 },        // major 6
            { intervals: [0, 3, 7, 9], name: 'm6', priority: 9 },       // minor 6

            // 9th chords
            { intervals: [0, 4, 7, 10, 14], name: '9', priority: 12 },      // dominant 9
            { intervals: [0, 3, 7, 10, 14], name: 'm9', priority: 11 },     // minor 9
            { intervals: [0, 4, 7, 11, 14], name: 'maj9', priority: 10 },   // major 9

            // Add9 (no 7th)
            { intervals: [0, 4, 7, 14], name: 'add9', priority: 8 },
            { intervals: [0, 3, 7, 14], name: 'madd9', priority: 8 },

            // 11th chords
            { intervals: [0, 4, 7, 10, 14, 17], name: '11', priority: 8 },
            { intervals: [0, 3, 7, 10, 14, 17], name: 'm11', priority: 8 },

            // 13th chords
            { intervals: [0, 4, 7, 10, 14, 21], name: '13', priority: 8 },
            { intervals: [0, 4, 7, 10, 21], name: '13', priority: 7 },      // no 9 or 11

            // Altered dominants
            { intervals: [0, 4, 10, 13], name: '7b9', priority: 9 },        // no 5
            { intervals: [0, 4, 7, 10, 13], name: '7b9', priority: 10 },
            { intervals: [0, 4, 10, 15], name: '7#9', priority: 9 },        // no 5
            { intervals: [0, 4, 7, 10, 15], name: '7#9', priority: 10 },
            { intervals: [0, 4, 6, 10], name: '7#11', priority: 8 },        // no 5
            { intervals: [0, 4, 10, 20], name: '7b13', priority: 8 },       // no 5
        ];

        // Shell voicing patterns (just 3rd and 7th, no root)
        const SHELL_PATTERNS = [
            { intervals: [4, 10], name: '7', priority: 12 },      // maj3 + min7 = dom7
            { intervals: [3, 10], name: 'm7', priority: 11 },     // min3 + min7 = min7
            { intervals: [4, 11], name: 'maj7', priority: 10 },   // maj3 + maj7 = maj7
            { intervals: [3, 9], name: 'dim7', priority: 9 },     // min3 + dim7 = dim7
            { intervals: [3, 11], name: 'mMaj7', priority: 8 },   // min3 + maj7 = minMaj7
        ];

        let chordIdentifierEnabled = true;

        function toggleChordIdentifier() {
            chordIdentifierEnabled = !chordIdentifierEnabled;
            const container = document.getElementById('chordIdentifier');
            const showBtn = document.getElementById('chordIdentifierShowBtn');
            if (chordIdentifierEnabled) {
                container.classList.remove('hidden');
                showBtn.classList.add('hidden');
                updateChordIdentifier();
            } else {
                container.classList.add('hidden');
                showBtn.classList.remove('hidden');
            }
            // Save preference
            localStorage.setItem('chordIdentifierEnabled', chordIdentifierEnabled);
        }

        function identifyChords(pitchClasses) {
            if (pitchClasses.size < 2) return [];

            const pcs = [...pitchClasses].sort((a, b) => a - b);
            const results = [];

            // Try each of 12 possible roots
            for (let root = 0; root < 12; root++) {
                // Normalize pitch classes relative to this root
                const normalized = pcs.map(pc => (pc - root + 12) % 12).sort((a, b) => a - b);

                // Check full chord templates
                for (const template of CHORD_TEMPLATES) {
                    const templatePcs = template.intervals.map(i => i % 12);
                    const templateSet = new Set(templatePcs);
                    const normalizedSet = new Set(normalized);

                    // Check if all held notes are in the template
                    const allNotesInTemplate = normalized.every(n => templateSet.has(n));
                    // Check if all template notes are held (exact match)
                    const exactMatch = templatePcs.every(n => normalizedSet.has(n)) && normalized.length === templatePcs.length;
                    // Check if held notes are subset of template (partial chord)
                    const isSubset = allNotesInTemplate && normalized.length < templatePcs.length;

                    if (exactMatch) {
                        results.push({
                            name: NOTE_NAMES[root] + template.name,
                            priority: template.priority + 10, // Boost exact matches
                            root,
                            type: 'exact'
                        });
                    } else if (isSubset && normalized.length >= 3) {
                        // Only show partial matches for 3+ notes
                        results.push({
                            name: NOTE_NAMES[root] + template.name,
                            priority: template.priority,
                            root,
                            type: 'partial'
                        });
                    }
                }

                // Check for rootless voicings (shell patterns)
                if (pcs.length === 2) {
                    for (const shell of SHELL_PATTERNS) {
                        const shellSet = new Set(shell.intervals);
                        if (normalized.length === 2 && normalized.every(n => shellSet.has(n))) {
                            results.push({
                                name: NOTE_NAMES[root] + shell.name,
                                priority: shell.priority,
                                root,
                                type: 'shell'
                            });
                        }
                    }
                }
            }

            // Sort by priority (descending), then alphabetically by root
            results.sort((a, b) => {
                if (b.priority !== a.priority) return b.priority - a.priority;
                return a.root - b.root;
            });

            // Remove duplicates (same chord name)
            const seen = new Set();
            const unique = results.filter(r => {
                if (seen.has(r.name)) return false;
                seen.add(r.name);
                return true;
            });

            return unique.slice(0, 3); // Top 3
        }

        function updateChordIdentifier() {
            if (!chordIdentifierEnabled) return;

            const display = document.getElementById('chordIdentifierDisplay');
            const pitchClasses = new Set([...heldNotes].map(n => n % 12));

            if (pitchClasses.size === 0) {
                display.textContent = '—';
                return;
            }

            if (pitchClasses.size === 1) {
                // Single note - just show the note name
                const pc = [...pitchClasses][0];
                display.textContent = NOTE_NAMES[pc];
                return;
            }

            const chords = identifyChords(pitchClasses);

            if (chords.length === 0) {
                // No chord match - show the notes
                const noteNames = [...pitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                display.textContent = noteNames;
            } else {
                display.textContent = chords.map(c => c.name).join(' • ');
            }
        }

        // ============ GLOBAL STATE ============
        let midiAccess = null;
        let selectedInput = null;
        let currentMode = 'intervals'; // 'intervals' or 'chords'
        let heldNotes = new Set(); // Currently held MIDI notes

        // ============ CATEGORY SWITCHING ============
        let currentCategory = 'training';

        function goHome() {
            switchCategory('training');
            switchMode('intervals');
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchCategory(category) {
            currentCategory = category;

            // Update category tabs
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('category' + category.charAt(0).toUpperCase() + category.slice(1)).classList.add('active');

            // Show/hide mode button containers
            document.getElementById('trainingModes').classList.toggle('hidden', category !== 'training');
            document.getElementById('chartsModes').classList.toggle('hidden', category !== 'charts');

            // Switch to first mode in the new category
            if (category === 'training') {
                switchMode('intervals');
            } else if (category === 'charts') {
                switchMode('attya');
            }
        }

        // ============ MODE SWITCHING ============
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const modeButtons = { intervals: 'intervalsMode', chords: 'chordsMode', iivi: 'iiviMode', scales: 'scalesMode', ext: 'extMode', alt: 'altMode', adv: 'advMode', minorIivi: 'minorIiviMode', kb: 'kbMode', jtou: 'jtouMode', dom7v: 'dom7vMode', extv: 'extvMode', pent: 'pentMode', bebop: 'bebopMode', tritone: 'tritoneMode', shell: 'shellMode', upper: 'upperMode', freestyle: 'freestyleMode', attya: 'attyaMode', voicelead: 'voiceleadMode' };
            const modePanels = { intervals: 'intervalsPanel', chords: 'chordsPanel', iivi: 'iiviPanel', scales: 'scalesPanel', ext: 'extPanel', alt: 'altPanel', adv: 'advPanel', minorIivi: 'minorIiviPanel', kb: 'kbPanel', jtou: 'jtouPanel', dom7v: 'dom7vPanel', extv: 'extvPanel', pent: 'pentPanel', bebop: 'bebopPanel', tritone: 'tritonePanel', shell: 'shellPanel', upper: 'upperPanel', freestyle: 'freestylePanel', attya: 'attyaPanel', voicelead: 'voiceleadPanel' };
            document.getElementById(modeButtons[mode]).classList.add('active');
            document.querySelectorAll('.mode-panel').forEach(panel => panel.classList.add('hidden'));
            document.getElementById(modePanels[mode]).classList.remove('hidden');
        }

        // ============ MIDI SETUP ============
        async function initMIDI() {
            try {
                if (!navigator.requestMIDIAccess) {
                    updateStatus('error', "Web MIDI not supported");
                    // Make status clickable to show help modal
                    const statusArea = document.getElementById('connectionStatusArea');
                    statusArea.classList.add('cursor-pointer', 'hover:opacity-80');
                    statusArea.onclick = () => document.getElementById('webMidiHelpModal').classList.remove('hidden');
                    statusArea.title = 'Click for browser recommendations';
                    return;
                }
                midiAccess = await navigator.requestMIDIAccess();
                updateStatus('waiting', "Select a MIDI device");
                populateDevices();
                midiAccess.onstatechange = populateDevices;
            } catch (err) {
                updateStatus('error', "MIDI Error: " + err.message);
            }
        }

        function populateDevices() {
            const inputSelect = document.getElementById('midiInputSelect');
            const outputSelect = document.getElementById('midiOutputSelect');
            const savedInput = localStorage.getItem('midiInput');
            const savedOutput = localStorage.getItem('midiOutput');

            inputSelect.innerHTML = '<option value="">Select Input Device</option>';
            outputSelect.innerHTML = '<option value="">Select Output Device</option>';

            for (let input of midiAccess.inputs.values()) {
                const opt = document.createElement('option');
                opt.value = input.id;
                opt.text = input.name;
                inputSelect.appendChild(opt);
            }

            for (let output of midiAccess.outputs.values()) {
                const opt = document.createElement('option');
                opt.value = output.id;
                opt.text = output.name;
                outputSelect.appendChild(opt);
            }

            if (savedInput && midiAccess.inputs.get(savedInput)) {
                inputSelect.value = savedInput;
                connectInput(savedInput);
            }
            if (savedOutput && midiAccess.outputs.get(savedOutput)) {
                outputSelect.value = savedOutput;
            }
        }

        function connectInput(id) {
            if (selectedInput) selectedInput.onmidimessage = null;
            if (id) {
                selectedInput = midiAccess.inputs.get(id);
                selectedInput.onmidimessage = handleMIDI;
                updateStatus('connected', 'Connected');
                localStorage.setItem('midiInput', id);

                // Show game content and enable MIDI collapse
                onMidiConnected(selectedInput.name);
            } else {
                selectedInput = null;
                updateStatus('waiting', "Select a MIDI device");
                onMidiDisconnected();
            }
        }

        let midiSettingsCollapsed = false;

        function onMidiConnected(deviceName) {
            // Show practice section and game panel
            document.getElementById('practiceSection').classList.remove('hidden');
            document.getElementById('intervalsPanel').classList.remove('hidden');

            // Update header with device name
            document.getElementById('midiDeviceName').innerText = deviceName;

            // Hide the preview piano
            document.getElementById('previewPiano').classList.add('hidden');

            // Auto-collapse MIDI settings
            collapseMidiSettings();
        }

        function onMidiDisconnected() {
            // Re-show MIDI settings section
            document.getElementById('midiCollapseBtn').classList.add('hidden');
            document.getElementById('midiSettingsBtn').classList.add('hidden');
            document.getElementById('midiSection').classList.remove('hidden');
            midiSettingsCollapsed = false;
        }

        function collapseMidiSettings() {
            midiSettingsCollapsed = true;
            document.getElementById('midiSection').classList.add('hidden');
            document.getElementById('midiSettingsBtn').classList.remove('hidden');
            document.getElementById('midiCollapseBtn').classList.add('hidden');
        }

        function toggleMidiSettings() {
            if (midiSettingsCollapsed) {
                midiSettingsCollapsed = false;
                document.getElementById('midiSection').classList.remove('hidden');
                document.getElementById('midiSettingsBtn').classList.add('hidden');
                document.getElementById('midiCollapseBtn').classList.remove('hidden');
            } else {
                collapseMidiSettings();
            }
        }

        document.getElementById('midiInputSelect').addEventListener('change', (e) => connectInput(e.target.value));
        document.getElementById('midiOutputSelect').addEventListener('change', (e) => {
            if (e.target.value) localStorage.setItem('midiOutput', e.target.value);
        });
        document.getElementById('iivi_voicingSelect').addEventListener('change', (e) => {
            const hint = document.getElementById('iivi_settingsHint');
            if (e.target.value === 'shell') {
                hint.innerText = 'Play only the 3rd and 7th of each chord (shell voicings). Notice how one note stays the same!';
            } else if (e.target.value === 'rootless') {
                hint.innerText = 'Play 3-5-7-9 without the root. V chord uses 13th instead of 5th. Left hand voicing style.';
            } else if (e.target.value === 'rootlessABA') {
                hint.innerText = 'Alternate Type A → B → A for smooth voice leading. ii(A) → V(B) → I(A). Minimal hand movement!';
            } else if (e.target.value === 'rootlessBAB') {
                hint.innerText = 'Alternate Type B → A → B for smooth voice leading. ii(B) → V(A) → I(B). Minimal hand movement!';
            } else {
                hint.innerText = 'Play ii → V → I in sequence. Each chord needs all 4 notes (any voicing).';
            }
        });

        function updateStatus(state, msg) {
            // state: 'connected' (green), 'waiting' (amber), 'error' (red)
            const colors = {
                connected: 'bg-green-500 shadow-[0_0_10px_rgba(74,222,128,0.5)]',
                waiting: 'bg-amber-500',
                error: 'bg-red-500'
            };
            document.getElementById('connectionStatus').className =
                `w-3 h-3 rounded-full ${colors[state] || colors.error}`;
            document.getElementById('connectionText').innerText = msg;
        }

        function handleMIDI(msg) {
            const [cmd, note, vel] = msg.data;
            if ((cmd & 0xF0) === 144 && vel > 0) {
                heldNotes.add(note);
                updateChordIdentifier();
                // Highlight preview piano (for testing before game starts)
                highlightKey('previewPianoSvg', note, 'key-active');
                if (currentMode === 'intervals') intOnNoteOn(note);
                else if (currentMode === 'chords') chOnNoteOn(note);
                else if (currentMode === 'iivi') iiviOnNoteOn(note);
                else if (currentMode === 'scales') scOnNoteOn(note);
                else if (currentMode === 'ext') extOnNoteOn(note);
                else if (currentMode === 'alt') altOnNoteOn(note);
                else if (currentMode === 'adv') advOnNoteOn(note);
                else if (currentMode === 'minorIivi') miiviOnNoteOn(note);
                else if (currentMode === 'kb') kbHandleNoteOn(note);
                else if (currentMode === 'jtou') jtouOnNoteOn(note);
                else if (currentMode === 'dom7v') dom7vOnNoteOn(note);
                else if (currentMode === 'extv') extvOnNoteOn(note);
                else if (currentMode === 'pent') pentOnNoteOn(note);
                else if (currentMode === 'bebop') bebopOnNoteOn(note);
                else if (currentMode === 'tritone') tritoneOnNoteOn(note);
                else if (currentMode === 'shell') shellOnNoteOn(note);
                else if (currentMode === 'upper') upperOnNoteOn(note);
                else if (currentMode === 'freestyle') freestyleOnNoteOn(note);
                else if (currentMode === 'attya') attyaOnNoteOn(note);
                else if (currentMode === 'voicelead') vlOnNoteOn(note);
            } else if ((cmd & 0xF0) === 128 || ((cmd & 0xF0) === 144 && vel === 0)) {
                heldNotes.delete(note);
                updateChordIdentifier();
                // Clear preview piano highlight
                highlightKey('previewPianoSvg', note, 'key-active', false);
                if (currentMode === 'intervals') intOnNoteOff(note);
                else if (currentMode === 'chords') chOnNoteOff(note);
                else if (currentMode === 'iivi') iiviOnNoteOff(note);
                else if (currentMode === 'scales') scOnNoteOff(note);
                else if (currentMode === 'ext') extOnNoteOff(note);
                else if (currentMode === 'alt') altOnNoteOff(note);
                else if (currentMode === 'adv') advOnNoteOff(note);
                else if (currentMode === 'minorIivi') miiviOnNoteOff(note);
                else if (currentMode === 'kb') kbHandleNoteOff(note);
                else if (currentMode === 'jtou') jtouOnNoteOff(note);
                else if (currentMode === 'dom7v') dom7vOnNoteOff(note);
                else if (currentMode === 'extv') extvOnNoteOff(note);
                else if (currentMode === 'pent') pentOnNoteOff(note);
                else if (currentMode === 'bebop') bebopOnNoteOff(note);
                else if (currentMode === 'tritone') tritoneOnNoteOff(note);
                else if (currentMode === 'shell') shellOnNoteOff(note);
                else if (currentMode === 'upper') upperOnNoteOff(note);
                else if (currentMode === 'freestyle') freestyleOnNoteOff(note);
                else if (currentMode === 'attya') attyaOnNoteOff(note);
                else if (currentMode === 'voicelead') vlOnNoteOff(note);
            }
        }

        // ============ PIANO VISUALIZATION ============
        function drawPiano(svgId) {
            const svg = document.getElementById(svgId);
            svg.innerHTML = '';
            const startNote = 21, endNote = 108; // Full 88 keys: A0 to C8
            const whiteW = 24, blackW = 14, height = 120;
            let x = 0;

            // Count white keys to calculate total width
            let whiteKeyCount = 0;
            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) whiteKeyCount++;
            }
            const totalWidth = whiteKeyCount * whiteW;
            svg.setAttribute("viewBox", `0 0 ${totalWidth} ${height}`);

            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x);
                    rect.setAttribute("y", 0);
                    rect.setAttribute("width", whiteW);
                    rect.setAttribute("height", height);
                    rect.setAttribute("class", "key key-white");
                    rect.setAttribute("data-note", i);
                    rect.setAttribute("data-piano", svgId);
                    svg.appendChild(rect);
                    x += whiteW;
                }
            }

            x = 0;
            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) {
                    x += whiteW;
                } else {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x - blackW / 2);
                    rect.setAttribute("y", 0);
                    rect.setAttribute("width", blackW);
                    rect.setAttribute("height", height * 0.6);
                    rect.setAttribute("class", "key key-black");
                    rect.setAttribute("data-note", i);
                    rect.setAttribute("data-piano", svgId);
                    svg.appendChild(rect);
                }
            }
        }

        function highlightKey(svgId, midi, className, add = true) {
            const key = document.querySelector(`#${svgId} [data-note="${midi}"]`);
            if (key) {
                if (add) key.classList.add(className);
                else key.classList.remove(className);
            }
        }

        function clearAllHighlights(svgId) {
            document.querySelectorAll(`#${svgId} .key`).forEach(k => {
                k.classList.remove('key-active', 'key-wrong', 'key-start', 'key-held', 'correct', 'incorrect', 'wrong', 'key-correct', 'key-error');
            });
        }

        function clearPiano(svgId) {
            clearAllHighlights(svgId);
        }

        function clearKeyHighlight(svgId, midi) {
            const key = document.querySelector(`#${svgId} [data-note="${midi}"]`);
            if (key) {
                key.classList.remove('key-active', 'key-wrong', 'key-held', 'correct', 'incorrect', 'wrong', 'key-correct', 'key-error');
            }
        }

        function clearPianoHighlights(svgId) {
            clearAllHighlights(svgId);
        }

        // ==================== INTERVALS MODE ====================
        let int_isPlaying = false;
        let int_challenge = null;
        let int_usedChallenges = new Set(); // Track all challenges in this game to avoid repeats
        let int_challengeStartTime = null;
        let int_config = null;
        let int_currentRound = 0;
        let int_firstTryCorrect = 0;
        let int_totalMistakes = 0;
        let int_slowCount = 0; // Intervals taking > 2 seconds
        let int_roundHadMistake = false;
        let int_stats = {};
        let int_allTimes = [];
        let int_history = [];
        let int_cumulativeStats = {}; // Persistent stats across all games

        function intSelectIntervals(preset) {
            document.querySelectorAll('.int-interval-cb').forEach(cb => {
                if (preset === 'all') cb.checked = true;
                else if (preset === 'none') cb.checked = false;
                else if (preset === 'thirds') cb.checked = [3, 4, 7].includes(parseInt(cb.value));
            });
        }

        function intStartGame() {
            saveAllSettings();
            const intervals = Array.from(document.querySelectorAll('.int-interval-cb:checked')).map(cb => parseInt(cb.value));
            if (intervals.length === 0) { alert('Select at least one interval!'); return; }

            const focusProblemAreas = document.getElementById('int_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = intGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas into challenges: "C Minor 3rd" -> { pitchClass: 0, interval: 3 }
                problemAreaChallenges = [];
                const reverseIntervals = {};
                Object.entries(INTERVAL_NAMES).forEach(([k, v]) => reverseIntervals[v] = parseInt(k));
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const intervalName = parts.slice(1).join(' ');
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    const interval = reverseIntervals[intervalName];
                    if (pitchClass >= 0 && interval) {
                        problemAreaChallenges.push({ pitchClass, interval, name: area.name });
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            int_config = {
                intervals,
                direction: document.getElementById('int_directionSelect').value,
                totalRounds: parseInt(document.getElementById('int_roundsSelect').value),
                focusProblemAreas,
                problemAreaChallenges
            };
            int_currentRound = 0;
            int_firstTryCorrect = 0;
            int_totalMistakes = 0;
            int_slowCount = 0;
            int_roundHadMistake = false;
            int_usedChallenges = new Set();
            int_stats = {};
            int_allTimes = [];

            document.getElementById('int_roundDisplay').innerText = '0';
            document.getElementById('int_totalRoundsDisplay').innerText = int_config.totalRounds;
            document.getElementById('int_responseTime').innerText = '--';
            document.getElementById('int_scoreDisplay').innerText = '0%';
            document.getElementById('int_slowDisplay').innerText = '0';
            document.getElementById('int_mistakesDisplay').innerText = '0';
            document.getElementById('int_startBtn').classList.add('hidden');
            document.getElementById('int_stopBtn').classList.remove('hidden');
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_settingsPanel').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');

            intRunCountdown(3);
        }

        function intRunCountdown(count) {
            if (count > 0) {
                document.getElementById('int_intervalName').innerText = '';
                document.getElementById('int_directionText').innerText = 'Get ready...';
                document.getElementById('int_startNote').innerText = count;
                document.getElementById('int_startNote').classList.add('text-blue-400');
                setTimeout(() => intRunCountdown(count - 1), 800);
            } else {
                document.getElementById('int_startNote').classList.remove('text-blue-400');
                int_isPlaying = true;
                intNextChallenge();
            }
        }

        function intStopGame() {
            int_isPlaying = false;
            int_challenge = null;
            clearAllHighlights('pianoSvg');
            intShowGameComplete();
        }

        function intNextChallenge() {
            if (!int_isPlaying) return;
            if (int_currentRound >= int_config.totalRounds) { intEndGame(); return; }

            clearAllHighlights('pianoSvg');
            int_currentRound++;
            int_roundHadMistake = false;

            let interval, dir, startMidi, startPitchClass, challengeKey;

            if (int_config.focusProblemAreas && int_config.problemAreaChallenges) {
                // Focus on problem areas: pick from problem area challenges
                const numDirections = int_config.direction === 'both' ? 2 : 1;
                const maxUnique = int_config.problemAreaChallenges.length * numDirections;
                if (int_usedChallenges.size >= maxUnique) {
                    int_usedChallenges = new Set();
                }

                let attempts = 0;
                do {
                    const problemArea = int_config.problemAreaChallenges[Math.floor(Math.random() * int_config.problemAreaChallenges.length)];
                    startPitchClass = problemArea.pitchClass;
                    interval = problemArea.interval;
                    dir = int_config.direction;
                    if (dir === 'both') dir = Math.random() < 0.5 ? 'up' : 'down';

                    // Find a valid startMidi for this pitch class
                    const baseOctave = 48 + startPitchClass; // C3 + pitch class offset
                    if (dir === 'up') {
                        startMidi = baseOctave + (Math.floor(Math.random() * 2) * 12); // C3-C4 range
                        if (startMidi + interval > 84) startMidi = baseOctave; // Clamp
                    } else {
                        startMidi = baseOctave + 12 + (Math.floor(Math.random() * 2) * 12); // C4-C5 range
                        if (startMidi - interval < 36) startMidi = baseOctave + 24; // Clamp
                    }

                    challengeKey = `${interval}-${startPitchClass}-${dir}`;
                    attempts++;
                } while (int_usedChallenges.has(challengeKey) && attempts < 50);
            } else {
                // Normal mode: pick from selected intervals
                const numIntervals = int_config.intervals.length;
                const numDirections = int_config.direction === 'both' ? 2 : 1;
                const maxUnique = numIntervals * 12 * numDirections;
                if (int_usedChallenges.size >= maxUnique) {
                    int_usedChallenges = new Set();
                }

                let attempts = 0;
                do {
                    interval = int_config.intervals[Math.floor(Math.random() * int_config.intervals.length)];
                    dir = int_config.direction;
                    if (dir === 'both') dir = Math.random() < 0.5 ? 'up' : 'down';

                    if (dir === 'up') startMidi = Math.floor(Math.random() * (72 - interval - 48 + 1)) + 48;
                    else startMidi = Math.floor(Math.random() * (72 - 48 - interval + 1)) + 48 + interval;

                    startPitchClass = startMidi % 12;
                    challengeKey = `${interval}-${startPitchClass}-${dir}`;
                    attempts++;
                } while (int_usedChallenges.has(challengeKey) && attempts < 50);
            }

            int_usedChallenges.add(challengeKey);
            const targetMidi = dir === 'up' ? startMidi + interval : startMidi - interval;
            int_challenge = { startMidi, interval, direction: dir, targetMidi };
            int_challengeStartTime = Date.now();

            document.getElementById('int_startNote').innerText = NOTE_NAMES[startPitchClass];
            document.getElementById('int_intervalName').innerText = INTERVAL_NAMES[interval];
            document.getElementById('int_directionText').innerText = dir === 'up' ? 'above' : 'below';
            document.getElementById('int_roundDisplay').innerText = int_currentRound;

            highlightKey('pianoSvg', startMidi, 'key-start');
        }

        function intOnNoteOn(midi) {
            if (!int_isPlaying || !int_challenge) {
                highlightKey('pianoSvg', midi, 'key-active');
                return;
            }

            if (midi === int_challenge.startMidi) { highlightKey('pianoSvg', midi, 'key-start'); return; }
            if (int_challenge.interval !== 12 && (midi % 12) === (int_challenge.startMidi % 12)) {
                highlightKey('pianoSvg', midi, 'key-start'); return;
            }

            const responseTime = (Date.now() - int_challengeStartTime) / 1000;
            const isCorrect = (midi % 12) === (int_challenge.targetMidi % 12);
            const interval = int_challenge.interval;
            const rootName = NOTE_NAMES[int_challenge.startMidi % 12];
            const statKey = `${rootName} ${INTERVAL_NAMES[interval]}`;

            if (!int_stats[statKey]) int_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
            int_stats[statKey].total++;

            if (isCorrect) {
                // Track slow responses (> 2 seconds)
                const wasSlow = responseTime > 2;
                if (wasSlow) {
                    int_slowCount++;
                    int_stats[statKey].slow++;
                    document.getElementById('int_slowDisplay').innerText = int_slowCount;
                }

                if (!int_roundHadMistake) {
                    int_firstTryCorrect++;
                    int_stats[statKey].firstTry++;
                    int_stats[statKey].times.push(responseTime);
                    int_allTimes.push(responseTime);
                    intShowFeedback('✓', true, responseTime);
                    intUpdateResponseTime(responseTime);
                } else {
                    intShowFeedback('✓', true);
                }
                highlightKey('pianoSvg', midi, 'key-active');
                intUpdateScoreDisplay();
                int_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { int_isPlaying = true; intNextChallenge(); }, 400);
            } else {
                int_totalMistakes++;
                int_roundHadMistake = true;
                highlightKey('pianoSvg', midi, 'key-wrong');
                intShowFeedback('✗', false);
                intUpdateScoreDisplay();
            }
        }

        function intOnNoteOff(midi) {
            highlightKey('pianoSvg', midi, 'key-active', false);
            highlightKey('pianoSvg', midi, 'key-wrong', false);
        }

        function intUpdateResponseTime(seconds) {
            const el = document.getElementById('int_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function intUpdateScoreDisplay() {
            const pct = int_currentRound > 0 ? Math.round((int_firstTryCorrect / int_currentRound) * 100) : 0;
            document.getElementById('int_scoreDisplay').innerText = pct + '%';
            document.getElementById('int_mistakesDisplay').innerText = int_totalMistakes;
        }

        function intShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('int_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function intEndGame() {
            int_isPlaying = false;
            int_challenge = null;
            clearAllHighlights('pianoSvg');

            const accuracy = int_config.totalRounds > 0 ? Math.round((int_firstTryCorrect / int_config.totalRounds) * 100) : 0;
            const avgTime = int_allTimes.length > 0 ? int_allTimes.reduce((a, b) => a + b, 0) / int_allTimes.length : 0;

            int_history.unshift({
                date: new Date().toISOString(),
                config: { ...int_config },
                score: int_firstTryCorrect,
                totalRounds: int_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: int_totalMistakes,
                slowCount: int_slowCount,
                stats: JSON.parse(JSON.stringify(int_stats))
            });
            if (int_history.length > 50) int_history.pop();
            localStorage.setItem('intervalGameHistory', JSON.stringify(int_history));
            intUpdateCumulativeStats();

            intShowGameComplete();
        }

        function intShowGameComplete() {
            const accuracy = int_currentRound > 0 ? Math.round((int_firstTryCorrect / int_currentRound) * 100) : 0;
            const avgTime = int_allTimes.length > 0 ? int_allTimes.reduce((a, b) => a + b, 0) / int_allTimes.length : 0;

            document.getElementById('int_finalScore').innerText = `${int_firstTryCorrect}/${int_currentRound}`;
            document.getElementById('int_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('int_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('int_finalMistakes').innerText = int_totalMistakes;
            document.getElementById('int_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('int_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('int_finalSlow').innerText = int_slowCount;
            document.getElementById('int_finalSlow').className = `text-3xl font-bold ${int_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(int_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('int_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('int_challengeDisplay').classList.add('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('int_stopBtn').classList.add('hidden');
            document.getElementById('int_playAgainBtn').classList.remove('hidden');
            document.getElementById('int_newGameBtn').classList.remove('hidden');

            intShowBreakdown();
            intRenderHistory();
        }

        function intShowBreakdown() {
            const grid = document.getElementById('int_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(int_stats).length > 0;

            if (!hasSessionStats) {
                // No session data - hide breakdown (Problem Areas in History shows cumulative)
                document.getElementById('int_breakdownSection').classList.add('hidden');
                return;
            }

            // Show this session's stats
            for (const [interval, data] of Object.entries(int_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${interval}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('int_breakdownSection').classList.remove('hidden');
        }

        function intPlayAgain() {
            int_currentRound = 0; int_firstTryCorrect = 0; int_totalMistakes = 0; int_slowCount = 0; int_roundHadMistake = false; int_usedChallenges = new Set(); int_stats = {}; int_allTimes = [];
            document.getElementById('int_roundDisplay').innerText = '0';
            document.getElementById('int_responseTime').innerText = '--';
            document.getElementById('int_scoreDisplay').innerText = '0%';
            document.getElementById('int_mistakesDisplay').innerText = '0';
            document.getElementById('int_slowDisplay').innerText = '0';
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_stopBtn').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.remove('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');
            intRunCountdown(3);
        }

        function intNewGame() {
            document.getElementById('int_settingsPanel').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.add('hidden');
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_startBtn').classList.remove('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');
        }

        function intLoadHistory() {
            const saved = localStorage.getItem('intervalGameHistory');
            if (saved) { int_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('intervalCumulativeStats');
            if (savedCumulative) { int_cumulativeStats = JSON.parse(savedCumulative); }
            intRenderHistory();
        }

        function intClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            int_history = [];
            int_cumulativeStats = {};
            localStorage.removeItem('intervalGameHistory');
            localStorage.removeItem('intervalCumulativeStats');
            intRenderHistory();
        }

        function intUpdateCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [intervalName, data] of Object.entries(int_stats)) {
                if (!int_cumulativeStats[intervalName]) {
                    int_cumulativeStats[intervalName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                int_cumulativeStats[intervalName].attempts += data.total;
                int_cumulativeStats[intervalName].firstTry += data.firstTry;
                int_cumulativeStats[intervalName].totalTime += data.times.reduce((a, b) => a + b, 0);
                int_cumulativeStats[intervalName].slow += data.slow || 0;
            }
            localStorage.setItem('intervalCumulativeStats', JSON.stringify(int_cumulativeStats));
        }

        function intGetProblemAreas() {
            // Return intervals sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(int_cumulativeStats)) {
                if (data.attempts >= 5) { // Only include intervals with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    // Combined problem score: lower success + higher slow = more problematic
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function intRenderHistory() {
            const content = document.getElementById('int_historyContent');
            if (int_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = int_history.length;
            const avgAccuracy = Math.round(int_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Get medals for top 3 performances
            const medals = getMedals(int_history, 'accuracy', 'avgTime');
            const displayedGames = int_history.slice(0, 10);

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent (🥇🥈🥉 = personal bests)</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx] || '';
                const rowClass = medal ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: direction and interval count
                const dir = game.config?.direction === 'up' ? '↑' : game.config?.direction === 'down' ? '↓' : '↕';
                const intCount = game.config?.intervals?.length || '?';
                const configStr = `${dir} ${intCount}int`;
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}⏱</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="w-6 inline-block">${medal}</span><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = intGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== 7TH CHORDS MODE ====================
        let ch_isPlaying = false;
        let ch_challenge = null; // { root: 0-11, type: 'maj7'|'min7'|'dom7', requiredPitchClasses: Set }
        let ch_usedChallenges = new Set(); // Track all challenges in this game to avoid repeats
        let ch_challengeStartTime = null;
        let ch_config = null;
        let ch_currentRound = 0;
        let ch_firstTryCorrect = 0;
        let ch_totalMistakes = 0;
        let ch_roundHadMistake = false;
        let ch_attemptHadMistake = false; // Tracks mistakes within a single attempt (while holding notes)
        let ch_stats = {}; // { 'C maj7': { firstTry, total, times } }
        let ch_allTimes = [];
        let ch_slowCount = 0; // Chords taking > 2 seconds
        let ch_history = [];
        let ch_cumulativeStats = {}; // Persistent stats across all games

        function chStartGame() {
            saveAllSettings();
            const types = Array.from(document.querySelectorAll('.ch-type-cb:checked')).map(cb => cb.value);
            if (types.length === 0) { alert('Select at least one chord type!'); return; }

            const focusProblemAreas = document.getElementById('ch_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = chGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C maj7" -> { pitchClass: 0, type: 'maj7' }
                problemAreaChallenges = [];
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const chordType = parts[1];
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    if (pitchClass >= 0 && CHORD_TYPES[chordType]) {
                        problemAreaChallenges.push({ pitchClass, type: chordType, name: area.name });
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            const twoHands = document.getElementById('ch_handsSelect').value === 'two';
            ch_config = {
                types,
                totalRounds: parseInt(document.getElementById('ch_roundsSelect').value),
                twoHands,
                focusProblemAreas,
                problemAreaChallenges
            };
            ch_currentRound = 0; ch_firstTryCorrect = 0; ch_totalMistakes = 0; ch_slowCount = 0; ch_roundHadMistake = false; ch_attemptHadMistake = false; ch_usedChallenges = new Set(); ch_stats = {}; ch_allTimes = [];

            document.getElementById('ch_roundDisplay').innerText = '0';
            document.getElementById('ch_totalRoundsDisplay').innerText = ch_config.totalRounds;
            document.getElementById('ch_responseTime').innerText = '--';
            document.getElementById('ch_scoreDisplay').innerText = '0%';
            document.getElementById('ch_mistakesDisplay').innerText = '0';
            document.getElementById('ch_slowDisplay').innerText = '0';
            document.getElementById('ch_startBtn').classList.add('hidden');
            document.getElementById('ch_stopBtn').classList.remove('hidden');
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_settingsPanel').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
            document.getElementById('ch_twoHandsIndicator').classList.toggle('hidden', !ch_config.twoHands);

            chRunCountdown(3);
        }

        function chRunCountdown(count) {
            if (count > 0) {
                document.getElementById('ch_chordRoot').innerText = count;
                document.getElementById('ch_chordType').innerText = '';
                document.getElementById('ch_heldNotes').innerText = 'Get ready...';
                setTimeout(() => chRunCountdown(count - 1), 800);
            } else {
                ch_isPlaying = true;
                chNextChallenge();
            }
        }

        function chStopGame() {
            ch_isPlaying = false;
            ch_challenge = null;
            clearAllHighlights('ch_pianoSvg');
            chShowGameComplete();
        }

        function chNextChallenge() {
            if (!ch_isPlaying) return;
            if (ch_currentRound >= ch_config.totalRounds) { chEndGame(); return; }

            clearAllHighlights('ch_pianoSvg');
            ch_currentRound++;
            ch_roundHadMistake = false;
            ch_attemptHadMistake = false;

            let root, type, challengeKey;

            if (ch_config.focusProblemAreas && ch_config.problemAreaChallenges) {
                // Focus on problem areas
                const maxUnique = ch_config.problemAreaChallenges.length;
                if (ch_usedChallenges.size >= maxUnique) {
                    ch_usedChallenges = new Set();
                }

                let attempts = 0;
                do {
                    const problemArea = ch_config.problemAreaChallenges[Math.floor(Math.random() * ch_config.problemAreaChallenges.length)];
                    root = problemArea.pitchClass;
                    type = problemArea.type;
                    challengeKey = `${root}-${type}`;
                    attempts++;
                } while (ch_usedChallenges.has(challengeKey) && attempts < 50);
            } else {
                // Normal mode
                const maxUnique = 12 * ch_config.types.length;
                if (ch_usedChallenges.size >= maxUnique) {
                    ch_usedChallenges = new Set();
                }

                let attempts = 0;
                do {
                    root = Math.floor(Math.random() * 12);
                    type = ch_config.types[Math.floor(Math.random() * ch_config.types.length)];
                    challengeKey = `${root}-${type}`;
                    attempts++;
                } while (ch_usedChallenges.has(challengeKey) && attempts < 50);
            }

            ch_usedChallenges.add(challengeKey);
            const chordDef = CHORD_TYPES[type];
            const requiredPitchClasses = new Set(chordDef.intervals.map(i => (root + i) % 12));

            ch_challenge = { root, type, requiredPitchClasses, name: `${NOTE_NAMES[root]} ${chordDef.display}` };
            ch_challengeStartTime = Date.now();

            document.getElementById('ch_chordRoot').innerText = NOTE_NAMES[root];
            document.getElementById('ch_chordType').innerText = chordDef.display;
            document.getElementById('ch_heldNotes').innerText = 'Holding: --';
            document.getElementById('ch_roundDisplay').innerText = ch_currentRound;
        }

        function chOnNoteOn(midi) {
            if (!ch_isPlaying || !ch_challenge) return;

            highlightKey('ch_pianoSvg', midi, 'key-held');

            // Check if this note is a wrong note (not in the required chord)
            const notePitchClass = midi % 12;
            const isWrongNote = !ch_challenge.requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                // Only count as a new mistake if this is the first wrong note of this attempt
                if (!ch_attemptHadMistake) {
                    ch_totalMistakes++;
                    ch_attemptHadMistake = true;
                    ch_roundHadMistake = true;
                    chShowFeedback('✗', false);
                    chUpdateScoreDisplay();
                }
                highlightKey('ch_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('ch_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held (need exactly the 4 pitch classes)
            const hasAllRequired = [...ch_challenge.requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            // For two-hand mode, check that notes span at least 2 octaves
            const heldOctaves = new Set([...heldNotes].map(n => Math.floor(n / 12)));
            const hasTwoOctaves = heldOctaves.size >= 2;
            const minNotes = ch_config.twoHands ? 8 : 4; // 4 notes per hand in two-hand mode
            const octaveRequirementMet = !ch_config.twoHands || hasTwoOctaves;

            if (hasAllRequired && heldNotes.size >= minNotes && octaveRequirementMet) {
                const responseTime = (Date.now() - ch_challengeStartTime) / 1000;
                const chordKey = ch_challenge.name;

                if (!ch_stats[chordKey]) ch_stats[chordKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                ch_stats[chordKey].total++;

                // Correct chord (we already counted mistakes above if any wrong notes were pressed)
                if (!ch_roundHadMistake) {
                    ch_firstTryCorrect++;
                    ch_stats[chordKey].firstTry++;
                    ch_stats[chordKey].times.push(responseTime);
                    ch_allTimes.push(responseTime);
                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        ch_slowCount++;
                        ch_stats[chordKey].slow++;
                        document.getElementById('ch_slowDisplay').innerText = ch_slowCount;
                    }
                    chShowFeedback('✓', true, responseTime);
                    chUpdateResponseTime(responseTime);
                } else {
                    chShowFeedback('✓', true);
                }
                chUpdateScoreDisplay();

                // Highlight correct notes green
                heldNotes.forEach(n => {
                    if (ch_challenge.requiredPitchClasses.has(n % 12)) {
                        highlightKey('ch_pianoSvg', n, 'key-active');
                    }
                });

                ch_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { ch_isPlaying = true; chNextChallenge(); }, 600);
            }
        }

        function chOnNoteOff(midi) {
            highlightKey('ch_pianoSvg', midi, 'key-held', false);
            highlightKey('ch_pianoSvg', midi, 'key-active', false);
            highlightKey('ch_pianoSvg', midi, 'key-wrong', false);

            if (ch_isPlaying && ch_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('ch_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
                // Note: Don't reset ch_attemptHadMistake here - it's reset when moving to next chord
            }
        }

        function chUpdateResponseTime(seconds) {
            const el = document.getElementById('ch_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function chUpdateScoreDisplay() {
            const pct = ch_currentRound > 0 ? Math.round((ch_firstTryCorrect / ch_currentRound) * 100) : 0;
            document.getElementById('ch_scoreDisplay').innerText = pct + '%';
            document.getElementById('ch_mistakesDisplay').innerText = ch_totalMistakes;
        }

        function chShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('ch_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function chEndGame() {
            ch_isPlaying = false;
            ch_challenge = null;
            clearAllHighlights('ch_pianoSvg');

            const accuracy = ch_config.totalRounds > 0 ? Math.round((ch_firstTryCorrect / ch_config.totalRounds) * 100) : 0;
            const avgTime = ch_allTimes.length > 0 ? ch_allTimes.reduce((a, b) => a + b, 0) / ch_allTimes.length : 0;

            ch_history.unshift({
                date: new Date().toISOString(),
                config: { ...ch_config },
                score: ch_firstTryCorrect,
                totalRounds: ch_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: ch_totalMistakes,
                slowCount: ch_slowCount,
                stats: JSON.parse(JSON.stringify(ch_stats))
            });
            if (ch_history.length > 50) ch_history.pop();
            localStorage.setItem('chordsGameHistory', JSON.stringify(ch_history));
            chUpdateCumulativeStats();

            chShowGameComplete();
        }

        function chShowGameComplete() {
            const accuracy = ch_currentRound > 0 ? Math.round((ch_firstTryCorrect / ch_currentRound) * 100) : 0;
            const avgTime = ch_allTimes.length > 0 ? ch_allTimes.reduce((a, b) => a + b, 0) / ch_allTimes.length : 0;

            document.getElementById('ch_finalScore').innerText = `${ch_firstTryCorrect}/${ch_currentRound}`;
            document.getElementById('ch_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('ch_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('ch_finalMistakes').innerText = ch_totalMistakes;
            document.getElementById('ch_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('ch_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('ch_finalSlow').innerText = ch_slowCount;
            document.getElementById('ch_finalSlow').className = `text-3xl font-bold ${ch_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(ch_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('ch_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('ch_challengeDisplay').classList.add('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('ch_stopBtn').classList.add('hidden');
            document.getElementById('ch_playAgainBtn').classList.remove('hidden');
            document.getElementById('ch_newGameBtn').classList.remove('hidden');

            chShowBreakdown();
            chRenderHistory();
        }

        function chShowBreakdown() {
            const grid = document.getElementById('ch_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(ch_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('ch_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chord, data] of Object.entries(ch_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chord}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('ch_breakdownSection').classList.remove('hidden');
        }

        function chPlayAgain() {
            ch_currentRound = 0; ch_firstTryCorrect = 0; ch_totalMistakes = 0; ch_slowCount = 0; ch_roundHadMistake = false; ch_attemptHadMistake = false; ch_usedChallenges = new Set(); ch_stats = {}; ch_allTimes = [];
            document.getElementById('ch_roundDisplay').innerText = '0';
            document.getElementById('ch_responseTime').innerText = '--';
            document.getElementById('ch_scoreDisplay').innerText = '0%';
            document.getElementById('ch_mistakesDisplay').innerText = '0';
            document.getElementById('ch_slowDisplay').innerText = '0';
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_stopBtn').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.remove('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
            document.getElementById('ch_twoHandsIndicator').classList.toggle('hidden', !ch_config.twoHands);
            chRunCountdown(3);
        }

        function chNewGame() {
            document.getElementById('ch_settingsPanel').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.add('hidden');
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_startBtn').classList.remove('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
        }

        function chLoadHistory() {
            const saved = localStorage.getItem('chordsGameHistory');
            if (saved) { ch_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('chordsCumulativeStats');
            if (savedCumulative) { ch_cumulativeStats = JSON.parse(savedCumulative); }
            chRenderHistory();
        }

        function chUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(ch_stats)) {
                if (!ch_cumulativeStats[chordName]) {
                    ch_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                ch_cumulativeStats[chordName].attempts += data.total;
                ch_cumulativeStats[chordName].firstTry += data.firstTry;
                ch_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                ch_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('chordsCumulativeStats', JSON.stringify(ch_cumulativeStats));
        }

        function chGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(ch_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function chClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            ch_history = [];
            ch_cumulativeStats = {};
            localStorage.removeItem('chordsGameHistory');
            localStorage.removeItem('chordsCumulativeStats');
            chRenderHistory();
        }

        function chRenderHistory() {
            const content = document.getElementById('ch_historyContent');
            if (ch_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = ch_history.length;
            const avgAccuracy = Math.round(ch_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Get medals for top 3 performances
            const medals = getMedals(ch_history, 'accuracy', 'avgTime');
            const displayedGames = ch_history.slice(0, 10);

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent (🥇🥈🥉 = personal bests)</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx] || '';
                const rowClass = medal ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config indicators
                const types = game.config?.types || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                const twoHands = game.config?.twoHands ? '2H' : '';
                const configStr = [typeStr, twoHands].filter(Boolean).join(' ');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}⏱</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="w-6 inline-block">${medal}</span><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = chGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== ii-V-I MODE ====================
        let iivi_isPlaying = false;
        let iivi_challenge = null; // { key: 0-11, chords: [{root, type, pitchClasses}, ...], currentStep: 0-2 }
        let iivi_usedKeys = new Set(); // Track all keys in this game to avoid repeats
        let iivi_challengeStartTime = null;
        let iivi_stepStartTime = null;
        let iivi_config = null;
        let iivi_currentRound = 0;
        let iivi_firstTryCorrect = 0;
        let iivi_totalMistakes = 0;
        let iivi_roundHadMistake = false;
        let iivi_attemptHadMistake = false;
        let iivi_stats = {}; // { 'C': { firstTry, total, times } }
        let iivi_allTimes = [];
        let iivi_slowCount = 0; // Chords taking > 2 seconds
        let iivi_history = [];
        let iivi_cumulativeStats = {}; // Persistent stats across all games
        let iivi_stepTimes = []; // Times for ii, V, I in current round

        function iiviGetProgression(key) {
            // ii = minor 7 built on 2nd degree
            // V = dominant 7 built on 5th degree
            // I = major 7 built on root
            const iiRoot = (key + 2) % 12;
            const VRoot = (key + 7) % 12;
            const IRoot = key;

            // Shell voicings: 3rd and 7th only
            // min7: 3rd = root+3, 7th = root+10
            // dom7: 3rd = root+4, 7th = root+10
            // maj7: 3rd = root+4, 7th = root+11
            const iiThird = (iiRoot + 3) % 12;
            const iiSeventh = (iiRoot + 10) % 12;
            const VThird = (VRoot + 4) % 12;
            const VSeventh = (VRoot + 10) % 12;
            const IThird = (IRoot + 4) % 12;
            const ISeventh = (IRoot + 11) % 12;

            // Rootless Type A voicings: 3-5-7-9 (bottom to top, no root)
            // min7: b3-5-b7-9 → intervals 3, 7, 10, 2
            // dom7: 3-13-b7-9 → intervals 4, 9, 10, 2 (uses 13 instead of 5)
            // maj7: 3-5-7-9 → intervals 4, 7, 11, 2
            const iiRootlessA = [3, 7, 10, 2].map(i => (iiRoot + i) % 12);
            const VRootlessA = [4, 9, 10, 2].map(i => (VRoot + i) % 12);
            const IRootlessA = [4, 7, 11, 2].map(i => (IRoot + i) % 12);

            // Rootless Type B voicings: 7-9-3-5 (bottom to top, no root)
            // min7: b7-9-b3-5 → intervals 10, 2, 3, 7
            // dom7: b7-9-3-13 → intervals 10, 2, 4, 9 (uses 13 instead of 5)
            // maj7: 7-9-3-5 → intervals 11, 2, 4, 7
            const iiRootlessB = [10, 2, 3, 7].map(i => (iiRoot + i) % 12);
            const VRootlessB = [10, 2, 4, 9].map(i => (VRoot + i) % 12);
            const IRootlessB = [11, 2, 4, 7].map(i => (IRoot + i) % 12);

            // For backward compatibility, rootless = Type A
            const iiRootless = iiRootlessA;
            const VRootless = VRootlessA;
            const IRootless = IRootlessA;

            return [
                {
                    root: iiRoot,
                    type: 'min7',
                    name: NOTE_NAMES[iiRoot] + 'm7',
                    rootlessName: NOTE_NAMES[iiRoot] + 'm9',
                    pitchClasses: new Set(CHORD_TYPES.min7.intervals.map(i => (iiRoot + i) % 12)),
                    shellPitchClasses: new Set([iiThird, iiSeventh]),
                    shellNames: NOTE_NAMES[iiThird] + ' + ' + NOTE_NAMES[iiSeventh],
                    rootlessPitchClasses: new Set(iiRootless),
                    rootlessNames: iiRootless.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessAPitchClasses: new Set(iiRootlessA),
                    rootlessANames: iiRootlessA.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessBPitchClasses: new Set(iiRootlessB),
                    rootlessBNames: iiRootlessB.map(pc => NOTE_NAMES[pc]).join(' ')
                },
                {
                    root: VRoot,
                    type: 'dom7',
                    name: NOTE_NAMES[VRoot] + '7',
                    rootlessName: NOTE_NAMES[VRoot] + '13',
                    pitchClasses: new Set(CHORD_TYPES.dom7.intervals.map(i => (VRoot + i) % 12)),
                    shellPitchClasses: new Set([VThird, VSeventh]),
                    shellNames: NOTE_NAMES[VSeventh] + ' + ' + NOTE_NAMES[VThird],
                    rootlessPitchClasses: new Set(VRootless),
                    rootlessNames: VRootless.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessAPitchClasses: new Set(VRootlessA),
                    rootlessANames: VRootlessA.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessBPitchClasses: new Set(VRootlessB),
                    rootlessBNames: VRootlessB.map(pc => NOTE_NAMES[pc]).join(' ')
                },
                {
                    root: IRoot,
                    type: 'maj7',
                    name: NOTE_NAMES[IRoot] + 'maj7',
                    rootlessName: NOTE_NAMES[IRoot] + 'maj9',
                    pitchClasses: new Set(CHORD_TYPES.maj7.intervals.map(i => (IRoot + i) % 12)),
                    shellPitchClasses: new Set([IThird, ISeventh]),
                    shellNames: NOTE_NAMES[IThird] + ' + ' + NOTE_NAMES[ISeventh],
                    rootlessPitchClasses: new Set(IRootless),
                    rootlessNames: IRootless.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessAPitchClasses: new Set(IRootlessA),
                    rootlessANames: IRootlessA.map(pc => NOTE_NAMES[pc]).join(' '),
                    rootlessBPitchClasses: new Set(IRootlessB),
                    rootlessBNames: IRootlessB.map(pc => NOTE_NAMES[pc]).join(' ')
                }
            ];
        }

        function iiviStartGame() {
            saveAllSettings();

            const focusProblemAreas = document.getElementById('iivi_focusProblemAreas').checked;
            let problemAreaKeys = null;

            if (focusProblemAreas) {
                const problemAreas = iiviGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C major" -> pitchClass 0
                problemAreaKeys = [];
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    if (pitchClass >= 0) {
                        problemAreaKeys.push(pitchClass);
                    }
                });
                if (problemAreaKeys.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            iivi_config = {
                totalRounds: parseInt(document.getElementById('iivi_roundsSelect').value),
                voicing: document.getElementById('iivi_voicingSelect').value,
                twoHands: document.getElementById('iivi_twoHands').checked,
                focusProblemAreas,
                problemAreaKeys
            };
            iivi_currentRound = 0; iivi_firstTryCorrect = 0; iivi_totalMistakes = 0; iivi_slowCount = 0;
            iivi_roundHadMistake = false; iivi_attemptHadMistake = false; iivi_usedKeys = new Set();
            iivi_stats = {}; iivi_allTimes = [];

            document.getElementById('iivi_roundDisplay').innerText = '0';
            document.getElementById('iivi_totalRoundsDisplay').innerText = iivi_config.totalRounds;
            document.getElementById('iivi_responseTime').innerText = '--';
            document.getElementById('iivi_scoreDisplay').innerText = '0%';
            document.getElementById('iivi_mistakesDisplay').innerText = '0';
            document.getElementById('iivi_slowDisplay').innerText = '0';
            document.getElementById('iivi_startBtn').classList.add('hidden');
            document.getElementById('iivi_stopBtn').classList.remove('hidden');
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_settingsPanel').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');

            // Update label based on voicing mode and two-hands setting
            let label = 'ii-V-I in the key of';
            if (iivi_config.voicing === 'shell') {
                label = iivi_config.twoHands ? 'Two hands: bass + shell (3rd + 7th) in' : 'Shell voicings (3rd + 7th) in';
            } else if (iivi_config.voicing === 'rootless') {
                label = iivi_config.twoHands ? 'Two hands: bass + rootless in' : 'Rootless voicings (no root) in';
            } else {
                label = iivi_config.twoHands ? 'Two hands: bass + voicing in' : 'ii-V-I in the key of';
            }
            document.getElementById('iivi_challengeLabel').innerText = label;

            iiviRunCountdown(3);
        }

        function iiviRunCountdown(count) {
            if (count > 0) {
                document.getElementById('iivi_keyDisplay').innerText = count;
                document.getElementById('iivi_chord_ii').innerText = '...';
                document.getElementById('iivi_chord_V').innerText = '...';
                document.getElementById('iivi_chord_I').innerText = '...';
                document.getElementById('iivi_shell_ii').innerText = '';
                document.getElementById('iivi_shell_V').innerText = '';
                document.getElementById('iivi_shell_I').innerText = '';
                document.getElementById('iivi_heldNotes').innerText = 'Get ready...';
                iiviResetStepStyles();
                setTimeout(() => iiviRunCountdown(count - 1), 800);
            } else {
                iivi_isPlaying = true;
                iiviNextChallenge();
            }
        }

        function iiviResetStepStyles() {
            ['ii', 'V', 'I'].forEach(step => {
                const el = document.querySelector(`#iivi_step_${step} > div`);
                el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                document.getElementById(`iivi_time_${step}`).innerText = '--';
            });
        }

        function iiviHighlightCurrentStep() {
            if (!iivi_challenge) return;
            const steps = ['ii', 'V', 'I'];
            steps.forEach((step, idx) => {
                const el = document.querySelector(`#iivi_step_${step} > div`);
                if (idx < iivi_challenge.currentStep) {
                    // Completed
                    el.className = 'w-20 h-16 rounded-lg bg-green-700 flex flex-col items-center justify-center mb-1 border-2 border-green-500';
                } else if (idx === iivi_challenge.currentStep) {
                    // Current
                    el.className = 'w-20 h-16 rounded-lg bg-blue-700 flex flex-col items-center justify-center mb-1 border-2 border-blue-400';
                } else {
                    // Upcoming
                    el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                }
            });
        }

        function iiviStopGame() {
            iivi_isPlaying = false;
            iivi_challenge = null;
            clearAllHighlights('iivi_pianoSvg');
            iiviShowGameComplete();
        }

        function iiviNextChallenge() {
            if (!iivi_isPlaying) return;
            if (iivi_currentRound >= iivi_config.totalRounds) { iiviEndGame(); return; }

            clearAllHighlights('iivi_pianoSvg');
            iivi_currentRound++;
            iivi_roundHadMistake = false;
            iivi_attemptHadMistake = false;
            iivi_stepTimes = [];

            let key;
            if (iivi_config.focusProblemAreas && iivi_config.problemAreaKeys) {
                // Focus on problem areas: pick from problem keys
                if (iivi_usedKeys.size >= iivi_config.problemAreaKeys.length) {
                    iivi_usedKeys.clear();
                }
                const unusedKeys = iivi_config.problemAreaKeys.filter(k => !iivi_usedKeys.has(k));
                key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            } else {
                // Normal mode: pick from all 12 keys
                if (iivi_usedKeys.size >= 12) {
                    iivi_usedKeys.clear();
                }
                const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                const unusedKeys = allKeys.filter(k => !iivi_usedKeys.has(k));
                key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            }

            iivi_usedKeys.add(key);
            const chords = iiviGetProgression(key);

            iivi_challenge = { key, chords, currentStep: 0 };
            iivi_challengeStartTime = Date.now();
            iivi_stepStartTime = Date.now();

            document.getElementById('iivi_keyDisplay').innerText = NOTE_NAMES[key];
            document.getElementById('iivi_heldNotes').innerText = 'Holding: --';
            document.getElementById('iivi_roundDisplay').innerText = iivi_currentRound;

            // Display chord names based on voicing mode
            const voicing = iivi_config.voicing;
            const isRootless = voicing === 'rootless' || voicing === 'rootlessABA' || voicing === 'rootlessBAB';
            document.getElementById('iivi_chord_ii').innerText = isRootless ? chords[0].rootlessName : chords[0].name;
            document.getElementById('iivi_chord_V').innerText = isRootless ? chords[1].rootlessName : chords[1].name;
            document.getElementById('iivi_chord_I').innerText = isRootless ? chords[2].rootlessName : chords[2].name;

            // Show/hide note hints based on voicing mode and two-hands setting
            const isShell = voicing === 'shell';
            const twoHands = iivi_config.twoHands;
            const showHint = isShell || isRootless || twoHands;

            // Determine voicing type for each step in A-B-A or B-A-B patterns
            // A-B-A: ii=A, V=B, I=A
            // B-A-B: ii=B, V=A, I=B
            const voicingPattern = voicing === 'rootlessABA' ? ['A', 'B', 'A']
                                 : voicing === 'rootlessBAB' ? ['B', 'A', 'B']
                                 : ['A', 'A', 'A']; // default rootless = all Type A

            // Build hint text for each chord
            chords.forEach((chord, i) => {
                const chordLabels = ['ii', 'V', 'I'];
                const hintEl = document.getElementById(`iivi_shell_${chordLabels[i]}`);
                const voicingType = voicingPattern[i];

                let hintText;
                if (twoHands) {
                    // Two-hands mode: show LH (bass) + RH (voicing)
                    const bassName = NOTE_NAMES[chord.root];
                    let rhNotes;
                    if (isRootless) {
                        rhNotes = voicingType === 'A' ? chord.rootlessANames : chord.rootlessBNames;
                    } else if (isShell) {
                        rhNotes = chord.shellNames;
                    } else {
                        // Full: 3-5-7 in RH (no root since bass has it)
                        const intervals = chord.type === 'min7' ? [3, 7, 10] : chord.type === 'dom7' ? [4, 7, 10] : [4, 7, 11];
                        rhNotes = intervals.map(i => NOTE_NAMES[(chord.root + i) % 12]).join(' ');
                    }
                    hintText = `LH: ${bassName} | RH: ${rhNotes}`;
                } else {
                    // Single-hand mode
                    if (isRootless) {
                        const typeLabel = (voicing === 'rootlessABA' || voicing === 'rootlessBAB') ? ` (${voicingType})` : '';
                        hintText = (voicingType === 'A' ? chord.rootlessANames : chord.rootlessBNames) + typeLabel;
                    } else {
                        hintText = chord.shellNames;
                    }
                }

                hintEl.innerText = hintText;
                hintEl.classList.toggle('hidden', !showHint);
            });

            iiviResetStepStyles();
            iiviHighlightCurrentStep();
        }

        function iiviOnNoteOn(midi) {
            if (!iivi_isPlaying || !iivi_challenge) return;

            highlightKey('iivi_pianoSvg', midi, 'key-held');

            const currentChord = iivi_challenge.chords[iivi_challenge.currentStep];
            const notePitchClass = midi % 12;
            const voicing = iivi_config.voicing;
            const twoHands = iivi_config.twoHands;

            // Determine required notes based on voicing and two-hands setting
            let voicingPitchClasses;
            let bassNote = null;
            let requiredNotes;

            // Determine voicing type for A-B-A or B-A-B patterns
            const isRootlessPattern = voicing === 'rootlessABA' || voicing === 'rootlessBAB';
            const isAnyRootless = voicing === 'rootless' || isRootlessPattern;
            let currentVoicingType = 'A'; // default
            if (isRootlessPattern) {
                const pattern = voicing === 'rootlessABA' ? ['A', 'B', 'A'] : ['B', 'A', 'B'];
                currentVoicingType = pattern[iivi_challenge.currentStep];
            }

            if (twoHands) {
                bassNote = currentChord.root;
                if (voicing === 'shell') {
                    // Two hands + shell: bass + 3rd + 7th = 3 notes
                    voicingPitchClasses = currentChord.shellPitchClasses;
                    requiredNotes = 3;
                } else if (isAnyRootless) {
                    // Two hands + rootless: bass + 4 rootless notes = 5 notes
                    voicingPitchClasses = currentVoicingType === 'A'
                        ? currentChord.rootlessAPitchClasses
                        : currentChord.rootlessBPitchClasses;
                    requiredNotes = 5;
                } else {
                    // Two hands + full: bass + 3rd + 5th + 7th = 4 notes (root in bass, not in voicing)
                    voicingPitchClasses = new Set([...currentChord.pitchClasses].filter(pc => pc !== bassNote));
                    requiredNotes = 4;
                }
            } else {
                // Single hand
                if (voicing === 'shell') {
                    voicingPitchClasses = currentChord.shellPitchClasses;
                    requiredNotes = 2;
                } else if (isAnyRootless) {
                    voicingPitchClasses = currentVoicingType === 'A'
                        ? currentChord.rootlessAPitchClasses
                        : currentChord.rootlessBPitchClasses;
                    requiredNotes = 4;
                } else {
                    voicingPitchClasses = currentChord.pitchClasses;
                    requiredNotes = 4;
                }
            }

            // Check if note is correct (either bass note or part of voicing)
            const isCorrectNote = twoHands
                ? (notePitchClass === bassNote || voicingPitchClasses.has(notePitchClass))
                : voicingPitchClasses.has(notePitchClass);

            if (!isCorrectNote) {
                if (!iivi_attemptHadMistake) {
                    iivi_totalMistakes++;
                    iivi_attemptHadMistake = true;
                    iivi_roundHadMistake = true;
                    iiviShowFeedback('✗', false);
                    iiviUpdateScoreDisplay();
                }
                highlightKey('iivi_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('iivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if current chord is complete
            let hasAllRequired;
            if (twoHands) {
                const hasBass = heldPitchClasses.has(bassNote);
                const hasVoicing = [...voicingPitchClasses].every(pc => heldPitchClasses.has(pc));
                hasAllRequired = hasBass && hasVoicing;
            } else {
                hasAllRequired = [...voicingPitchClasses].every(pc => heldPitchClasses.has(pc));
            }

            if (hasAllRequired && heldNotes.size >= requiredNotes) {
                const stepTime = (Date.now() - iivi_stepStartTime) / 1000;
                iivi_stepTimes.push(stepTime);

                // Track slow responses (> 2 seconds)
                if (stepTime > 2) {
                    iivi_slowCount++;
                    document.getElementById('iivi_slowDisplay').innerText = iivi_slowCount;
                }

                // Show time for this step
                const stepNames = ['ii', 'V', 'I'];
                document.getElementById(`iivi_time_${stepNames[iivi_challenge.currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                // Highlight correct notes
                heldNotes.forEach(n => {
                    const pc = n % 12;
                    const isRequired = twoHands
                        ? (pc === bassNote || voicingPitchClasses.has(pc))
                        : voicingPitchClasses.has(pc);
                    if (isRequired) {
                        highlightKey('iivi_pianoSvg', n, 'key-active');
                    }
                });

                // Score this chord individually
                if (!iivi_attemptHadMistake) {
                    iivi_firstTryCorrect++;
                }

                // Move to next step
                iivi_challenge.currentStep++;
                iivi_attemptHadMistake = false; // Reset for next chord
                iiviUpdateScoreDisplay();

                if (iivi_challenge.currentStep >= 3) {
                    // Progression complete!
                    iivi_isPlaying = false; // Prevent mistakes during transition
                    const avgTime = iivi_stepTimes.reduce((a, b) => a + b, 0) / iivi_stepTimes.length;
                    const keyName = NOTE_NAMES[iivi_challenge.key];

                    if (!iivi_stats[keyName]) iivi_stats[keyName] = { firstTry: 0, total: 0, times: [], slow: 0 };
                    iivi_stats[keyName].total++;

                    // Check if any step was slow (> 2 seconds)
                    const hadSlowStep = iivi_stepTimes.some(t => t > 2);
                    if (hadSlowStep) {
                        iivi_stats[keyName].slow++;
                    }

                    if (!iivi_roundHadMistake) {
                        iivi_stats[keyName].firstTry++;
                        iivi_stats[keyName].times.push(avgTime);
                    }
                    iivi_allTimes.push(avgTime);
                    iiviShowFeedback('✓', true);
                    iiviUpdateResponseTime(avgTime);

                    setTimeout(() => { iivi_isPlaying = true; iiviNextChallenge(); }, 800);
                } else {
                    // Move to next chord
                    iivi_stepStartTime = Date.now();
                    iiviHighlightCurrentStep();
                    iiviShowFeedback('✓', true, stepTime);
                }
            }
        }

        function iiviOnNoteOff(midi) {
            highlightKey('iivi_pianoSvg', midi, 'key-held', false);
            highlightKey('iivi_pianoSvg', midi, 'key-active', false);
            highlightKey('iivi_pianoSvg', midi, 'key-wrong', false);

            if (iivi_isPlaying && iivi_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('iivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
                // Note: Don't reset iivi_attemptHadMistake here - it's reset when moving to next chord
            }
        }

        function iiviUpdateResponseTime(seconds) {
            const el = document.getElementById('iivi_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function iiviUpdateScoreDisplay() {
            const currentStep = iivi_challenge ? iivi_challenge.currentStep : 0;
            const totalChords = iivi_currentRound * 3 + currentStep;
            const pct = totalChords > 0 ? Math.round((iivi_firstTryCorrect / totalChords) * 100) : 0;
            document.getElementById('iivi_scoreDisplay').innerText = pct + '%';
            document.getElementById('iivi_mistakesDisplay').innerText = iivi_totalMistakes;
        }

        function iiviShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('iivi_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function iiviEndGame() {
            iivi_isPlaying = false;
            iivi_challenge = null;
            clearAllHighlights('iivi_pianoSvg');

            const totalChords = iivi_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((iivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = iivi_allTimes.length > 0 ? iivi_allTimes.reduce((a, b) => a + b, 0) / iivi_allTimes.length : 0;

            iivi_history.unshift({
                date: new Date().toISOString(),
                config: { ...iivi_config },
                score: iivi_firstTryCorrect,
                totalRounds: iivi_config.totalRounds,
                totalChords: totalChords,
                accuracy, avgTime,
                totalMistakes: iivi_totalMistakes,
                slowCount: iivi_slowCount,
                stats: JSON.parse(JSON.stringify(iivi_stats))
            });
            if (iivi_history.length > 50) iivi_history.pop();
            localStorage.setItem('iiviGameHistory', JSON.stringify(iivi_history));
            iiviUpdateCumulativeStats();

            iiviShowGameComplete();
        }

        function iiviShowGameComplete() {
            const totalChords = iivi_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((iivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = iivi_allTimes.length > 0 ? iivi_allTimes.reduce((a, b) => a + b, 0) / iivi_allTimes.length : 0;

            document.getElementById('iivi_finalScore').innerText = `${iivi_firstTryCorrect}/${totalChords} chords`;
            document.getElementById('iivi_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('iivi_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('iivi_finalMistakes').innerText = iivi_totalMistakes;
            document.getElementById('iivi_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('iivi_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('iivi_finalSlow').innerText = iivi_slowCount;
            document.getElementById('iivi_finalSlow').className = `text-3xl font-bold ${iivi_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(iivi_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('iivi_finalWeakAreas').innerText = weak.length > 0 ? `Focus on keys: ${weak.join(', ')}` : '';

            document.getElementById('iivi_challengeDisplay').classList.add('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('iivi_stopBtn').classList.add('hidden');
            document.getElementById('iivi_playAgainBtn').classList.remove('hidden');
            document.getElementById('iivi_newGameBtn').classList.remove('hidden');

            iiviShowBreakdown();
            iiviRenderHistory();
        }

        function iiviShowBreakdown() {
            const grid = document.getElementById('iivi_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(iivi_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('iivi_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [key, data] of Object.entries(iivi_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">Key of ${key}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('iivi_breakdownSection').classList.remove('hidden');
        }

        function iiviPlayAgain() {
            iivi_currentRound = 0; iivi_firstTryCorrect = 0; iivi_totalMistakes = 0; iivi_slowCount = 0;
            iivi_roundHadMistake = false; iivi_attemptHadMistake = false; iivi_usedKeys = new Set();
            iivi_stats = {}; iivi_allTimes = [];
            document.getElementById('iivi_roundDisplay').innerText = '0';
            document.getElementById('iivi_responseTime').innerText = '--';
            document.getElementById('iivi_scoreDisplay').innerText = '0%';
            document.getElementById('iivi_mistakesDisplay').innerText = '0';
            document.getElementById('iivi_slowDisplay').innerText = '0';
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_stopBtn').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');
            iiviRunCountdown(3);
        }

        function iiviNewGame() {
            document.getElementById('iivi_settingsPanel').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.add('hidden');
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_startBtn').classList.remove('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');
        }

        function iiviLoadHistory() {
            const saved = localStorage.getItem('iiviGameHistory');
            if (saved) { iivi_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('iiviCumulativeStats');
            if (savedCumulative) { iivi_cumulativeStats = JSON.parse(savedCumulative); }
            iiviRenderHistory();
        }

        function iiviUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(iivi_stats)) {
                if (!iivi_cumulativeStats[keyName]) {
                    iivi_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                iivi_cumulativeStats[keyName].attempts += data.total;
                iivi_cumulativeStats[keyName].firstTry += data.firstTry;
                iivi_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                iivi_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('iiviCumulativeStats', JSON.stringify(iivi_cumulativeStats));
        }

        function iiviGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(iivi_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function iiviClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            iivi_history = [];
            iivi_cumulativeStats = {};
            localStorage.removeItem('iiviGameHistory');
            localStorage.removeItem('iiviCumulativeStats');
            iiviRenderHistory();
        }

        function iiviRenderHistory() {
            const content = document.getElementById('iivi_historyContent');
            if (iivi_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = iivi_history.length;
            const avgAccuracy = Math.min(100, Math.round(iivi_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            const displayedGames = iivi_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const totalChords = game.totalChords || game.totalRounds * 3;
                const chordScore = game.score !== undefined ? Math.min(game.score, totalChords) : Math.round(Math.min(game.accuracy, 100) * totalChords / 100);
                const displayAccuracy = Math.min(game.accuracy, 100);
                // Config: voicing type
                const voicing = game.config?.voicing === 'shell' ? 'shell' : game.config?.voicing === 'rootless' ? 'rootless' : 'full';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${chordScore}/${totalChords}</span><span class="text-xs text-purple-400 ml-1">${voicing}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = iiviGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== JAZZ SCALES MODE ====================
        let sc_isPlaying = false;
        let sc_challenge = null; // { root: 0-11, chordType: 'maj7'|'min7'|'dom7', scaleName: string, scaleNotes: [pitchClasses], currentNoteIndex: 0 }
        let sc_usedChallenges = new Set();
        let sc_challengeStartTime = null;
        let sc_config = null;
        let sc_currentRound = 0;
        let sc_firstTryCorrect = 0;
        let sc_totalMistakes = 0;
        let sc_roundHadMistake = false;
        let sc_noteHadMistake = false;
        let sc_stats = {};
        let sc_allTimes = [];
        let sc_history = [];
        let sc_cumulativeStats = {}; // Persistent stats across all games

        // Scale intervals from root (chord tone + whole step principle)
        const SCALE_TYPES = {
            'maj7': {
                name: 'Lydian',
                intervals: [0, 2, 4, 6, 7, 9, 11], // 1 2 3 #4 5 6 7
                degrees: ['1', '2', '3', '#4', '5', '6', '7']
            },
            'min7': {
                name: 'Dorian',
                intervals: [0, 2, 3, 5, 7, 9, 10], // 1 2 b3 4 5 6 b7
                degrees: ['1', '2', 'b3', '4', '5', '6', 'b7']
            },
            'dom7': {
                name: 'Lydian Dom',
                intervals: [0, 2, 4, 6, 7, 9, 10], // 1 2 3 #4 5 6 b7
                degrees: ['1', '2', '3', '#4', '5', '6', 'b7']
            }
        };

        // Extension intervals: 9=2, 11=5, 13=9 (semitones from root)
        const EXTENSION_INTERVALS = { '9': 2, '11': 5, '13': 9 };

        // Get extended chord pitch classes
        function getExtendedChord(root, chordType, extension) {
            const base = CHORD_TYPES[chordType].intervals.map(i => (root + i) % 12);
            const extIntervals = [];
            if (extension === '9' || extension === '11' || extension === '13') extIntervals.push(2);
            if (extension === '11' || extension === '13') extIntervals.push(5);
            if (extension === '13') extIntervals.push(9);
            const extNotes = extIntervals.map(i => (root + i) % 12);
            const allNotes = [...base, ...extNotes];

            // Build display name
            const rootName = NOTE_NAMES[root];
            let chordName = '';
            if (chordType === 'maj7') {
                chordName = rootName + 'maj' + extension;
            } else if (chordType === 'min7') {
                chordName = rootName + 'm' + extension;
            } else { // dom7
                chordName = rootName + extension;
            }

            // Build formula
            const formulas = {
                '9': ['1', '3', '5', '7', '9'],
                '11': ['1', '3', '5', '7', '9', '11'],
                '13': ['1', '3', '5', '7', '9', '11', '13']
            };

            // Get actual note names for display
            const noteNames = allNotes.map(pc => NOTE_NAMES[pc]);

            return {
                root,
                chordType,
                extension,
                chordName,
                pitchClasses: new Set(allNotes),
                noteCount: allNotes.length,
                formula: formulas[extension],
                noteNames
            };
        }

        function scGetScale(root, chordType) {
            const scaleType = SCALE_TYPES[chordType];
            const scaleNotes = scaleType.intervals.map(i => (root + i) % 12);
            const chordDisplay = NOTE_NAMES[root] + (chordType === 'maj7' ? ' maj7' : chordType === 'min7' ? ' min7' : ' 7');
            return {
                root,
                chordType,
                chordDisplay,
                scaleName: scaleType.name,
                scaleNotes,
                degrees: scaleType.degrees
            };
        }

        function scStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('sc_chordTypeSelect').value;
            const showHints = document.getElementById('sc_showHints').checked;
            const focusProblemAreas = document.getElementById('sc_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = scGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C Lydian" -> { pitchClass: 0, scaleName: 'Lydian' }
                const scaleToChordType = { 'Lydian': 'maj7', 'Dorian': 'min7', 'Mixolydian': 'dom7' };
                problemAreaChallenges = [];
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const scaleName = parts[1];
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    const chordType = scaleToChordType[scaleName];
                    if (pitchClass >= 0 && chordType) {
                        problemAreaChallenges.push({ pitchClass, chordType, scaleName, name: area.name });
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            sc_config = {
                totalRounds: parseInt(document.getElementById('sc_roundsSelect').value),
                chordTypes: chordTypeSetting === 'all' ? ['maj7', 'min7', 'dom7'] : [chordTypeSetting],
                showHints,
                focusProblemAreas,
                problemAreaChallenges
            };
            sc_currentRound = 0; sc_firstTryCorrect = 0; sc_totalMistakes = 0;
            sc_roundHadMistake = false; sc_noteHadMistake = false; sc_usedChallenges = new Set();
            sc_stats = {}; sc_allTimes = [];

            document.getElementById('sc_roundDisplay').innerText = '0';
            document.getElementById('sc_totalRoundsDisplay').innerText = sc_config.totalRounds;
            document.getElementById('sc_responseTime').innerText = '--';
            document.getElementById('sc_scoreDisplay').innerText = '0%';
            document.getElementById('sc_mistakesDisplay').innerText = '0';
            document.getElementById('sc_startBtn').classList.add('hidden');
            document.getElementById('sc_stopBtn').classList.remove('hidden');
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_settingsPanel').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');

            // Show/hide hints based on setting
            document.querySelectorAll('.sc-hint').forEach(el => {
                el.style.visibility = showHints ? 'visible' : 'hidden';
            });

            scRunCountdown(3);
        }

        function scRunCountdown(count) {
            if (count > 0) {
                document.getElementById('sc_chordDisplay').innerText = count;
                document.getElementById('sc_scaleNameDisplay').innerText = '';
                document.getElementById('sc_expectedNote').innerHTML = 'Get ready...';
                scResetNoteProgress();
                setTimeout(() => scRunCountdown(count - 1), 800);
            } else {
                sc_isPlaying = true;
                scNextChallenge();
            }
        }

        function scResetNoteProgress() {
            for (let i = 0; i < 7; i++) {
                const el = document.getElementById(`sc_note_${i}`);
                el.className = 'w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600';
            }
        }

        function scUpdateNoteProgress() {
            if (!sc_challenge) return;
            const degrees = sc_challenge.degrees;
            const showHints = sc_config.showHints;
            for (let i = 0; i < 7; i++) {
                const el = document.getElementById(`sc_note_${i}`);
                // Show degree hint or just position number based on setting
                el.innerHTML = showHints ? degrees[i] : (i < sc_challenge.currentNoteIndex ? '✓' : '');
                if (i < sc_challenge.currentNoteIndex) {
                    el.className = 'w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-sm font-bold border-2 border-green-400';
                } else if (i === sc_challenge.currentNoteIndex) {
                    el.className = 'w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold border-2 border-blue-400';
                } else {
                    el.className = 'w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600';
                }
            }
        }

        function scStopGame() {
            sc_isPlaying = false;
            sc_challenge = null;
            clearAllHighlights('sc_pianoSvg');
            scShowGameComplete();
        }

        function scNextChallenge() {
            if (!sc_isPlaying) return;
            if (sc_currentRound >= sc_config.totalRounds) { scEndGame(); return; }

            clearAllHighlights('sc_pianoSvg');
            sc_currentRound++;
            sc_roundHadMistake = false;
            sc_noteHadMistake = false;

            let root, chordType, challengeKey;

            if (sc_config.focusProblemAreas && sc_config.problemAreaChallenges) {
                // Focus on problem areas
                const maxChallenges = sc_config.problemAreaChallenges.length;
                if (sc_usedChallenges.size >= maxChallenges) {
                    sc_usedChallenges.clear();
                }

                let attempts = 0;
                do {
                    const problemArea = sc_config.problemAreaChallenges[Math.floor(Math.random() * sc_config.problemAreaChallenges.length)];
                    root = problemArea.pitchClass;
                    chordType = problemArea.chordType;
                    challengeKey = `${root}-${chordType}`;
                    attempts++;
                } while (sc_usedChallenges.has(challengeKey) && attempts < 50);
            } else {
                // Normal mode
                const maxChallenges = 12 * sc_config.chordTypes.length;
                if (sc_usedChallenges.size >= maxChallenges) {
                    sc_usedChallenges.clear();
                }

                let attempts = 0;
                do {
                    root = Math.floor(Math.random() * 12);
                    chordType = sc_config.chordTypes[Math.floor(Math.random() * sc_config.chordTypes.length)];
                    challengeKey = `${root}-${chordType}`;
                    attempts++;
                } while (sc_usedChallenges.has(challengeKey) && attempts < 50);
            }

            sc_usedChallenges.add(challengeKey);
            const scale = scGetScale(root, chordType);

            sc_challenge = { ...scale, currentNoteIndex: 0 };
            sc_challengeStartTime = Date.now();

            document.getElementById('sc_chordDisplay').innerText = scale.chordDisplay;
            document.getElementById('sc_scaleNameDisplay').innerText = scale.scaleName;
            document.getElementById('sc_roundDisplay').innerText = sc_currentRound;

            scUpdateNoteProgress();
            scUpdateExpectedNote();
        }

        function scUpdateExpectedNote() {
            if (!sc_challenge || sc_challenge.currentNoteIndex >= 7) return;
            if (sc_config.showHints) {
                const expectedPitchClass = sc_challenge.scaleNotes[sc_challenge.currentNoteIndex];
                document.getElementById('sc_expectedNote').innerHTML = `Next: <span class="text-white font-bold">${NOTE_NAMES[expectedPitchClass]}</span>`;
            } else {
                document.getElementById('sc_expectedNote').innerHTML = `<span class="text-slate-500">Note ${sc_challenge.currentNoteIndex + 1} of 7</span>`;
            }
        }

        function scOnNoteOn(midi) {
            if (!sc_isPlaying || !sc_challenge) return;

            highlightKey('sc_pianoSvg', midi, 'key-held');
            if (sc_challenge.currentNoteIndex >= 7) return;

            const notePitchClass = midi % 12;
            const expectedPitchClass = sc_challenge.scaleNotes[sc_challenge.currentNoteIndex];

            if (notePitchClass === expectedPitchClass) {
                // Correct note!
                highlightKey('sc_pianoSvg', midi, 'key-active');

                // Score this note individually
                if (!sc_noteHadMistake) {
                    sc_firstTryCorrect++;
                }

                sc_challenge.currentNoteIndex++;
                sc_noteHadMistake = false; // Reset for next note
                scUpdateNoteProgress();
                scUpdateScoreDisplay();

                if (sc_challenge.currentNoteIndex >= 7) {
                    // Scale complete!
                    const scaleTime = (Date.now() - sc_challengeStartTime) / 1000;
                    const statKey = sc_challenge.chordDisplay;

                    if (!sc_stats[statKey]) sc_stats[statKey] = { firstTry: 0, total: 0, times: [] };
                    sc_stats[statKey].total++;

                    if (!sc_roundHadMistake) {
                        sc_stats[statKey].firstTry++;
                        sc_stats[statKey].times.push(scaleTime);
                        sc_allTimes.push(scaleTime);
                        scShowFeedback('✓', true, scaleTime);
                        scUpdateResponseTime(scaleTime);
                    } else {
                        scShowFeedback('✓', true);
                    }
                    document.getElementById('sc_expectedNote').innerHTML = '<span class="text-green-400">Complete!</span>';

                    sc_isPlaying = false; // Prevent mistakes during transition
                    setTimeout(() => { sc_isPlaying = true; scNextChallenge(); }, 800);
                } else {
                    scUpdateExpectedNote();
                }
            } else {
                // Wrong note!
                if (!sc_noteHadMistake) {
                    sc_totalMistakes++;
                    sc_noteHadMistake = true;
                    sc_roundHadMistake = true;
                    scShowFeedback('✗', false);
                    scUpdateScoreDisplay();
                }
                highlightKey('sc_pianoSvg', midi, 'key-wrong');
            }
        }

        function scOnNoteOff(midi) {
            highlightKey('sc_pianoSvg', midi, 'key-held', false);
            highlightKey('sc_pianoSvg', midi, 'key-active', false);
            highlightKey('sc_pianoSvg', midi, 'key-wrong', false);
        }

        function scUpdateResponseTime(seconds) {
            const el = document.getElementById('sc_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 3 ? 'timer-fast' : seconds < 6 ? 'timer-medium' : 'timer-slow');
        }

        function scUpdateScoreDisplay() {
            const currentNoteIdx = sc_challenge ? sc_challenge.currentNoteIndex : 0;
            const totalNotes = (sc_currentRound - 1) * 7 + currentNoteIdx;
            const pct = totalNotes > 0 ? Math.round((sc_firstTryCorrect / totalNotes) * 100) : 0;
            document.getElementById('sc_scoreDisplay').innerText = pct + '%';
            document.getElementById('sc_mistakesDisplay').innerText = sc_totalMistakes;
        }

        function scShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('sc_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function scEndGame() {
            sc_isPlaying = false;
            sc_challenge = null;
            clearAllHighlights('sc_pianoSvg');

            const totalNotes = sc_config.totalRounds * 7;
            const accuracy = totalNotes > 0 ? Math.min(100, Math.round((sc_firstTryCorrect / totalNotes) * 100)) : 0;
            const avgTime = sc_allTimes.length > 0 ? sc_allTimes.reduce((a, b) => a + b, 0) / sc_allTimes.length : 0;

            sc_history.unshift({
                date: new Date().toISOString(),
                config: { ...sc_config },
                score: sc_firstTryCorrect,
                totalRounds: sc_config.totalRounds,
                totalNotes: totalNotes,
                accuracy, avgTime,
                totalMistakes: sc_totalMistakes,
                stats: JSON.parse(JSON.stringify(sc_stats))
            });
            if (sc_history.length > 50) sc_history.pop();
            localStorage.setItem('scGameHistory', JSON.stringify(sc_history));
            scUpdateCumulativeStats();

            scShowGameComplete();
        }

        function scShowGameComplete() {
            const totalNotes = sc_currentRound * 7;
            const accuracy = totalNotes > 0 ? Math.min(100, Math.round((sc_firstTryCorrect / totalNotes) * 100)) : 0;
            const avgTime = sc_allTimes.length > 0 ? sc_allTimes.reduce((a, b) => a + b, 0) / sc_allTimes.length : 0;

            document.getElementById('sc_finalScore').innerText = `${sc_firstTryCorrect}/${totalNotes} notes`;
            document.getElementById('sc_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('sc_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('sc_finalMistakes').innerText = sc_totalMistakes;
            document.getElementById('sc_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('sc_finalAvgTime').className = `text-3xl font-bold ${avgTime < 3 ? 'text-green-400' : avgTime < 6 ? 'text-yellow-400' : 'text-red-400'}`;

            const weak = Object.entries(sc_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('sc_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('sc_challengeDisplay').classList.add('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('sc_stopBtn').classList.add('hidden');
            document.getElementById('sc_playAgainBtn').classList.remove('hidden');
            document.getElementById('sc_newGameBtn').classList.remove('hidden');

            scShowBreakdown();
            scRenderHistory();
        }

        function scShowBreakdown() {
            const grid = document.getElementById('sc_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(sc_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('sc_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [scale, data] of Object.entries(sc_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${scale}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('sc_breakdownSection').classList.remove('hidden');
        }

        function scPlayAgain() {
            sc_currentRound = 0; sc_firstTryCorrect = 0; sc_totalMistakes = 0;
            sc_roundHadMistake = false; sc_noteHadMistake = false; sc_usedChallenges = new Set();
            sc_stats = {}; sc_allTimes = [];
            document.getElementById('sc_roundDisplay').innerText = '0';
            document.getElementById('sc_responseTime').innerText = '--';
            document.getElementById('sc_scoreDisplay').innerText = '0%';
            document.getElementById('sc_mistakesDisplay').innerText = '0';
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_stopBtn').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.remove('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');
            scRunCountdown(3);
        }

        function scNewGame() {
            document.getElementById('sc_settingsPanel').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.add('hidden');
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_startBtn').classList.remove('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');
        }

        function scLoadHistory() {
            const saved = localStorage.getItem('scGameHistory');
            if (saved) { sc_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('scCumulativeStats');
            if (savedCumulative) { sc_cumulativeStats = JSON.parse(savedCumulative); }
            scRenderHistory();
        }

        function scUpdateCumulativeStats() {
            for (const [scaleName, data] of Object.entries(sc_stats)) {
                if (!sc_cumulativeStats[scaleName]) {
                    sc_cumulativeStats[scaleName] = { attempts: 0, firstTry: 0, totalTime: 0 };
                }
                sc_cumulativeStats[scaleName].attempts += data.total;
                sc_cumulativeStats[scaleName].firstTry += data.firstTry;
                sc_cumulativeStats[scaleName].totalTime += data.times.reduce((a, b) => a + b, 0);
            }
            localStorage.setItem('scCumulativeStats', JSON.stringify(sc_cumulativeStats));
        }

        function scGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(sc_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = 100 - successRate; // No slow tracking for scales
                    areas.push({ name, successRate, slowRate: 0, avgTime, attempts: data.attempts, firstTry: data.firstTry, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function scClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            sc_history = [];
            sc_cumulativeStats = {};
            localStorage.removeItem('scGameHistory');
            localStorage.removeItem('scCumulativeStats');
            scRenderHistory();
        }

        function scRenderHistory() {
            const content = document.getElementById('sc_historyContent');
            if (sc_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = sc_history.length;
            const avgAccuracy = Math.min(100, Math.round(sc_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            const displayedGames = sc_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const totalNotes = game.totalNotes || game.totalRounds * 7;
                const noteScore = game.score !== undefined ? Math.min(game.score, totalNotes) : Math.round(Math.min(game.accuracy, 100) * totalNotes / 100);
                const displayAccuracy = Math.min(game.accuracy, 100);
                // Config: chord types
                const types = game.config?.chordTypes || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${noteScore}/${totalNotes}</span><span class="text-xs text-purple-400 ml-1">${typeStr}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = scGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ EXTENSIONS MODE ============
        let ext_isPlaying = false;
        let ext_config = { totalRounds: 12, chordTypes: ['maj7', 'min7', 'dom7'], extensions: ['9', '11', '13'] };
        let ext_currentRound = 0;
        let ext_firstTryCorrect = 0;
        let ext_totalMistakes = 0;
        let ext_roundHadMistake = false;
        let ext_challenge = null;
        let ext_startTime = null;
        let ext_usedChallenges = new Set();
        let ext_stats = {};
        let ext_allTimes = [];
        let ext_slowCount = 0; // Chords taking > 2 seconds
        let ext_history = [];
        let ext_cumulativeStats = {}; // Persistent stats across all games
        let ext_heldNotes = new Set();

        function extStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('ext_chordTypeSelect').value;
            const extensionSetting = document.getElementById('ext_extensionSelect').value;
            const showHints = document.getElementById('ext_showHints').checked;
            const focusProblemAreas = document.getElementById('ext_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = extGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "Cmaj9" -> { pitchClass, chordType, extension }
                problemAreaChallenges = [];
                problemAreas.forEach(area => {
                    // Parse names like "Cmaj9", "Dm11", "G13"
                    const match = area.name.match(/^([A-G]b?)(.+?)(9|11|13)$/);
                    if (match) {
                        const noteName = match[1];
                        const typeStr = match[2]; // "maj", "m", ""
                        const ext = match[3];
                        const pitchClass = NOTE_NAMES.indexOf(noteName);
                        let chordType = typeStr === 'maj' ? 'maj7' : typeStr === 'm' ? 'min7' : 'dom7';
                        if (pitchClass >= 0) {
                            problemAreaChallenges.push({ pitchClass, chordType, extension: ext, name: area.name });
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            ext_config = {
                totalRounds: parseInt(document.getElementById('ext_roundsSelect').value),
                chordTypes: chordTypeSetting === 'all' ? ['maj7', 'min7', 'dom7'] : [chordTypeSetting],
                extensions: extensionSetting === 'all' ? ['9', '11', '13'] : [extensionSetting],
                showHints,
                focusProblemAreas,
                problemAreaChallenges
            };
            ext_currentRound = 0; ext_firstTryCorrect = 0; ext_totalMistakes = 0; ext_slowCount = 0;
            ext_roundHadMistake = false; ext_usedChallenges = new Set();
            ext_stats = {}; ext_allTimes = [];

            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_totalRoundsDisplay').innerText = ext_config.totalRounds;
            document.getElementById('ext_responseTime').innerText = '--';
            document.getElementById('ext_scoreDisplay').innerText = '0%';
            document.getElementById('ext_mistakesDisplay').innerText = '0';
            document.getElementById('ext_slowDisplay').innerText = '0';
            document.getElementById('ext_startBtn').classList.add('hidden');
            document.getElementById('ext_stopBtn').classList.remove('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_settingsPanel').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.remove('hidden');
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');

            // Show/hide formula hint based on setting
            document.getElementById('ext_formulaHint').style.display = showHints ? 'inline' : 'none';

            extRunCountdown(3);
        }

        function extRunCountdown(count) {
            if (count > 0) {
                document.getElementById('ext_chordDisplay').innerText = count;
                document.getElementById('ext_noteCount').innerText = '';
                document.getElementById('ext_formulaDisplay').innerText = 'Get ready...';
                document.getElementById('ext_heldNotes').innerText = 'Get ready...';
                setTimeout(() => extRunCountdown(count - 1), 800);
            } else {
                ext_isPlaying = true;
                extNextChallenge();
            }
        }

        function extStopGame() {
            ext_isPlaying = false;
            ext_challenge = null;
            clearAllHighlights('ext_pianoSvg');
            extShowGameComplete();
        }

        function extNextChallenge() {
            if (ext_currentRound >= ext_config.totalRounds) {
                ext_isPlaying = false;
                extShowGameComplete();
                return;
            }

            ext_currentRound++;
            ext_roundHadMistake = false;
            ext_heldNotes.clear();
            clearAllHighlights('ext_pianoSvg');
            document.getElementById('ext_roundDisplay').innerText = ext_currentRound;

            // Generate challenge (avoid duplicates)
            let challenge;
            let attempts = 0;

            if (ext_config.focusProblemAreas && ext_config.problemAreaChallenges) {
                // Focus on problem areas
                do {
                    const problemArea = ext_config.problemAreaChallenges[Math.floor(Math.random() * ext_config.problemAreaChallenges.length)];
                    const key = `${problemArea.pitchClass}-${problemArea.chordType}-${problemArea.extension}`;
                    if (!ext_usedChallenges.has(key) || attempts > 50) {
                        ext_usedChallenges.add(key);
                        challenge = getExtendedChord(problemArea.pitchClass, problemArea.chordType, problemArea.extension);
                        break;
                    }
                    attempts++;
                } while (true);
            } else {
                // Normal mode
                do {
                    const root = Math.floor(Math.random() * 12);
                    const chordType = ext_config.chordTypes[Math.floor(Math.random() * ext_config.chordTypes.length)];
                    const extension = ext_config.extensions[Math.floor(Math.random() * ext_config.extensions.length)];
                    const key = `${root}-${chordType}-${extension}`;
                    if (!ext_usedChallenges.has(key) || attempts > 50) {
                        ext_usedChallenges.add(key);
                        challenge = getExtendedChord(root, chordType, extension);
                        break;
                    }
                    attempts++;
                } while (true);
            }

            ext_challenge = challenge;
            ext_startTime = Date.now();
            ext_heldNotes.clear();

            // Update display
            document.getElementById('ext_chordDisplay').innerText = challenge.chordName;
            document.getElementById('ext_noteCount').innerText = challenge.noteCount;
            document.getElementById('ext_formulaDisplay').innerText = challenge.formula.join(' - ');
            document.getElementById('ext_heldNotes').innerText = 'Holding: --';

            ext_isPlaying = true; // Re-enable input for new challenge
        }

        function extUpdateHeldDisplay() {
            if (!ext_challenge) return;
            const heldPitchClasses = new Set([...ext_heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]);
            document.getElementById('ext_heldNotes').innerText = heldNames.length > 0 ? 'Holding: ' + heldNames.join(' ') : 'Holding: --';
        }

        function extOnNoteOn(midi) {
            if (!ext_isPlaying || !ext_challenge) return;

            highlightKey('ext_pianoSvg', midi, 'key-held');
            ext_heldNotes.add(midi);

            const notePitchClass = midi % 12;
            const isWrongNote = !ext_challenge.pitchClasses.has(notePitchClass);

            if (isWrongNote && !ext_roundHadMistake) {
                ext_totalMistakes++;
                ext_roundHadMistake = true;
                extShowFeedback('✗', false);
                document.getElementById('ext_mistakesDisplay').innerText = ext_totalMistakes;
                highlightKey('ext_pianoSvg', midi, 'key-wrong');
            }

            extUpdateHeldDisplay();

            // Check if all required notes are held simultaneously
            const heldPitchClasses = new Set([...ext_heldNotes].map(n => n % 12));
            const allCorrect = [...ext_challenge.pitchClasses].every(pc => heldPitchClasses.has(pc));

            if (allCorrect && heldPitchClasses.size >= ext_challenge.pitchClasses.size) {
                ext_isPlaying = false; // Prevent mistakes during transition
                const elapsed = ((Date.now() - ext_startTime) / 1000).toFixed(2);
                const responseTime = parseFloat(elapsed);
                ext_allTimes.push(responseTime);

                // Track stats by full chord name (includes root)
                const statKey = ext_challenge.chordName;
                if (!ext_stats[statKey]) ext_stats[statKey] = { correct: 0, total: 0, slow: 0 };
                ext_stats[statKey].total++;

                // Track slow responses (> 2 seconds)
                const wasSlow = responseTime > 2;
                if (wasSlow) {
                    ext_slowCount++;
                    ext_stats[statKey].slow++;
                    document.getElementById('ext_slowDisplay').innerText = ext_slowCount;
                }
                document.getElementById('ext_responseTime').innerText = elapsed + 's';

                if (!ext_roundHadMistake) {
                    ext_firstTryCorrect++;
                    ext_stats[statKey].correct++;
                }
                extShowFeedback('✓', true);
                const extPct = ext_currentRound > 0 ? Math.round((ext_firstTryCorrect / ext_currentRound) * 100) : 0;
                document.getElementById('ext_scoreDisplay').innerText = extPct + '%';

                clearAllHighlights('ext_pianoSvg');
                setTimeout(() => {
                    ext_heldNotes.clear();
                    ext_isPlaying = true;
                    extNextChallenge();
                }, 600);
            }
        }

        function extOnNoteOff(midi) {
            highlightKey('ext_pianoSvg', midi, 'key-held', false);
            ext_heldNotes.delete(midi);
            extUpdateHeldDisplay();
        }

        function extShowFeedback(text, isCorrect) {
            const area = document.getElementById('ext_feedbackArea');
            const div = document.createElement('div');
            div.className = `text-6xl font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'} feedback-float`;
            div.innerText = text;
            area.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function extShowGameComplete() {
            document.getElementById('ext_stopBtn').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.add('hidden');
            document.getElementById('ext_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('ext_playAgainBtn').classList.remove('hidden');
            document.getElementById('ext_newGameBtn').classList.remove('hidden');

            const accuracy = ext_currentRound > 0 ? Math.round((ext_firstTryCorrect / ext_currentRound) * 100) : 0;
            const avgTime = ext_allTimes.length > 0 ? (ext_allTimes.reduce((a, b) => a + b, 0) / ext_allTimes.length).toFixed(1) : 0;

            document.getElementById('ext_finalScore').innerText = `${ext_firstTryCorrect}/${ext_currentRound}`;
            document.getElementById('ext_finalAccuracy').innerText = accuracy + '%';
            document.getElementById('ext_finalMistakes').innerText = ext_totalMistakes;
            document.getElementById('ext_finalAvgTime').innerText = avgTime + 's';
            document.getElementById('ext_finalSlow').innerText = ext_slowCount;
            document.getElementById('ext_finalSlow').className = `text-3xl font-bold ${ext_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Weak areas
            const weakAreas = [];
            for (const [key, stats] of Object.entries(ext_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                if (pct < 70) {
                    const [chordType, ext] = key.split('-');
                    const typeName = chordType === 'maj7' ? 'maj' : chordType === 'min7' ? 'min' : 'dom';
                    weakAreas.push(`${typeName}${ext} (${pct}%)`);
                }
            }
            document.getElementById('ext_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Practice more: ' + weakAreas.join(', ') : '';

            // Save history
            ext_history.unshift({ date: new Date().toISOString(), score: ext_firstTryCorrect, totalRounds: ext_currentRound, accuracy, avgTime: parseFloat(avgTime), mistakes: ext_totalMistakes, slowCount: ext_slowCount });
            localStorage.setItem('extGameHistory', JSON.stringify(ext_history.slice(0, 50)));
            extSaveCumulativeStats();
            extRenderHistory();

            // Breakdown
            extShowBreakdown();
        }

        function extShowBreakdown() {
            const grid = document.getElementById('ext_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(ext_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('ext_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [key, stats] of Object.entries(ext_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                const isSlow = stats.slow > 0;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${stats.correct}/${stats.total})</p>${isSlow ? '<p class="text-xs text-orange-400">⏱ slow</p>' : ''}`;
                grid.appendChild(div);
            }
            document.getElementById('ext_breakdownSection').classList.remove('hidden');
        }

        function extPlayAgain() {
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.remove('hidden');
            document.getElementById('ext_stopBtn').classList.remove('hidden');
            ext_currentRound = 0; ext_firstTryCorrect = 0; ext_totalMistakes = 0; ext_slowCount = 0;
            ext_usedChallenges.clear(); ext_stats = {}; ext_allTimes = [];
            document.getElementById('ext_scoreDisplay').innerText = '0%';
            document.getElementById('ext_mistakesDisplay').innerText = '0';
            document.getElementById('ext_slowDisplay').innerText = '0';
            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_responseTime').innerText = '--';
            extRunCountdown(3);
        }

        function extNewGame() {
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_settingsPanel').classList.remove('hidden');
            document.getElementById('ext_startBtn').classList.remove('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');
            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_responseTime').innerText = '--';
        }

        function extLoadHistory() {
            const saved = localStorage.getItem('extGameHistory');
            if (saved) { ext_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('extCumulativeStats');
            if (savedCumulative) { ext_cumulativeStats = JSON.parse(savedCumulative); }
            extRenderHistory();
        }

        function extSaveCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [chordName, data] of Object.entries(ext_stats)) {
                if (!ext_cumulativeStats[chordName]) {
                    ext_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, slow: 0 };
                }
                ext_cumulativeStats[chordName].attempts += data.total;
                ext_cumulativeStats[chordName].firstTry += data.correct;
                ext_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('extCumulativeStats', JSON.stringify(ext_cumulativeStats));
        }

        function extGetProblemAreas() {
            // Return chords sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(ext_cumulativeStats)) {
                if (data.attempts >= 3) { // Only include chords with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function extClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            ext_history = [];
            ext_cumulativeStats = {};
            localStorage.removeItem('extGameHistory');
            localStorage.removeItem('extCumulativeStats');
            extRenderHistory();
        }

        function extRenderHistory() {
            const content = document.getElementById('ext_historyContent');
            if (ext_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = ext_history.length;
            const avgAccuracy = Math.round(ext_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = ext_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: chord types and extensions
                const types = game.config?.chordTypes || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                const exts = game.config?.extensions || ['9', '11', '13'];
                const extStr = exts.length === 3 ? '' : exts.join('/');
                const configStr = [typeStr, extStr].filter(Boolean).join(' ');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = extGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ALTERED EXTENSIONS MODE ============
        // Altered intervals: b9=1, #9=3, #11=6, b13=8 (semitones from root)
        const ALTERED_INTERVALS = {
            'b9': { interval: 1, formula: 'b9' },
            '#9': { interval: 3, formula: '#9' },
            '#11': { interval: 6, formula: '#11' },
            'b13': { interval: 8, formula: 'b13' }
        };

        function getAlteredChord(root, alteration, voicing = 'full') {
            // Base dom7: 0, 4, 7, 10 (R, 3, 5, b7)
            const base = [0, 4, 7, 10].map(i => (root + i) % 12);
            const altInterval = ALTERED_INTERVALS[alteration].interval;
            const altNote = (root + altInterval) % 12;

            // For full voicing, #11 and b13 include the natural 9th (like extended chords)
            const includeNinth = voicing === 'full' && (alteration === '#11' || alteration === 'b13');
            const ninthNote = (root + 2) % 12; // natural 9th = 2 semitones

            let allNotes, formula;
            if (includeNinth) {
                allNotes = [...base, ninthNote, altNote];
                formula = ['1', '3', '5', 'b7', '9', alteration];
            } else {
                allNotes = [...base, altNote];
                formula = ['1', '3', '5', 'b7', alteration];
            }

            // Build display name
            const rootName = NOTE_NAMES[root];
            const chordName = rootName + '7' + alteration;

            // Get actual note names for display
            const noteNames = allNotes.map(pc => NOTE_NAMES[pc]);

            return {
                root,
                alteration,
                chordName,
                pitchClasses: new Set(allNotes),
                noteCount: allNotes.length,
                formula,
                noteNames
            };
        }

        let alt_isPlaying = false;
        let alt_config = { totalRounds: 12, alterations: ['b9', '#9', '#11', 'b13'] };
        let alt_currentRound = 0;
        let alt_firstTryCorrect = 0;
        let alt_totalMistakes = 0;
        let alt_roundHadMistake = false;
        let alt_challenge = null;
        let alt_startTime = null;
        let alt_usedChallenges = new Set();
        let alt_stats = {};
        let alt_allTimes = [];
        let alt_slowCount = 0; // Chords taking > 2 seconds
        let alt_history = [];
        let alt_cumulativeStats = {}; // Persistent stats across all games
        let alt_heldNotes = new Set();

        function altStartGame() {
            saveAllSettings();
            const alterationSetting = document.getElementById('alt_alterationSelect').value;
            const voicingSetting = document.getElementById('alt_voicingSelect').value;
            const focusProblemAreas = document.getElementById('alt_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = altGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C7b9" -> { pitchClass, alteration }
                problemAreaChallenges = [];
                problemAreas.forEach(area => {
                    const match = area.name.match(/^([A-G]b?)7(b9|#9|#11|b13)$/);
                    if (match) {
                        const noteName = match[1];
                        const alteration = match[2];
                        const pitchClass = NOTE_NAMES.indexOf(noteName);
                        if (pitchClass >= 0) {
                            problemAreaChallenges.push({ pitchClass, alteration, name: area.name });
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            alt_config = {
                totalRounds: parseInt(document.getElementById('alt_roundsSelect').value),
                alterations: alterationSetting === 'all' ? ['b9', '#9', '#11', 'b13'] : [alterationSetting],
                voicing: voicingSetting,
                focusProblemAreas,
                problemAreaChallenges
            };
            alt_currentRound = 0; alt_firstTryCorrect = 0; alt_totalMistakes = 0; alt_slowCount = 0;
            alt_roundHadMistake = false; alt_usedChallenges = new Set();
            alt_stats = {}; alt_allTimes = [];

            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_totalRoundsDisplay').innerText = alt_config.totalRounds;
            document.getElementById('alt_responseTime').innerText = '--';
            document.getElementById('alt_scoreDisplay').innerText = '0%';
            document.getElementById('alt_mistakesDisplay').innerText = '0';
            document.getElementById('alt_slowDisplay').innerText = '0';
            document.getElementById('alt_startBtn').classList.add('hidden');
            document.getElementById('alt_stopBtn').classList.remove('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_settingsPanel').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.remove('hidden');
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');

            altRunCountdown(3);
        }

        function altRunCountdown(count) {
            if (count > 0) {
                document.getElementById('alt_chordDisplay').innerText = count;
                document.getElementById('alt_noteCount').innerText = '';
                document.getElementById('alt_formulaDisplay').innerText = 'Get ready...';
                document.getElementById('alt_noteIndicators').innerHTML = '';
                setTimeout(() => altRunCountdown(count - 1), 800);
            } else {
                alt_isPlaying = true;
                altNextChallenge();
            }
        }

        function altStopGame() {
            alt_isPlaying = false;
            alt_challenge = null;
            clearAllHighlights('alt_pianoSvg');
            altShowGameComplete();
        }

        function altNextChallenge() {
            if (alt_currentRound >= alt_config.totalRounds) {
                alt_isPlaying = false;
                altShowGameComplete();
                return;
            }

            alt_currentRound++;
            alt_roundHadMistake = false;
            alt_heldNotes.clear();
            clearAllHighlights('alt_pianoSvg');
            document.getElementById('alt_roundDisplay').innerText = alt_currentRound;

            // Generate challenge (avoid duplicates)
            let challenge;
            let attempts = 0;

            if (alt_config.focusProblemAreas && alt_config.problemAreaChallenges) {
                // Focus on problem areas
                do {
                    const problemArea = alt_config.problemAreaChallenges[Math.floor(Math.random() * alt_config.problemAreaChallenges.length)];
                    const key = `${problemArea.pitchClass}-${problemArea.alteration}`;
                    if (!alt_usedChallenges.has(key) || attempts > 50) {
                        alt_usedChallenges.add(key);
                        challenge = getAlteredChord(problemArea.pitchClass, problemArea.alteration, alt_config.voicing);
                        break;
                    }
                    attempts++;
                } while (true);
            } else {
                // Normal mode
                do {
                    const root = Math.floor(Math.random() * 12);
                    const alteration = alt_config.alterations[Math.floor(Math.random() * alt_config.alterations.length)];
                    const key = `${root}-${alteration}`;
                    if (!alt_usedChallenges.has(key) || attempts > 50) {
                        alt_usedChallenges.add(key);
                        challenge = getAlteredChord(root, alteration, alt_config.voicing);
                        break;
                    }
                    attempts++;
                } while (true);
            }

            alt_challenge = challenge;
            alt_startTime = Date.now();
            alt_heldNotes.clear();

            // Update display
            document.getElementById('alt_chordDisplay').innerText = challenge.chordName;
            document.getElementById('alt_noteCount').innerText = challenge.noteCount;
            document.getElementById('alt_formulaDisplay').innerText = challenge.formula.join(' - ');
            document.getElementById('alt_heldNotes').innerText = 'Holding: --';
        }

        function altUpdateHeldDisplay() {
            if (!alt_challenge) return;
            const heldPitchClasses = new Set([...alt_heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]);
            document.getElementById('alt_heldNotes').innerText = heldNames.length > 0 ? 'Holding: ' + heldNames.join(' ') : 'Holding: --';
        }

        function altOnNoteOn(midi) {
            if (!alt_isPlaying || !alt_challenge) return;

            highlightKey('alt_pianoSvg', midi, 'key-held');
            alt_heldNotes.add(midi);

            const notePitchClass = midi % 12;
            const isWrongNote = !alt_challenge.pitchClasses.has(notePitchClass);

            if (isWrongNote && !alt_roundHadMistake) {
                alt_totalMistakes++;
                alt_roundHadMistake = true;
                altShowFeedback('✗', false);
                document.getElementById('alt_mistakesDisplay').innerText = alt_totalMistakes;
                highlightKey('alt_pianoSvg', midi, 'key-wrong');
            }

            altUpdateHeldDisplay();

            // Check if all required notes are held simultaneously
            const heldPitchClasses = new Set([...alt_heldNotes].map(n => n % 12));
            const allCorrect = [...alt_challenge.pitchClasses].every(pc => heldPitchClasses.has(pc));

            if (allCorrect && heldPitchClasses.size >= alt_challenge.pitchClasses.size) {
                alt_isPlaying = false; // Prevent mistakes during transition
                const elapsed = ((Date.now() - alt_startTime) / 1000).toFixed(2);
                const responseTime = parseFloat(elapsed);
                alt_allTimes.push(responseTime);

                // Track stats by full chord name (includes root)
                const statKey = alt_challenge.chordName;
                if (!alt_stats[statKey]) alt_stats[statKey] = { correct: 0, total: 0, slow: 0 };
                alt_stats[statKey].total++;

                // Track slow responses (> 2 seconds)
                const wasSlow = responseTime > 2;
                if (wasSlow) {
                    alt_slowCount++;
                    alt_stats[statKey].slow++;
                    document.getElementById('alt_slowDisplay').innerText = alt_slowCount;
                }
                document.getElementById('alt_responseTime').innerText = elapsed + 's';

                if (!alt_roundHadMistake) {
                    alt_firstTryCorrect++;
                    alt_stats[statKey].correct++;
                }
                altShowFeedback('✓', true);
                const altPct = alt_currentRound > 0 ? Math.round((alt_firstTryCorrect / alt_currentRound) * 100) : 0;
                document.getElementById('alt_scoreDisplay').innerText = altPct + '%';

                clearAllHighlights('alt_pianoSvg');
                setTimeout(() => {
                    alt_heldNotes.clear();
                    alt_isPlaying = true;
                    altNextChallenge();
                }, 600);
            }
        }

        function altOnNoteOff(midi) {
            highlightKey('alt_pianoSvg', midi, 'key-held', false);
            alt_heldNotes.delete(midi);
            altUpdateHeldDisplay();
        }

        function altShowFeedback(text, isCorrect) {
            const area = document.getElementById('alt_feedbackArea');
            const div = document.createElement('div');
            div.className = `text-6xl font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'} feedback-float`;
            div.innerText = text;
            area.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function altShowGameComplete() {
            document.getElementById('alt_stopBtn').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.add('hidden');
            document.getElementById('alt_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('alt_playAgainBtn').classList.remove('hidden');
            document.getElementById('alt_newGameBtn').classList.remove('hidden');

            const accuracy = alt_currentRound > 0 ? Math.round((alt_firstTryCorrect / alt_currentRound) * 100) : 0;
            const avgTime = alt_allTimes.length > 0 ? (alt_allTimes.reduce((a, b) => a + b, 0) / alt_allTimes.length).toFixed(1) : 0;

            document.getElementById('alt_finalScore').innerText = `${alt_firstTryCorrect}/${alt_currentRound}`;
            document.getElementById('alt_finalAccuracy').innerText = accuracy + '%';
            document.getElementById('alt_finalMistakes').innerText = alt_totalMistakes;
            document.getElementById('alt_finalAvgTime').innerText = avgTime + 's';
            document.getElementById('alt_finalSlow').innerText = alt_slowCount;
            document.getElementById('alt_finalSlow').className = `text-3xl font-bold ${alt_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Weak areas
            const weakAreas = [];
            for (const [key, stats] of Object.entries(alt_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                if (pct < 70) weakAreas.push(`7${key} (${pct}%)`);
            }
            document.getElementById('alt_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Practice more: ' + weakAreas.join(', ') : '';

            // Save history
            alt_history.unshift({ date: new Date().toISOString(), score: alt_firstTryCorrect, totalRounds: alt_currentRound, accuracy, avgTime: parseFloat(avgTime), mistakes: alt_totalMistakes, slowCount: alt_slowCount });
            localStorage.setItem('altGameHistory', JSON.stringify(alt_history.slice(0, 50)));
            altSaveCumulativeStats();
            altRenderHistory();

            // Breakdown
            altShowBreakdown();
        }

        function altShowBreakdown() {
            const grid = document.getElementById('alt_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(alt_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('alt_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [key, stats] of Object.entries(alt_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                const isSlow = stats.slow > 0;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                div.innerHTML = `<p class="font-semibold">7${key}</p><p>${pct}% (${stats.correct}/${stats.total})</p>${isSlow ? '<p class="text-xs text-orange-400">⏱ slow</p>' : ''}`;
                grid.appendChild(div);
            }
            document.getElementById('alt_breakdownSection').classList.remove('hidden');
        }

        function altPlayAgain() {
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.remove('hidden');
            document.getElementById('alt_stopBtn').classList.remove('hidden');
            alt_currentRound = 0; alt_firstTryCorrect = 0; alt_totalMistakes = 0; alt_slowCount = 0;
            alt_usedChallenges.clear(); alt_stats = {}; alt_allTimes = [];
            document.getElementById('alt_scoreDisplay').innerText = '0%';
            document.getElementById('alt_mistakesDisplay').innerText = '0';
            document.getElementById('alt_slowDisplay').innerText = '0';
            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_responseTime').innerText = '--';
            altRunCountdown(3);
        }

        function altNewGame() {
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_settingsPanel').classList.remove('hidden');
            document.getElementById('alt_startBtn').classList.remove('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');
            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_responseTime').innerText = '--';
        }

        function altLoadHistory() {
            const saved = localStorage.getItem('altGameHistory');
            if (saved) { alt_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('altCumulativeStats');
            if (savedCumulative) { alt_cumulativeStats = JSON.parse(savedCumulative); }
            altRenderHistory();
        }

        function altSaveCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [chordName, data] of Object.entries(alt_stats)) {
                if (!alt_cumulativeStats[chordName]) {
                    alt_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, slow: 0 };
                }
                alt_cumulativeStats[chordName].attempts += data.total;
                alt_cumulativeStats[chordName].firstTry += data.correct;
                alt_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('altCumulativeStats', JSON.stringify(alt_cumulativeStats));
        }

        function altGetProblemAreas() {
            // Return chords sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(alt_cumulativeStats)) {
                if (data.attempts >= 3) { // Only include chords with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function altClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            alt_history = [];
            alt_cumulativeStats = {};
            localStorage.removeItem('altGameHistory');
            localStorage.removeItem('altCumulativeStats');
            altRenderHistory();
        }

        function altRenderHistory() {
            const content = document.getElementById('alt_historyContent');
            if (alt_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = alt_history.length;
            const avgAccuracy = Math.round(alt_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = alt_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: alterations
                const alts = game.config?.alterations || ['b9', '#9', '#11', 'b13'];
                const altStr = alts.length === 4 ? 'all' : alts.join('/');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${altStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = altGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ADVANCED CHORDS MODE ============
        const ADV_CHORD_TYPES = {
            'halfdim': { name: 'halfdim', display: 'ø7', intervals: [0, 3, 6, 10], formula: 'R b3 b5 b7', noteCount: 4 },
            'dim7': { name: 'dim7', display: 'dim7', intervals: [0, 3, 6, 9], formula: 'R b3 b5 bb7', noteCount: 4 },
            'minMaj7': { name: 'minMaj7', display: 'mM7', intervals: [0, 3, 7, 11], formula: 'R b3 5 7', noteCount: 4 },
            'maj6': { name: 'maj6', display: '6', intervals: [0, 4, 7, 9], formula: 'R 3 5 6', noteCount: 4 },
            'min6': { name: 'min6', display: 'm6', intervals: [0, 3, 7, 9], formula: 'R b3 5 6', noteCount: 4 },
            'dom7sharp5': { name: 'dom7sharp5', display: '7#5', intervals: [0, 4, 8, 10], formula: 'R 3 #5 b7', noteCount: 4 },
            'dom13': { name: 'dom13', display: '13', intervals: [0, 4, 7, 10, 14, 21], formula: 'R 3 5 b7 9 13', noteCount: 5 }, // min 5 notes
            'dom7alt': { name: 'dom7alt', display: '7alt', intervals: [0, 4, 10, 3, 8], formula: 'R 3 b7 #9 b13', noteCount: 5 }, // no 5th
            'sus4': { name: 'sus4', display: 'sus4', intervals: [0, 5, 7], formula: 'R 4 5', noteCount: 3 },
            '7sus4': { name: '7sus4', display: '7sus4', intervals: [0, 5, 7, 10], formula: 'R 4 5 b7', noteCount: 4 }
        };

        let adv_isPlaying = false;
        let adv_challenge = null;
        let adv_usedChallenges = new Set();
        let adv_challengeStartTime = null;
        let adv_config = null;
        let adv_currentRound = 0;
        let adv_firstTryCorrect = 0;
        let adv_totalMistakes = 0;
        let adv_roundHadMistake = false;
        let adv_attemptHadMistake = false;
        let adv_stats = {};
        let adv_allTimes = [];
        let adv_slowCount = 0; // Chords taking > 2 seconds
        let adv_history = [];
        let adv_cumulativeStats = {}; // Persistent stats across all games

        function advSelectChords(preset) {
            document.querySelectorAll('.adv-type-cb').forEach(cb => {
                const val = cb.value;
                if (preset === 'all') cb.checked = true;
                else if (preset === 'none') cb.checked = false;
                else if (preset === 'common') cb.checked = ['halfdim', 'dim7', 'minMaj7', 'maj6', 'min6'].includes(val);
                else if (preset === 'dominant') cb.checked = ['dom7sharp5', 'dom13', 'dom7alt'].includes(val);
                else if (preset === 'diminished') cb.checked = ['halfdim', 'dim7'].includes(val);
            });
        }

        function advStartGame() {
            saveAllSettings();
            const types = Array.from(document.querySelectorAll('.adv-type-cb:checked')).map(cb => cb.value);
            if (types.length === 0) { alert('Select at least one chord type!'); return; }

            const showHints = document.getElementById('adv_showHints').checked;
            const focusProblemAreas = document.getElementById('adv_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = advGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C ø7" -> { pitchClass, type }
                const displayToType = { 'ø7': 'halfdim', 'dim7': 'dim7', 'mMaj7': 'minMaj7', '6': 'maj6', 'm6': 'min6', '7#5': 'dom7sharp5', '13': 'dom13', '7alt': 'dom7alt', 'sus4': 'sus4', '7sus4': '7sus4' };
                problemAreaChallenges = [];
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const displayType = parts.slice(1).join(' ');
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    const chordType = displayToType[displayType];
                    if (pitchClass >= 0 && chordType) {
                        problemAreaChallenges.push({ pitchClass, type: chordType, name: area.name });
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            adv_config = {
                types,
                totalRounds: parseInt(document.getElementById('adv_roundsSelect').value),
                showHints,
                focusProblemAreas,
                problemAreaChallenges
            };
            adv_currentRound = 0; adv_firstTryCorrect = 0; adv_totalMistakes = 0; adv_slowCount = 0;
            adv_roundHadMistake = false; adv_attemptHadMistake = false;
            adv_usedChallenges = new Set(); adv_stats = {}; adv_allTimes = [];

            document.getElementById('adv_roundDisplay').innerText = '0';
            document.getElementById('adv_totalRoundsDisplay').innerText = adv_config.totalRounds;
            document.getElementById('adv_responseTime').innerText = '--';
            document.getElementById('adv_scoreDisplay').innerText = '0%';
            document.getElementById('adv_mistakesDisplay').innerText = '0';
            document.getElementById('adv_slowDisplay').innerText = '0';
            document.getElementById('adv_startBtn').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.remove('hidden');
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_settingsPanel').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');

            // Show/hide formula hint based on setting
            document.getElementById('adv_chordFormula').style.display = showHints ? 'block' : 'none';

            advRunCountdown(3);
        }

        function advRunCountdown(count) {
            if (count > 0) {
                document.getElementById('adv_chordRoot').innerText = count;
                document.getElementById('adv_chordType').innerText = '';
                document.getElementById('adv_chordFormula').innerText = '';
                document.getElementById('adv_heldNotes').innerText = 'Get ready...';
                setTimeout(() => advRunCountdown(count - 1), 800);
            } else {
                adv_isPlaying = true;
                advNextChallenge();
            }
        }

        function advStopGame() {
            adv_isPlaying = false;
            adv_challenge = null;
            clearAllHighlights('adv_pianoSvg');
            document.getElementById('adv_settingsPanel').classList.remove('hidden');
            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.add('hidden');
            document.getElementById('adv_startBtn').classList.remove('hidden');
        }

        function advNextChallenge() {
            if (!adv_isPlaying) return;
            if (adv_currentRound >= adv_config.totalRounds) { advEndGame(); return; }

            clearAllHighlights('adv_pianoSvg');
            adv_currentRound++;
            adv_roundHadMistake = false;
            adv_attemptHadMistake = false;

            document.getElementById('adv_roundDisplay').innerText = adv_currentRound;

            let root, type, challengeKey;

            if (adv_config.focusProblemAreas && adv_config.problemAreaChallenges) {
                // Focus on problem areas
                const maxUnique = adv_config.problemAreaChallenges.length;
                if (adv_usedChallenges.size >= maxUnique) {
                    adv_usedChallenges.clear();
                }

                let attempts = 0;
                do {
                    const problemArea = adv_config.problemAreaChallenges[Math.floor(Math.random() * adv_config.problemAreaChallenges.length)];
                    root = problemArea.pitchClass;
                    type = problemArea.type;
                    challengeKey = `${root}-${type}`;
                    attempts++;
                } while (adv_usedChallenges.has(challengeKey) && attempts < 100);
            } else {
                // Normal mode
                const maxUnique = 12 * adv_config.types.length;
                if (adv_usedChallenges.size >= maxUnique) {
                    adv_usedChallenges.clear();
                }

                let attempts = 0;
                do {
                    root = Math.floor(Math.random() * 12);
                    type = adv_config.types[Math.floor(Math.random() * adv_config.types.length)];
                    challengeKey = `${root}-${type}`;
                    attempts++;
                } while (adv_usedChallenges.has(challengeKey) && attempts < 100);
            }

            adv_usedChallenges.add(challengeKey);

            const chordDef = ADV_CHORD_TYPES[type];
            const requiredPitchClasses = new Set(chordDef.intervals.map(i => (root + i) % 12));

            adv_challenge = {
                root,
                type,
                requiredPitchClasses,
                noteCount: chordDef.noteCount,
                name: `${NOTE_NAMES[root]} ${chordDef.display}`
            };
            adv_challengeStartTime = Date.now();

            document.getElementById('adv_chordRoot').innerText = NOTE_NAMES[root];
            document.getElementById('adv_chordType').innerText = chordDef.display;
            document.getElementById('adv_chordFormula').innerText = chordDef.formula;
            document.getElementById('adv_heldNotes').innerText = 'Holding: --';
        }

        function advOnNoteOn(midi) {
            if (!adv_isPlaying || !adv_challenge) return;

            highlightKey('adv_pianoSvg', midi, 'key-held');

            const notePitchClass = midi % 12;
            const isWrongNote = !adv_challenge.requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!adv_attemptHadMistake) {
                    adv_totalMistakes++;
                    adv_attemptHadMistake = true;
                    adv_roundHadMistake = true;
                    advShowFeedback('✗', false);
                    advUpdateScoreDisplay();
                }
                highlightKey('adv_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('adv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const hasAllRequired = [...adv_challenge.requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= adv_challenge.noteCount) {
                const responseTime = (Date.now() - adv_challengeStartTime) / 1000;
                const chordKey = adv_challenge.name;

                if (!adv_stats[chordKey]) adv_stats[chordKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                adv_stats[chordKey].total++;

                if (!adv_roundHadMistake) {
                    adv_firstTryCorrect++;
                    adv_stats[chordKey].firstTry++;
                    adv_stats[chordKey].times.push(responseTime);
                    adv_allTimes.push(responseTime);
                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        adv_slowCount++;
                        adv_stats[chordKey].slow++;
                        document.getElementById('adv_slowDisplay').innerText = adv_slowCount;
                    }
                    advShowFeedback('✓', true, responseTime);
                    advUpdateResponseTime(responseTime);
                } else {
                    advShowFeedback('✓', true);
                }
                advUpdateScoreDisplay();

                // Highlight correct notes green
                heldNotes.forEach(n => {
                    if (adv_challenge.requiredPitchClasses.has(n % 12)) {
                        highlightKey('adv_pianoSvg', n, 'key-active');
                    }
                });

                adv_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { adv_isPlaying = true; advNextChallenge(); }, 600);
            }
        }

        function advOnNoteOff(midi) {
            highlightKey('adv_pianoSvg', midi, 'key-held', false);
            highlightKey('adv_pianoSvg', midi, 'key-active', false);
            highlightKey('adv_pianoSvg', midi, 'key-wrong', false);

            if (adv_isPlaying && adv_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('adv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function advUpdateResponseTime(seconds) {
            const el = document.getElementById('adv_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function advUpdateScoreDisplay() {
            const pct = adv_currentRound > 0 ? Math.round((adv_firstTryCorrect / adv_currentRound) * 100) : 0;
            document.getElementById('adv_scoreDisplay').innerText = pct + '%';
            document.getElementById('adv_mistakesDisplay').innerText = adv_totalMistakes;
        }

        function advShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('adv_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function advEndGame() {
            adv_isPlaying = false;
            adv_challenge = null;
            clearAllHighlights('adv_pianoSvg');

            const accuracy = adv_config.totalRounds > 0 ? Math.min(100, Math.round((adv_firstTryCorrect / adv_config.totalRounds) * 100)) : 0;
            const avgTime = adv_allTimes.length > 0 ? adv_allTimes.reduce((a, b) => a + b, 0) / adv_allTimes.length : 0;

            adv_history.unshift({
                date: new Date().toISOString(),
                config: { ...adv_config },
                score: adv_firstTryCorrect,
                totalRounds: adv_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: adv_totalMistakes,
                slowCount: adv_slowCount,
                stats: JSON.parse(JSON.stringify(adv_stats))
            });
            if (adv_history.length > 50) adv_history.pop();
            localStorage.setItem('advGameHistory', JSON.stringify(adv_history));
            advUpdateCumulativeStats();

            advShowGameComplete();
        }

        function advShowGameComplete() {
            const accuracy = adv_currentRound > 0 ? Math.min(100, Math.round((adv_firstTryCorrect / adv_currentRound) * 100)) : 0;
            const avgTime = adv_allTimes.length > 0 ? adv_allTimes.reduce((a, b) => a + b, 0) / adv_allTimes.length : 0;

            document.getElementById('adv_finalScore').innerText = `${adv_firstTryCorrect}/${adv_currentRound}`;
            document.getElementById('adv_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('adv_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('adv_finalMistakes').innerText = adv_totalMistakes;
            document.getElementById('adv_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('adv_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('adv_finalSlow').innerText = adv_slowCount;
            document.getElementById('adv_finalSlow').className = `text-3xl font-bold ${adv_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(adv_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('adv_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('adv_stopBtn').classList.add('hidden');
            document.getElementById('adv_playAgainBtn').classList.remove('hidden');
            document.getElementById('adv_newGameBtn').classList.remove('hidden');

            advShowBreakdown();
            advRenderHistory();
        }

        function advShowBreakdown() {
            const grid = document.getElementById('adv_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(adv_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('adv_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chord, data] of Object.entries(adv_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chord}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('adv_breakdownSection').classList.remove('hidden');
        }

        function advPlayAgain() {
            adv_currentRound = 0; adv_firstTryCorrect = 0; adv_totalMistakes = 0; adv_slowCount = 0;
            adv_roundHadMistake = false; adv_attemptHadMistake = false;
            adv_usedChallenges = new Set(); adv_stats = {}; adv_allTimes = [];
            document.getElementById('adv_roundDisplay').innerText = '0';
            document.getElementById('adv_responseTime').innerText = '--';
            document.getElementById('adv_scoreDisplay').innerText = '0%';
            document.getElementById('adv_mistakesDisplay').innerText = '0';
            document.getElementById('adv_slowDisplay').innerText = '0';
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.remove('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');
            advRunCountdown(3);
        }

        function advNewGame() {
            document.getElementById('adv_settingsPanel').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_startBtn').classList.remove('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');
        }

        function advLoadHistory() {
            const saved = localStorage.getItem('advGameHistory');
            if (saved) { adv_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('advCumulativeStats');
            if (savedCumulative) { adv_cumulativeStats = JSON.parse(savedCumulative); }
            advRenderHistory();
        }

        function advUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(adv_stats)) {
                if (!adv_cumulativeStats[chordName]) {
                    adv_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                adv_cumulativeStats[chordName].attempts += data.total;
                adv_cumulativeStats[chordName].firstTry += data.firstTry;
                adv_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                adv_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('advCumulativeStats', JSON.stringify(adv_cumulativeStats));
        }

        function advGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(adv_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function advClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            adv_history = [];
            adv_cumulativeStats = {};
            localStorage.removeItem('advGameHistory');
            localStorage.removeItem('advCumulativeStats');
            advRenderHistory();
        }

        function advRenderHistory() {
            const content = document.getElementById('adv_historyContent');
            if (adv_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = adv_history.length;
            const avgAccuracy = Math.min(100, Math.round(adv_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            const displayedGames = adv_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const types = game.config?.types || [];
                const typeStr = types.length >= 6 ? 'all' : types.slice(0, 3).map(t => ADV_CHORD_TYPES[t]?.display || t).join('/') + (types.length > 3 ? '...' : '');
                const displayAccuracy = Math.min(game.accuracy, 100);
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${typeStr}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = advGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ MINOR ii-V-i MODE ============
        // Minor ii-V-i chord intervals (not in CHORD_TYPES)
        const MINOR_IIVI_CHORDS = {
            'halfdim': { intervals: [0, 3, 6, 10], display: 'ø7' },  // R b3 b5 b7
            'dom7': { intervals: [0, 4, 7, 10], display: '7' },       // R 3 5 b7
            'minMaj7': { intervals: [0, 3, 7, 11], display: 'mM7' }   // R b3 5 7
        };

        let miivi_isPlaying = false;
        let miivi_challenge = null;
        let miivi_usedKeys = new Set();
        let miivi_challengeStartTime = null;
        let miivi_stepStartTime = null;
        let miivi_stepTimes = [];
        let miivi_config = null;
        let miivi_currentRound = 0;
        let miivi_firstTryCorrect = 0;
        let miivi_totalMistakes = 0;
        let miivi_roundHadMistake = false;
        let miivi_attemptHadMistake = false;
        let miivi_stats = {};
        let miivi_allTimes = [];
        let miivi_slowCount = 0; // Chords taking > 2 seconds
        let miivi_history = [];
        let miivi_cumulativeStats = {}; // Persistent stats across all games

        function miiviGetProgression(key) {
            // Minor ii-V-i:
            // ii = half-diminished built on 2nd degree
            // V = dominant 7 built on 5th degree
            // i = minor-major 7 built on root
            const iiRoot = (key + 2) % 12;
            const VRoot = (key + 7) % 12;
            const iRoot = key;

            return [
                {
                    root: iiRoot,
                    type: 'halfdim',
                    name: NOTE_NAMES[iiRoot] + 'ø7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.halfdim.intervals.map(i => (iiRoot + i) % 12))
                },
                {
                    root: VRoot,
                    type: 'dom7',
                    name: NOTE_NAMES[VRoot] + '7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.dom7.intervals.map(i => (VRoot + i) % 12))
                },
                {
                    root: iRoot,
                    type: 'minMaj7',
                    name: NOTE_NAMES[iRoot] + 'mM7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.minMaj7.intervals.map(i => (iRoot + i) % 12))
                }
            ];
        }

        function miiviStartGame() {
            saveAllSettings();

            const focusProblemAreas = document.getElementById('miivi_focusProblemAreas').checked;
            let problemAreaKeys = null;

            if (focusProblemAreas) {
                const problemAreas = miiviGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas into keys: "C minor" -> pitchClass 0
                problemAreaKeys = [];
                problemAreas.forEach(area => {
                    const parts = area.name.split(' ');
                    const noteName = parts[0];
                    const pitchClass = NOTE_NAMES.indexOf(noteName);
                    if (pitchClass >= 0) {
                        problemAreaKeys.push(pitchClass);
                    }
                });
                if (problemAreaKeys.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            miivi_config = {
                totalRounds: parseInt(document.getElementById('miivi_roundsSelect').value),
                twoHands: document.getElementById('miivi_twoHands').checked,
                focusProblemAreas,
                problemAreaKeys
            };
            miivi_currentRound = 0; miivi_firstTryCorrect = 0; miivi_totalMistakes = 0; miivi_slowCount = 0;
            miivi_roundHadMistake = false; miivi_attemptHadMistake = false; miivi_usedKeys = new Set();
            miivi_stats = {}; miivi_allTimes = [];

            document.getElementById('miivi_roundDisplay').innerText = '0';
            document.getElementById('miivi_totalRoundsDisplay').innerText = miivi_config.totalRounds;
            document.getElementById('miivi_responseTime').innerText = '--';
            document.getElementById('miivi_scoreDisplay').innerText = '0%';
            document.getElementById('miivi_mistakesDisplay').innerText = '0';
            document.getElementById('miivi_slowDisplay').innerText = '0';
            document.getElementById('miivi_startBtn').classList.add('hidden');
            document.getElementById('miivi_stopBtn').classList.remove('hidden');
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_settingsPanel').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');

            // Update label based on two-hands setting
            const label = miivi_config.twoHands ? 'Two hands: bass + voicing in' : 'Minor ii-V-i in';
            document.getElementById('miivi_challengeLabel').innerText = label;

            miiviRunCountdown(3);
        }

        function miiviRunCountdown(count) {
            if (count > 0) {
                document.getElementById('miivi_keyDisplay').innerText = count;
                document.getElementById('miivi_chord_ii').innerText = '...';
                document.getElementById('miivi_chord_V').innerText = '...';
                document.getElementById('miivi_chord_i').innerText = '...';
                document.getElementById('miivi_heldNotes').innerText = 'Get ready...';
                miiviResetStepStyles();
                setTimeout(() => miiviRunCountdown(count - 1), 800);
            } else {
                miivi_isPlaying = true;
                miiviNextChallenge();
            }
        }

        function miiviResetStepStyles() {
            ['ii', 'V', 'i'].forEach(step => {
                const el = document.querySelector(`#miivi_step_${step} > div`);
                el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                document.getElementById(`miivi_time_${step}`).innerText = '--';
            });
        }

        function miiviHighlightCurrentStep() {
            if (!miivi_challenge) return;
            const steps = ['ii', 'V', 'i'];
            steps.forEach((step, idx) => {
                const el = document.querySelector(`#miivi_step_${step} > div`);
                if (idx < miivi_challenge.currentStep) {
                    el.className = 'w-20 h-16 rounded-lg bg-green-700 flex flex-col items-center justify-center mb-1 border-2 border-green-500';
                } else if (idx === miivi_challenge.currentStep) {
                    el.className = 'w-20 h-16 rounded-lg bg-purple-700 flex flex-col items-center justify-center mb-1 border-2 border-purple-400';
                } else {
                    el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                }
            });
        }

        function miiviStopGame() {
            miivi_isPlaying = false;
            miivi_challenge = null;
            clearAllHighlights('miivi_pianoSvg');
            miiviShowGameComplete();
        }

        function miiviNextChallenge() {
            if (!miivi_isPlaying) return;
            if (miivi_currentRound >= miivi_config.totalRounds) { miiviEndGame(); return; }

            clearAllHighlights('miivi_pianoSvg');
            miivi_currentRound++;
            miivi_roundHadMistake = false;
            miivi_attemptHadMistake = false;
            miivi_stepTimes = [];

            let key;
            if (miivi_config.focusProblemAreas && miivi_config.problemAreaKeys) {
                // Focus on problem areas: pick from problem area keys
                if (miivi_usedKeys.size >= miivi_config.problemAreaKeys.length) {
                    miivi_usedKeys.clear();
                }
                const unusedProblemKeys = miivi_config.problemAreaKeys.filter(k => !miivi_usedKeys.has(k));
                key = unusedProblemKeys[Math.floor(Math.random() * unusedProblemKeys.length)];
            } else {
                // Normal mode: pick from all 12 keys
                if (miivi_usedKeys.size >= 12) {
                    miivi_usedKeys.clear();
                }
                const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                const unusedKeys = allKeys.filter(k => !miivi_usedKeys.has(k));
                key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            }
            miivi_usedKeys.add(key);
            const chords = miiviGetProgression(key);

            miivi_challenge = { key, chords, currentStep: 0 };
            miivi_challengeStartTime = Date.now();
            miivi_stepStartTime = Date.now();

            document.getElementById('miivi_keyDisplay').innerText = NOTE_NAMES[key] + ' minor';
            document.getElementById('miivi_chord_ii').innerText = chords[0].name;
            document.getElementById('miivi_chord_V').innerText = chords[1].name;
            document.getElementById('miivi_chord_i').innerText = chords[2].name;
            document.getElementById('miivi_heldNotes').innerText = 'Holding: --';
            document.getElementById('miivi_roundDisplay').innerText = miivi_currentRound;

            // Show/hide note hints based on two-hands setting
            const twoHands = miivi_config.twoHands;
            const chordLabels = ['ii', 'V', 'i'];

            chords.forEach((chord, i) => {
                const hintEl = document.getElementById(`miivi_hint_${chordLabels[i]}`);
                if (twoHands) {
                    // Two-hands mode: show LH (bass) + RH (3-5-7)
                    const bassName = NOTE_NAMES[chord.root];
                    // Get intervals based on chord type: iiø7 = half-dim, V7alt = dom7, imM7 = minMaj7
                    let intervals;
                    if (chord.type === 'hdim7') {
                        intervals = [3, 6, 10]; // b3, b5, b7
                    } else if (chord.type === 'dom7') {
                        intervals = [4, 7, 10]; // 3, 5, b7
                    } else {
                        // minMaj7
                        intervals = [3, 7, 11]; // b3, 5, 7
                    }
                    const rhNotes = intervals.map(i => NOTE_NAMES[(chord.root + i) % 12]).join(' ');
                    hintEl.innerText = `LH: ${bassName} | RH: ${rhNotes}`;
                    hintEl.classList.remove('hidden');
                } else {
                    hintEl.classList.add('hidden');
                }
            });

            miiviResetStepStyles();
            miiviHighlightCurrentStep();
        }

        function miiviOnNoteOn(midi) {
            if (!miivi_isPlaying || !miivi_challenge) return;

            highlightKey('miivi_pianoSvg', midi, 'key-held');

            const currentChord = miivi_challenge.chords[miivi_challenge.currentStep];
            const notePitchClass = midi % 12;
            const twoHands = miivi_config.twoHands;

            // Determine required notes based on two-hands setting
            let voicingPitchClasses;
            let bassNote = null;
            let requiredNotes;

            if (twoHands) {
                // Two hands: bass (root) + voicing (3rd, 5th, 7th) = 4 notes
                bassNote = currentChord.root;
                voicingPitchClasses = new Set([...currentChord.pitchClasses].filter(pc => pc !== bassNote));
                requiredNotes = 4;
            } else {
                // Single hand: full chord (R, 3, 5, 7)
                voicingPitchClasses = currentChord.pitchClasses;
                requiredNotes = 4;
            }

            // Check if note is correct (either bass or part of voicing)
            const isCorrectNote = twoHands
                ? (notePitchClass === bassNote || voicingPitchClasses.has(notePitchClass))
                : voicingPitchClasses.has(notePitchClass);

            if (!isCorrectNote) {
                if (!miivi_attemptHadMistake) {
                    miivi_totalMistakes++;
                    miivi_attemptHadMistake = true;
                    miivi_roundHadMistake = true;
                    miiviShowFeedback('✗', false);
                    miiviUpdateScoreDisplay();
                }
                highlightKey('miivi_pianoSvg', midi, 'key-wrong');
            }

            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('miivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check completion - need both bass and voicing in two-hands mode
            let hasAllRequired;
            if (twoHands) {
                const hasBass = heldPitchClasses.has(bassNote);
                const hasVoicing = [...voicingPitchClasses].every(pc => heldPitchClasses.has(pc));
                hasAllRequired = hasBass && hasVoicing;
            } else {
                hasAllRequired = [...voicingPitchClasses].every(pc => heldPitchClasses.has(pc));
            }

            if (hasAllRequired && heldNotes.size >= requiredNotes) {
                const stepTime = (Date.now() - miivi_stepStartTime) / 1000;
                miivi_stepTimes.push(stepTime);

                // Track slow responses (> 2 seconds)
                if (stepTime > 2) {
                    miivi_slowCount++;
                    document.getElementById('miivi_slowDisplay').innerText = miivi_slowCount;
                }

                const stepNames = ['ii', 'V', 'i'];
                document.getElementById(`miivi_time_${stepNames[miivi_challenge.currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                heldNotes.forEach(n => {
                    const pc = n % 12;
                    const isRequired = twoHands
                        ? (pc === bassNote || voicingPitchClasses.has(pc))
                        : voicingPitchClasses.has(pc);
                    if (isRequired) {
                        highlightKey('miivi_pianoSvg', n, 'key-active');
                    }
                });

                const keyName = NOTE_NAMES[miivi_challenge.key] + 'm';
                if (!miivi_stats[keyName]) miivi_stats[keyName] = { firstTry: 0, total: 0, times: [], slow: 0 };

                // Track slow for this key if step was slow
                const wasSlow = stepTime > 2;
                if (wasSlow) {
                    miivi_stats[keyName].slow++;
                }

                if (!miivi_attemptHadMistake) {
                    miivi_firstTryCorrect++;
                    miivi_stats[keyName].firstTry++;
                    miivi_stats[keyName].times.push(stepTime);
                    miivi_allTimes.push(stepTime);
                    miiviShowFeedback('✓', true, stepTime);
                } else {
                    miiviShowFeedback('✓', true);
                }
                miivi_stats[keyName].total++;
                miiviUpdateScoreDisplay();

                miivi_attemptHadMistake = false;

                if (miivi_challenge.currentStep < 2) {
                    miivi_challenge.currentStep++;
                    miivi_stepStartTime = Date.now();
                    setTimeout(() => {
                        clearAllHighlights('miivi_pianoSvg');
                        miiviHighlightCurrentStep();
                    }, 400);
                } else {
                    // Progression complete!
                    miivi_isPlaying = false; // Prevent mistakes during transition
                    const avgChordTime = miivi_stepTimes.reduce((a, b) => a + b, 0) / miivi_stepTimes.length;
                    miiviUpdateResponseTime(avgChordTime);
                    setTimeout(() => { miivi_isPlaying = true; miiviNextChallenge(); }, 600);
                }
            }
        }

        function miiviOnNoteOff(midi) {
            highlightKey('miivi_pianoSvg', midi, 'key-held', false);
            highlightKey('miivi_pianoSvg', midi, 'key-active', false);
            highlightKey('miivi_pianoSvg', midi, 'key-wrong', false);

            if (miivi_isPlaying && miivi_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('miivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function miiviUpdateResponseTime(seconds) {
            const el = document.getElementById('miivi_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function miiviUpdateScoreDisplay() {
            const currentStep = miivi_challenge ? miivi_challenge.currentStep : 0;
            const totalChords = miivi_currentRound * 3 + currentStep;
            const pct = totalChords > 0 ? Math.round((miivi_firstTryCorrect / totalChords) * 100) : 0;
            document.getElementById('miivi_scoreDisplay').innerText = pct + '%';
            document.getElementById('miivi_mistakesDisplay').innerText = miivi_totalMistakes;
        }

        function miiviShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('miivi_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function miiviEndGame() {
            miivi_isPlaying = false;
            miivi_challenge = null;
            clearAllHighlights('miivi_pianoSvg');

            const totalChords = miivi_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((miivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = miivi_allTimes.length > 0 ? miivi_allTimes.reduce((a, b) => a + b, 0) / miivi_allTimes.length : 0;

            miivi_history.unshift({
                date: new Date().toISOString(),
                config: { ...miivi_config },
                score: miivi_firstTryCorrect,
                totalChords,
                accuracy, avgTime,
                totalMistakes: miivi_totalMistakes,
                slowCount: miivi_slowCount,
                stats: JSON.parse(JSON.stringify(miivi_stats))
            });
            if (miivi_history.length > 50) miivi_history.pop();
            localStorage.setItem('minorIiviGameHistory', JSON.stringify(miivi_history));
            miiviUpdateCumulativeStats();

            miiviShowGameComplete();
        }

        function miiviShowGameComplete() {
            const totalChords = miivi_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((miivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = miivi_allTimes.length > 0 ? miivi_allTimes.reduce((a, b) => a + b, 0) / miivi_allTimes.length : 0;

            document.getElementById('miivi_finalScore').innerText = `${miivi_firstTryCorrect}/${totalChords}`;
            document.getElementById('miivi_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('miivi_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('miivi_finalMistakes').innerText = miivi_totalMistakes;
            document.getElementById('miivi_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('miivi_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('miivi_finalSlow').innerText = miivi_slowCount;
            document.getElementById('miivi_finalSlow').className = `text-3xl font-bold ${miivi_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(miivi_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('miivi_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('miivi_challengeDisplay').classList.add('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('miivi_stopBtn').classList.add('hidden');
            document.getElementById('miivi_playAgainBtn').classList.remove('hidden');
            document.getElementById('miivi_newGameBtn').classList.remove('hidden');

            miiviShowBreakdown();
            miiviRenderHistory();
        }

        function miiviShowBreakdown() {
            const grid = document.getElementById('miivi_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(miivi_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('miivi_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [keyName, data] of Object.entries(miivi_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('miivi_breakdownSection').classList.remove('hidden');
        }

        function miiviPlayAgain() {
            miivi_currentRound = 0; miivi_firstTryCorrect = 0; miivi_totalMistakes = 0; miivi_slowCount = 0;
            miivi_roundHadMistake = false; miivi_attemptHadMistake = false;
            miivi_usedKeys = new Set(); miivi_stats = {}; miivi_allTimes = [];
            document.getElementById('miivi_roundDisplay').innerText = '0';
            document.getElementById('miivi_responseTime').innerText = '--';
            document.getElementById('miivi_scoreDisplay').innerText = '0%';
            document.getElementById('miivi_mistakesDisplay').innerText = '0';
            document.getElementById('miivi_slowDisplay').innerText = '0';
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_stopBtn').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');
            miiviRunCountdown(3);
        }

        function miiviNewGame() {
            document.getElementById('miivi_settingsPanel').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.add('hidden');
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_startBtn').classList.remove('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');
        }

        function miiviLoadHistory() {
            const saved = localStorage.getItem('minorIiviGameHistory');
            if (saved) { miivi_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('miiviCumulativeStats');
            if (savedCumulative) { miivi_cumulativeStats = JSON.parse(savedCumulative); }
            miiviRenderHistory();
        }

        function miiviUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(miivi_stats)) {
                if (!miivi_cumulativeStats[keyName]) {
                    miivi_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                miivi_cumulativeStats[keyName].attempts += data.total;
                miivi_cumulativeStats[keyName].firstTry += data.firstTry;
                miivi_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                miivi_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('miiviCumulativeStats', JSON.stringify(miivi_cumulativeStats));
        }

        function miiviGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(miivi_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function miiviClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            miivi_history = [];
            miivi_cumulativeStats = {};
            localStorage.removeItem('minorIiviGameHistory');
            localStorage.removeItem('miiviCumulativeStats');
            miiviRenderHistory();
        }

        function miiviRenderHistory() {
            const content = document.getElementById('miivi_historyContent');
            if (miivi_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = miivi_history.length;
            const avgAccuracy = Math.min(100, Math.round(miivi_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            const displayedGames = miivi_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const rounds = game.config?.totalRounds || (game.totalChords / 3);
                const displayAccuracy = Math.min(game.accuracy, 100);
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${rounds}r</span><span class="text-xs text-purple-400 ml-1">minor</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = miiviGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ KENNY BARRON MODE ============
        // Kenny Barron voicing: stacked 5ths
        // Minor 11: LH (R-5-9), RH (b3-b7-11) - intervals [0,7,2] + [3,10,5]
        // Major 7#11: LH (R-5-9), RH (3-7-#11) - intervals [0,7,2] + [4,11,6]

        const KB_VOICINGS = {
            minor: {
                name: 'm11',
                lh: [0, 7, 2],      // R, 5, 9 (mod 12)
                rh: [3, 10, 5],     // b3, b7, 11 (mod 12)
                lhLabels: ['R', '5', '9'],
                rhLabels: ['b3', 'b7', '11']
            },
            major: {
                name: 'maj7#11',
                lh: [0, 7, 2],      // R, 5, 9 (mod 12)
                rh: [4, 11, 6],     // 3, 7, #11 (mod 12)
                lhLabels: ['R', '5', '9'],
                rhLabels: ['3', '7', '#11']
            }
        };

        let kb_gameActive = false;
        let kb_isPlaying = false;
        let kb_config = {};
        let kb_challenge = null;
        let kb_currentRound = 0;
        let kb_usedKeys = new Set();
        let kb_startTime = null;
        let kb_timerInterval = null;
        let kb_history = [];
        let kb_cumulativeStats = {}; // Persistent stats across all games
        let kb_stats = {};
        let kb_allTimes = [];
        let kb_slowCount = 0; // Chords taking > 2 seconds
        let kb_firstTryCorrect = 0;
        let kb_totalMistakes = 0;
        let kb_roundHadMistake = false;

        function kbStartGame() {
            saveAllSettings();
            const chordType = document.getElementById('kb_chordType').value;
            const voicingType = document.getElementById('kb_voicingType').value;
            const totalRounds = parseInt(document.getElementById('kb_rounds').value);
            const showHints = document.getElementById('kb_showHints').checked;

            const focusProblemAreas = document.getElementById('kb_focusProblemAreas').checked;
            let problemAreaKeys = null;

            if (focusProblemAreas) {
                const problemAreas = kbGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas into keys: "C" -> pitchClass 0
                problemAreaKeys = [];
                problemAreas.forEach(area => {
                    const pitchClass = NOTE_NAMES.indexOf(area.name);
                    if (pitchClass >= 0) {
                        problemAreaKeys.push(pitchClass);
                    }
                });
                if (problemAreaKeys.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            kb_config = { chordType, voicingType, totalRounds, showHints, focusProblemAreas, problemAreaKeys };
            kb_currentRound = 0;
            kb_usedKeys = new Set();
            kb_stats = {};
            kb_allTimes = [];
            kb_slowCount = 0;
            kb_firstTryCorrect = 0;
            kb_totalMistakes = 0;

            document.getElementById('kb_settingsPanel').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.remove('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_totalRounds').innerText = totalRounds;
            document.getElementById('kb_roundDisplay').innerText = '0';
            document.getElementById('kb_scoreDisplay').innerText = '0%';
            document.getElementById('kb_mistakesDisplay').innerText = '0';
            document.getElementById('kb_slowDisplay').innerText = '0';
            document.getElementById('kb_responseTime').innerText = '--';

            document.getElementById('kb_startBtn').classList.add('hidden');
            document.getElementById('kb_stopBtn').classList.remove('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');

            kbRunCountdown(3);
        }

        function kbRunCountdown(count) {
            if (count > 0) {
                document.getElementById('kb_chordDisplay').innerText = count;
                document.getElementById('kb_lhNotes').innerText = '...';
                document.getElementById('kb_rhNotes').innerText = '...';
                document.getElementById('kb_heldNotes').innerText = 'Get ready...';
                document.getElementById('kb_noteIndicators').innerHTML = '';
                setTimeout(() => kbRunCountdown(count - 1), 800);
            } else {
                kb_isPlaying = true;
                kbNextChallenge();
            }
        }

        function kbStopGame() {
            kb_gameActive = false;
            kb_isPlaying = false;
            if (kb_timerInterval) clearInterval(kb_timerInterval);
            clearAllHighlights('kb_pianoSvg');
            document.getElementById('kb_settingsPanel').classList.remove('hidden');
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_startBtn').classList.remove('hidden');
            document.getElementById('kb_stopBtn').classList.add('hidden');
        }

        function kbGetVoicing(root, type) {
            const voicing = KB_VOICINGS[type];
            const isSawnOff = kb_config.voicingType === 'sawnoff';

            // Calculate pitch classes
            const lhPitchClasses = voicing.lh.map(i => (root + i) % 12);
            const rhIntervals = isSawnOff ? voicing.rh.slice(0, 2) : voicing.rh;
            const rhPitchClasses = rhIntervals.map(i => (root + i) % 12);

            const allPitchClasses = new Set([...lhPitchClasses, ...rhPitchClasses]);

            // Note names for display
            const lhNotes = lhPitchClasses.map(pc => NOTE_NAMES[pc]);
            const rhNotes = rhPitchClasses.map(pc => NOTE_NAMES[pc]);

            const lhLabels = voicing.lhLabels;
            const rhLabels = isSawnOff ? voicing.rhLabels.slice(0, 2) : voicing.rhLabels;

            return {
                pitchClasses: allPitchClasses,
                lhPitchClasses,
                rhPitchClasses,
                lhNotes,
                rhNotes,
                lhLabels,
                rhLabels,
                chordName: NOTE_NAMES[root] + voicing.name,
                type
            };
        }

        function kbNextChallenge() {
            clearAllHighlights('kb_pianoSvg');
            kb_currentRound++;
            kb_roundHadMistake = false;

            if (kb_currentRound > kb_config.totalRounds) {
                kbGameComplete();
                return;
            }

            // Pick random unused key
            let key;
            if (kb_config.focusProblemAreas && kb_config.problemAreaKeys) {
                // Focus on problem areas: pick from problem area keys
                if (kb_usedKeys.size >= kb_config.problemAreaKeys.length) kb_usedKeys.clear();
                const unusedProblemKeys = kb_config.problemAreaKeys.filter(k => !kb_usedKeys.has(k));
                key = unusedProblemKeys[Math.floor(Math.random() * unusedProblemKeys.length)];
            } else {
                // Normal mode: pick from all 12 keys
                if (kb_usedKeys.size >= 12) kb_usedKeys.clear();
                const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                const unusedKeys = allKeys.filter(k => !kb_usedKeys.has(k));
                key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            }
            kb_usedKeys.add(key);

            // Pick chord type
            let chordType;
            if (kb_config.chordType === 'both') {
                chordType = Math.random() < 0.5 ? 'minor' : 'major';
            } else {
                chordType = kb_config.chordType;
            }

            const voicing = kbGetVoicing(key, chordType);
            kb_challenge = { key, voicing };

            // Update UI
            document.getElementById('kb_roundDisplay').innerText = kb_currentRound;
            document.getElementById('kb_chordDisplay').innerText = voicing.chordName;
            if (kb_config.showHints) {
                document.getElementById('kb_lhNotes').innerText = voicing.lhLabels.join(' - ');
                document.getElementById('kb_rhNotes').innerText = voicing.rhLabels.join(' - ');
            } else {
                const lhDots = voicing.lhLabels.map(() => '•').join('   ');
                const rhDots = voicing.rhLabels.map(() => '•').join('   ');
                document.getElementById('kb_lhNotes').innerText = lhDots;
                document.getElementById('kb_rhNotes').innerText = rhDots;
            }
            document.getElementById('kb_heldNotes').innerText = 'Holding: --';
            const kbPct = kb_currentRound > 0 ? Math.round((kb_firstTryCorrect / kb_currentRound) * 100) : 0;
            document.getElementById('kb_scoreDisplay').innerText = kbPct + '%';
            document.getElementById('kb_mistakesDisplay').innerText = kb_totalMistakes;

            kbUpdateNoteIndicators();
            kb_startTime = Date.now();
            kb_gameActive = true;
        }

        function kbUpdateNoteIndicators() {
            if (!kb_challenge) return;
            const container = document.getElementById('kb_noteIndicators');
            const allPitchClasses = [...kb_challenge.voicing.lhPitchClasses, ...kb_challenge.voicing.rhPitchClasses];
            const allNotes = [...kb_challenge.voicing.lhNotes, ...kb_challenge.voicing.rhNotes];

            let html = '';
            allPitchClasses.forEach((pc, i) => {
                const isPlayed = kbGetHeldPitchClasses().has(pc);
                const colorClass = isPlayed ? 'bg-teal-600 border-teal-400' : 'bg-slate-700 border-slate-600';
                // Show checkmark when played
                const content = isPlayed ? '✓' : '';
                html += `<div class="w-8 h-8 rounded-full ${colorClass} flex items-center justify-center text-xs font-bold border-2">${content}</div>`;
            });
            container.innerHTML = html;
        }

        function kbGetHeldPitchClasses() {
            const pitchClasses = new Set();
            heldNotes.forEach(note => pitchClasses.add(note % 12));
            return pitchClasses;
        }

        function kbHandleNoteOn(note) {
            if (!kb_gameActive || !kb_challenge) return;

            highlightKey('kb_pianoSvg', note, 'key-held');

            kbUpdateHeldDisplay();
            kbUpdateNoteIndicators();
            kbCheckVoicing();
        }

        function kbHandleNoteOff(note) {
            highlightKey('kb_pianoSvg', note, 'key-held', false);
            highlightKey('kb_pianoSvg', note, 'key-active', false);
            highlightKey('kb_pianoSvg', note, 'key-wrong', false);
            if (!kb_gameActive || !kb_challenge) return;

            kbUpdateHeldDisplay();
            kbUpdateNoteIndicators();
        }

        function kbUpdateHeldDisplay() {
            const noteNames = [...heldNotes].map(n => NOTE_NAMES[n % 12]).join(', ');
            document.getElementById('kb_heldNotes').innerText = 'Holding: ' + (noteNames || '--');
        }

        function kbCheckVoicing() {
            const heldPitchClasses = kbGetHeldPitchClasses();
            const targetPitchClasses = kb_challenge.voicing.pitchClasses;

            // Check for wrong notes
            for (const pc of heldPitchClasses) {
                if (!targetPitchClasses.has(pc)) {
                    kb_roundHadMistake = true;
                    kb_totalMistakes++;
                    document.getElementById('kb_mistakesDisplay').innerText = kb_totalMistakes;
                    kbShowFeedback('✗', 'text-red-400');
                    return;
                }
            }

            // Check if all notes are played
            if (heldPitchClasses.size === targetPitchClasses.size) {
                let allCorrect = true;
                for (const pc of targetPitchClasses) {
                    if (!heldPitchClasses.has(pc)) {
                        allCorrect = false;
                        break;
                    }
                }

                if (allCorrect) {
                    const elapsed = (Date.now() - kb_startTime) / 1000;
                    kb_gameActive = false;

                    if (!kb_roundHadMistake) kb_firstTryCorrect++;
                    kb_allTimes.push(elapsed);

                    // Track stats by key
                    const keyName = NOTE_NAMES[kb_challenge.key];
                    if (!kb_stats[keyName]) kb_stats[keyName] = { total: 0, firstTry: 0, times: [], slow: 0 };
                    kb_stats[keyName].total++;
                    if (!kb_roundHadMistake) kb_stats[keyName].firstTry++;
                    kb_stats[keyName].times.push(elapsed);

                    // Track slow responses (> 2 seconds)
                    const wasSlow = elapsed > 2;
                    if (wasSlow) {
                        kb_slowCount++;
                        kb_stats[keyName].slow++;
                        document.getElementById('kb_slowDisplay').innerText = kb_slowCount;
                    }

                    // Update response time display
                    const avgTime = kb_allTimes.reduce((a, b) => a + b, 0) / kb_allTimes.length;
                    const timerEl = document.getElementById('kb_responseTime');
                    timerEl.innerText = avgTime.toFixed(1) + 's';
                    timerEl.className = 'text-2xl font-mono ' + (avgTime < 3 ? 'timer-fast' : avgTime < 6 ? 'timer-medium' : 'timer-slow');

                    kbShowFeedback('✓', 'text-green-400');
                    setTimeout(kbNextChallenge, 800);
                }
            }
        }

        function kbShowFeedback(text, colorClass) {
            const area = document.getElementById('kb_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-6xl font-bold ${colorClass} feedback-anim`;
            el.innerText = text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function kbGameComplete() {
            kb_gameActive = false;
            kb_isPlaying = false;

            const accuracy = Math.round((kb_firstTryCorrect / kb_config.totalRounds) * 100);
            const avgTime = kb_allTimes.length > 0 ? kb_allTimes.reduce((a, b) => a + b, 0) / kb_allTimes.length : 0;

            // Save to history
            kb_history.unshift({
                date: new Date().toISOString(),
                accuracy,
                avgTime,
                totalRounds: kb_config.totalRounds,
                firstTry: kb_firstTryCorrect,
                mistakes: kb_totalMistakes,
                slowCount: kb_slowCount,
                config: kb_config
            });
            if (kb_history.length > 50) kb_history = kb_history.slice(0, 50);
            localStorage.setItem('kbGameHistory', JSON.stringify(kb_history));
            kbUpdateCumulativeStats();
            kbRenderHistory();

            // Update final stats display
            document.getElementById('kb_finalScore').innerText = `${kb_firstTryCorrect}/${kb_config.totalRounds}`;
            document.getElementById('kb_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('kb_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('kb_finalMistakes').innerText = kb_totalMistakes;
            document.getElementById('kb_finalAvgTime').innerText = `${avgTime.toFixed(1)}s`;
            document.getElementById('kb_finalSlow').innerText = kb_slowCount;
            document.getElementById('kb_finalSlow').className = `text-3xl font-bold ${kb_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Show/hide elements
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('kb_stopBtn').classList.add('hidden');
            document.getElementById('kb_playAgainBtn').classList.remove('hidden');
            document.getElementById('kb_newGameBtn').classList.remove('hidden');

            kbShowBreakdown();
        }

        function kbShowBreakdown() {
            const grid = document.getElementById('kb_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(kb_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('kb_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [keyName, data] of Object.entries(kb_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('kb_breakdownSection').classList.remove('hidden');
        }

        function kbPlayAgain() {
            kb_currentRound = 0;
            kb_firstTryCorrect = 0;
            kb_totalMistakes = 0;
            kb_slowCount = 0;
            kb_usedKeys = new Set();
            kb_stats = {};
            kb_allTimes = [];

            document.getElementById('kb_roundDisplay').innerText = '0';
            document.getElementById('kb_scoreDisplay').innerText = '0%';
            document.getElementById('kb_mistakesDisplay').innerText = '0';
            document.getElementById('kb_slowDisplay').innerText = '0';
            document.getElementById('kb_responseTime').innerText = '--';

            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.remove('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');
            document.getElementById('kb_stopBtn').classList.remove('hidden');
            document.getElementById('kb_breakdownSection').classList.add('hidden');

            kbRunCountdown(3);
        }

        function kbNewGame() {
            document.getElementById('kb_settingsPanel').classList.remove('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');
            document.getElementById('kb_startBtn').classList.remove('hidden');
            document.getElementById('kb_breakdownSection').classList.add('hidden');
        }

        function kbLoadHistory() {
            const saved = localStorage.getItem('kbGameHistory');
            if (saved) { kb_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('kbCumulativeStats');
            if (savedCumulative) { kb_cumulativeStats = JSON.parse(savedCumulative); }
            kbRenderHistory();
        }

        function kbUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(kb_stats)) {
                if (!kb_cumulativeStats[keyName]) {
                    kb_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                kb_cumulativeStats[keyName].attempts += data.total;
                kb_cumulativeStats[keyName].firstTry += data.firstTry;
                kb_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                kb_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('kbCumulativeStats', JSON.stringify(kb_cumulativeStats));
        }

        function kbGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(kb_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function kbClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            kb_history = [];
            kb_cumulativeStats = {};
            localStorage.removeItem('kbGameHistory');
            localStorage.removeItem('kbCumulativeStats');
            kbRenderHistory();
        }

        function kbRenderHistory() {
            const content = document.getElementById('kb_historyContent');
            if (kb_history.length === 0) {
                content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>';
                return;
            }

            const totalGames = kb_history.length;
            const avgAccuracy = Math.round(kb_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = kb_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const typeLabel = game.config?.chordType === 'minor' ? 'min' : game.config?.chordType === 'major' ? 'maj' : 'mix';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-teal-400 ml-1">${typeLabel}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = kbGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ JUST THE TWO OF US MODE ============
        // bVImaj7 → V7#9 → im7 progression (in Fm: Dbmaj7 → C7#9 → Fm7)

        let jtou_gameActive = false;
        let jtou_isPlaying = false;
        let jtou_config = {};
        let jtou_challenge = null;
        let jtou_currentRound = 0;
        let jtou_currentStep = 0; // 0=bVI, 1=V, 2=i
        let jtou_usedKeys = new Set();
        let jtou_startTime = null;
        let jtou_stepStartTime = null;
        let jtou_history = [];
        let jtou_cumulativeStats = {}; // Persistent stats across all games
        let jtou_stats = {};
        let jtou_allTimes = [];
        let jtou_stepTimes = [];
        let jtou_firstTryCorrect = 0;
        let jtou_totalMistakes = 0;
        let jtou_slowChords = 0; // Chords taking > 2 seconds
        let jtou_roundHadMistake = false;
        let jtou_attemptHadMistake = false;

        const MINOR_KEY_NAMES = ['Cm', 'C#m', 'Dm', 'D#m', 'Em', 'Fm', 'F#m', 'Gm', 'G#m', 'Am', 'Bbm', 'Bm'];

        function jtouGetProgression(minorRoot, voicing = 'full') {
            // Voice leading magic: the 9th of bVI = #9 of V = b7 of i (common tone!)
            // In Fm: that note is Eb, connecting Dbmaj9 → C7#9 → Fm7

            // bVImaj9: root at (minorRoot + 8) % 12
            // Voicing: R 3 5 7 9 (e.g., Db F Ab C Eb)
            const bVIRoot = (minorRoot + 8) % 12;
            const bVIIntervals = [0, 4, 7, 11, 2]; // R, 3, 5, 7, 9
            const bVIChord = {
                name: NOTE_NAMES[bVIRoot] + 'maj9',
                pitchClasses: new Set(bVIIntervals.map(i => (bVIRoot + i) % 12)),
                notes: bVIIntervals.map(i => NOTE_NAMES[(bVIRoot + i) % 12]),
                label: 'bVImaj9'
            };

            // V7#9: root at (minorRoot + 7) % 12
            const VRoot = (minorRoot + 7) % 12;
            // Full: R 3 5 b7 #9 (e.g., C E G Bb Eb) - 5 notes
            // No5:  R 3 b7 #9 (e.g., C E Bb Eb) - 4 notes, no 5th
            const VIntervals = voicing === 'no5' ? [0, 4, 10, 3] : [0, 4, 7, 10, 3];
            const VChord = {
                name: NOTE_NAMES[VRoot] + '7#9',
                pitchClasses: new Set(VIntervals.map(i => (VRoot + i) % 12)),
                notes: VIntervals.map(i => NOTE_NAMES[(VRoot + i) % 12]),
                label: 'V7#9'
            };

            // im9: root at minorRoot
            // Voicing: R b3 5 b7 9 (e.g., F Ab C Eb G)
            const iIntervals = [0, 3, 7, 10, 2]; // R, b3, 5, b7, 9
            const iChord = {
                name: NOTE_NAMES[minorRoot] + 'm9',
                pitchClasses: new Set(iIntervals.map(i => (minorRoot + i) % 12)),
                notes: iIntervals.map(i => NOTE_NAMES[(minorRoot + i) % 12]),
                label: 'im9'
            };

            return [bVIChord, VChord, iChord];
        }

        function jtouStartGame() {
            saveAllSettings();
            const totalRounds = parseInt(document.getElementById('jtou_roundsSelect').value);
            const showHints = document.getElementById('jtou_showHints').checked;
            const voicing = document.getElementById('jtou_voicingSelect').value;

            const focusProblemAreas = document.getElementById('jtou_focusProblemAreas').checked;
            let problemAreaKeys = null;

            if (focusProblemAreas) {
                const problemAreas = jtouGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas into keys: "Cm" -> 0, "F#m" -> 6, etc.
                problemAreaKeys = [];
                problemAreas.forEach(area => {
                    const pitchClass = MINOR_KEY_NAMES.indexOf(area.name);
                    if (pitchClass >= 0) {
                        problemAreaKeys.push(pitchClass);
                    }
                });
                if (problemAreaKeys.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            jtou_config = { totalRounds, showHints, voicing, focusProblemAreas, problemAreaKeys };
            jtou_currentRound = 0;
            jtou_usedKeys = new Set();
            jtou_stats = {};
            jtou_allTimes = [];
            jtou_firstTryCorrect = 0;
            jtou_totalMistakes = 0;
            jtou_slowChords = 0;

            document.getElementById('jtou_settingsPanel').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_totalRoundsDisplay').innerText = totalRounds;
            document.getElementById('jtou_roundDisplay').innerText = '0';
            document.getElementById('jtou_scoreDisplay').innerText = '0%';
            document.getElementById('jtou_mistakesDisplay').innerText = '0';
            document.getElementById('jtou_slowDisplay').innerText = '0';
            document.getElementById('jtou_responseTime').innerText = '--';

            document.getElementById('jtou_startBtn').classList.add('hidden');
            document.getElementById('jtou_stopBtn').classList.remove('hidden');
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');

            jtouRunCountdown(3);
        }

        function jtouRunCountdown(count) {
            if (count > 0) {
                document.getElementById('jtou_keyDisplay').innerText = count;
                document.getElementById('jtou_challengeLabel').innerText = 'Get ready...';
                document.getElementById('jtou_heldNotes').innerText = '';
                jtouResetStepDisplay();
                setTimeout(() => jtouRunCountdown(count - 1), 800);
            } else {
                jtou_isPlaying = true;
                jtouNextChallenge();
            }
        }

        function jtouResetStepDisplay() {
            ['bVI', 'V', 'i'].forEach(step => {
                const stepEl = document.getElementById(`jtou_step_${step}`);
                stepEl.querySelector('div').classList.remove('border-pink-400', 'bg-pink-900/50', 'border-green-400', 'bg-green-900/50');
                stepEl.querySelector('div').classList.add('border-slate-600', 'bg-slate-700');
                document.getElementById(`jtou_time_${step}`).innerText = '--';
                document.getElementById(`jtou_chord_${step}`).innerText = '...';
                document.getElementById(`jtou_notes_${step}`).innerText = '';
            });
        }

        function jtouStopGame() {
            jtou_gameActive = false;
            jtou_isPlaying = false;
            clearAllHighlights('jtou_pianoSvg');
            document.getElementById('jtou_settingsPanel').classList.remove('hidden');
            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_startBtn').classList.remove('hidden');
            document.getElementById('jtou_stopBtn').classList.add('hidden');
        }

        function jtouNextChallenge() {
            clearAllHighlights('jtou_pianoSvg');
            jtou_currentRound++;
            jtou_roundHadMistake = false;
            jtou_currentStep = 0;
            jtou_stepTimes = [];

            if (jtou_currentRound > jtou_config.totalRounds) {
                jtouEndGame();
                return;
            }

            // Pick random unused key
            let key;
            if (jtou_config.focusProblemAreas && jtou_config.problemAreaKeys) {
                // Focus on problem areas: pick from problem area keys
                if (jtou_usedKeys.size >= jtou_config.problemAreaKeys.length) jtou_usedKeys.clear();
                const unusedProblemKeys = jtou_config.problemAreaKeys.filter(k => !jtou_usedKeys.has(k));
                key = unusedProblemKeys[Math.floor(Math.random() * unusedProblemKeys.length)];
            } else {
                // Normal mode: pick from all 12 keys
                if (jtou_usedKeys.size >= 12) jtou_usedKeys.clear();
                const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                const unusedKeys = allKeys.filter(k => !jtou_usedKeys.has(k));
                key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            }
            jtou_usedKeys.add(key);

            const progression = jtouGetProgression(key, jtou_config.voicing);
            jtou_challenge = { key, progression, keyName: MINOR_KEY_NAMES[key] };

            // Update UI
            document.getElementById('jtou_roundDisplay').innerText = jtou_currentRound;
            document.getElementById('jtou_challengeLabel').innerText = 'Just the Two of Us in';
            document.getElementById('jtou_keyDisplay').innerText = jtou_challenge.keyName;

            // Reset step styling first, then set chord names/notes
            jtouResetStepDisplay();

            // Update chord names and notes in the progression display
            if (jtou_config.showHints) {
                document.getElementById('jtou_chord_bVI').innerText = progression[0].name;
                document.getElementById('jtou_chord_V').innerText = progression[1].name;
                document.getElementById('jtou_chord_i').innerText = progression[2].name;
                document.getElementById('jtou_notes_bVI').innerText = progression[0].notes.join(' ');
                document.getElementById('jtou_notes_V').innerText = progression[1].notes.join(' ');
                document.getElementById('jtou_notes_i').innerText = progression[2].notes.join(' ');
            } else {
                document.getElementById('jtou_chord_bVI').innerText = '?';
                document.getElementById('jtou_chord_V').innerText = '?';
                document.getElementById('jtou_chord_i').innerText = '?';
            }

            jtouHighlightCurrentStep();

            jtou_startTime = Date.now();
            jtou_stepStartTime = Date.now();
            jtou_gameActive = true;
            jtou_isPlaying = true;
            jtou_attemptHadMistake = false;
        }

        function jtouHighlightCurrentStep() {
            const stepIds = ['bVI', 'V', 'i'];
            stepIds.forEach((id, idx) => {
                const stepEl = document.getElementById(`jtou_step_${id}`);
                const box = stepEl.querySelector('div');
                if (idx === jtou_currentStep) {
                    box.classList.remove('border-slate-600', 'bg-slate-700', 'border-green-400', 'bg-green-900/50');
                    box.classList.add('border-pink-400', 'bg-pink-900/50');
                } else if (idx < jtou_currentStep) {
                    box.classList.remove('border-slate-600', 'bg-slate-700', 'border-pink-400', 'bg-pink-900/50');
                    box.classList.add('border-green-400', 'bg-green-900/50');
                }
            });
        }

        function jtouOnNoteOn(midi) {
            const pitchClass = midi % 12;
            const noteName = NOTE_NAMES[pitchClass];

            // Debug: Log why we might ignore input
            if (!jtou_isPlaying) {
                console.log(`[JTOU] Ignoring ${noteName} - jtou_isPlaying is false (transition window)`);
                return;
            }
            if (!jtou_challenge) {
                console.log(`[JTOU] Ignoring ${noteName} - no active challenge`);
                return;
            }

            highlightKey('jtou_pianoSvg', midi, 'key-held');

            const currentChord = jtou_challenge.progression[jtou_currentStep];

            // Check if this note is correct
            if (!currentChord.pitchClasses.has(pitchClass)) {
                // Wrong note
                if (!jtou_attemptHadMistake) {
                    console.log(`[JTOU] MISTAKE: ${noteName} not in ${currentChord.name} (${[...currentChord.pitchClasses].map(pc => NOTE_NAMES[pc]).join(', ')})`);
                    jtou_attemptHadMistake = true;
                    jtou_roundHadMistake = true;
                    jtou_totalMistakes++;
                    document.getElementById('jtou_mistakesDisplay').innerText = jtou_totalMistakes;
                    jtouShowFeedback('✗', false);
                } else {
                    console.log(`[JTOU] Wrong note ${noteName} but already had mistake this attempt`);
                }
            } else {
                console.log(`[JTOU] Correct note: ${noteName} for ${currentChord.name}`);
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('jtou_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if chord is complete - must be HOLDING all required notes
            const hasAllRequired = [...currentChord.pitchClasses].every(pc => heldPitchClasses.has(pc));
            if (hasAllRequired && heldNotes.size >= currentChord.pitchClasses.size) {
                jtou_isPlaying = false; // Prevent mistakes during transition
                const stepTime = (Date.now() - jtou_stepStartTime) / 1000;
                jtou_stepTimes.push(stepTime);
                jtou_allTimes.push(stepTime);

                // Track slow chords (> 2 seconds)
                if (stepTime > 2) {
                    jtou_slowChords++;
                    document.getElementById('jtou_slowDisplay').innerText = jtou_slowChords;
                }

                // Update time display for this step
                const stepIds = ['bVI', 'V', 'i'];
                document.getElementById(`jtou_time_${stepIds[jtou_currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                // Track first-try correct for this chord
                if (!jtou_attemptHadMistake) {
                    jtou_firstTryCorrect++;
                    const totalChords = (jtou_currentRound - 1) * 4 + jtou_currentStep + 1;
                    const jtouPct = totalChords > 0 ? Math.round((jtou_firstTryCorrect / totalChords) * 100) : 0;
                    document.getElementById('jtou_scoreDisplay').innerText = jtouPct + '%';
                }

                jtouShowFeedback('✓', true, stepTime);

                // Move to next step or next round
                jtou_currentStep++;
                jtou_attemptHadMistake = false;

                if (jtou_currentStep < 3) {
                    // Next chord in progression
                    jtou_stepStartTime = Date.now();
                    setTimeout(() => {
                        jtou_isPlaying = true;
                        jtouHighlightCurrentStep();
                    }, 400);
                } else {
                    // Progression complete
                    const avgChordTime = jtou_stepTimes.reduce((a, b) => a + b, 0) / jtou_stepTimes.length;
                    jtouUpdateResponseTime(avgChordTime);

                    // Track stats by key
                    const keyName = jtou_challenge.keyName;
                    if (!jtou_stats[keyName]) jtou_stats[keyName] = { total: 0, firstTry: 0, times: [], slow: 0 };
                    jtou_stats[keyName].total += 3;
                    jtou_stats[keyName].firstTry += jtou_stepTimes.length - (jtou_roundHadMistake ? 1 : 0);
                    jtou_stats[keyName].times.push(...jtou_stepTimes);
                    // Count slow chords in this round
                    jtou_stats[keyName].slow += jtou_stepTimes.filter(t => t > 2).length;

                    setTimeout(() => { jtou_isPlaying = true; jtouNextChallenge(); }, 600);
                }
            }
        }

        function jtouOnNoteOff(midi) {
            highlightKey('jtou_pianoSvg', midi, 'key-held', false);
            highlightKey('jtou_pianoSvg', midi, 'key-active', false);
            highlightKey('jtou_pianoSvg', midi, 'key-wrong', false);
            if (!jtou_challenge) return;

            if (jtou_isPlaying) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('jtou_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function jtouUpdateResponseTime(seconds) {
            const el = document.getElementById('jtou_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function jtouShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('jtou_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function jtouEndGame() {
            jtou_isPlaying = false;
            jtou_gameActive = false;
            jtou_challenge = null;

            const totalChords = jtou_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((jtou_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = jtou_allTimes.length > 0 ? jtou_allTimes.reduce((a, b) => a + b, 0) / jtou_allTimes.length : 0;

            jtou_history.unshift({
                date: new Date().toISOString(),
                config: { ...jtou_config },
                score: jtou_firstTryCorrect,
                totalChords,
                accuracy,
                avgTime,
                totalMistakes: jtou_totalMistakes,
                slowChords: jtou_slowChords,
                stats: JSON.parse(JSON.stringify(jtou_stats))
            });
            if (jtou_history.length > 50) jtou_history.pop();
            localStorage.setItem('jtouGameHistory', JSON.stringify(jtou_history));
            jtouUpdateCumulativeStats();

            jtouShowGameComplete();
        }

        function jtouShowGameComplete() {
            const totalChords = jtou_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((jtou_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = jtou_allTimes.length > 0 ? jtou_allTimes.reduce((a, b) => a + b, 0) / jtou_allTimes.length : 0;

            document.getElementById('jtou_finalScore').innerText = `${jtou_firstTryCorrect}/${totalChords}`;
            document.getElementById('jtou_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('jtou_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('jtou_finalMistakes').innerText = jtou_totalMistakes;
            document.getElementById('jtou_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('jtou_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('jtou_finalSlow').innerText = jtou_slowChords;
            document.getElementById('jtou_finalSlow').className = `text-3xl font-bold ${jtou_slowChords === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('jtou_stopBtn').classList.add('hidden');
            document.getElementById('jtou_playAgainBtn').classList.remove('hidden');
            document.getElementById('jtou_newGameBtn').classList.remove('hidden');

            jtouShowBreakdown();
            jtouRenderHistory();
        }

        function jtouShowBreakdown() {
            const grid = document.getElementById('jtou_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(jtou_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('jtou_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [keyName, data] of Object.entries(jtou_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('jtou_breakdownSection').classList.remove('hidden');
        }

        function jtouPlayAgain() {
            jtou_currentRound = 0;
            jtou_firstTryCorrect = 0;
            jtou_totalMistakes = 0;
            jtou_slowChords = 0;
            jtou_roundHadMistake = false;
            jtou_attemptHadMistake = false;
            jtou_usedKeys = new Set();
            jtou_stats = {};
            jtou_allTimes = [];
            document.getElementById('jtou_roundDisplay').innerText = '0';
            document.getElementById('jtou_responseTime').innerText = '--';
            document.getElementById('jtou_scoreDisplay').innerText = '0%';
            document.getElementById('jtou_mistakesDisplay').innerText = '0';
            document.getElementById('jtou_slowDisplay').innerText = '0';
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');
            document.getElementById('jtou_stopBtn').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.remove('hidden');
            document.getElementById('jtou_breakdownSection').classList.add('hidden');
            jtouRunCountdown(3);
        }

        function jtouNewGame() {
            document.getElementById('jtou_settingsPanel').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');
            document.getElementById('jtou_startBtn').classList.remove('hidden');
            document.getElementById('jtou_breakdownSection').classList.add('hidden');
        }

        function jtouLoadHistory() {
            const saved = localStorage.getItem('jtouGameHistory');
            if (saved) { jtou_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('jtouCumulativeStats');
            if (savedCumulative) { jtou_cumulativeStats = JSON.parse(savedCumulative); }
            jtouRenderHistory();
        }

        function jtouUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(jtou_stats)) {
                if (!jtou_cumulativeStats[keyName]) {
                    jtou_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                jtou_cumulativeStats[keyName].attempts += data.total;
                jtou_cumulativeStats[keyName].firstTry += data.firstTry;
                jtou_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                jtou_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('jtouCumulativeStats', JSON.stringify(jtou_cumulativeStats));
        }

        function jtouGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(jtou_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function jtouClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            jtou_history = [];
            jtou_cumulativeStats = {};
            localStorage.removeItem('jtouGameHistory');
            localStorage.removeItem('jtouCumulativeStats');
            jtouRenderHistory();
        }

        function jtouRenderHistory() {
            const content = document.getElementById('jtou_historyContent');
            if (jtou_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = jtou_history.length;
            const avgAccuracy = Math.min(100, Math.round(jtou_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            const displayedGames = jtou_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const rounds = game.config?.totalRounds || (game.totalChords / 3);
                const displayAccuracy = Math.min(game.accuracy, 100);
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${rounds}r</span><span class="text-xs text-pink-400 ml-1">JTOU</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = jtouGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ROOTLESS VOICINGS MODE ============
        // Rootless voicings: Type A (3-5-7-9) and Type B (7-9-3-5)
        const ROOTLESS_VOICINGS = {
            'maj7': {
                suffix: 'Maj7',
                A: { intervals: [4, 7, 11, 2], formula: '3 - 5 - 7 - 9' },    // maj3, P5, maj7, maj9
                B: { intervals: [11, 2, 4, 7], formula: '7 - 9 - 3 - 5' }     // maj7, maj9, maj3, P5
            },
            'min7': {
                suffix: 'm7',
                A: { intervals: [3, 7, 10, 2], formula: 'b3 - 5 - b7 - 9' },  // min3, P5, min7, maj9
                B: { intervals: [10, 2, 3, 7], formula: 'b7 - 9 - b3 - 5' }   // min7, maj9, min3, P5
            },
            'dom7': {
                suffix: '7',
                A: { intervals: [4, 7, 10, 2], formula: '3 - 5 - b7 - 9' },   // maj3, P5, min7, maj9
                B: { intervals: [10, 2, 4, 7], formula: 'b7 - 9 - 3 - 5' }    // min7, maj9, maj3, P5
            }
        };
        const ROOTLESS_CHORD_TYPES = ['maj7', 'min7', 'dom7'];
        const ROOTLESS_VOICING_TYPES = ['A', 'B'];

        let dom7v_isPlaying = false;
        let dom7v_challenge = null;
        let dom7v_usedChallenges = new Set(); // Track used root+type combinations
        let dom7v_challengeStartTime = null;
        let dom7v_config = null;
        let dom7v_currentRound = 0;
        let dom7v_firstTryCorrect = 0;
        let dom7v_totalMistakes = 0;
        let dom7v_roundHadMistake = false;
        let dom7v_stats = {};
        let dom7v_allTimes = [];
        let dom7v_slowCount = 0;
        let dom7v_history = [];
        let dom7v_cumulativeStats = {};

        function dom7vGetChallenge(root, chordType, voicingType) {
            const chord = ROOTLESS_VOICINGS[chordType];
            const voicing = chord[voicingType];
            const pitchClasses = new Set(voicing.intervals.map(i => (root + i) % 12));
            const noteNames = voicing.intervals.map(i => NOTE_NAMES[(root + i) % 12]);
            return {
                root: root,
                chordType: chordType,
                voicingType: voicingType,
                name: NOTE_NAMES[root] + chord.suffix,
                pitchClasses: pitchClasses,
                noteNames: noteNames,
                formula: voicing.formula
            };
        }

        function dom7vUpdateSettingsHint() {
            const voicingType = document.getElementById('dom7v_voicingTypeSelect').value;
            const hint = document.getElementById('dom7v_settingsHint');
            if (voicingType === 'A') {
                hint.innerText = 'Type A: 3-5-7-9 (from bottom). Standard rootless voicing.';
            } else if (voicingType === 'B') {
                hint.innerText = 'Type B: 7-9-3-5 (from bottom). Inverted voicing, voice-leads smoothly with Type A.';
            } else {
                hint.innerText = 'Both types: Practice alternating between A (3-5-7-9) and B (7-9-3-5) voicings.';
            }
        }

        function dom7vStartGame() {
            saveAllSettings();

            const focusProblemAreas = document.getElementById('dom7v_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = dom7vGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "CMaj7", "Dm7 (A)", etc.
                problemAreaChallenges = [];
                const suffixToChordType = { 'Maj7': 'maj7', 'm7': 'min7', '7': 'dom7' };
                problemAreas.forEach(area => {
                    // Check if voicing type is specified: "CMaj7 (A)"
                    const voicingMatch = area.name.match(/\s*\(([AB])\)$/);
                    let chordName = area.name;
                    let voicingType = null;
                    if (voicingMatch) {
                        voicingType = voicingMatch[1];
                        chordName = area.name.replace(/\s*\([AB]\)$/, '');
                    }
                    // Parse chord name to root + chordType
                    for (const [suffix, chordType] of Object.entries(suffixToChordType)) {
                        if (chordName.endsWith(suffix)) {
                            const noteName = chordName.slice(0, -suffix.length);
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, chordType, voicingType, name: area.name });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            dom7v_config = {
                totalRounds: parseInt(document.getElementById('dom7v_roundsSelect').value),
                showHints: document.getElementById('dom7v_showHints').checked,
                chordType: document.getElementById('dom7v_chordTypeSelect').value,
                voicingType: document.getElementById('dom7v_voicingTypeSelect').value,
                focusProblemAreas,
                problemAreaChallenges
            };
            dom7v_currentRound = 0;
            dom7v_firstTryCorrect = 0;
            dom7v_totalMistakes = 0;
            dom7v_slowCount = 0;
            dom7v_roundHadMistake = false;
            dom7v_usedChallenges = new Set();
            dom7v_stats = {};
            dom7v_allTimes = [];

            document.getElementById('dom7v_roundDisplay').innerText = '0';
            document.getElementById('dom7v_totalRoundsDisplay').innerText = dom7v_config.totalRounds;
            document.getElementById('dom7v_responseTime').innerText = '--';
            document.getElementById('dom7v_scoreDisplay').innerText = '0%';
            document.getElementById('dom7v_mistakesDisplay').innerText = '0';
            document.getElementById('dom7v_slowDisplay').innerText = '0';

            document.getElementById('dom7v_startBtn').classList.add('hidden');
            document.getElementById('dom7v_stopBtn').classList.remove('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            document.getElementById('dom7v_settingsPanel').classList.add('hidden');
            document.getElementById('dom7v_challengeDisplay').classList.remove('hidden');
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_breakdownSection').classList.add('hidden');

            dom7vRunCountdown(3);
        }

        function dom7vRunCountdown(seconds) {
            if (seconds > 0) {
                document.getElementById('dom7v_chordDisplay').innerText = seconds;
                document.getElementById('dom7v_formulaLine').classList.add('hidden');
                document.getElementById('dom7v_noteHint').classList.add('hidden');
                document.getElementById('dom7v_heldNotes').innerText = 'Get ready...';
                setTimeout(() => dom7vRunCountdown(seconds - 1), 1000);
            } else {
                document.getElementById('dom7v_formulaLine').classList.remove('hidden');
                dom7v_isPlaying = true;
                dom7vNextChallenge();
            }
        }

        function dom7vNextChallenge() {
            if (dom7v_currentRound >= dom7v_config.totalRounds) {
                dom7vEndGame();
                return;
            }

            let chosen;

            if (dom7v_config.focusProblemAreas && dom7v_config.problemAreaChallenges) {
                // Focus on problem areas: pick from problem area challenges
                const voicingTypesToUse = dom7v_config.voicingType === 'both' ? ROOTLESS_VOICING_TYPES : [dom7v_config.voicingType];

                // Build list of available problem area challenges
                let availableChallenges = [];
                dom7v_config.problemAreaChallenges.forEach(pa => {
                    // If problem area has specific voicing type, use it; otherwise use selected voicing types
                    const voicings = pa.voicingType ? [pa.voicingType] : voicingTypesToUse;
                    for (const vt of voicings) {
                        const key = `${pa.root}-${pa.chordType}-${vt}`;
                        if (!dom7v_usedChallenges.has(key)) {
                            availableChallenges.push({ root: pa.root, chordType: pa.chordType, voicingType: vt, key });
                        }
                    }
                });

                // Reset if we've used all problem area combinations
                if (availableChallenges.length === 0) {
                    dom7v_usedChallenges.clear();
                    dom7v_config.problemAreaChallenges.forEach(pa => {
                        const voicings = pa.voicingType ? [pa.voicingType] : voicingTypesToUse;
                        for (const vt of voicings) {
                            const key = `${pa.root}-${pa.chordType}-${vt}`;
                            availableChallenges.push({ root: pa.root, chordType: pa.chordType, voicingType: vt, key });
                        }
                    });
                }

                chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            } else {
                // Normal mode: pick from all combinations
                const chordTypesToUse = dom7v_config.chordType === 'all' ? ROOTLESS_CHORD_TYPES : [dom7v_config.chordType];
                const voicingTypesToUse = dom7v_config.voicingType === 'both' ? ROOTLESS_VOICING_TYPES : [dom7v_config.voicingType];

                // Build list of available root+chordType+voicingType combinations
                let availableChallenges = [];
                for (let root = 0; root < 12; root++) {
                    for (const chordType of chordTypesToUse) {
                        for (const voicingType of voicingTypesToUse) {
                            const key = `${root}-${chordType}-${voicingType}`;
                            if (!dom7v_usedChallenges.has(key)) {
                                availableChallenges.push({ root, chordType, voicingType, key });
                            }
                        }
                    }
                }

                // Reset if we've used all combinations
                if (availableChallenges.length === 0) {
                    dom7v_usedChallenges.clear();
                    for (let root = 0; root < 12; root++) {
                        for (const chordType of chordTypesToUse) {
                            for (const voicingType of voicingTypesToUse) {
                                availableChallenges.push({ root, chordType, voicingType, key: `${root}-${chordType}-${voicingType}` });
                            }
                        }
                    }
                }

                chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            }

            dom7v_usedChallenges.add(chosen.key);

            dom7v_challenge = dom7vGetChallenge(chosen.root, chosen.chordType, chosen.voicingType);
            dom7v_currentRound++;
            dom7v_roundHadMistake = false;
            dom7v_challengeStartTime = Date.now();

            document.getElementById('dom7v_roundDisplay').innerText = dom7v_currentRound;
            document.getElementById('dom7v_chordDisplay').innerText = dom7v_challenge.name;
            document.getElementById('dom7v_formulaHint').innerText = dom7v_challenge.formula;
            document.getElementById('dom7v_heldNotes').innerText = 'Holding: --';

            // Show voicing type indicator when practicing both types
            const voicingTypeDisplay = document.getElementById('dom7v_voicingTypeDisplay');
            if (dom7v_config.voicingType === 'both') {
                voicingTypeDisplay.innerText = `(${dom7v_challenge.voicingType})`;
            } else {
                voicingTypeDisplay.innerText = '';
            }

            // Show/hide note hint based on settings
            const noteHintEl = document.getElementById('dom7v_noteHint');
            if (dom7v_config.showHints) {
                noteHintEl.innerText = dom7v_challenge.noteNames.join(' - ');
                noteHintEl.classList.remove('hidden');
            } else {
                noteHintEl.classList.add('hidden');
            }

            clearAllHighlights('dom7v_pianoSvg');
        }

        function dom7vOnNoteOn(midi) {
            if (!dom7v_isPlaying || !dom7v_challenge) return;

            highlightKey('dom7v_pianoSvg', midi, 'key-held');

            const notePitchClass = midi % 12;
            const requiredPitchClasses = dom7v_challenge.pitchClasses;

            // Check if note is wrong (not in the voicing)
            const isWrongNote = !requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!dom7v_roundHadMistake) {
                    dom7v_totalMistakes++;
                    dom7v_roundHadMistake = true;
                    dom7vShowFeedback('✗', false);
                    document.getElementById('dom7v_mistakesDisplay').innerText = dom7v_totalMistakes;
                }
                highlightKey('dom7v_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('dom7v_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const hasAllRequired = [...requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldPitchClasses.size >= requiredPitchClasses.size) {
                // Voicing complete!
                const responseTime = (Date.now() - dom7v_challengeStartTime) / 1000;

                // Track slow responses
                if (responseTime > 2) {
                    dom7v_slowCount++;
                    document.getElementById('dom7v_slowDisplay').innerText = dom7v_slowCount;
                }

                // Update stats for this chord (include voicing type in key when practicing both)
                const statKey = dom7v_config.voicingType === 'both'
                    ? `${dom7v_challenge.name} (${dom7v_challenge.voicingType})`
                    : dom7v_challenge.name;
                if (!dom7v_stats[statKey]) {
                    dom7v_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                }
                dom7v_stats[statKey].total++;
                if (responseTime > 2) dom7v_stats[statKey].slow++;

                if (!dom7v_roundHadMistake) {
                    dom7v_firstTryCorrect++;
                    dom7v_stats[statKey].firstTry++;
                    dom7v_stats[statKey].times.push(responseTime);
                    dom7v_allTimes.push(responseTime);
                    const dom7vPct = dom7v_currentRound > 0 ? Math.round((dom7v_firstTryCorrect / dom7v_currentRound) * 100) : 0;
                    document.getElementById('dom7v_scoreDisplay').innerText = dom7vPct + '%';
                    dom7vShowFeedback('✓', true, responseTime);
                } else {
                    dom7vShowFeedback('✓', true);
                }

                // Update average time
                if (dom7v_allTimes.length > 0) {
                    const avg = dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length;
                    dom7vUpdateResponseTime(avg);
                }

                dom7v_isPlaying = false;
                setTimeout(() => {
                    clearAllHighlights('dom7v_pianoSvg');
                    dom7v_isPlaying = true;
                    dom7vNextChallenge();
                }, 600);
            }
        }

        function dom7vOnNoteOff(midi) {
            highlightKey('dom7v_pianoSvg', midi, 'key-held', false);
            highlightKey('dom7v_pianoSvg', midi, 'key-wrong', false);

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('dom7v_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function dom7vShowFeedback(text, isPositive, time = null) {
            const el = document.getElementById('dom7v_feedbackFloat');
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none feedback-anim ' + (isPositive ? 'text-green-400' : 'text-red-400');
            setTimeout(() => { el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none opacity-0'; }, 1000);
        }

        function dom7vUpdateResponseTime(avgTime) {
            const el = document.getElementById('dom7v_responseTime');
            el.innerText = avgTime.toFixed(1) + 's';
            el.className = 'text-2xl font-mono ' + (avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow');
        }

        function dom7vStopGame() {
            dom7v_isPlaying = false;
            dom7v_challenge = null;
            clearAllHighlights('dom7v_pianoSvg');
            document.getElementById('dom7v_startBtn').classList.remove('hidden');
            document.getElementById('dom7v_stopBtn').classList.add('hidden');
            document.getElementById('dom7v_challengeDisplay').classList.add('hidden');
            document.getElementById('dom7v_settingsPanel').classList.remove('hidden');
        }

        function dom7vEndGame() {
            dom7v_isPlaying = false;
            dom7v_challenge = null;
            clearAllHighlights('dom7v_pianoSvg');

            const totalRounds = dom7v_config.totalRounds;
            const accuracy = totalRounds > 0 ? Math.min(100, Math.round((dom7v_firstTryCorrect / totalRounds) * 100)) : 0;
            const avgTime = dom7v_allTimes.length > 0 ? dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length : 0;

            // Save to history
            dom7v_history.unshift({
                date: new Date().toISOString(),
                config: { ...dom7v_config },
                score: dom7v_firstTryCorrect,
                totalRounds,
                accuracy,
                avgTime,
                totalMistakes: dom7v_totalMistakes,
                slowCount: dom7v_slowCount,
                stats: JSON.parse(JSON.stringify(dom7v_stats))
            });
            if (dom7v_history.length > 50) dom7v_history.pop();
            localStorage.setItem('dom7vGameHistory', JSON.stringify(dom7v_history));

            dom7vUpdateCumulativeStats();
            dom7vShowGameComplete();
        }

        function dom7vShowGameComplete() {
            const totalRounds = dom7v_config.totalRounds;
            const accuracy = totalRounds > 0 ? Math.min(100, Math.round((dom7v_firstTryCorrect / totalRounds) * 100)) : 0;
            const avgTime = dom7v_allTimes.length > 0 ? dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length : 0;

            document.getElementById('dom7v_finalScore').innerText = `${dom7v_firstTryCorrect}/${totalRounds}`;
            document.getElementById('dom7v_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('dom7v_finalMistakes').innerText = dom7v_totalMistakes;
            document.getElementById('dom7v_finalAvgTime').innerText = avgTime.toFixed(1) + 's';
            document.getElementById('dom7v_finalSlow').innerText = dom7v_slowCount;

            // Identify weak areas from this game
            const weakAreas = Object.entries(dom7v_stats)
                .filter(([_, data]) => data.firstTry < data.total)
                .map(([name, _]) => name);
            document.getElementById('dom7v_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Needs practice: ' + weakAreas.join(', ') : '';

            document.getElementById('dom7v_challengeDisplay').classList.add('hidden');
            document.getElementById('dom7v_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('dom7v_stopBtn').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.remove('hidden');
            document.getElementById('dom7v_newGameBtn').classList.remove('hidden');

            dom7vShowBreakdown();
            dom7vRenderHistory();
        }

        function dom7vPlayAgain() {
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            dom7vStartGame();
        }

        function dom7vNewGame() {
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_breakdownSection').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            document.getElementById('dom7v_startBtn').classList.remove('hidden');
            document.getElementById('dom7v_settingsPanel').classList.remove('hidden');
        }

        function dom7vShowBreakdown() {
            const grid = document.getElementById('dom7v_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(dom7v_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('dom7v_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chordName, data] of Object.entries(dom7v_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;

                const color = pct >= 80 ? 'bg-green-900 border-green-700' :
                              pct >= 50 ? 'bg-yellow-900 border-yellow-700' :
                              'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';

                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chordName}</p>
                                 <p>${pct}% (${data.firstTry}/${data.total})</p>
                                 <p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('dom7v_breakdownSection').classList.remove('hidden');
        }

        function dom7vLoadHistory() {
            const saved = localStorage.getItem('dom7vGameHistory');
            if (saved) { dom7v_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('dom7vCumulativeStats');
            if (savedCumulative) { dom7v_cumulativeStats = JSON.parse(savedCumulative); }
            dom7vRenderHistory();
        }

        function dom7vClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            dom7v_history = [];
            dom7v_cumulativeStats = {};
            localStorage.removeItem('dom7vGameHistory');
            localStorage.removeItem('dom7vCumulativeStats');
            dom7vRenderHistory();
        }

        function dom7vUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(dom7v_stats)) {
                if (!dom7v_cumulativeStats[chordName]) {
                    dom7v_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                dom7v_cumulativeStats[chordName].attempts += data.total;
                dom7v_cumulativeStats[chordName].firstTry += data.firstTry;
                dom7v_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                dom7v_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('dom7vCumulativeStats', JSON.stringify(dom7v_cumulativeStats));
        }

        function dom7vGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(dom7v_cumulativeStats)) {
                if (data.attempts >= 3) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function dom7vRenderHistory() {
            const content = document.getElementById('dom7v_historyContent');
            if (dom7v_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = dom7v_history.length;
            const avgAccuracy = Math.round(dom7v_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = dom7v_history.slice(0, 10);
            const medals = getMedals(displayedGames, 'accuracy', 'avgTime');

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: 🥇🥈🥉 = top 3</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const medal = medals[idx];
                const rowClass = medal === '🥇' ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats (only show actual problems)
            const problemAreas = dom7vGetProblemAreas().filter(a => a.successRate < 80 || a.slowRate > 30);
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-1">Problem Areas <span class="text-slate-500">(practice these)</span></p>
                    <p class="text-[10px] text-slate-500 mb-2">% = first-try accuracy, ⏱ = slow responses. Clear History to reset.</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.slice(0, 10).forEach(area => {
                    const pct = Math.round(area.successRate);
                    const pctClass = pct < 50 ? 'text-red-400' : pct < 80 ? 'text-yellow-400' : 'text-green-400';
                    const slowIndicator = area.slowRate > 30 ? ' <span class="text-orange-400">⏱</span>' : '';
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="${pctClass}">${pct}%</span>${slowIndicator}
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ EXTENDED VOICINGS MODE ============
        // Extended voicings: Maj6/9 (3-5-6-9), Min6/9 (b3-5-6-9), Dom13 (3-13-7-9)
        const EXTENDED_VOICINGS = {
            'maj69': { intervals: [4, 7, 9, 2], suffix: 'Maj6/9', formula: '3 - 5 - 6 - 9' },   // maj3, P5, maj6, maj9
            'min69': { intervals: [3, 7, 9, 2], suffix: 'm6/9', formula: 'b3 - 5 - 6 - 9' },    // min3, P5, maj6, maj9
            'dom13': { intervals: [4, 9, 10, 2], suffix: '13', formula: '3 - 13 - 7 - 9' }      // maj3, maj13, min7, maj9
        };
        const EXTENDED_CHORD_TYPES = ['maj69', 'min69', 'dom13'];

        let extv_isPlaying = false;
        let extv_challenge = null;
        let extv_usedChallenges = new Set();
        let extv_challengeStartTime = null;
        let extv_config = null;
        let extv_currentRound = 0;
        let extv_firstTryCorrect = 0;
        let extv_totalMistakes = 0;
        let extv_roundHadMistake = false;
        let extv_stats = {};
        let extv_allTimes = [];
        let extv_slowCount = 0;
        let extv_history = [];
        let extv_cumulativeStats = {};

        function extvGetChallenge(root, chordType) {
            const voicing = EXTENDED_VOICINGS[chordType];
            const pitchClasses = new Set(voicing.intervals.map(i => (root + i) % 12));
            const noteNames = voicing.intervals.map(i => NOTE_NAMES[(root + i) % 12]);
            return {
                root: root,
                chordType: chordType,
                name: NOTE_NAMES[root] + voicing.suffix,
                pitchClasses: pitchClasses,
                noteNames: noteNames,
                formula: voicing.formula
            };
        }

        function extvStartGame() {
            saveAllSettings();

            const focusProblemAreas = document.getElementById('extv_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = extvGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "CMaj6/9", "Dm6/9", "G13"
                problemAreaChallenges = [];
                const suffixToChordType = { 'Maj6/9': 'maj69', 'm6/9': 'min69', '13': 'dom13' };
                problemAreas.forEach(area => {
                    for (const [suffix, chordType] of Object.entries(suffixToChordType)) {
                        if (area.name.endsWith(suffix)) {
                            const noteName = area.name.slice(0, -suffix.length);
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, chordType, name: area.name });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            extv_config = {
                totalRounds: parseInt(document.getElementById('extv_roundsSelect').value),
                showHints: document.getElementById('extv_showHints').checked,
                chordType: document.getElementById('extv_chordTypeSelect').value,
                focusProblemAreas,
                problemAreaChallenges
            };
            extv_currentRound = 0;
            extv_firstTryCorrect = 0;
            extv_totalMistakes = 0;
            extv_slowCount = 0;
            extv_roundHadMistake = false;
            extv_usedChallenges = new Set();
            extv_stats = {};
            extv_allTimes = [];

            document.getElementById('extv_roundDisplay').innerText = '0';
            document.getElementById('extv_totalRoundsDisplay').innerText = extv_config.totalRounds;
            document.getElementById('extv_responseTime').innerText = '--';
            document.getElementById('extv_scoreDisplay').innerText = '0%';
            document.getElementById('extv_mistakesDisplay').innerText = '0';
            document.getElementById('extv_slowDisplay').innerText = '0';

            document.getElementById('extv_startBtn').classList.add('hidden');
            document.getElementById('extv_stopBtn').classList.remove('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            document.getElementById('extv_settingsPanel').classList.add('hidden');
            document.getElementById('extv_challengeDisplay').classList.remove('hidden');
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_breakdownSection').classList.add('hidden');

            extvRunCountdown(3);
        }

        function extvRunCountdown(seconds) {
            if (seconds > 0) {
                document.getElementById('extv_chordDisplay').innerText = seconds;
                document.getElementById('extv_formulaLine').classList.add('hidden');
                document.getElementById('extv_noteHint').classList.add('hidden');
                document.getElementById('extv_heldNotes').innerText = 'Get ready...';
                setTimeout(() => extvRunCountdown(seconds - 1), 1000);
            } else {
                document.getElementById('extv_formulaLine').classList.remove('hidden');
                extv_isPlaying = true;
                extvNextChallenge();
            }
        }

        function extvNextChallenge() {
            if (extv_currentRound >= extv_config.totalRounds) {
                extvEndGame();
                return;
            }

            let chosen;

            if (extv_config.focusProblemAreas && extv_config.problemAreaChallenges) {
                // Focus on problem areas
                let availableChallenges = [];
                extv_config.problemAreaChallenges.forEach(pa => {
                    const key = `${pa.root}-${pa.chordType}`;
                    if (!extv_usedChallenges.has(key)) {
                        availableChallenges.push({ root: pa.root, chordType: pa.chordType, key });
                    }
                });

                // Reset if we've used all problem area combinations
                if (availableChallenges.length === 0) {
                    extv_usedChallenges.clear();
                    extv_config.problemAreaChallenges.forEach(pa => {
                        const key = `${pa.root}-${pa.chordType}`;
                        availableChallenges.push({ root: pa.root, chordType: pa.chordType, key });
                    });
                }

                chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            } else {
                // Normal mode
                const chordTypesToUse = extv_config.chordType === 'all' ? EXTENDED_CHORD_TYPES : [extv_config.chordType];

                // Build list of available root+chordType combinations
                let availableChallenges = [];
                for (let root = 0; root < 12; root++) {
                    for (const chordType of chordTypesToUse) {
                        const key = `${root}-${chordType}`;
                        if (!extv_usedChallenges.has(key)) {
                            availableChallenges.push({ root, chordType, key });
                        }
                    }
                }

                // Reset if we've used all combinations
                if (availableChallenges.length === 0) {
                    extv_usedChallenges.clear();
                    for (let root = 0; root < 12; root++) {
                        for (const chordType of chordTypesToUse) {
                            availableChallenges.push({ root, chordType, key: `${root}-${chordType}` });
                        }
                    }
                }

                chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            }

            extv_usedChallenges.add(chosen.key);

            extv_challenge = extvGetChallenge(chosen.root, chosen.chordType);
            extv_currentRound++;
            extv_roundHadMistake = false;
            extv_challengeStartTime = Date.now();

            document.getElementById('extv_roundDisplay').innerText = extv_currentRound;
            document.getElementById('extv_chordDisplay').innerText = extv_challenge.name;
            document.getElementById('extv_formulaHint').innerText = extv_challenge.formula;
            document.getElementById('extv_heldNotes').innerText = 'Holding: --';

            // Show/hide note hint based on settings
            const noteHintEl = document.getElementById('extv_noteHint');
            if (extv_config.showHints) {
                noteHintEl.innerText = extv_challenge.noteNames.join(' - ');
                noteHintEl.classList.remove('hidden');
            } else {
                noteHintEl.classList.add('hidden');
            }

            clearAllHighlights('extv_pianoSvg');
        }

        function extvOnNoteOn(midi) {
            if (!extv_isPlaying || !extv_challenge) return;

            highlightKey('extv_pianoSvg', midi, 'key-held');

            const pc = midi % 12;
            const isCorrect = extv_challenge.pitchClasses.has(pc);

            if (!isCorrect) {
                if (!extv_roundHadMistake) {
                    extv_roundHadMistake = true;
                    extv_totalMistakes++;
                    document.getElementById('extv_mistakesDisplay').innerText = extv_totalMistakes;
                    extvShowFeedback('✗', false);
                }
                highlightKey('extv_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('extv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const allCorrect = [...extv_challenge.pitchClasses].every(pc => heldPitchClasses.has(pc));

            if (allCorrect && heldNotes.size >= extv_challenge.pitchClasses.size) {
                const responseTime = (Date.now() - extv_challengeStartTime) / 1000;

                if (responseTime > 2) {
                    extv_slowCount++;
                    document.getElementById('extv_slowDisplay').innerText = extv_slowCount;
                }

                // Update stats for this chord
                const statKey = extv_challenge.name;
                if (!extv_stats[statKey]) {
                    extv_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                }
                extv_stats[statKey].total++;
                if (responseTime > 2) extv_stats[statKey].slow++;

                if (!extv_roundHadMistake) {
                    extv_firstTryCorrect++;
                    extv_stats[statKey].firstTry++;
                    extv_stats[statKey].times.push(responseTime);
                    extv_allTimes.push(responseTime);
                    const extvPct = extv_currentRound > 0 ? Math.round((extv_firstTryCorrect / extv_currentRound) * 100) : 0;
                    document.getElementById('extv_scoreDisplay').innerText = extvPct + '%';
                    extvShowFeedback('✓', true, responseTime);
                } else {
                    extvShowFeedback('✓', true);
                }

                // Update average time
                if (extv_allTimes.length > 0) {
                    const avg = extv_allTimes.reduce((a, b) => a + b, 0) / extv_allTimes.length;
                    extvUpdateResponseTime(avg);
                }

                setTimeout(() => {
                    clearAllHighlights('extv_pianoSvg');
                    extvNextChallenge();
                }, 500);
            }
        }

        function extvOnNoteOff(midi) {
            clearKeyHighlight('extv_pianoSvg', midi);

            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('extv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function extvShowFeedback(text, isPositive, time = null) {
            const el = document.getElementById('extv_feedbackFloat');
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none feedback-anim ' + (isPositive ? 'text-green-400' : 'text-red-400');
            setTimeout(() => { el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none opacity-0'; }, 1000);
        }

        function extvUpdateResponseTime(avgTime) {
            const el = document.getElementById('extv_responseTime');
            el.innerText = avgTime.toFixed(1) + 's';
            el.className = 'text-2xl font-mono ' + (avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow');
        }

        function extvStopGame() {
            extv_isPlaying = false;
            extv_challenge = null;
            clearAllHighlights('extv_pianoSvg');
            document.getElementById('extv_startBtn').classList.remove('hidden');
            document.getElementById('extv_stopBtn').classList.add('hidden');
            document.getElementById('extv_challengeDisplay').classList.add('hidden');
            document.getElementById('extv_settingsPanel').classList.remove('hidden');
        }

        function extvEndGame() {
            extv_isPlaying = false;
            extv_challenge = null;

            // Save to history
            const gameResult = {
                date: new Date().toISOString(),
                score: extv_firstTryCorrect,
                total: extv_config.totalRounds,
                accuracy: Math.round((extv_firstTryCorrect / extv_config.totalRounds) * 100),
                avgTime: extv_allTimes.length > 0 ? (extv_allTimes.reduce((a, b) => a + b, 0) / extv_allTimes.length).toFixed(1) : '--',
                mistakes: extv_totalMistakes,
                slow: extv_slowCount,
                chordType: extv_config.chordType
            };
            extv_history.unshift(gameResult);
            if (extv_history.length > 10) extv_history.pop();
            localStorage.setItem('extvGameHistory', JSON.stringify(extv_history));

            extvUpdateCumulativeStats();

            // Update final display
            document.getElementById('extv_finalScore').innerText = `${extv_firstTryCorrect}/${extv_config.totalRounds}`;
            document.getElementById('extv_finalAccuracy').innerText = gameResult.accuracy + '%';
            document.getElementById('extv_finalMistakes').innerText = extv_totalMistakes;
            document.getElementById('extv_finalAvgTime').innerText = gameResult.avgTime + 's';
            document.getElementById('extv_finalSlow').innerText = extv_slowCount;

            const weakAreas = Object.entries(extv_stats)
                .filter(([_, data]) => data.firstTry < data.total)
                .map(([name, _]) => name);
            document.getElementById('extv_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Needs practice: ' + weakAreas.join(', ') : '';

            document.getElementById('extv_challengeDisplay').classList.add('hidden');
            document.getElementById('extv_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('extv_stopBtn').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.remove('hidden');
            document.getElementById('extv_newGameBtn').classList.remove('hidden');

            extvShowBreakdown();
            extvRenderHistory();
        }

        function extvPlayAgain() {
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            extvStartGame();
        }

        function extvNewGame() {
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_breakdownSection').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            document.getElementById('extv_startBtn').classList.remove('hidden');
            document.getElementById('extv_settingsPanel').classList.remove('hidden');
        }

        function extvShowBreakdown() {
            const grid = document.getElementById('extv_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(extv_stats).length > 0;

            if (!hasSessionStats) {
                document.getElementById('extv_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chordName, data] of Object.entries(extv_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;

                const color = pct >= 80 ? 'bg-green-900 border-green-700' :
                              pct >= 50 ? 'bg-yellow-900 border-yellow-700' :
                              'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';

                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chordName}</p>
                                 <p>${pct}% (${data.firstTry}/${data.total})</p>
                                 <p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('extv_breakdownSection').classList.remove('hidden');
        }

        function extvLoadHistory() {
            const savedHistory = localStorage.getItem('extvGameHistory');
            if (savedHistory) { extv_history = JSON.parse(savedHistory); }
            const savedCumulative = localStorage.getItem('extvCumulativeStats');
            if (savedCumulative) { extv_cumulativeStats = JSON.parse(savedCumulative); }
            extvRenderHistory();
        }

        function extvClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            extv_history = [];
            extv_cumulativeStats = {};
            localStorage.removeItem('extvGameHistory');
            localStorage.removeItem('extvCumulativeStats');
            extvRenderHistory();
        }

        function extvUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(extv_stats)) {
                if (!extv_cumulativeStats[chordName]) {
                    extv_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                extv_cumulativeStats[chordName].attempts += data.total;
                extv_cumulativeStats[chordName].firstTry += data.firstTry;
                extv_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                extv_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('extvCumulativeStats', JSON.stringify(extv_cumulativeStats));
        }

        function extvGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(extv_cumulativeStats)) {
                if (data.attempts >= 3) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    if (successRate < 80 || slowRate > 30) {
                        areas.push({ name, successRate: successRate.toFixed(0), slowRate: slowRate.toFixed(0), attempts: data.attempts });
                    }
                }
            }
            return areas.sort((a, b) => parseFloat(a.successRate) - parseFloat(b.successRate)).slice(0, 5);
        }

        function extvRenderHistory() {
            const content = document.getElementById('extv_historyContent');
            if (extv_history.length === 0 && Object.keys(extv_cumulativeStats).length === 0) {
                content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>';
                return;
            }

            let html = '';

            // Problem areas
            const problemAreas = extvGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3 mb-4">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    const mistakeRate = Math.round(100 - parseFloat(area.successRate));
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.name} <span class="text-red-400">${mistakeRate}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            // Recent games
            if (extv_history.length > 0) {
                html += '<p class="text-slate-400 text-sm mb-2">Recent Games:</p>';
                html += '<div class="space-y-1">';
                extv_history.forEach(game => {
                    const date = new Date(game.date).toLocaleDateString();
                    const typeLabel = game.chordType === 'all' ? 'All' : EXTENDED_VOICINGS[game.chordType]?.suffix || game.chordType;
                    const slowLabel = game.slow > 0 ? ` | <span class="text-orange-400">${game.slow} slow</span>` : '';
                    html += `<div class="text-sm">
                        <span class="text-slate-500">${date}</span>
                        <span class="text-slate-400 ml-2">${typeLabel}</span>
                        <span class="ml-2 ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 50 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span>
                        <span class="text-slate-500">(${game.score}/${game.total})</span>
                        <span class="text-purple-400 ml-2">${game.avgTime}s avg</span>
                        ${slowLabel}
                    </div>`;
                });
                html += '</div>';
            }

            content.innerHTML = html;
        }

        // ============ PENTATONIC & BLUES MODE ============
        const PENT_SCALES = {
            'minPent': {
                name: 'Minor Pentatonic',
                intervals: [0, 3, 5, 7, 10],
                degrees: ['1', 'b3', '4', '5', 'b7']
            },
            'majPent': {
                name: 'Major Pentatonic',
                intervals: [0, 2, 4, 7, 9],
                degrees: ['1', '2', '3', '5', '6']
            },
            'blues': {
                name: 'Blues',
                intervals: [0, 3, 5, 6, 7, 10],
                degrees: ['1', 'b3', '4', 'b5', '5', 'b7']
            }
        };

        let pent_isPlaying = false;
        let pent_challenge = null;
        let pent_usedChallenges = new Set();
        let pent_challengeStartTime = null;
        let pent_config = null;
        let pent_currentRound = 0;
        let pent_firstTryCorrect = 0;
        let pent_totalMistakes = 0;
        let pent_roundHadMistake = false;
        let pent_stats = {};
        let pent_allTimes = [];
        let pent_slowCount = 0;
        let pent_history = [];
        let pent_cumulativeStats = {};
        let pent_currentNoteIndex = 0;

        function pentStartGame() {
            saveAllSettings();
            const scaleType = document.getElementById('pent_scaleTypeSelect').value;
            const rounds = parseInt(document.getElementById('pent_roundsSelect').value);
            const showHints = document.getElementById('pent_showHints').checked;

            const focusProblemAreas = document.getElementById('pent_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = pentGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C Minor Pentatonic" -> { root: 0, scaleType: 'minPent' }
                problemAreaChallenges = [];
                const nameToScaleType = {};
                Object.entries(PENT_SCALES).forEach(([type, def]) => {
                    nameToScaleType[def.name] = type;
                });
                problemAreas.forEach(area => {
                    // Key is like "C Minor Pentatonic", "D Blues"
                    for (const [name, type] of Object.entries(nameToScaleType)) {
                        if (area.key.endsWith(name)) {
                            const noteName = area.key.slice(0, -(name.length + 1)); // +1 for space
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, scaleType: type, key: area.key });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            pent_config = { scaleType, rounds, showHints, focusProblemAreas, problemAreaChallenges };
            pent_isPlaying = true;
            pent_usedChallenges.clear();
            pent_currentRound = 0;
            pent_firstTryCorrect = 0;
            pent_totalMistakes = 0;
            pent_stats = {};
            pent_allTimes = [];
            pent_slowCount = 0;

            document.getElementById('pent_settingsPanel').classList.add('hidden');
            document.getElementById('pent_challengeDisplay').classList.remove('hidden');
            document.getElementById('pent_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('pent_startBtn').innerText = 'Stop';
            document.getElementById('pent_startBtn').disabled = false;
            document.getElementById('pent_startBtn').onclick = pentStopGame;
            document.getElementById('pent_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('pent_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('pent_totalRounds').innerText = rounds;

            // Show/hide hints
            document.querySelectorAll('.pent-hint').forEach(el => {
                el.style.display = showHints ? 'block' : 'none';
            });

            pentRunCountdown(3);
        }

        function pentStopGame() {
            pent_isPlaying = false;
            document.getElementById('pent_settingsPanel').classList.remove('hidden');
            document.getElementById('pent_challengeDisplay').classList.add('hidden');
            document.getElementById('pent_startBtn').innerText = 'Start Game';
            document.getElementById('pent_startBtn').disabled = false;
            document.getElementById('pent_startBtn').onclick = pentStartGame;
            document.getElementById('pent_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('pent_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            clearPiano('pent_pianoSvg');
        }

        function pentRunCountdown(count) {
            if (!pent_isPlaying) return;
            document.getElementById('pent_rootDisplay').innerText = count;
            document.getElementById('pent_scaleNameDisplay').innerText = '';
            if (count > 0) {
                setTimeout(() => pentRunCountdown(count - 1), 800);
            } else {
                pentNextChallenge();
            }
        }

        function pentNextChallenge() {
            if (pent_currentRound >= pent_config.rounds) {
                pentEndGame();
                return;
            }

            pent_currentRound++;
            pent_roundHadMistake = false;
            pent_currentNoteIndex = 0;
            document.getElementById('pent_currentRound').innerText = pent_currentRound;

            let root, scaleType;

            if (pent_config.focusProblemAreas && pent_config.problemAreaChallenges) {
                // Focus on problem areas
                const maxUnique = pent_config.problemAreaChallenges.length;
                if (pent_usedChallenges.size >= maxUnique) {
                    pent_usedChallenges.clear();
                }
                // Pick from problem areas
                let availablePAs = pent_config.problemAreaChallenges.filter(pa => {
                    const key = `${pa.root}-${pa.scaleType}`;
                    return !pent_usedChallenges.has(key);
                });
                if (availablePAs.length === 0) {
                    availablePAs = pent_config.problemAreaChallenges;
                }
                const chosen = availablePAs[Math.floor(Math.random() * availablePAs.length)];
                root = chosen.root;
                scaleType = chosen.scaleType;
            } else {
                // Normal mode: Pick random root and scale type
                root = Math.floor(Math.random() * 12);
                if (pent_config.scaleType === 'all') {
                    const types = Object.keys(PENT_SCALES);
                    scaleType = types[Math.floor(Math.random() * types.length)];
                } else {
                    scaleType = pent_config.scaleType;
                }
            }

            const challengeKey = `${root}-${scaleType}`;
            if (pent_usedChallenges.has(challengeKey) && pent_usedChallenges.size < 36) {
                pentNextChallenge();
                return;
            }
            pent_usedChallenges.add(challengeKey);

            const scaleDef = PENT_SCALES[scaleType];
            const expectedNotes = scaleDef.intervals.map(i => (root + i) % 12);

            pent_challenge = {
                root,
                scaleType,
                scaleName: scaleDef.name,
                expectedNotes,
                degrees: scaleDef.degrees,
                key: `${NOTE_NAMES[root]} ${scaleDef.name}`
            };

            pent_challengeStartTime = Date.now();

            // Update display
            document.getElementById('pent_rootDisplay').innerText = NOTE_NAMES[root];
            document.getElementById('pent_scaleNameDisplay').innerText = scaleDef.name;

            // Build note progress indicators
            const progressDiv = document.getElementById('pent_noteProgress');
            progressDiv.innerHTML = scaleDef.degrees.map((deg, i) =>
                `<div class="w-10 h-10 rounded-full ${i === 0 ? 'bg-blue-600 border-blue-400' : 'bg-slate-700 border-slate-600'} flex items-center justify-center text-sm font-bold border-2" id="pent_note_${i}">
                    <span class="pent-hint" style="display:${pent_config.showHints ? 'block' : 'none'}">${deg}</span>
                </div>`
            ).join('');

            // Update expected note hint
            if (pent_config.showHints) {
                document.getElementById('pent_expectedNote').innerHTML = `Next: <span class="text-white font-bold">${NOTE_NAMES[expectedNotes[0]]}</span>`;
            } else {
                document.getElementById('pent_expectedNote').innerHTML = `<span class="text-slate-500">Note 1 of ${expectedNotes.length}</span>`;
            }

            // Clear piano highlights
            for (let i = 0; i < 128; i++) {
                highlightKey('pent_pianoSvg', i, 'key-correct', false);
                highlightKey('pent_pianoSvg', i, 'key-error', false);
            }

            // Initialize stats for this scale if needed
            if (!pent_stats[pent_challenge.key]) {
                pent_stats[pent_challenge.key] = { attempts: 0, mistakes: 0, times: [] };
            }
            pent_stats[pent_challenge.key].attempts++;
        }

        function pentOnNoteOn(midi) {
            if (!pent_isPlaying || !pent_challenge || !pent_challengeStartTime) return;

            const pitchClass = midi % 12;
            const expectedPitchClass = pent_challenge.expectedNotes[pent_currentNoteIndex];

            if (pitchClass === expectedPitchClass) {
                // Correct note
                highlightKey('pent_pianoSvg', midi, 'key-correct', true);

                // Update progress indicator - mark current as complete
                const noteEl = document.getElementById(`pent_note_${pent_currentNoteIndex}`);
                if (noteEl) {
                    noteEl.classList.remove('bg-slate-700', 'border-slate-600', 'bg-blue-600', 'border-blue-400');
                    noteEl.classList.add('bg-green-600', 'border-green-400');
                }

                pent_currentNoteIndex++;

                // Highlight next note in blue
                const nextNoteEl = document.getElementById(`pent_note_${pent_currentNoteIndex}`);
                if (nextNoteEl && pent_currentNoteIndex < pent_challenge.expectedNotes.length) {
                    nextNoteEl.classList.remove('bg-slate-700', 'border-slate-600');
                    nextNoteEl.classList.add('bg-blue-600', 'border-blue-400');
                }

                // Update expected note hint
                if (pent_currentNoteIndex < pent_challenge.expectedNotes.length) {
                    if (pent_config.showHints) {
                        document.getElementById('pent_expectedNote').innerHTML =
                            `Next: <span class="text-white font-bold">${NOTE_NAMES[pent_challenge.expectedNotes[pent_currentNoteIndex]]}</span>`;
                    } else {
                        document.getElementById('pent_expectedNote').innerHTML =
                            `<span class="text-slate-500">Note ${pent_currentNoteIndex + 1} of ${pent_challenge.expectedNotes.length}</span>`;
                    }
                }

                // Check if scale is complete
                if (pent_currentNoteIndex >= pent_challenge.expectedNotes.length) {
                    const elapsed = (Date.now() - pent_challengeStartTime) / 1000;
                    pent_allTimes.push(elapsed);
                    pent_stats[pent_challenge.key].times.push(elapsed);

                    if (!pent_roundHadMistake) {
                        pent_firstTryCorrect++;
                    }

                    if (elapsed > 2) {
                        pent_slowCount++;
                    }

                    document.getElementById('pent_score').innerText = pent_firstTryCorrect;

                    // Show "Complete!" in expected note area
                    document.getElementById('pent_expectedNote').innerHTML = '<span class="text-green-400">Complete!</span>';

                    // Update avg time display
                    const avgTime = pent_allTimes.reduce((a, b) => a + b, 0) / pent_allTimes.length;
                    const timeEl = document.getElementById('pent_responseTime');
                    timeEl.innerText = avgTime.toFixed(1) + 's';
                    timeEl.className = `text-2xl font-mono ${avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow'}`;

                    // Show feedback
                    pentShowFeedback(true);

                    // Next challenge after delay
                    setTimeout(pentNextChallenge, 800);
                }
            } else {
                // Wrong note
                highlightKey('pent_pianoSvg', midi, 'key-error', true);
                pent_totalMistakes++;
                pent_roundHadMistake = true;
                pent_stats[pent_challenge.key].mistakes++;
                document.getElementById('pent_mistakes').innerText = pent_totalMistakes;
                pentShowFeedback(false);

                setTimeout(() => {
                    highlightKey('pent_pianoSvg', midi, 'key-error', false);
                }, 300);
            }
        }

        function pentOnNoteOff(midi) {
            highlightKey('pent_pianoSvg', midi, 'key-correct', false);
            highlightKey('pent_pianoSvg', midi, 'key-active', false);
        }

        function pentShowFeedback(correct) {
            const float = document.getElementById('pent_feedbackFloat');
            float.innerText = correct ? '✓' : '✗';
            float.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none z-50 ${correct ? 'text-green-400' : 'text-red-400'}`;
            setTimeout(() => { float.classList.add('hidden'); }, 500);
        }

        function pentEndGame() {
            pent_isPlaying = false;
            pent_challenge = null;

            const accuracy = Math.round((pent_firstTryCorrect / pent_config.rounds) * 100);
            const avgTime = pent_allTimes.length > 0
                ? pent_allTimes.reduce((a, b) => a + b, 0) / pent_allTimes.length
                : 0;

            document.getElementById('pent_challengeDisplay').classList.add('hidden');
            document.getElementById('pent_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('pent_finalScore').innerText = `${pent_firstTryCorrect}/${pent_config.rounds}`;
            document.getElementById('pent_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('pent_finalMistakes').innerText = pent_totalMistakes;
            document.getElementById('pent_finalAvgTime').innerText = `${avgTime.toFixed(1)}s`;

            if (pent_slowCount > 0) {
                document.getElementById('pent_finalSlowCount').innerText = `${pent_slowCount} slow response${pent_slowCount > 1 ? 's' : ''} (>2s)`;
            } else {
                document.getElementById('pent_finalSlowCount').innerText = '';
            }

            document.getElementById('pent_slow').innerText = pent_slowCount;
            document.getElementById('pent_settingsPanel').classList.remove('hidden');
            document.getElementById('pent_startBtn').innerText = 'Play Again';
            document.getElementById('pent_startBtn').disabled = false;
            document.getElementById('pent_startBtn').onclick = pentStartGame;
            document.getElementById('pent_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('pent_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Save to history
            const gameRecord = {
                timestamp: Date.now(),
                score: pent_firstTryCorrect,
                totalRounds: pent_config.rounds,
                accuracy,
                avgTime,
                mistakes: pent_totalMistakes,
                slowCount: pent_slowCount,
                config: { ...pent_config }
            };
            pent_history.unshift(gameRecord);
            if (pent_history.length > 20) pent_history.pop();
            localStorage.setItem('pentHistory', JSON.stringify(pent_history));

            // Update cumulative stats
            pentUpdateCumulativeStats();

            // Show breakdown
            pentShowBreakdown();
            pentRenderHistory();
        }

        function pentShowBreakdown() {
            const grid = document.getElementById('pent_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(pent_stats).length > 0;

            if (hasSessionStats) {
                for (const [key, data] of Object.entries(pent_stats)) {
                    const pct = data.attempts > 0 ? Math.round(((data.attempts - data.mistakes) / data.attempts) * 100) : 0;
                    const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = data.attempts - data.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${firstTry}/${data.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('pent_breakdownSection').classList.remove('hidden');
            } else {
                // Show only problem areas from cumulative stats on page load
                const problemAreas = pentGetProblemAreas();
                if (problemAreas.length === 0) {
                    document.getElementById('pent_breakdownSection').classList.add('hidden');
                    return;
                }
                for (const area of problemAreas) {
                    const data = pent_cumulativeStats[area.key];
                    const firstTry = data.attempts - data.mistakes;
                    const pct = data.attempts > 0 ? Math.round((firstTry / data.attempts) * 100) : 0;
                    const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    div.innerHTML = `<p class="font-semibold">${area.key}</p><p>${pct}% (${firstTry}/${data.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('pent_breakdownSection').classList.remove('hidden');
            }
        }

        function pentLoadHistory() {
            const saved = localStorage.getItem('pentHistory');
            if (saved) {
                try { pent_history = JSON.parse(saved); } catch (e) { pent_history = []; }
            }
            const savedStats = localStorage.getItem('pentCumulativeStats');
            if (savedStats) {
                try { pent_cumulativeStats = JSON.parse(savedStats); } catch (e) { pent_cumulativeStats = {}; }
            }
            pentRenderHistory();
        }

        function pentUpdateCumulativeStats() {
            Object.entries(pent_stats).forEach(([key, data]) => {
                if (!pent_cumulativeStats[key]) {
                    pent_cumulativeStats[key] = { attempts: 0, mistakes: 0, times: [] };
                }
                pent_cumulativeStats[key].attempts += data.attempts;
                pent_cumulativeStats[key].mistakes += data.mistakes;
                pent_cumulativeStats[key].times.push(...data.times);
                if (pent_cumulativeStats[key].times.length > 50) {
                    pent_cumulativeStats[key].times = pent_cumulativeStats[key].times.slice(-50);
                }
            });
            localStorage.setItem('pentCumulativeStats', JSON.stringify(pent_cumulativeStats));
        }

        function pentGetProblemAreas() {
            const dominated = [];
            Object.entries(pent_cumulativeStats).forEach(([key, data]) => {
                if (data.attempts >= 2) {
                    const mistakeRate = data.mistakes / data.attempts;
                    const avgTime = data.times.length > 0
                        ? data.times.reduce((a, b) => a + b, 0) / data.times.length
                        : 0;
                    if (mistakeRate > 0.3 || avgTime > 3) {
                        dominated.push({ key, mistakeRate, avgTime, attempts: data.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function pentClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            pent_history = [];
            pent_cumulativeStats = {};
            localStorage.removeItem('pentHistory');
            localStorage.removeItem('pentCumulativeStats');
            pentRenderHistory();
        }

        function pentRenderHistory() {
            const content = document.getElementById('pent_historyContent');
            if (pent_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="pentClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            // Normalize accuracy field for medal calculation
            const normalizedHistory = pent_history.map(g => ({
                ...g,
                firstTryPct: g.accuracy !== undefined ? Math.min(g.accuracy, 100) : g.firstTryPct
            }));
            const medals = getMedals(normalizedHistory, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="pentClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            pent_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.timestamp || game.date).toLocaleDateString();
                const avgSec = game.avgTime.toFixed(1);
                const configLabel = game.config?.scaleType || 'All';
                const rounds = game.totalRounds || game.rounds;
                const firstTry = game.accuracy !== undefined ? Math.min(game.accuracy, 100) : game.firstTryPct;
                const slowCount = game.slowCount || 0;
                const timeClass = game.avgTime < 4 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16">${configLabel}</span>
                    <span class="text-white w-12">${rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${firstTry}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });
            html += '</div>';

            // Problem areas
            const problemAreas = pentGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ BEBOP SCALES MODE ============
        const BEBOP_SCALES = {
            'dominant': {
                name: 'Bebop Dominant',
                intervals: [0, 2, 4, 5, 7, 9, 10, 11], // 1 2 3 4 5 6 b7 7
                degrees: ['1', '2', '3', '4', '5', '6', 'b7', '7']
            },
            'major': {
                name: 'Bebop Major',
                intervals: [0, 2, 4, 5, 7, 8, 9, 11], // 1 2 3 4 5 #5 6 7
                degrees: ['1', '2', '3', '4', '5', '#5', '6', '7']
            }
        };

        let bebop_isPlaying = false;
        let bebop_challenge = null;
        let bebop_challengeStartTime = null;
        let bebop_config = null;
        let bebop_currentRound = 0;
        let bebop_firstTryCorrect = 0;
        let bebop_totalMistakes = 0;
        let bebop_roundHadMistake = false;
        let bebop_stats = {};
        let bebop_allTimes = [];
        let bebop_slowCount = 0;
        let bebop_history = [];
        let bebop_cumulativeStats = {};
        let bebop_currentNoteIndex = 0;

        function bebopStartGame() {
            saveAllSettings();
            const scaleType = document.getElementById('bebop_scaleTypeSelect').value;
            const rounds = parseInt(document.getElementById('bebop_roundsSelect').value);
            const showHints = document.getElementById('bebop_showHints').checked;

            const focusProblemAreas = document.getElementById('bebop_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = bebopGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C Bebop Dominant" -> { root: 0, scaleType: 'dominant' }
                problemAreaChallenges = [];
                const nameToScaleType = {};
                Object.entries(BEBOP_SCALES).forEach(([type, def]) => {
                    nameToScaleType[def.name] = type;
                });
                problemAreas.forEach(area => {
                    // Key is like "C Bebop Dominant", "D Bebop Major"
                    for (const [name, type] of Object.entries(nameToScaleType)) {
                        if (area.key.endsWith(name)) {
                            const noteName = area.key.slice(0, -(name.length + 1)); // +1 for space
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, scaleType: type, key: area.key });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            let scaleTypes = [];
            if (scaleType === 'all') {
                scaleTypes = Object.keys(BEBOP_SCALES);
            } else {
                scaleTypes = [scaleType];
            }

            bebop_config = { scaleTypes, rounds, showHints, focusProblemAreas, problemAreaChallenges };
            bebop_currentRound = 0;
            bebop_firstTryCorrect = 0;
            bebop_totalMistakes = 0;
            bebop_stats = {};
            bebop_allTimes = [];
            bebop_slowCount = 0;
            bebop_isPlaying = true;

            document.getElementById('bebop_settingsPanel').classList.add('hidden');
            document.getElementById('bebop_challengeDisplay').classList.remove('hidden');
            document.getElementById('bebop_completeDisplay').classList.add('hidden');
            document.getElementById('bebop_startBtn').textContent = 'Stop';
            document.getElementById('bebop_startBtn').onclick = bebopStopGame;
            document.getElementById('bebop_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('bebop_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('bebop_totalRounds').textContent = rounds;
            document.getElementById('bebop_firstTry').textContent = '0%';
            document.getElementById('bebop_mistakes').textContent = '0';
            document.getElementById('bebop_slow').textContent = '0';
            document.getElementById('bebop_responseTime').textContent = '--';

            bebopRunCountdown(3);
        }

        function bebopRunCountdown(count) {
            if (!bebop_isPlaying) return;
            document.getElementById('bebop_rootDisplay').textContent = count;
            document.getElementById('bebop_scaleNameDisplay').textContent = '';
            document.getElementById('bebop_noteProgress').innerHTML = '';
            if (count > 0) {
                setTimeout(() => bebopRunCountdown(count - 1), 800);
            } else {
                bebopNextChallenge();
            }
        }

        function bebopStopGame() {
            bebop_isPlaying = false;
            document.getElementById('bebop_settingsPanel').classList.remove('hidden');
            document.getElementById('bebop_challengeDisplay').classList.add('hidden');
            document.getElementById('bebop_startBtn').textContent = 'Start Game';
            document.getElementById('bebop_startBtn').onclick = bebopStartGame;
            document.getElementById('bebop_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('bebop_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            clearPiano('bebop_pianoSvg');
        }

        function bebopNextChallenge() {
            if (bebop_currentRound >= bebop_config.rounds) {
                bebopEndGame();
                return;
            }

            bebop_currentRound++;
            bebop_roundHadMistake = false;
            bebop_currentNoteIndex = 0;

            let root, scaleType;

            if (bebop_config.focusProblemAreas && bebop_config.problemAreaChallenges) {
                // Focus on problem areas: pick from problem area challenges
                const chosen = bebop_config.problemAreaChallenges[Math.floor(Math.random() * bebop_config.problemAreaChallenges.length)];
                root = chosen.root;
                scaleType = chosen.scaleType;
            } else {
                // Normal mode: Pick random root and scale type
                root = Math.floor(Math.random() * 12);
                scaleType = bebop_config.scaleTypes[Math.floor(Math.random() * bebop_config.scaleTypes.length)];
            }
            const scale = BEBOP_SCALES[scaleType];

            // Calculate the expected notes in order (ascending from root)
            const expectedNotes = scale.intervals.map(interval => (root + interval) % 12);

            bebop_challenge = {
                root,
                scaleType,
                scaleName: scale.name,
                expectedNotes,
                degrees: scale.degrees
            };

            // Update display
            document.getElementById('bebop_rootDisplay').textContent = NOTE_NAMES[root];
            document.getElementById('bebop_scaleNameDisplay').textContent = scale.name;
            document.getElementById('bebop_roundDisplay').textContent = bebop_currentRound;
            document.getElementById('bebop_feedbackText').textContent = '';
            document.getElementById('bebop_feedbackText').className = 'text-lg font-semibold h-7';

            // Build note progress indicators (8 notes for bebop)
            const progressDiv = document.getElementById('bebop_noteProgress');
            progressDiv.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const noteDiv = document.createElement('div');
                noteDiv.id = `bebop_note_${i}`;
                // First note highlighted in blue as current
                noteDiv.className = i === 0
                    ? 'w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold border-2 border-blue-400'
                    : 'w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600';
                if (bebop_config.showHints) {
                    noteDiv.innerHTML = `<span class="bebop-hint">${scale.degrees[i]}</span>`;
                }
                progressDiv.appendChild(noteDiv);
            }

            // Update expected note hint
            if (bebop_config.showHints) {
                document.getElementById('bebop_expectedNote').innerHTML = `Next: <span class="text-white font-bold">${NOTE_NAMES[expectedNotes[0]]}</span>`;
            } else {
                document.getElementById('bebop_expectedNote').innerHTML = `<span class="text-slate-500">Note 1 of 8</span>`;
            }

            // Show/hide hints based on setting
            document.querySelectorAll('.bebop-hint').forEach(el => {
                el.style.display = bebop_config.showHints ? '' : 'none';
            });

            clearPiano('bebop_pianoSvg');
            bebop_challengeStartTime = Date.now();
        }

        function bebopOnNoteOn(midi) {
            if (!bebop_isPlaying || !bebop_challenge || !bebop_challengeStartTime) return;

            const pitchClass = midi % 12;
            const expectedPitchClass = bebop_challenge.expectedNotes[bebop_currentNoteIndex];

            if (pitchClass === expectedPitchClass) {
                // Correct note
                highlightKey('bebop_pianoSvg', midi, 'correct');
                const noteDiv = document.getElementById(`bebop_note_${bebop_currentNoteIndex}`);
                if (noteDiv) {
                    noteDiv.classList.remove('bg-slate-700', 'border-slate-600');
                    noteDiv.classList.add('bg-green-600', 'border-green-400');
                }
                bebop_currentNoteIndex++;

                // Highlight next note in blue (if not complete)
                if (bebop_currentNoteIndex < bebop_challenge.expectedNotes.length) {
                    const nextNoteDiv = document.getElementById(`bebop_note_${bebop_currentNoteIndex}`);
                    if (nextNoteDiv) {
                        nextNoteDiv.classList.remove('bg-slate-700', 'border-slate-600');
                        nextNoteDiv.classList.add('bg-blue-600', 'border-blue-400');
                    }
                    // Update expected note hint
                    if (bebop_config.showHints) {
                        document.getElementById('bebop_expectedNote').innerHTML =
                            `Next: <span class="text-white font-bold">${NOTE_NAMES[bebop_challenge.expectedNotes[bebop_currentNoteIndex]]}</span>`;
                    } else {
                        document.getElementById('bebop_expectedNote').innerHTML =
                            `<span class="text-slate-500">Note ${bebop_currentNoteIndex + 1} of 8</span>`;
                    }
                }

                // Check if scale complete
                if (bebop_currentNoteIndex >= bebop_challenge.expectedNotes.length) {
                    const elapsed = Date.now() - bebop_challengeStartTime;
                    const isSlow = elapsed > 4000; // 4 seconds for 8 notes

                    if (!bebop_roundHadMistake) {
                        bebop_firstTryCorrect++;
                    }
                    if (isSlow) {
                        bebop_slowCount++;
                    }

                    bebop_allTimes.push(elapsed);

                    // Track stats
                    const key = `${NOTE_NAMES[bebop_challenge.root]} ${bebop_challenge.scaleName}`;
                    if (!bebop_stats[key]) {
                        bebop_stats[key] = { attempts: 0, mistakes: 0, times: [], root: bebop_challenge.root, scaleType: bebop_challenge.scaleType };
                    }
                    bebop_stats[key].attempts++;
                    if (bebop_roundHadMistake) bebop_stats[key].mistakes++;
                    bebop_stats[key].times.push(elapsed);

                    // Update display
                    const firstTryPct = Math.round((bebop_firstTryCorrect / bebop_currentRound) * 100);
                    document.getElementById('bebop_firstTry').textContent = firstTryPct + '%';
                    document.getElementById('bebop_slow').textContent = bebop_slowCount;

                    const avgTime = bebop_allTimes.reduce((a, b) => a + b, 0) / bebop_allTimes.length;
                    const avgSec = (avgTime / 1000).toFixed(1);
                    document.getElementById('bebop_responseTime').textContent = avgSec + 's';
                    document.getElementById('bebop_responseTime').className = `text-2xl font-mono ${avgTime < 4000 ? 'timer-fast' : 'timer-slow'}`;

                    document.getElementById('bebop_feedbackText').textContent = isSlow ? 'Slow' : 'Nice!';
                    document.getElementById('bebop_feedbackText').className = `text-lg font-semibold h-7 ${isSlow ? 'text-yellow-400' : 'text-green-400'}`;

                    // Show "Complete!" in expected note area
                    document.getElementById('bebop_expectedNote').innerHTML = '<span class="text-green-400">Complete!</span>';

                    setTimeout(bebopNextChallenge, 800);
                }
            } else {
                // Wrong note
                highlightKey('bebop_pianoSvg', midi, 'incorrect');
                if (!bebop_roundHadMistake) {
                    bebop_roundHadMistake = true;
                    bebop_totalMistakes++;
                    document.getElementById('bebop_mistakes').textContent = bebop_totalMistakes;
                }
                document.getElementById('bebop_feedbackText').textContent = 'Try again';
                document.getElementById('bebop_feedbackText').className = 'text-lg font-semibold h-7 text-red-400';
            }
        }

        function bebopOnNoteOff(midi) {
            clearKeyHighlight('bebop_pianoSvg', midi);
        }

        function bebopEndGame() {
            bebop_isPlaying = false;

            document.getElementById('bebop_challengeDisplay').classList.add('hidden');
            document.getElementById('bebop_completeDisplay').classList.remove('hidden');
            document.getElementById('bebop_startBtn').textContent = 'Play Again';
            document.getElementById('bebop_startBtn').onclick = bebopStartGame;
            document.getElementById('bebop_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('bebop_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('bebop_settingsPanel').classList.remove('hidden');

            // Final stats
            const avgTime = bebop_allTimes.length > 0 ? bebop_allTimes.reduce((a, b) => a + b, 0) / bebop_allTimes.length : 0;
            const avgSec = (avgTime / 1000).toFixed(1);
            const firstTryPct = Math.round((bebop_firstTryCorrect / bebop_config.rounds) * 100);

            document.getElementById('bebop_finalRounds').textContent = bebop_config.rounds;
            document.getElementById('bebop_finalAvgTime').textContent = avgSec + 's';
            document.getElementById('bebop_finalFirstTry').textContent = firstTryPct + '%';
            document.getElementById('bebop_finalMistakes').textContent = bebop_totalMistakes;
            document.getElementById('bebop_finalSlow').textContent = bebop_slowCount;

            // Save to history
            const gameRecord = {
                date: new Date().toISOString(),
                rounds: bebop_config.rounds,
                avgTime,
                firstTryPct,
                mistakes: bebop_totalMistakes,
                slow: bebop_slowCount,
                scaleTypes: bebop_config.scaleTypes,
                stats: bebop_stats
            };
            bebop_history.unshift(gameRecord);
            if (bebop_history.length > 20) bebop_history.pop();
            localStorage.setItem('bebop_history', JSON.stringify(bebop_history));

            bebopUpdateCumulativeStats();
            bebopShowBreakdown();
            bebopRenderHistory();
            clearPiano('bebop_pianoSvg');
        }

        function bebopShowBreakdown() {
            const grid = document.getElementById('bebop_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(bebop_stats).length > 0;

            if (hasSessionStats) {
                for (const [key, stat] of Object.entries(bebop_stats)) {
                    const pct = Math.round(((stat.attempts - stat.mistakes) / stat.attempts) * 100);
                    const avgT = stat.times.length > 0 ? (stat.times.reduce((a, b) => a + b, 0) / stat.times.length / 1000) : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 4; // Scales use 4s threshold

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = stat.attempts - stat.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${firstTry}/${stat.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('bebop_breakdownSection').classList.remove('hidden');
            } else {
                // Show only problem areas from cumulative stats on page load
                const problemAreas = bebopGetProblemAreas();
                if (problemAreas.length === 0) {
                    document.getElementById('bebop_breakdownSection').classList.add('hidden');
                    return;
                }
                for (const area of problemAreas) {
                    const data = bebop_cumulativeStats[area.key];
                    const firstTry = data.attempts - data.mistakes;
                    const pct = data.attempts > 0 ? Math.round((firstTry / data.attempts) * 100) : 0;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color} text-sm`;
                    div.innerHTML = `<p class="font-semibold">${area.key}</p><p>${pct}% (${firstTry}/${data.attempts})</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('bebop_breakdownSection').classList.remove('hidden');
            }
        }

        function bebopLoadHistory() {
            const saved = localStorage.getItem('bebop_history');
            if (saved) {
                bebop_history = JSON.parse(saved);
            }
            const cumSaved = localStorage.getItem('bebop_cumulativeStats');
            if (cumSaved) {
                bebop_cumulativeStats = JSON.parse(cumSaved);
            }
            bebopRenderHistory();
        }

        function bebopUpdateCumulativeStats() {
            Object.keys(bebop_stats).forEach(key => {
                const stat = bebop_stats[key];
                if (!bebop_cumulativeStats[key]) {
                    bebop_cumulativeStats[key] = { attempts: 0, mistakes: 0 };
                }
                bebop_cumulativeStats[key].attempts += stat.attempts;
                bebop_cumulativeStats[key].mistakes += stat.mistakes;
            });
            localStorage.setItem('bebop_cumulativeStats', JSON.stringify(bebop_cumulativeStats));
        }

        function bebopGetProblemAreas() {
            const dominated = [];
            Object.keys(bebop_cumulativeStats).forEach(key => {
                const stat = bebop_cumulativeStats[key];
                if (stat.attempts >= 3) {
                    const mistakeRate = stat.mistakes / stat.attempts;
                    if (mistakeRate > 0.3) {
                        dominated.push({ key, mistakeRate, attempts: stat.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function bebopClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            bebop_history = [];
            bebop_cumulativeStats = {};
            localStorage.removeItem('bebop_history');
            localStorage.removeItem('bebop_cumulativeStats');
            bebopRenderHistory();
        }

        function bebopRenderHistory() {
            const content = document.getElementById('bebop_historyContent');
            if (bebop_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="bebopClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            const medals = getMedals(bebop_history, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="bebopClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            bebop_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.date).toLocaleDateString();
                const avgSec = (game.avgTime / 1000).toFixed(1);
                const configLabel = game.scaleTypes?.join('/') || 'All';
                const slowCount = game.slow || game.slowCount || 0;
                const timeClass = game.avgTime < 4000 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16 truncate">${configLabel}</span>
                    <span class="text-white w-12">${game.rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${game.firstTryPct}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });

            html += '</div>';

            // Problem areas
            const problemAreas = bebopGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ TRITONE SUBSTITUTION MODE ============
        let tritone_isPlaying = false;
        let tritone_challenge = null;
        let tritone_challengeStartTime = null;
        let tritone_config = null;
        let tritone_currentRound = 0;
        let tritone_firstTryCorrect = 0;
        let tritone_totalMistakes = 0;
        let tritone_roundHadMistake = false;
        let tritone_stats = {};
        let tritone_allTimes = [];
        let tritone_slowCount = 0;
        let tritone_history = [];
        let tritone_cumulativeStats = {};
        let tritone_usedRoots = new Set();

        function tritoneGetSubstitution(originalRoot) {
            // Tritone = 6 semitones
            const subRoot = (originalRoot + 6) % 12;
            // Dom7 intervals: R, M3, P5, m7 = 0, 4, 7, 10
            const fullVoicing = [0, 4, 7, 10].map(i => (subRoot + i) % 12);
            // Shell voicing: R, 3, 7 = 0, 4, 10
            const shellVoicing = [0, 4, 10].map(i => (subRoot + i) % 12);

            return {
                originalRoot,
                originalName: NOTE_NAMES[originalRoot] + '7',
                subRoot,
                subName: NOTE_NAMES[subRoot] + '7',
                fullPitchClasses: new Set(fullVoicing),
                shellPitchClasses: new Set(shellVoicing)
            };
        }

        function tritoneStartGame() {
            saveAllSettings();
            const voicing = document.getElementById('tritone_voicingSelect').value;
            const rounds = parseInt(document.getElementById('tritone_roundsSelect').value);
            const showHints = document.getElementById('tritone_showHints').checked;

            const focusProblemAreas = document.getElementById('tritone_focusProblemAreas').checked;
            let problemAreaRoots = null;

            if (focusProblemAreas) {
                const problemAreas = tritoneGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "G7" -> originalRoot 7
                problemAreaRoots = [];
                problemAreas.forEach(area => {
                    // Key is like "G7", "C7"
                    const noteName = area.key.replace('7', '');
                    const root = NOTE_NAMES.indexOf(noteName);
                    if (root >= 0) {
                        problemAreaRoots.push(root);
                    }
                });
                if (problemAreaRoots.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            tritone_config = { voicing, rounds, showHints, focusProblemAreas, problemAreaRoots };
            tritone_currentRound = 0;
            tritone_firstTryCorrect = 0;
            tritone_totalMistakes = 0;
            tritone_stats = {};
            tritone_allTimes = [];
            tritone_slowCount = 0;
            tritone_usedRoots.clear();
            tritone_isPlaying = true;

            document.getElementById('tritone_settingsPanel').classList.add('hidden');
            document.getElementById('tritone_challengeDisplay').classList.remove('hidden');
            document.getElementById('tritone_completeDisplay').classList.add('hidden');
            document.getElementById('tritone_startBtn').textContent = 'Stop';
            document.getElementById('tritone_startBtn').onclick = tritoneStopGame;
            document.getElementById('tritone_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('tritone_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('tritone_totalRounds').textContent = rounds;
            document.getElementById('tritone_firstTry').textContent = '0%';
            document.getElementById('tritone_mistakes').textContent = '0';
            document.getElementById('tritone_slow').textContent = '0';
            document.getElementById('tritone_responseTime').textContent = '--';

            tritoneRunCountdown(3);
        }

        function tritoneRunCountdown(count) {
            if (!tritone_isPlaying) return;
            document.getElementById('tritone_chordDisplay').textContent = count;
            document.getElementById('tritone_hint').classList.add('hidden');
            document.getElementById('tritone_feedbackText').textContent = '';
            if (count > 0) {
                setTimeout(() => tritoneRunCountdown(count - 1), 800);
            } else {
                tritoneNextChallenge();
            }
        }

        function tritoneStopGame() {
            tritone_isPlaying = false;
            document.getElementById('tritone_settingsPanel').classList.remove('hidden');
            document.getElementById('tritone_challengeDisplay').classList.add('hidden');
            document.getElementById('tritone_startBtn').textContent = 'Start Game';
            document.getElementById('tritone_startBtn').onclick = tritoneStartGame;
            document.getElementById('tritone_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('tritone_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            clearPiano('tritone_pianoSvg');
        }

        function tritoneNextChallenge() {
            if (tritone_currentRound >= tritone_config.rounds) {
                tritoneEndGame();
                return;
            }

            tritone_currentRound++;
            tritone_roundHadMistake = false;

            let originalRoot;

            if (tritone_config.focusProblemAreas && tritone_config.problemAreaRoots) {
                // Focus on problem areas: pick from problem area roots
                if (tritone_usedRoots.size >= tritone_config.problemAreaRoots.length) {
                    tritone_usedRoots.clear();
                }
                const unusedProblemRoots = tritone_config.problemAreaRoots.filter(r => !tritone_usedRoots.has(r));
                originalRoot = unusedProblemRoots[Math.floor(Math.random() * unusedProblemRoots.length)];
            } else {
                // Normal mode: Reset used roots if all 12 have been used (for rounds > 12)
                if (tritone_usedRoots.size >= 12) {
                    tritone_usedRoots.clear();
                }
                // Pick random root that hasn't been used yet
                do {
                    originalRoot = Math.floor(Math.random() * 12);
                } while (tritone_usedRoots.has(originalRoot));
            }
            tritone_usedRoots.add(originalRoot);

            tritone_challenge = tritoneGetSubstitution(originalRoot);

            // Update display
            document.getElementById('tritone_chordDisplay').textContent = tritone_challenge.originalName;
            document.getElementById('tritone_roundDisplay').textContent = tritone_currentRound;
            document.getElementById('tritone_feedbackText').textContent = '';
            document.getElementById('tritone_feedbackText').className = 'text-lg font-semibold h-7 mt-4';

            // Hint
            const hintEl = document.getElementById('tritone_hint');
            if (tritone_config.showHints) {
                const noteNames = Array.from(tritone_config.voicing === 'shell'
                    ? tritone_challenge.shellPitchClasses
                    : tritone_challenge.fullPitchClasses
                ).map(pc => NOTE_NAMES[pc]);
                hintEl.textContent = `→ ${tritone_challenge.subName} (${noteNames.join(' ')})`;
                hintEl.classList.remove('hidden');
            } else {
                hintEl.classList.add('hidden');
            }

            clearPiano('tritone_pianoSvg');
            tritone_challengeStartTime = Date.now();
        }

        function tritoneOnNoteOn(midi) {
            if (!tritone_isPlaying || !tritone_challenge || !tritone_challengeStartTime) return;

            const pitchClass = midi % 12;
            const expectedPitchClasses = tritone_config.voicing === 'shell'
                ? tritone_challenge.shellPitchClasses
                : tritone_challenge.fullPitchClasses;

            if (expectedPitchClasses.has(pitchClass)) {
                highlightKey('tritone_pianoSvg', midi, 'correct');
            } else {
                highlightKey('tritone_pianoSvg', midi, 'incorrect');
                if (!tritone_roundHadMistake) {
                    tritone_roundHadMistake = true;
                    tritone_totalMistakes++;
                    document.getElementById('tritone_mistakes').textContent = tritone_totalMistakes;
                }
                document.getElementById('tritone_feedbackText').textContent = 'Wrong note';
                document.getElementById('tritone_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-red-400';
                return;
            }

            // Check if all notes are held
            const heldPitchClasses = new Set(Array.from(heldNotes).map(n => n % 12));
            const allNotesHeld = Array.from(expectedPitchClasses).every(pc => heldPitchClasses.has(pc));

            if (allNotesHeld) {
                const elapsed = Date.now() - tritone_challengeStartTime;
                const isSlow = elapsed > 2000;

                if (!tritone_roundHadMistake) {
                    tritone_firstTryCorrect++;
                }
                if (isSlow) {
                    tritone_slowCount++;
                }

                tritone_allTimes.push(elapsed);

                // Track stats
                const key = tritone_challenge.originalName;
                if (!tritone_stats[key]) {
                    tritone_stats[key] = { attempts: 0, mistakes: 0, times: [], originalRoot: tritone_challenge.originalRoot };
                }
                tritone_stats[key].attempts++;
                if (tritone_roundHadMistake) tritone_stats[key].mistakes++;
                tritone_stats[key].times.push(elapsed);

                // Update display
                const firstTryPct = Math.round((tritone_firstTryCorrect / tritone_currentRound) * 100);
                document.getElementById('tritone_firstTry').textContent = firstTryPct + '%';
                document.getElementById('tritone_slow').textContent = tritone_slowCount;

                const avgTime = tritone_allTimes.reduce((a, b) => a + b, 0) / tritone_allTimes.length;
                const avgSec = (avgTime / 1000).toFixed(1);
                document.getElementById('tritone_responseTime').textContent = avgSec + 's';
                document.getElementById('tritone_responseTime').className = `text-2xl font-mono ${avgTime < 2000 ? 'timer-fast' : 'timer-slow'}`;

                document.getElementById('tritone_feedbackText').textContent = `${tritone_challenge.subName}! ${isSlow ? '(Slow)' : ''}`;
                document.getElementById('tritone_feedbackText').className = `text-lg font-semibold h-7 mt-4 ${isSlow ? 'text-yellow-400' : 'text-green-400'}`;

                setTimeout(tritoneNextChallenge, 800);
            }
        }

        function tritoneOnNoteOff(midi) {
            clearKeyHighlight('tritone_pianoSvg', midi);
        }

        function tritoneEndGame() {
            tritone_isPlaying = false;

            document.getElementById('tritone_challengeDisplay').classList.add('hidden');
            document.getElementById('tritone_completeDisplay').classList.remove('hidden');
            document.getElementById('tritone_startBtn').textContent = 'Play Again';
            document.getElementById('tritone_startBtn').onclick = tritoneStartGame;
            document.getElementById('tritone_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('tritone_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('tritone_settingsPanel').classList.remove('hidden');

            // Final stats
            const avgTime = tritone_allTimes.length > 0 ? tritone_allTimes.reduce((a, b) => a + b, 0) / tritone_allTimes.length : 0;
            const avgSec = (avgTime / 1000).toFixed(1);
            const firstTryPct = Math.round((tritone_firstTryCorrect / tritone_config.rounds) * 100);

            document.getElementById('tritone_finalRounds').textContent = tritone_config.rounds;
            document.getElementById('tritone_finalAvgTime').textContent = avgSec + 's';
            document.getElementById('tritone_finalFirstTry').textContent = firstTryPct + '%';
            document.getElementById('tritone_finalMistakes').textContent = tritone_totalMistakes;
            document.getElementById('tritone_finalSlow').textContent = tritone_slowCount;

            // Save to history
            const gameRecord = {
                date: new Date().toISOString(),
                rounds: tritone_config.rounds,
                avgTime,
                firstTryPct,
                mistakes: tritone_totalMistakes,
                slow: tritone_slowCount,
                voicing: tritone_config.voicing,
                stats: tritone_stats
            };
            tritone_history.unshift(gameRecord);
            if (tritone_history.length > 20) tritone_history.pop();
            localStorage.setItem('tritone_history', JSON.stringify(tritone_history));

            tritoneUpdateCumulativeStats();
            tritoneShowBreakdown();
            tritoneRenderHistory();
            clearPiano('tritone_pianoSvg');
        }

        function tritoneShowBreakdown() {
            const grid = document.getElementById('tritone_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(tritone_stats).length > 0;

            if (hasSessionStats) {
                for (const [key, stat] of Object.entries(tritone_stats)) {
                    const sub = tritoneGetSubstitution(stat.originalRoot);
                    const pct = Math.round(((stat.attempts - stat.mistakes) / stat.attempts) * 100);
                    const avgT = stat.times.length > 0 ? (stat.times.reduce((a, b) => a + b, 0) / stat.times.length / 1000) : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = stat.attempts - stat.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key} → ${sub.subName}</p><p>${pct}% (${firstTry}/${stat.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('tritone_breakdownSection').classList.remove('hidden');
            } else {
                // Show only problem areas from cumulative stats on page load
                const problemAreas = tritoneGetProblemAreas();
                if (problemAreas.length === 0) {
                    document.getElementById('tritone_breakdownSection').classList.add('hidden');
                    return;
                }
                for (const area of problemAreas) {
                    const data = tritone_cumulativeStats[area.key];
                    // Parse key to get original root (e.g., "G7" -> 7)
                    const noteName = area.key.replace('7', '');
                    const originalRoot = NOTE_NAMES.indexOf(noteName);
                    const sub = originalRoot >= 0 ? tritoneGetSubstitution(originalRoot) : { subName: '?' };
                    const firstTry = data.attempts - data.mistakes;
                    const pct = data.attempts > 0 ? Math.round((firstTry / data.attempts) * 100) : 0;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color} text-sm`;
                    div.innerHTML = `<p class="font-semibold">${area.key} → ${sub.subName}</p><p>${pct}% (${firstTry}/${data.attempts})</p>`;
                    grid.appendChild(div);
                }
                document.getElementById('tritone_breakdownSection').classList.remove('hidden');
            }
        }

        function tritoneLoadHistory() {
            const saved = localStorage.getItem('tritone_history');
            if (saved) {
                tritone_history = JSON.parse(saved);
            }
            const cumSaved = localStorage.getItem('tritone_cumulativeStats');
            if (cumSaved) {
                tritone_cumulativeStats = JSON.parse(cumSaved);
            }
            tritoneRenderHistory();
        }

        function tritoneUpdateCumulativeStats() {
            Object.keys(tritone_stats).forEach(key => {
                const stat = tritone_stats[key];
                if (!tritone_cumulativeStats[key]) {
                    tritone_cumulativeStats[key] = { attempts: 0, mistakes: 0 };
                }
                tritone_cumulativeStats[key].attempts += stat.attempts;
                tritone_cumulativeStats[key].mistakes += stat.mistakes;
            });
            localStorage.setItem('tritone_cumulativeStats', JSON.stringify(tritone_cumulativeStats));
        }

        function tritoneGetProblemAreas() {
            const dominated = [];
            Object.keys(tritone_cumulativeStats).forEach(key => {
                const stat = tritone_cumulativeStats[key];
                if (stat.attempts >= 3) {
                    const mistakeRate = stat.mistakes / stat.attempts;
                    if (mistakeRate > 0.3) {
                        dominated.push({ key, mistakeRate, attempts: stat.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function tritoneClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            tritone_history = [];
            tritone_cumulativeStats = {};
            localStorage.removeItem('tritone_history');
            localStorage.removeItem('tritone_cumulativeStats');
            tritoneRenderHistory();
        }

        function tritoneRenderHistory() {
            const content = document.getElementById('tritone_historyContent');
            if (tritone_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="tritoneClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            const medals = getMedals(tritone_history, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="tritoneClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            tritone_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.date).toLocaleDateString();
                const avgSec = (game.avgTime / 1000).toFixed(1);
                const configLabel = game.voicing || 'shell';
                const slowCount = game.slow || game.slowCount || 0;
                const timeClass = game.avgTime < 2000 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16">${configLabel}</span>
                    <span class="text-white w-12">${game.rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${game.firstTryPct}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });

            html += '</div>';

            // Problem areas
            const problemAreas = tritoneGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ SHELL VOICINGS (Mode 17) ============
        // Shell voicing formulas: Root + 3rd + 7th
        const SHELL_TYPES = {
            'maj7': { intervals: [0, 4, 11], formula: 'R 3 7', name: 'maj7' },
            'min7': { intervals: [0, 3, 10], formula: 'R ♭3 ♭7', name: 'min7' },
            'dom7': { intervals: [0, 4, 10], formula: 'R 3 ♭7', name: '7' }
        };

        let shell_isPlaying = false;
        let shell_challenge = null;
        let shell_usedChallenges = new Set();
        let shell_challengeStartTime = null;
        let shell_config = null;
        let shell_currentRound = 0;
        let shell_firstTryCorrect = 0;
        let shell_totalMistakes = 0;
        let shell_roundHadMistake = false;
        let shell_stats = {};
        let shell_allTimes = [];
        let shell_slowCount = 0;
        let shell_history = [];
        let shell_cumulativeStats = {};
        let shell_heldNotes = new Set();

        function shellGetChallenge(root, chordType) {
            const typeInfo = SHELL_TYPES[chordType];
            const pitchClasses = new Set(typeInfo.intervals.map(i => (root + i) % 12));
            const chordName = NOTE_NAMES[root] + typeInfo.name;
            const noteNames = typeInfo.intervals.map(i => NOTE_NAMES[(root + i) % 12]).join(' - ');

            return {
                root,
                chordType,
                name: chordName,
                pitchClasses,
                noteNames,
                formula: typeInfo.formula
            };
        }

        function shellStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('shell_chordTypeSelect').value;
            const rounds = parseInt(document.getElementById('shell_roundsSelect').value);
            const showHints = document.getElementById('shell_showHints').checked;

            const focusProblemAreas = document.getElementById('shell_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = shellGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "Cmaj7", "Dm7", "G7"
                problemAreaChallenges = [];
                const suffixToChordType = { 'maj7': 'maj7', 'min7': 'min7', '7': 'dom7' };
                problemAreas.forEach(area => {
                    for (const [suffix, chordType] of Object.entries(suffixToChordType)) {
                        if (area.key.endsWith(suffix)) {
                            const noteName = area.key.slice(0, -suffix.length);
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, chordType, key: area.key });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            shell_config = { chordType: chordTypeSetting, rounds, showHints, focusProblemAreas, problemAreaChallenges };
            shell_usedChallenges.clear();
            shell_currentRound = 0;
            shell_firstTryCorrect = 0;
            shell_totalMistakes = 0;
            shell_stats = {};
            shell_allTimes = [];
            shell_slowCount = 0;

            document.getElementById('shell_settingsPanel').classList.add('hidden');
            document.getElementById('shell_challengeDisplay').classList.remove('hidden');
            document.getElementById('shell_completeDisplay').classList.add('hidden');
            document.getElementById('shell_breakdownSection').classList.add('hidden');
            document.getElementById('shell_startBtn').textContent = 'Stop';
            document.getElementById('shell_startBtn').onclick = shellStopGame;
            document.getElementById('shell_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('shell_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('shell_totalRounds').innerText = rounds;
            document.getElementById('shell_roundDisplay').innerText = '0';
            document.getElementById('shell_firstTry').innerText = '0%';
            document.getElementById('shell_mistakes').innerText = '0';
            document.getElementById('shell_slow').innerText = '0';
            document.getElementById('shell_responseTime').innerText = '--';

            shell_isPlaying = true;

            // Countdown
            const chordDisplay = document.getElementById('shell_chordDisplay');
            let count = 3;
            chordDisplay.innerText = count;
            document.getElementById('shell_hint').classList.add('hidden');
            document.getElementById('shell_feedbackText').innerText = '';

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    chordDisplay.innerText = count;
                } else {
                    clearInterval(countdownInterval);
                    shellNextChallenge();
                }
            }, 500);
        }

        function shellStopGame() {
            shell_isPlaying = false;
            document.getElementById('shell_settingsPanel').classList.remove('hidden');
            document.getElementById('shell_challengeDisplay').classList.add('hidden');
            document.getElementById('shell_startBtn').textContent = 'Start Game';
            document.getElementById('shell_startBtn').onclick = shellStartGame;
            document.getElementById('shell_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('shell_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            clearPianoHighlights('shell_pianoSvg');
        }

        function shellNextChallenge() {
            if (!shell_isPlaying) return;

            let root, type;

            if (shell_config.focusProblemAreas && shell_config.problemAreaChallenges) {
                // Focus on problem areas
                const allChallenges = shell_config.problemAreaChallenges.map(pa => `${pa.root}-${pa.chordType}`);
                const available = allChallenges.filter(c => !shell_usedChallenges.has(c));

                if (available.length === 0) {
                    shell_usedChallenges.clear();
                    available.push(...allChallenges);
                }

                const pick = available[Math.floor(Math.random() * available.length)];
                shell_usedChallenges.add(pick);
                const [rootStr, typeStr] = pick.split('-');
                root = parseInt(rootStr);
                type = typeStr;
            } else {
                // Normal mode: Get available chord types
                let availableTypes;
                if (shell_config.chordType === 'all') {
                    availableTypes = ['maj7', 'min7', 'dom7'];
                } else {
                    availableTypes = [shell_config.chordType];
                }

                // Generate all possible challenges
                const allChallenges = [];
                for (let r = 0; r < 12; r++) {
                    for (const t of availableTypes) {
                        allChallenges.push(`${r}-${t}`);
                    }
                }

                // Filter out used ones
                const available = allChallenges.filter(c => !shell_usedChallenges.has(c));

                if (available.length === 0) {
                    shell_usedChallenges.clear();
                    available.push(...allChallenges);
                }

                // Pick random challenge
                const pick = available[Math.floor(Math.random() * available.length)];
                shell_usedChallenges.add(pick);

                const [rootStr, typeStr] = pick.split('-');
                root = parseInt(rootStr);
                type = typeStr;
            }

            shell_challenge = shellGetChallenge(root, type);
            shell_roundHadMistake = false;
            shell_heldNotes.clear();
            shell_challengeStartTime = Date.now();
            shell_currentRound++;

            // Initialize stats for this chord
            const statKey = shell_challenge.name;
            if (!shell_stats[statKey]) {
                shell_stats[statKey] = { attempts: 0, mistakes: 0, times: [] };
            }
            shell_stats[statKey].attempts++;

            // Update display
            document.getElementById('shell_chordDisplay').innerText = shell_challenge.name;
            document.getElementById('shell_roundDisplay').innerText = shell_currentRound;
            document.getElementById('shell_feedbackText').innerText = '';

            // Show hint if enabled
            const hintEl = document.getElementById('shell_hint');
            if (shell_config.showHints) {
                hintEl.innerText = `${shell_challenge.formula}: ${shell_challenge.noteNames}`;
                hintEl.classList.remove('hidden');
            } else {
                hintEl.classList.add('hidden');
            }

            clearPianoHighlights('shell_pianoSvg');
        }

        function shellOnNoteOn(midi) {
            if (!shell_isPlaying || !shell_challenge || !shell_challengeStartTime) return;

            const pitchClass = midi % 12;
            shell_heldNotes.add(midi);

            const isCorrect = shell_challenge.pitchClasses.has(pitchClass);
            highlightKey('shell_pianoSvg', midi, isCorrect ? 'correct' : 'wrong');

            if (!isCorrect) {
                shell_totalMistakes++;
                shell_roundHadMistake = true;
                shell_stats[shell_challenge.name].mistakes++;
                document.getElementById('shell_mistakes').innerText = shell_totalMistakes;
                document.getElementById('shell_feedbackText').innerText = '✗';
                document.getElementById('shell_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-red-400';
            }

            // Check if all required notes are held
            const heldPitchClasses = new Set(Array.from(shell_heldNotes).map(n => n % 12));
            const allCorrect = Array.from(shell_challenge.pitchClasses).every(pc => heldPitchClasses.has(pc));

            if (allCorrect && heldPitchClasses.size >= shell_challenge.pitchClasses.size) {
                const elapsed = Date.now() - shell_challengeStartTime;
                shell_allTimes.push(elapsed);
                shell_stats[shell_challenge.name].times.push(elapsed);

                if (elapsed > 2000) {
                    shell_slowCount++;
                    document.getElementById('shell_slow').innerText = shell_slowCount;
                }

                if (!shell_roundHadMistake) {
                    shell_firstTryCorrect++;
                }

                const pct = Math.round((shell_firstTryCorrect / shell_currentRound) * 100);
                document.getElementById('shell_firstTry').innerText = pct + '%';

                // Update response time
                const timeClass = elapsed < 2000 ? 'timer-fast' : (elapsed < 4000 ? 'timer-medium' : 'timer-slow');
                document.getElementById('shell_responseTime').innerText = (elapsed / 1000).toFixed(1) + 's';
                document.getElementById('shell_responseTime').className = 'text-2xl font-mono ' + timeClass;

                // Show animated feedback overlay
                if (!shell_roundHadMistake) {
                    shellShowFeedback('✓', true, elapsed / 1000);
                } else {
                    shellShowFeedback('✓', true);
                }

                document.getElementById('shell_feedbackText').innerText = '✓ ' + shell_challenge.noteNames;
                document.getElementById('shell_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-green-400';

                if (shell_currentRound >= shell_config.rounds) {
                    setTimeout(() => shellEndGame(), 800);
                } else {
                    setTimeout(() => shellNextChallenge(), 800);
                }
            }
        }

        function shellOnNoteOff(midi) {
            shell_heldNotes.delete(midi);
            clearKeyHighlight('shell_pianoSvg', midi);
        }

        function shellShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('shell_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function shellEndGame() {
            shell_isPlaying = false;

            const avgTime = shell_allTimes.length > 0
                ? Math.round(shell_allTimes.reduce((a, b) => a + b, 0) / shell_allTimes.length)
                : 0;
            const firstTryPct = Math.round((shell_firstTryCorrect / shell_currentRound) * 100);

            // Update cumulative stats
            shellUpdateCumulativeStats();

            // Save to history
            shell_history.unshift({
                date: new Date().toISOString(),
                rounds: shell_currentRound,
                avgTime,
                firstTryPct,
                mistakes: shell_totalMistakes,
                slowCount: shell_slowCount,
                config: { ...shell_config }
            });
            shell_history = shell_history.slice(0, 20);
            localStorage.setItem('shell_history', JSON.stringify(shell_history));

            // Update display
            document.getElementById('shell_challengeDisplay').classList.add('hidden');
            document.getElementById('shell_completeDisplay').classList.remove('hidden');
            document.getElementById('shell_finalRounds').innerText = shell_currentRound;
            document.getElementById('shell_finalAvgTime').innerText = (avgTime / 1000).toFixed(1) + 's';
            document.getElementById('shell_finalFirstTry').innerText = firstTryPct + '%';
            document.getElementById('shell_finalMistakes').innerText = shell_totalMistakes;
            document.getElementById('shell_finalSlow').innerText = shell_slowCount;

            document.getElementById('shell_startBtn').textContent = 'Play Again';
            document.getElementById('shell_startBtn').onclick = shellStartGame;
            document.getElementById('shell_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('shell_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('shell_settingsPanel').classList.remove('hidden');

            shellShowBreakdown();
            shellRenderHistory();
        }

        function shellShowBreakdown() {
            const grid = document.getElementById('shell_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(shell_stats).length > 0;

            if (hasSessionStats) {
                Object.keys(shell_stats).sort().forEach(key => {
                    const stat = shell_stats[key];
                    const pct = stat.attempts > 0
                        ? Math.round(((stat.attempts - stat.mistakes) / stat.attempts) * 100)
                        : 0;
                    const avgT = stat.times.length > 0
                        ? (stat.times.reduce((a, b) => a + b, 0) / stat.times.length / 1000)
                        : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = stat.attempts - stat.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${firstTry}/${stat.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                });
                document.getElementById('shell_breakdownSection').classList.remove('hidden');
            } else {
                // Show only problem areas from cumulative stats on page load
                const problemAreas = shellGetProblemAreas();
                if (problemAreas.length === 0) {
                    document.getElementById('shell_breakdownSection').classList.add('hidden');
                    return;
                }
                problemAreas.forEach(area => {
                    const data = shell_cumulativeStats[area.key];
                    const firstTry = data.attempts - data.mistakes;
                    const pct = data.attempts > 0 ? Math.round((firstTry / data.attempts) * 100) : 0;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color} text-sm`;
                    div.innerHTML = `<p class="font-semibold">${area.key}</p><p>${pct}% (${firstTry}/${data.attempts})</p>`;
                    grid.appendChild(div);
                });
                document.getElementById('shell_breakdownSection').classList.remove('hidden');
            }
        }

        function shellLoadHistory() {
            const saved = localStorage.getItem('shell_history');
            if (saved) {
                shell_history = JSON.parse(saved);
            }
            const cumSaved = localStorage.getItem('shell_cumulativeStats');
            if (cumSaved) {
                shell_cumulativeStats = JSON.parse(cumSaved);
            }
            shellRenderHistory();
        }

        function shellUpdateCumulativeStats() {
            Object.keys(shell_stats).forEach(key => {
                const stat = shell_stats[key];
                if (!shell_cumulativeStats[key]) {
                    shell_cumulativeStats[key] = { attempts: 0, mistakes: 0 };
                }
                shell_cumulativeStats[key].attempts += stat.attempts;
                shell_cumulativeStats[key].mistakes += stat.mistakes;
            });
            localStorage.setItem('shell_cumulativeStats', JSON.stringify(shell_cumulativeStats));
        }

        function shellGetProblemAreas() {
            const dominated = [];
            Object.keys(shell_cumulativeStats).forEach(key => {
                const stat = shell_cumulativeStats[key];
                if (stat.attempts >= 3) {
                    const mistakeRate = stat.mistakes / stat.attempts;
                    if (mistakeRate > 0.3) {
                        dominated.push({ key, mistakeRate, attempts: stat.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function shellClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            shell_history = [];
            shell_cumulativeStats = {};
            localStorage.removeItem('shell_history');
            localStorage.removeItem('shell_cumulativeStats');
            shellRenderHistory();
        }

        function shellRenderHistory() {
            const content = document.getElementById('shell_historyContent');
            if (shell_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="shellClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            const medals = getMedals(shell_history, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="shellClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            shell_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.date).toLocaleDateString();
                const avgSec = (game.avgTime / 1000).toFixed(1);
                const configLabel = game.config?.chordType === 'all' ? 'All' : game.config?.chordType || 'All';
                const slowCount = game.slowCount || 0;
                const timeClass = game.avgTime < 2000 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16">${configLabel}</span>
                    <span class="text-white w-12">${game.rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${game.firstTryPct}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });

            html += '</div>';

            // Problem areas
            const problemAreas = shellGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ UPPER STRUCTURE TRIADS MODE ============
        const UPPER_STRUCTURE_TYPES = {
            'bII': {
                interval: 1,
                name: '7b9',
                description: 'bII triad over dominant',
                formula: 'bass + triad on b2'
            },
            'II': {
                interval: 2,
                name: '13#11',
                description: 'II triad over dominant',
                formula: 'bass + triad on 2'
            },
            'bIII': {
                interval: 3,
                name: '7#9',
                description: 'bIII triad over dominant',
                formula: 'bass + triad on b3'
            },
            'bVI': {
                interval: 8,
                name: '7alt',
                description: 'bVI triad over dominant',
                formula: 'bass + triad on b6'
            },
            'VI': {
                interval: 9,
                name: '13b9',
                description: 'VI triad over dominant',
                formula: 'bass + triad on 6'
            }
        };

        let upper_isPlaying = false;
        let upper_challenge = null;
        let upper_usedChallenges = new Set();
        let upper_challengeStartTime = null;
        let upper_config = null;
        let upper_heldNotes = new Set();
        let upper_roundHadMistake = false;
        let upper_currentRound = 0;
        let upper_firstTryCorrect = 0;
        let upper_totalMistakes = 0;
        let upper_stats = {};
        let upper_allTimes = [];
        let upper_slowCount = 0;
        let upper_history = [];
        let upper_cumulativeStats = {};

        function upperGetChallenge(root, structureType) {
            const structure = UPPER_STRUCTURE_TYPES[structureType];
            const triadRoot = (root + structure.interval) % 12;

            // Major triad intervals: root, major 3rd, perfect 5th
            const triadIntervals = [0, 4, 7];
            const triadPitchClasses = new Set(triadIntervals.map(i => (triadRoot + i) % 12));

            // Bass note is the root
            const bassPitchClass = root;

            // All required pitch classes (bass + triad)
            const allPitchClasses = new Set([bassPitchClass, ...triadPitchClasses]);

            // Names
            const bassName = NOTE_NAMES[root];
            const triadRootName = NOTE_NAMES[triadRoot];
            const chordName = `${bassName}${structure.name}`;
            const triadNotes = triadIntervals.map(i => NOTE_NAMES[(triadRoot + i) % 12]).join(' ');

            return {
                root,
                structureType,
                name: chordName,
                displayName: chordName,
                bassPitchClass,
                triadPitchClasses,
                allPitchClasses,
                triadRoot,
                triadRootName,
                triadNotes,
                intervalName: structureType,
                bassName
            };
        }

        function upperStartGame() {
            saveAllSettings();
            const typeSetting = document.getElementById('upper_typeSelect').value;
            const rounds = parseInt(document.getElementById('upper_roundsSelect').value);
            const hintLevel = document.getElementById('upper_hintLevel').value;

            const focusProblemAreas = document.getElementById('upper_focusProblemAreas').checked;
            let problemAreaChallenges = null;

            if (focusProblemAreas) {
                const problemAreas = upperGetProblemAreas();
                if (problemAreas.length === 0) {
                    alert('No problem areas found yet! Play more games to identify areas that need work, then try again.');
                    return;
                }
                // Parse problem areas: "C7b9", "D13#11" -> { root: 0, structureType: 'bII' }
                problemAreaChallenges = [];
                const nameToType = {};
                Object.entries(UPPER_STRUCTURE_TYPES).forEach(([type, def]) => {
                    nameToType[def.name] = type;
                });
                problemAreas.forEach(area => {
                    for (const [name, type] of Object.entries(nameToType)) {
                        if (area.key.endsWith(name)) {
                            const noteName = area.key.slice(0, -name.length);
                            const root = NOTE_NAMES.indexOf(noteName);
                            if (root >= 0) {
                                problemAreaChallenges.push({ root, structureType: type, key: area.key });
                                break;
                            }
                        }
                    }
                });
                if (problemAreaChallenges.length === 0) {
                    alert('Could not parse problem areas. Please try again.');
                    return;
                }
            }

            upper_config = { structureType: typeSetting, rounds, hintLevel, focusProblemAreas, problemAreaChallenges };
            upper_usedChallenges.clear();
            upper_currentRound = 0;
            upper_firstTryCorrect = 0;
            upper_totalMistakes = 0;
            upper_stats = {};
            upper_allTimes = [];
            upper_slowCount = 0;

            document.getElementById('upper_settingsPanel').classList.add('hidden');
            document.getElementById('upper_challengeDisplay').classList.remove('hidden');
            document.getElementById('upper_completeDisplay').classList.add('hidden');
            document.getElementById('upper_breakdownSection').classList.add('hidden');
            document.getElementById('upper_startBtn').textContent = 'Stop';
            document.getElementById('upper_startBtn').onclick = upperStopGame;
            document.getElementById('upper_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('upper_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('upper_totalRounds').innerText = rounds;
            document.getElementById('upper_roundDisplay').innerText = '0';
            document.getElementById('upper_firstTry').innerText = '0%';
            document.getElementById('upper_mistakes').innerText = '0';
            document.getElementById('upper_slow').innerText = '0';
            document.getElementById('upper_responseTime').innerText = '--';

            upper_isPlaying = true;

            // Countdown
            const chordDisplay = document.getElementById('upper_chordDisplay');
            let count = 3;
            chordDisplay.innerText = count;
            document.getElementById('upper_hint').classList.add('hidden');
            document.getElementById('upper_feedbackText').innerText = '';

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    chordDisplay.innerText = count;
                } else {
                    clearInterval(countdownInterval);
                    upperNextChallenge();
                }
            }, 500);
        }

        function upperStopGame() {
            upper_isPlaying = false;
            document.getElementById('upper_settingsPanel').classList.remove('hidden');
            document.getElementById('upper_challengeDisplay').classList.add('hidden');
            document.getElementById('upper_startBtn').textContent = 'Start Game';
            document.getElementById('upper_startBtn').onclick = upperStartGame;
            document.getElementById('upper_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('upper_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            clearPianoHighlights('upper_pianoSvg');
        }

        function upperNextChallenge() {
            if (!upper_isPlaying) return;

            let root, type;

            if (upper_config.focusProblemAreas && upper_config.problemAreaChallenges) {
                // Focus on problem areas
                const allChallenges = upper_config.problemAreaChallenges.map(pa => `${pa.root}-${pa.structureType}`);
                let available = allChallenges.filter(c => !upper_usedChallenges.has(c));

                if (available.length === 0) {
                    upper_usedChallenges.clear();
                    available = [...allChallenges];
                }

                const pick = available[Math.floor(Math.random() * available.length)];
                upper_usedChallenges.add(pick);
                const [rootStr, typeStr] = pick.split('-');
                root = parseInt(rootStr);
                type = typeStr;
            } else {
                // Normal mode: Get available structure types
                let availableTypes;
                if (upper_config.structureType === 'all') {
                    availableTypes = Object.keys(UPPER_STRUCTURE_TYPES);
                } else {
                    availableTypes = [upper_config.structureType];
                }

                // Generate all possible challenges
                const allChallenges = [];
                for (let r = 0; r < 12; r++) {
                    for (const t of availableTypes) {
                        allChallenges.push(`${r}-${t}`);
                    }
                }

                // Filter out used ones
                let available = allChallenges.filter(c => !upper_usedChallenges.has(c));

                if (available.length === 0) {
                    upper_usedChallenges.clear();
                    available = [...allChallenges];
                }

                // Pick random challenge
                const pick = available[Math.floor(Math.random() * available.length)];
                upper_usedChallenges.add(pick);

                const [rootStr, typeStr] = pick.split('-');
                root = parseInt(rootStr);
                type = typeStr;
            }

            upper_challenge = upperGetChallenge(root, type);
            upper_roundHadMistake = false;
            upper_heldNotes.clear();
            upper_challengeStartTime = Date.now();
            upper_currentRound++;

            // Initialize stats for this chord
            const statKey = upper_challenge.name;
            if (!upper_stats[statKey]) {
                upper_stats[statKey] = { attempts: 0, mistakes: 0, times: [] };
            }
            upper_stats[statKey].attempts++;

            // Update display
            document.getElementById('upper_chordDisplay').innerText = upper_challenge.displayName;
            document.getElementById('upper_roundDisplay').innerText = upper_currentRound;
            document.getElementById('upper_feedbackText').innerText = '';

            // Show hint based on hint level
            const hintEl = document.getElementById('upper_hint');
            if (upper_config.hintLevel === 'full') {
                hintEl.innerText = `LH: ${upper_challenge.bassName} | RH: ${upper_challenge.triadRootName} major (${upper_challenge.triadNotes})`;
                hintEl.classList.remove('hidden');
            } else if (upper_config.hintLevel === 'interval') {
                hintEl.innerText = `Upper structure: ${upper_challenge.intervalName}`;
                hintEl.classList.remove('hidden');
            } else {
                hintEl.classList.add('hidden');
            }

            clearPianoHighlights('upper_pianoSvg');
        }

        function upperOnNoteOn(midi) {
            if (!upper_isPlaying || !upper_challenge || !upper_challengeStartTime) return;

            const pitchClass = midi % 12;
            upper_heldNotes.add(midi);

            const isCorrect = upper_challenge.allPitchClasses.has(pitchClass);
            highlightKey('upper_pianoSvg', midi, isCorrect ? 'correct' : 'wrong');

            if (!isCorrect) {
                upper_totalMistakes++;
                upper_roundHadMistake = true;
                upper_stats[upper_challenge.name].mistakes++;
                document.getElementById('upper_mistakes').innerText = upper_totalMistakes;
                document.getElementById('upper_feedbackText').innerText = '✗';
                document.getElementById('upper_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-red-400';
            }

            // Check if all required notes are held
            const heldPitchClasses = new Set(Array.from(upper_heldNotes).map(n => n % 12));
            const allCorrect = Array.from(upper_challenge.allPitchClasses).every(pc => heldPitchClasses.has(pc));
            const requiredCount = upper_challenge.allPitchClasses.size;

            if (allCorrect && heldPitchClasses.size >= requiredCount) {
                const elapsed = Date.now() - upper_challengeStartTime;
                upper_allTimes.push(elapsed);
                upper_stats[upper_challenge.name].times.push(elapsed);

                if (elapsed > 2000) {
                    upper_slowCount++;
                    document.getElementById('upper_slow').innerText = upper_slowCount;
                }

                if (!upper_roundHadMistake) {
                    upper_firstTryCorrect++;
                }

                const pct = Math.round((upper_firstTryCorrect / upper_currentRound) * 100);
                document.getElementById('upper_firstTry').innerText = pct + '%';

                // Update response time
                const timeClass = elapsed < 2000 ? 'timer-fast' : (elapsed < 4000 ? 'timer-medium' : 'timer-slow');
                document.getElementById('upper_responseTime').innerText = (elapsed / 1000).toFixed(1) + 's';
                document.getElementById('upper_responseTime').className = 'text-2xl font-mono ' + timeClass;

                document.getElementById('upper_feedbackText').innerText = `✓ ${upper_challenge.bassName} + ${upper_challenge.triadRootName} maj`;
                document.getElementById('upper_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-green-400';

                if (upper_currentRound >= upper_config.rounds) {
                    setTimeout(() => upperEndGame(), 800);
                } else {
                    setTimeout(() => upperNextChallenge(), 800);
                }
            }
        }

        function upperOnNoteOff(midi) {
            upper_heldNotes.delete(midi);
            clearKeyHighlight('upper_pianoSvg', midi);
        }

        function upperEndGame() {
            upper_isPlaying = false;

            const avgTime = upper_allTimes.length > 0
                ? Math.round(upper_allTimes.reduce((a, b) => a + b, 0) / upper_allTimes.length)
                : 0;
            const firstTryPct = Math.round((upper_firstTryCorrect / upper_currentRound) * 100);

            // Update cumulative stats
            upperUpdateCumulativeStats();

            // Save to history
            upper_history.unshift({
                date: new Date().toISOString(),
                rounds: upper_currentRound,
                avgTime,
                firstTryPct,
                mistakes: upper_totalMistakes,
                slowCount: upper_slowCount,
                config: upper_config
            });
            if (upper_history.length > 20) upper_history.pop();
            localStorage.setItem('upper_history', JSON.stringify(upper_history));

            // Update display
            document.getElementById('upper_challengeDisplay').classList.add('hidden');
            document.getElementById('upper_completeDisplay').classList.remove('hidden');
            document.getElementById('upper_finalRounds').innerText = upper_currentRound;
            document.getElementById('upper_finalAvgTime').innerText = (avgTime / 1000).toFixed(1) + 's';
            document.getElementById('upper_finalFirstTry').innerText = firstTryPct + '%';
            document.getElementById('upper_finalMistakes').innerText = upper_totalMistakes;
            document.getElementById('upper_finalSlow').innerText = upper_slowCount;

            document.getElementById('upper_startBtn').textContent = 'Play Again';
            document.getElementById('upper_startBtn').onclick = upperStartGame;
            document.getElementById('upper_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('upper_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('upper_settingsPanel').classList.remove('hidden');

            upperShowBreakdown();
            upperRenderHistory();
        }

        function upperShowBreakdown() {
            const grid = document.getElementById('upper_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(upper_stats).length > 0;

            if (hasSessionStats) {
                Object.keys(upper_stats).sort().forEach(key => {
                    const stat = upper_stats[key];
                    const pct = stat.attempts > 0
                        ? Math.round(((stat.attempts - stat.mistakes) / stat.attempts) * 100)
                        : 0;
                    const avgT = stat.times.length > 0
                        ? (stat.times.reduce((a, b) => a + b, 0) / stat.times.length / 1000)
                        : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = stat.attempts - stat.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${firstTry}/${stat.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                });
                document.getElementById('upper_breakdownSection').classList.remove('hidden');
            } else {
                // Show only problem areas from cumulative stats on page load
                const problemAreas = upperGetProblemAreas();
                if (problemAreas.length === 0) {
                    document.getElementById('upper_breakdownSection').classList.add('hidden');
                    return;
                }
                problemAreas.forEach(area => {
                    const data = upper_cumulativeStats[area.key];
                    const firstTry = data.attempts - data.mistakes;
                    const pct = data.attempts > 0 ? Math.round((firstTry / data.attempts) * 100) : 0;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color} text-sm`;
                    div.innerHTML = `<p class="font-semibold">${area.key}</p><p>${pct}% (${firstTry}/${data.attempts})</p>`;
                    grid.appendChild(div);
                });
                document.getElementById('upper_breakdownSection').classList.remove('hidden');
            }
        }

        function upperLoadHistory() {
            const saved = localStorage.getItem('upper_history');
            if (saved) {
                upper_history = JSON.parse(saved);
            }
            const cumSaved = localStorage.getItem('upper_cumulativeStats');
            if (cumSaved) {
                upper_cumulativeStats = JSON.parse(cumSaved);
            }
            upperRenderHistory();
        }

        function upperUpdateCumulativeStats() {
            Object.keys(upper_stats).forEach(key => {
                const stat = upper_stats[key];
                if (!upper_cumulativeStats[key]) {
                    upper_cumulativeStats[key] = { attempts: 0, mistakes: 0 };
                }
                upper_cumulativeStats[key].attempts += stat.attempts;
                upper_cumulativeStats[key].mistakes += stat.mistakes;
            });
            localStorage.setItem('upper_cumulativeStats', JSON.stringify(upper_cumulativeStats));
        }

        function upperGetProblemAreas() {
            const dominated = [];
            Object.keys(upper_cumulativeStats).forEach(key => {
                const stat = upper_cumulativeStats[key];
                if (stat.attempts >= 3) {
                    const mistakeRate = stat.mistakes / stat.attempts;
                    if (mistakeRate > 0.3) {
                        dominated.push({ key, mistakeRate, attempts: stat.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function upperClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            upper_history = [];
            upper_cumulativeStats = {};
            localStorage.removeItem('upper_history');
            localStorage.removeItem('upper_cumulativeStats');
            upperRenderHistory();
        }

        function upperRenderHistory() {
            const content = document.getElementById('upper_historyContent');
            if (upper_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="upperClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            const medals = getMedals(upper_history, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="upperClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            upper_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.date).toLocaleDateString();
                const avgSec = (game.avgTime / 1000).toFixed(1);
                const configLabel = game.config?.structureType === 'all' ? 'All' : game.config?.structureType || 'All';
                const slowCount = game.slowCount || 0;
                const timeClass = game.avgTime < 2000 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16">${configLabel}</span>
                    <span class="text-white w-12">${game.rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${game.firstTryPct}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });

            html += '</div>';

            // Problem areas
            const problemAreas = upperGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ SETTINGS PERSISTENCE ============
        function saveAllSettings() {
            const settings = {
                intervals: {
                    intervals: Array.from(document.querySelectorAll('.int-interval-cb:checked')).map(cb => parseInt(cb.value)),
                    direction: document.getElementById('int_directionSelect').value,
                    rounds: document.getElementById('int_roundsSelect').value,
                    focusProblemAreas: document.getElementById('int_focusProblemAreas').checked
                },
                chords: {
                    types: Array.from(document.querySelectorAll('.ch-type-cb:checked')).map(cb => cb.value),
                    hands: document.getElementById('ch_handsSelect').value,
                    rounds: document.getElementById('ch_roundsSelect').value,
                    focusProblemAreas: document.getElementById('ch_focusProblemAreas').checked
                },
                iivi: {
                    voicing: document.getElementById('iivi_voicingSelect').value,
                    rounds: document.getElementById('iivi_roundsSelect').value,
                    twoHands: document.getElementById('iivi_twoHands').checked,
                    focusProblemAreas: document.getElementById('iivi_focusProblemAreas').checked
                },
                scales: {
                    chordType: document.getElementById('sc_chordTypeSelect').value,
                    rounds: document.getElementById('sc_roundsSelect').value,
                    showHints: document.getElementById('sc_showHints').checked,
                    focusProblemAreas: document.getElementById('sc_focusProblemAreas').checked
                },
                extensions: {
                    chordType: document.getElementById('ext_chordTypeSelect').value,
                    extension: document.getElementById('ext_extensionSelect').value,
                    rounds: document.getElementById('ext_roundsSelect').value,
                    showHints: document.getElementById('ext_showHints').checked,
                    focusProblemAreas: document.getElementById('ext_focusProblemAreas').checked
                },
                altered: {
                    alteration: document.getElementById('alt_alterationSelect').value,
                    voicing: document.getElementById('alt_voicingSelect').value,
                    rounds: document.getElementById('alt_roundsSelect').value,
                    focusProblemAreas: document.getElementById('alt_focusProblemAreas').checked
                },
                advanced: {
                    types: Array.from(document.querySelectorAll('.adv-type-cb:checked')).map(cb => cb.value),
                    rounds: document.getElementById('adv_roundsSelect').value,
                    showHints: document.getElementById('adv_showHints').checked,
                    focusProblemAreas: document.getElementById('adv_focusProblemAreas').checked
                },
                minorIivi: {
                    rounds: document.getElementById('miivi_roundsSelect').value,
                    twoHands: document.getElementById('miivi_twoHands').checked,
                    focusProblemAreas: document.getElementById('miivi_focusProblemAreas').checked
                },
                kennyBarron: {
                    chordType: document.getElementById('kb_chordType').value,
                    voicingType: document.getElementById('kb_voicingType').value,
                    rounds: document.getElementById('kb_rounds').value,
                    showHints: document.getElementById('kb_showHints').checked,
                    focusProblemAreas: document.getElementById('kb_focusProblemAreas').checked
                },
                jtou: {
                    voicing: document.getElementById('jtou_voicingSelect').value,
                    rounds: document.getElementById('jtou_roundsSelect').value,
                    showHints: document.getElementById('jtou_showHints').checked,
                    focusProblemAreas: document.getElementById('jtou_focusProblemAreas').checked
                },
                dom7Voicing: {
                    chordType: document.getElementById('dom7v_chordTypeSelect').value,
                    voicingType: document.getElementById('dom7v_voicingTypeSelect').value,
                    rounds: document.getElementById('dom7v_roundsSelect').value,
                    showHints: document.getElementById('dom7v_showHints').checked,
                    focusProblemAreas: document.getElementById('dom7v_focusProblemAreas').checked
                },
                extendedVoicings: {
                    chordType: document.getElementById('extv_chordTypeSelect').value,
                    rounds: document.getElementById('extv_roundsSelect').value,
                    showHints: document.getElementById('extv_showHints').checked,
                    focusProblemAreas: document.getElementById('extv_focusProblemAreas').checked
                },
                pentatonic: {
                    scaleType: document.getElementById('pent_scaleTypeSelect').value,
                    rounds: document.getElementById('pent_roundsSelect').value,
                    showHints: document.getElementById('pent_showHints').checked,
                    focusProblemAreas: document.getElementById('pent_focusProblemAreas').checked
                },
                bebop: {
                    scaleType: document.getElementById('bebop_scaleTypeSelect').value,
                    rounds: document.getElementById('bebop_roundsSelect').value,
                    showHints: document.getElementById('bebop_showHints').checked,
                    focusProblemAreas: document.getElementById('bebop_focusProblemAreas').checked
                },
                tritone: {
                    voicing: document.getElementById('tritone_voicingSelect').value,
                    rounds: document.getElementById('tritone_roundsSelect').value,
                    showHints: document.getElementById('tritone_showHints').checked,
                    focusProblemAreas: document.getElementById('tritone_focusProblemAreas').checked
                },
                shell: {
                    chordType: document.getElementById('shell_chordTypeSelect').value,
                    rounds: document.getElementById('shell_roundsSelect').value,
                    showHints: document.getElementById('shell_showHints').checked,
                    focusProblemAreas: document.getElementById('shell_focusProblemAreas').checked
                },
                upper: {
                    structureType: document.getElementById('upper_typeSelect').value,
                    rounds: document.getElementById('upper_roundsSelect').value,
                    hintLevel: document.getElementById('upper_hintLevel').value,
                    focusProblemAreas: document.getElementById('upper_focusProblemAreas').checked
                },
                freestyle: {
                    chordType: document.getElementById('freestyle_chordTypeSelect').value,
                    rounds: document.getElementById('freestyle_roundsSelect').value,
                    requireRoot: document.getElementById('freestyle_requireRoot').checked,
                    showHints: document.getElementById('freestyle_showHints').checked,
                    focusProblemAreas: document.getElementById('freestyle_focusProblemAreas').checked
                },
                attya: {
                    voicing: document.getElementById('attya_voicingSelect').value,
                    showHints: document.getElementById('attya_showHints').checked
                }
            };
            localStorage.setItem('pianoTutorSettings', JSON.stringify(settings));
        }

        function loadAllSettings() {
            const saved = localStorage.getItem('pianoTutorSettings');
            if (!saved) return;
            try {
                const settings = JSON.parse(saved);

                // Intervals
                if (settings.intervals) {
                    document.querySelectorAll('.int-interval-cb').forEach(cb => {
                        cb.checked = settings.intervals.intervals.includes(parseInt(cb.value));
                    });
                    if (settings.intervals.direction) document.getElementById('int_directionSelect').value = settings.intervals.direction;
                    if (settings.intervals.rounds) document.getElementById('int_roundsSelect').value = settings.intervals.rounds;
                    if (settings.intervals.focusProblemAreas !== undefined) document.getElementById('int_focusProblemAreas').checked = settings.intervals.focusProblemAreas;
                }

                // Chords
                if (settings.chords) {
                    document.querySelectorAll('.ch-type-cb').forEach(cb => {
                        cb.checked = settings.chords.types.includes(cb.value);
                    });
                    if (settings.chords.hands) document.getElementById('ch_handsSelect').value = settings.chords.hands;
                    if (settings.chords.rounds) document.getElementById('ch_roundsSelect').value = settings.chords.rounds;
                    if (settings.chords.focusProblemAreas !== undefined) document.getElementById('ch_focusProblemAreas').checked = settings.chords.focusProblemAreas;
                }

                // ii-V-I
                if (settings.iivi) {
                    if (settings.iivi.voicing) document.getElementById('iivi_voicingSelect').value = settings.iivi.voicing;
                    if (settings.iivi.rounds) document.getElementById('iivi_roundsSelect').value = settings.iivi.rounds;
                    if (settings.iivi.twoHands !== undefined) document.getElementById('iivi_twoHands').checked = settings.iivi.twoHands;
                    if (settings.iivi.focusProblemAreas !== undefined) document.getElementById('iivi_focusProblemAreas').checked = settings.iivi.focusProblemAreas;
                }

                // Scales
                if (settings.scales) {
                    if (settings.scales.chordType) document.getElementById('sc_chordTypeSelect').value = settings.scales.chordType;
                    if (settings.scales.rounds) document.getElementById('sc_roundsSelect').value = settings.scales.rounds;
                    if (settings.scales.showHints !== undefined) document.getElementById('sc_showHints').checked = settings.scales.showHints;
                    if (settings.scales.focusProblemAreas !== undefined) document.getElementById('sc_focusProblemAreas').checked = settings.scales.focusProblemAreas;
                }

                // Extensions
                if (settings.extensions) {
                    if (settings.extensions.chordType) document.getElementById('ext_chordTypeSelect').value = settings.extensions.chordType;
                    if (settings.extensions.extension) document.getElementById('ext_extensionSelect').value = settings.extensions.extension;
                    if (settings.extensions.rounds) document.getElementById('ext_roundsSelect').value = settings.extensions.rounds;
                    if (settings.extensions.showHints !== undefined) document.getElementById('ext_showHints').checked = settings.extensions.showHints;
                    if (settings.extensions.focusProblemAreas !== undefined) document.getElementById('ext_focusProblemAreas').checked = settings.extensions.focusProblemAreas;
                }

                // Altered
                if (settings.altered) {
                    if (settings.altered.alteration) document.getElementById('alt_alterationSelect').value = settings.altered.alteration;
                    if (settings.altered.voicing) document.getElementById('alt_voicingSelect').value = settings.altered.voicing;
                    if (settings.altered.rounds) document.getElementById('alt_roundsSelect').value = settings.altered.rounds;
                    if (settings.altered.focusProblemAreas !== undefined) document.getElementById('alt_focusProblemAreas').checked = settings.altered.focusProblemAreas;
                }

                // Advanced
                if (settings.advanced) {
                    document.querySelectorAll('.adv-type-cb').forEach(cb => {
                        cb.checked = settings.advanced.types.includes(cb.value);
                    });
                    if (settings.advanced.rounds) document.getElementById('adv_roundsSelect').value = settings.advanced.rounds;
                    if (settings.advanced.showHints !== undefined) document.getElementById('adv_showHints').checked = settings.advanced.showHints;
                    if (settings.advanced.focusProblemAreas !== undefined) document.getElementById('adv_focusProblemAreas').checked = settings.advanced.focusProblemAreas;
                }

                // Minor ii-V-i
                if (settings.minorIivi) {
                    if (settings.minorIivi.rounds) document.getElementById('miivi_roundsSelect').value = settings.minorIivi.rounds;
                    if (settings.minorIivi.twoHands !== undefined) document.getElementById('miivi_twoHands').checked = settings.minorIivi.twoHands;
                    if (settings.minorIivi.focusProblemAreas !== undefined) document.getElementById('miivi_focusProblemAreas').checked = settings.minorIivi.focusProblemAreas;
                }

                // Kenny Barron
                if (settings.kennyBarron) {
                    if (settings.kennyBarron.chordType) document.getElementById('kb_chordType').value = settings.kennyBarron.chordType;
                    if (settings.kennyBarron.voicingType) document.getElementById('kb_voicingType').value = settings.kennyBarron.voicingType;
                    if (settings.kennyBarron.rounds) document.getElementById('kb_rounds').value = settings.kennyBarron.rounds;
                    if (settings.kennyBarron.showHints !== undefined) document.getElementById('kb_showHints').checked = settings.kennyBarron.showHints;
                    if (settings.kennyBarron.focusProblemAreas !== undefined) document.getElementById('kb_focusProblemAreas').checked = settings.kennyBarron.focusProblemAreas;
                }

                // JTOU
                if (settings.jtou) {
                    if (settings.jtou.voicing) document.getElementById('jtou_voicingSelect').value = settings.jtou.voicing;
                    if (settings.jtou.rounds) document.getElementById('jtou_roundsSelect').value = settings.jtou.rounds;
                    if (settings.jtou.showHints !== undefined) document.getElementById('jtou_showHints').checked = settings.jtou.showHints;
                    if (settings.jtou.focusProblemAreas !== undefined) document.getElementById('jtou_focusProblemAreas').checked = settings.jtou.focusProblemAreas;
                }

                // Rootless Voicings
                if (settings.dom7Voicing) {
                    if (settings.dom7Voicing.chordType) document.getElementById('dom7v_chordTypeSelect').value = settings.dom7Voicing.chordType;
                    if (settings.dom7Voicing.voicingType) document.getElementById('dom7v_voicingTypeSelect').value = settings.dom7Voicing.voicingType;
                    if (settings.dom7Voicing.rounds) document.getElementById('dom7v_roundsSelect').value = settings.dom7Voicing.rounds;
                    if (settings.dom7Voicing.showHints !== undefined) document.getElementById('dom7v_showHints').checked = settings.dom7Voicing.showHints;
                    if (settings.dom7Voicing.focusProblemAreas !== undefined) document.getElementById('dom7v_focusProblemAreas').checked = settings.dom7Voicing.focusProblemAreas;
                }

                // Extended Voicings
                if (settings.extendedVoicings) {
                    if (settings.extendedVoicings.chordType) document.getElementById('extv_chordTypeSelect').value = settings.extendedVoicings.chordType;
                    if (settings.extendedVoicings.rounds) document.getElementById('extv_roundsSelect').value = settings.extendedVoicings.rounds;
                    if (settings.extendedVoicings.showHints !== undefined) document.getElementById('extv_showHints').checked = settings.extendedVoicings.showHints;
                    if (settings.extendedVoicings.focusProblemAreas !== undefined) document.getElementById('extv_focusProblemAreas').checked = settings.extendedVoicings.focusProblemAreas;
                }

                // Pentatonic & Blues
                if (settings.pentatonic) {
                    if (settings.pentatonic.scaleType) document.getElementById('pent_scaleTypeSelect').value = settings.pentatonic.scaleType;
                    if (settings.pentatonic.rounds) document.getElementById('pent_roundsSelect').value = settings.pentatonic.rounds;
                    if (settings.pentatonic.showHints !== undefined) document.getElementById('pent_showHints').checked = settings.pentatonic.showHints;
                    if (settings.pentatonic.focusProblemAreas !== undefined) document.getElementById('pent_focusProblemAreas').checked = settings.pentatonic.focusProblemAreas;
                }

                // Bebop Scales
                if (settings.bebop) {
                    if (settings.bebop.scaleType) document.getElementById('bebop_scaleTypeSelect').value = settings.bebop.scaleType;
                    if (settings.bebop.rounds) document.getElementById('bebop_roundsSelect').value = settings.bebop.rounds;
                    if (settings.bebop.showHints !== undefined) document.getElementById('bebop_showHints').checked = settings.bebop.showHints;
                    if (settings.bebop.focusProblemAreas !== undefined) document.getElementById('bebop_focusProblemAreas').checked = settings.bebop.focusProblemAreas;
                }

                // Tritone Substitution
                if (settings.tritone) {
                    if (settings.tritone.voicing) document.getElementById('tritone_voicingSelect').value = settings.tritone.voicing;
                    if (settings.tritone.rounds) document.getElementById('tritone_roundsSelect').value = settings.tritone.rounds;
                    if (settings.tritone.showHints !== undefined) document.getElementById('tritone_showHints').checked = settings.tritone.showHints;
                    if (settings.tritone.focusProblemAreas !== undefined) document.getElementById('tritone_focusProblemAreas').checked = settings.tritone.focusProblemAreas;
                }

                // Shell Voicings
                if (settings.shell) {
                    if (settings.shell.chordType) document.getElementById('shell_chordTypeSelect').value = settings.shell.chordType;
                    if (settings.shell.rounds) document.getElementById('shell_roundsSelect').value = settings.shell.rounds;
                    if (settings.shell.showHints !== undefined) document.getElementById('shell_showHints').checked = settings.shell.showHints;
                    if (settings.shell.focusProblemAreas !== undefined) document.getElementById('shell_focusProblemAreas').checked = settings.shell.focusProblemAreas;
                }

                // Upper Structure Triads
                if (settings.upper) {
                    if (settings.upper.structureType) document.getElementById('upper_typeSelect').value = settings.upper.structureType;
                    if (settings.upper.rounds) document.getElementById('upper_roundsSelect').value = settings.upper.rounds;
                    if (settings.upper.hintLevel) document.getElementById('upper_hintLevel').value = settings.upper.hintLevel;
                    if (settings.upper.focusProblemAreas !== undefined) document.getElementById('upper_focusProblemAreas').checked = settings.upper.focusProblemAreas;
                }

                // Freestyle Voicing
                if (settings.freestyle) {
                    if (settings.freestyle.chordType) document.getElementById('freestyle_chordTypeSelect').value = settings.freestyle.chordType;
                    if (settings.freestyle.rounds) document.getElementById('freestyle_roundsSelect').value = settings.freestyle.rounds;
                    if (settings.freestyle.requireRoot !== undefined) document.getElementById('freestyle_requireRoot').checked = settings.freestyle.requireRoot;
                    if (settings.freestyle.showHints !== undefined) document.getElementById('freestyle_showHints').checked = settings.freestyle.showHints;
                    if (settings.freestyle.focusProblemAreas !== undefined) document.getElementById('freestyle_focusProblemAreas').checked = settings.freestyle.focusProblemAreas;
                }

                // ATTYA
                if (settings.attya) {
                    if (settings.attya.voicing) document.getElementById('attya_voicingSelect').value = settings.attya.voicing;
                    if (settings.attya.showHints !== undefined) document.getElementById('attya_showHints').checked = settings.attya.showHints;
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // ============ FREESTYLE VOICING MODE ============
        const FREESTYLE_CHORD_TYPES = {
            'maj7': { suffix: 'maj7', third: 4, seventh: 11, display: 'maj7' },
            'min7': { suffix: 'm7', third: 3, seventh: 10, display: 'm7' },
            'dom7': { suffix: '7', third: 4, seventh: 10, display: '7' }
        };

        let freestyle_isPlaying = false;
        let freestyle_challenge = null;
        let freestyle_usedChallenges = new Set();
        let freestyle_challengeStartTime = null;
        let freestyle_config = null;
        let freestyle_currentRound = 0;
        let freestyle_firstTryCorrect = 0;
        let freestyle_totalMistakes = 0;
        let freestyle_roundHadMistake = false;
        let freestyle_confirmationTimer = null;
        let freestyle_isConfirming = false;
        let freestyle_confirmedTime = null;
        let freestyle_stats = {};
        let freestyle_allTimes = [];
        let freestyle_slowCount = 0;
        let freestyle_history = [];
        let freestyle_cumulativeStats = {};
        let freestyle_heldNotes = new Set();

        function freestyleGetValidIntervals(chordType) {
            // Base intervals valid for all chord types: root, 5th, 9th, 11th, 13th
            const intervals = new Set([0, 7, 2, 5, 9]);

            if (chordType === 'maj7') {
                intervals.add(4);  // major 3rd
                intervals.add(11); // major 7th
                intervals.add(6);  // #11 (common on maj7)
                return intervals;
            }
            if (chordType === 'min7') {
                intervals.add(3);  // minor 3rd
                intervals.add(10); // minor 7th
                return intervals;
            }
            if (chordType === 'dom7') {
                intervals.add(4);  // major 3rd
                intervals.add(10); // minor 7th
                intervals.add(1);  // b9
                intervals.add(3);  // #9
                intervals.add(6);  // #11
                intervals.add(8);  // b13
                return intervals;
            }
            return intervals;
        }

        function freestyleIsValidVoicing(heldPitchClasses, root, chordType) {
            const chordInfo = FREESTYLE_CHORD_TYPES[chordType];
            const third = (root + chordInfo.third) % 12;
            const seventh = (root + chordInfo.seventh) % 12;

            // Must have guide tones
            if (!heldPitchClasses.has(third) || !heldPitchClasses.has(seventh)) return false;

            // If require root is checked, must have root
            if (freestyle_config.requireRoot && !heldPitchClasses.has(root)) return false;

            // Check that all held notes are valid for this chord
            const validIntervals = freestyleGetValidIntervals(chordType);
            for (const pc of heldPitchClasses) {
                const interval = (pc - root + 12) % 12;
                if (!validIntervals.has(interval)) return false;
            }

            return true;
        }

        function freestyleStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('freestyle_chordTypeSelect').value;
            const rounds = parseInt(document.getElementById('freestyle_roundsSelect').value);
            const requireRoot = document.getElementById('freestyle_requireRoot').checked;

            const showHints = document.getElementById('freestyle_showHints').checked;
            const focusProblemAreas = document.getElementById('freestyle_focusProblemAreas').checked;
            freestyle_config = { chordType: chordTypeSetting, rounds, requireRoot, showHints, focusProblemAreas };
            freestyle_usedChallenges.clear();
            freestyle_currentRound = 0;
            freestyle_firstTryCorrect = 0;
            freestyle_totalMistakes = 0;
            freestyle_slowCount = 0;
            freestyle_roundHadMistake = false;
            freestyle_stats = {};
            freestyle_allTimes = [];
            freestyle_isPlaying = true;
            freestyle_heldNotes.clear();

            document.getElementById('freestyle_settingsPanel').classList.add('hidden');
            document.getElementById('freestyle_challengeDisplay').classList.remove('hidden');
            document.getElementById('freestyle_completeDisplay').classList.add('hidden');
            document.getElementById('freestyle_breakdownSection').classList.add('hidden');
            document.getElementById('freestyle_startBtn').textContent = 'Stop';
            document.getElementById('freestyle_startBtn').onclick = freestyleStopGame;
            document.getElementById('freestyle_startBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('freestyle_startBtn').classList.add('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('freestyle_totalRounds').innerText = rounds;
            document.getElementById('freestyle_roundDisplay').innerText = '0';
            document.getElementById('freestyle_firstTry').innerText = '0%';
            document.getElementById('freestyle_mistakes').innerText = '0';
            document.getElementById('freestyle_slow').innerText = '0';
            document.getElementById('freestyle_responseTime').innerText = '--';

            // Countdown
            const chordDisplay = document.getElementById('freestyle_chordDisplay');
            let count = 3;
            chordDisplay.innerText = count;
            document.getElementById('freestyle_recognized').innerText = '';
            document.getElementById('freestyle_feedbackText').innerText = '';

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    chordDisplay.innerText = count;
                } else {
                    clearInterval(countdownInterval);
                    freestyleNextChallenge();
                }
            }, 800);
        }

        function freestyleStopGame() {
            freestyle_isPlaying = false;
            // Clear any pending confirmation timer
            if (freestyle_confirmationTimer) {
                clearTimeout(freestyle_confirmationTimer);
                freestyle_confirmationTimer = null;
            }
            freestyle_isConfirming = false;
            freestyle_confirmedTime = null;
            document.getElementById('freestyle_settingsPanel').classList.remove('hidden');
            document.getElementById('freestyle_challengeDisplay').classList.add('hidden');
            document.getElementById('freestyle_startBtn').textContent = 'Start Game';
            document.getElementById('freestyle_startBtn').onclick = freestyleStartGame;
            document.getElementById('freestyle_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('freestyle_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            drawPiano('freestyle_pianoSvg');
        }

        function freestyleNextChallenge() {
            if (!freestyle_isPlaying) return;

            // Reset confirmation state
            freestyle_isConfirming = false;
            freestyle_confirmedTime = null;
            if (freestyle_confirmationTimer) {
                clearTimeout(freestyle_confirmationTimer);
                freestyle_confirmationTimer = null;
            }

            if (freestyle_currentRound >= freestyle_config.rounds) {
                freestyleEndGame();
                return;
            }

            // Pick random root and chord type
            let root, chordType;
            const chordTypes = freestyle_config.chordType === 'all' ? ['maj7', 'min7', 'dom7'] : [freestyle_config.chordType];

            // Check for problem areas if enabled
            const problemAreas = freestyle_config.focusProblemAreas ? freestyleGetProblemAreas() : [];
            const useProblemArea = problemAreas.length > 0 && Math.random() < 0.6;

            if (useProblemArea) {
                const problemChord = problemAreas[Math.floor(Math.random() * problemAreas.length)];
                // Parse chord name (e.g., "Cmaj7" -> root=0, chordType=maj7)
                const match = problemChord.match(/^([A-G][#b]?)(maj7|m7|7)$/);
                if (match) {
                    const noteIdx = { 'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11 };
                    const suffixMap = { 'maj7': 'maj7', 'm7': 'min7', '7': 'dom7' };
                    root = noteIdx[match[1]];
                    chordType = suffixMap[match[2]];
                }
            }

            if (root === undefined) {
                let attempts = 0;
                do {
                    root = Math.floor(Math.random() * 12);
                    chordType = chordTypes[Math.floor(Math.random() * chordTypes.length)];
                    attempts++;
                } while (freestyle_usedChallenges.has(`${root}-${chordType}`) && attempts < 50);

                if (attempts >= 50) {
                    freestyle_usedChallenges.clear();
                    root = Math.floor(Math.random() * 12);
                    chordType = chordTypes[Math.floor(Math.random() * chordTypes.length)];
                }
            }

            freestyle_usedChallenges.add(`${root}-${chordType}`);
            freestyle_currentRound++;

            const chordInfo = FREESTYLE_CHORD_TYPES[chordType];
            const chordName = NOTE_NAMES[root] + chordInfo.suffix;

            freestyle_challenge = { root, chordType, name: chordName };
            freestyle_roundHadMistake = false;
            freestyle_heldNotes.clear();
            freestyle_challengeStartTime = Date.now();

            // Initialize stats for this chord
            const statKey = chordName;
            if (!freestyle_stats[statKey]) {
                freestyle_stats[statKey] = { attempts: 0, mistakes: 0, times: [] };
            }
            freestyle_stats[statKey].attempts++;

            // Update display
            document.getElementById('freestyle_chordDisplay').innerText = chordName;
            document.getElementById('freestyle_roundDisplay').innerText = freestyle_currentRound;
            document.getElementById('freestyle_recognized').innerText = '';
            document.getElementById('freestyle_feedbackText').innerText = '';
            document.getElementById('freestyle_feedbackText').className = 'text-lg font-semibold h-7';

            // Show hint if enabled
            const hintEl = document.getElementById('freestyle_hint');
            if (freestyle_config.showHints) {
                const thirdNote = NOTE_NAMES[(root + chordInfo.third) % 12];
                const seventhNote = NOTE_NAMES[(root + chordInfo.seventh) % 12];
                hintEl.innerText = `Guide tones: ${thirdNote} + ${seventhNote}`;
                hintEl.classList.remove('hidden');
            } else {
                hintEl.classList.add('hidden');
            }

            drawPiano('freestyle_pianoSvg');
        }

        function freestyleOnNoteOn(midi) {
            if (!freestyle_isPlaying || !freestyle_challenge || !freestyle_challengeStartTime) return;

            freestyle_heldNotes.add(midi);
            const heldPitchClasses = new Set([...freestyle_heldNotes].map(n => n % 12));

            // Highlight on piano
            drawPiano('freestyle_pianoSvg', freestyle_heldNotes);

            // Check for wrong notes (notes not in valid intervals) - only count if not already confirming
            if (!freestyle_isConfirming) {
                const notePitchClass = midi % 12;
                const validIntervals = freestyleGetValidIntervals(freestyle_challenge.chordType);
                const noteInterval = (notePitchClass - freestyle_challenge.root + 12) % 12;
                const isWrongNote = !validIntervals.has(noteInterval);

                if (isWrongNote && !freestyle_roundHadMistake) {
                    freestyle_totalMistakes++;
                    freestyle_roundHadMistake = true;
                    freestyle_stats[freestyle_challenge.name].mistakes++;
                    document.getElementById('freestyle_mistakes').innerText = freestyle_totalMistakes;
                }
            }

            // Show what chord is being recognized
            const recognized = identifyChords(heldPitchClasses);
            let recognizedName = '';
            if (recognized && recognized.length > 0) {
                recognizedName = recognized[0].name;
                document.getElementById('freestyle_recognized').innerText = recognizedName;
            } else if (heldPitchClasses.size >= 2) {
                recognizedName = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('freestyle_recognized').innerText = recognizedName;
            }

            // Check if current voicing is valid
            const isValid = freestyleIsValidVoicing(heldPitchClasses, freestyle_challenge.root, freestyle_challenge.chordType);

            // If valid and not already confirming, start confirmation period
            if (isValid && heldPitchClasses.size >= 2 && !freestyle_isConfirming) {
                freestyle_isConfirming = true;
                freestyle_confirmedTime = Date.now() - freestyle_challengeStartTime;

                // Record stats immediately (time is locked in)
                freestyle_allTimes.push(freestyle_confirmedTime);
                freestyle_stats[freestyle_challenge.name].times.push(freestyle_confirmedTime);

                if (freestyle_confirmedTime > 2000) {
                    freestyle_slowCount++;
                    document.getElementById('freestyle_slow').innerText = freestyle_slowCount;
                }

                if (!freestyle_roundHadMistake) {
                    freestyle_firstTryCorrect++;
                }

                const pct = freestyle_currentRound > 0 ? Math.round((freestyle_firstTryCorrect / freestyle_currentRound) * 100) : 0;
                document.getElementById('freestyle_firstTry').innerText = pct + '%';

                const seconds = freestyle_confirmedTime / 1000;
                document.getElementById('freestyle_responseTime').innerText = seconds.toFixed(1) + 's';
                document.getElementById('freestyle_responseTime').className = 'text-2xl font-mono ' +
                    (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');

                // Show initial valid feedback
                document.getElementById('freestyle_feedbackText').innerText = '✓ Valid!';
                document.getElementById('freestyle_feedbackText').className = 'text-lg font-semibold h-7 mt-4 text-green-400';

                // Start confirmation timer - wait 1.5s for additional notes
                freestyle_confirmationTimer = setTimeout(() => {
                    freestyleConfirmAndAdvance();
                }, 1500);
            }
        }

        function freestyleConfirmAndAdvance() {
            if (!freestyle_isPlaying || !freestyle_challenge) return;

            // Get final chord recognition
            const heldPitchClasses = new Set([...freestyle_heldNotes].map(n => n % 12));
            const recognized = identifyChords(heldPitchClasses);
            let finalChord = recognized && recognized.length > 0 ? recognized[0].name : 'Valid voicing';

            // Build explanation of why it's valid
            const root = freestyle_challenge.root;
            const chordInfo = FREESTYLE_CHORD_TYPES[freestyle_challenge.chordType];
            const thirdNote = NOTE_NAMES[(root + chordInfo.third) % 12];
            const seventhNote = NOTE_NAMES[(root + chordInfo.seventh) % 12];

            // Show final feedback
            document.getElementById('freestyle_feedbackText').innerHTML =
                `<span class="text-green-400">✓ ${finalChord}</span><br><span class="text-sm text-slate-400">Guide tones: ${thirdNote} + ${seventhNote}</span>`;

            // Advance after showing final feedback
            setTimeout(() => {
                freestyle_isConfirming = false;
                freestyle_confirmedTime = null;
                freestyleNextChallenge();
            }, 800);
        }

        function freestyleOnNoteOff(midi) {
            freestyle_heldNotes.delete(midi);
            if (freestyle_isPlaying) {
                drawPiano('freestyle_pianoSvg', freestyle_heldNotes);

                // Update recognized chord display
                const heldPitchClasses = new Set([...freestyle_heldNotes].map(n => n % 12));
                if (heldPitchClasses.size > 0) {
                    const recognized = identifyChord(heldPitchClasses);
                    if (recognized && recognized.length > 0) {
                        document.getElementById('freestyle_recognized').innerText = recognized[0].name;
                    } else {
                        document.getElementById('freestyle_recognized').innerText = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                    }
                } else {
                    document.getElementById('freestyle_recognized').innerText = '';
                }
            }
        }

        function freestyleShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('freestyle_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function freestyleEndGame() {
            freestyle_isPlaying = false;
            const avgTime = freestyle_allTimes.length > 0 ? freestyle_allTimes.reduce((a, b) => a + b, 0) / freestyle_allTimes.length : 0;
            const accuracy = freestyle_currentRound > 0 ? Math.round((freestyle_firstTryCorrect / freestyle_currentRound) * 100) : 0;

            // Save to history
            freestyle_history.unshift({
                date: new Date().toISOString(),
                rounds: freestyle_currentRound,
                avgTime: avgTime,
                firstTryPct: accuracy,
                mistakes: freestyle_totalMistakes,
                slowCount: freestyle_slowCount,
                config: { chordType: freestyle_config.chordType, requireRoot: freestyle_config.requireRoot }
            });
            if (freestyle_history.length > 20) freestyle_history.pop();
            localStorage.setItem('freestyle_history', JSON.stringify(freestyle_history));

            freestyleUpdateCumulativeStats();

            // Update display
            document.getElementById('freestyle_challengeDisplay').classList.add('hidden');
            document.getElementById('freestyle_completeDisplay').classList.remove('hidden');
            document.getElementById('freestyle_finalRounds').innerText = freestyle_currentRound;
            document.getElementById('freestyle_finalAvgTime').innerText = (avgTime / 1000).toFixed(1) + 's';
            document.getElementById('freestyle_finalFirstTry').innerText = accuracy + '%';
            document.getElementById('freestyle_finalMistakes').innerText = freestyle_totalMistakes;
            document.getElementById('freestyle_finalSlow').innerText = freestyle_slowCount;

            document.getElementById('freestyle_startBtn').textContent = 'Play Again';
            document.getElementById('freestyle_startBtn').onclick = freestyleStartGame;
            document.getElementById('freestyle_startBtn').classList.remove('bg-slate-600', 'hover:bg-slate-500');
            document.getElementById('freestyle_startBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');

            freestyleShowBreakdown();
            freestyleRenderHistory();
        }

        function freestyleShowBreakdown() {
            const grid = document.getElementById('freestyle_breakdownGrid');
            grid.innerHTML = '';

            const hasSessionStats = Object.keys(freestyle_stats).length > 0;

            if (hasSessionStats) {
                Object.keys(freestyle_stats).sort().forEach(key => {
                    const stat = freestyle_stats[key];
                    const pct = stat.attempts > 0 ? Math.round(((stat.attempts - stat.mistakes) / stat.attempts) * 100) : 0;
                    const avgT = stat.times.length > 0 ? stat.times.reduce((a, b) => a + b, 0) / stat.times.length / 1000 : 0;
                    const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                    const isSlow = avgT > 2;

                    const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                    const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                    const div = document.createElement('div');
                    div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                    const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                    const firstTry = stat.attempts - stat.mistakes;
                    div.innerHTML = `<p class="font-semibold">${key}</p><p>${pct}% (${firstTry}/${stat.attempts})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                    grid.appendChild(div);
                });
                document.getElementById('freestyle_breakdownSection').classList.remove('hidden');
            } else {
                document.getElementById('freestyle_breakdownSection').classList.add('hidden');
            }
        }

        function freestyleLoadHistory() {
            const saved = localStorage.getItem('freestyle_history');
            if (saved) {
                freestyle_history = JSON.parse(saved);
            }
            const cumSaved = localStorage.getItem('freestyle_cumulativeStats');
            if (cumSaved) {
                freestyle_cumulativeStats = JSON.parse(cumSaved);
            }
            freestyleRenderHistory();
        }

        function freestyleClearHistory() {
            if (!confirm('Clear all history and statistics for this mode?')) return;
            freestyle_history = [];
            freestyle_cumulativeStats = {};
            localStorage.removeItem('freestyle_history');
            localStorage.removeItem('freestyle_cumulativeStats');
            freestyleRenderHistory();
        }

        function freestyleUpdateCumulativeStats() {
            Object.keys(freestyle_stats).forEach(key => {
                const stat = freestyle_stats[key];
                if (!freestyle_cumulativeStats[key]) {
                    freestyle_cumulativeStats[key] = { attempts: 0, mistakes: 0 };
                }
                freestyle_cumulativeStats[key].attempts += stat.attempts;
                freestyle_cumulativeStats[key].mistakes += stat.mistakes;
            });
            localStorage.setItem('freestyle_cumulativeStats', JSON.stringify(freestyle_cumulativeStats));
        }

        function freestyleGetProblemAreas() {
            const dominated = [];
            Object.keys(freestyle_cumulativeStats).forEach(key => {
                const stat = freestyle_cumulativeStats[key];
                if (stat.attempts >= 3) {
                    const mistakeRate = stat.mistakes / stat.attempts;
                    if (mistakeRate > 0.3) {
                        dominated.push({ key, mistakeRate, attempts: stat.attempts });
                    }
                }
            });
            return dominated.sort((a, b) => b.mistakeRate - a.mistakeRate).slice(0, 5);
        }

        function freestyleRenderHistory() {
            const content = document.getElementById('freestyle_historyContent');
            if (freestyle_history.length === 0) {
                content.innerHTML = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="freestyleClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div><p class="text-slate-400">No games played yet.</p>';
                return;
            }

            const medals = getMedals(freestyle_history, 'firstTryPct', 'avgTime');
            let html = '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white">History</h2><button onclick="freestyleClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button></div>';
            html += '<div class="space-y-2">';

            freestyle_history.slice(0, 5).forEach((game, idx) => {
                const date = new Date(game.date).toLocaleDateString();
                const avgSec = (game.avgTime / 1000).toFixed(1);
                const configLabel = game.config?.chordType === 'all' ? 'All' : game.config?.chordType || 'All';
                const slowCount = game.slowCount || 0;
                const timeClass = game.avgTime < 2000 ? 'text-green-400' : 'text-yellow-400';
                const slowClass = slowCount > 0 ? 'text-yellow-400' : 'text-slate-500';
                const medal = medals[idx] || '';
                html += `<div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                    <span class="w-6">${medal}</span>
                    <span class="text-slate-400 w-16">${date}</span>
                    <span class="text-xs text-slate-500 w-16">${configLabel}</span>
                    <span class="text-white w-12">${game.rounds} rds</span>
                    <span class="${timeClass} w-10">${avgSec}s</span>
                    <span class="text-green-400 w-10">${game.firstTryPct}%</span>
                    <span class="${slowClass} w-8">${slowCount}⏱</span>
                </div>`;
            });

            html += '</div>';

            // Problem areas
            const problemAreas = freestyleGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="flex flex-wrap gap-2">`;
                problemAreas.forEach(area => {
                    html += `<span class="px-2 py-1 bg-red-900/30 border border-red-700/50 rounded text-xs">
                        ${area.key} <span class="text-red-400">${(area.mistakeRate * 100).toFixed(0)}%</span>
                    </span>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ALL THE THINGS YOU ARE MODE ============
        let attya_isPlaying = false;
        let attya_chords = [];
        let attya_voicings = [];
        let attya_currentIndex = 0;
        let attya_heldNotes = new Set();
        let attya_challengeStartTime = null;
        let attya_responseTimes = [];
        let attya_mistakes = 0;
        let attya_firstTryCount = 0;
        let attya_currentFirstTry = true;
        let attya_waitingForRelease = false; // Require all notes released before next chord

        function attyaRenderChartGrid() {
            const grid = document.getElementById('attya_chartGrid');
            const chords = flattenChart(ATTYA_CHART);
            let html = '';
            let lastSection = '';
            let barIndex = 0;

            for (const section of ATTYA_CHART.sections) {
                for (const bar of section.bars) {
                    const chordSymbols = bar.chords || [bar.chord];
                    const isNewSection = section.name !== lastSection;
                    lastSection = section.name;

                    let cellContent = chordSymbols.map(c => `<div class="truncate">${c}</div>`).join('');
                    if (isNewSection && barIndex % 4 === 0) {
                        cellContent = `<div class="text-[10px] text-slate-500 absolute -top-3 left-1">${section.name}</div>` + cellContent;
                    }

                    html += `<div id="attya_bar_${barIndex}" class="relative p-2 bg-slate-700/50 rounded border border-slate-600 text-slate-300 font-mono" style="font-size: 11px;">${cellContent}</div>`;
                    barIndex++;
                }
            }

            grid.innerHTML = html;
        }

        function attyaUpdateChartHighlight() {
            // Clear all highlights
            document.querySelectorAll('[id^="attya_bar_"]').forEach(el => {
                el.classList.remove('bg-blue-600/30', 'border-blue-500', 'bg-green-600/30', 'border-green-500');
                el.classList.add('bg-slate-700/50', 'border-slate-600');
            });

            // Find which bar contains the current chord index
            let chordCount = 0;
            let barIndex = 0;
            for (const section of ATTYA_CHART.sections) {
                for (const bar of section.bars) {
                    const numChords = bar.chords ? bar.chords.length : 1;
                    const startIdx = chordCount;
                    const endIdx = chordCount + numChords;

                    const barEl = document.getElementById(`attya_bar_${barIndex}`);
                    if (barEl) {
                        if (attya_currentIndex >= startIdx && attya_currentIndex < endIdx) {
                            // Current bar
                            barEl.classList.remove('bg-slate-700/50', 'border-slate-600');
                            barEl.classList.add('bg-blue-600/30', 'border-blue-500');
                        } else if (attya_currentIndex >= endIdx) {
                            // Completed bar
                            barEl.classList.remove('bg-slate-700/50', 'border-slate-600');
                            barEl.classList.add('bg-green-600/30', 'border-green-500');
                        }
                    }

                    chordCount = endIdx;
                    barIndex++;
                }
            }
        }

        function attyaStartGame() {
            const voicing = document.getElementById('attya_voicingSelect').value;

            // Flatten chart and compute voicings
            attya_chords = flattenChart(ATTYA_CHART);
            if (voicing === 'shell') {
                // Shell voicings (no A/B optimization needed)
                attya_voicings = attya_chords.map(chord => ({
                    chord: chord,
                    voicingType: 'shell',
                    pitchClasses: getVoicingPitchClasses(chord.root, chord.type, 'shell')
                }));
            } else {
                // Compute optimal A/B voicings
                attya_voicings = computeOptimalVoicings(attya_chords);
            }

            // Reset state
            attya_isPlaying = true;
            attya_currentIndex = 0;
            attya_heldNotes = new Set();
            attya_responseTimes = [];
            attya_mistakes = 0;
            attya_firstTryCount = 0;
            attya_currentFirstTry = true;
            attya_waitingForRelease = false;

            // Update UI
            document.getElementById('attya_settingsPanel').classList.add('hidden');
            document.getElementById('attya_challengeDisplay').classList.remove('hidden');
            document.getElementById('attya_completeDisplay').classList.add('hidden');
            document.getElementById('attya_progress').textContent = '0';
            document.getElementById('attya_totalChanges').textContent = attya_chords.length;
            document.getElementById('attya_firstTry').textContent = '0%';
            document.getElementById('attya_mistakes').textContent = '0';
            document.getElementById('attya_responseTime').textContent = '--';

            const startBtn = document.getElementById('attya_startBtn');
            startBtn.textContent = 'Stop';
            startBtn.onclick = attyaStopGame;
            startBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            startBtn.classList.add('bg-slate-600', 'hover:bg-slate-500');

            attyaUpdateChartHighlight();
            attyaShowChallenge();
        }

        function attyaStopGame() {
            attya_isPlaying = false;

            document.getElementById('attya_settingsPanel').classList.remove('hidden');
            document.getElementById('attya_challengeDisplay').classList.add('hidden');

            const startBtn = document.getElementById('attya_startBtn');
            startBtn.textContent = 'Start';
            startBtn.onclick = attyaStartGame;
            startBtn.classList.remove('bg-slate-600', 'hover:bg-slate-500');
            startBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Clear piano
            document.querySelectorAll('#attya_pianoSvg .key').forEach(key => {
                key.classList.remove('key-active', 'key-correct', 'key-wrong');
            });
        }

        function attyaShowChallenge() {
            if (!attya_isPlaying || attya_currentIndex >= attya_voicings.length) return;

            const current = attya_voicings[attya_currentIndex];
            const chord = current.chord;
            const showHints = document.getElementById('attya_showHints').checked;

            // Update display
            document.getElementById('attya_sectionLabel').textContent = `Bar ${chord.bar} • Section ${chord.section}`;
            document.getElementById('attya_chordDisplay').textContent = chord.symbol;

            // Show voicing type
            if (document.getElementById('attya_voicingSelect').value === 'shell') {
                document.getElementById('attya_voicingType').textContent = 'Shell (3-7)';
            } else {
                document.getElementById('attya_voicingType').textContent = `Type ${current.voicingType}`;
            }

            // Show hint - use actual MIDI notes if available for accurate display
            if (showHints) {
                let noteNames;
                if (current.midiNotes && current.midiNotes.length > 0) {
                    // Use the actual optimized MIDI notes
                    noteNames = getMidiNoteNames(current.midiNotes);
                } else {
                    // Fallback to pitch class names
                    noteNames = getVoicingNoteNames(chord.root, chord.type, current.voicingType);
                }
                document.getElementById('attya_hint').textContent = noteNames;
                document.getElementById('attya_hint').classList.remove('hidden');
            } else {
                document.getElementById('attya_hint').classList.add('hidden');
            }

            document.getElementById('attya_feedbackText').textContent = '';
            attya_currentFirstTry = true;
            attya_challengeStartTime = Date.now();
        }

        function attyaOnNoteOn(midi) {
            if (!attya_isPlaying || attya_currentIndex >= attya_voicings.length || !attya_challengeStartTime) return;

            attya_heldNotes.add(midi);
            highlightKey('attya_pianoSvg', midi, 'key-active', true);

            // If waiting for all notes to be released before next chord, don't check yet
            if (attya_waitingForRelease) return;

            // Check if held notes match expected voicing
            const current = attya_voicings[attya_currentIndex];
            const heldPitchClasses = new Set([...attya_heldNotes].map(n => n % 12));
            const expectedPitchClasses = new Set(current.pitchClasses);

            // Check for correct voicing
            const isCorrect = expectedPitchClasses.size === heldPitchClasses.size &&
                [...expectedPitchClasses].every(pc => heldPitchClasses.has(pc));

            // Check for wrong notes
            const hasWrongNote = [...heldPitchClasses].some(pc => !expectedPitchClasses.has(pc));

            if (hasWrongNote) {
                attya_currentFirstTry = false;
                attya_mistakes++;
                document.getElementById('attya_mistakes').textContent = attya_mistakes;
                document.getElementById('attya_feedbackText').innerHTML = '<span class="text-red-400">Wrong note!</span>';

                // Highlight wrong key
                highlightKey('attya_pianoSvg', midi, 'key-wrong', true);
                setTimeout(() => highlightKey('attya_pianoSvg', midi, 'key-wrong', false), 300);
            }

            if (isCorrect) {
                const responseTime = Date.now() - attya_challengeStartTime;
                attya_responseTimes.push(responseTime);

                if (attya_currentFirstTry) {
                    attya_firstTryCount++;
                }

                // Update stats
                const firstTryPct = Math.round((attya_firstTryCount / (attya_currentIndex + 1)) * 100);
                document.getElementById('attya_firstTry').textContent = `${firstTryPct}%`;
                document.getElementById('attya_progress').textContent = attya_currentIndex + 1;

                // Update avg time
                const avgTime = attya_responseTimes.reduce((a, b) => a + b, 0) / attya_responseTimes.length;
                const avgTimeStr = (avgTime / 1000).toFixed(1) + 's';
                document.getElementById('attya_responseTime').textContent = avgTimeStr;
                document.getElementById('attya_responseTime').className = `text-2xl font-mono ${avgTime < 2000 ? 'timer-fast' : avgTime < 4000 ? 'timer-medium' : 'timer-slow'}`;

                // Show success feedback
                document.getElementById('attya_feedbackText').innerHTML = '<span class="text-green-400">Correct!</span>';

                // Flash correct keys
                for (const note of attya_heldNotes) {
                    highlightKey('attya_pianoSvg', note, 'key-correct', true);
                }

                // Advance after brief delay
                // Set flag to require release before next chord can be checked
                attya_waitingForRelease = true;

                setTimeout(() => {
                    // Clear keys visually (but notes may still be held)
                    for (const note of attya_heldNotes) {
                        highlightKey('attya_pianoSvg', note, 'key-correct', false);
                        highlightKey('attya_pianoSvg', note, 'key-active', false);
                    }

                    attya_currentIndex++;
                    attyaUpdateChartHighlight();

                    if (attya_currentIndex >= attya_voicings.length) {
                        attyaEndGame();
                    } else {
                        attyaShowChallenge();
                    }
                }, 400);
            }
        }

        function attyaOnNoteOff(midi) {
            attya_heldNotes.delete(midi);
            highlightKey('attya_pianoSvg', midi, 'key-active', false);

            // If waiting for release and all notes are now released, clear the flag
            if (attya_waitingForRelease && attya_heldNotes.size === 0) {
                attya_waitingForRelease = false;
                // Reset challenge start time now that we're ready for fresh input
                attya_challengeStartTime = Date.now();
            }
        }

        function attyaEndGame() {
            attya_isPlaying = false;

            // Calculate final stats
            const avgTime = attya_responseTimes.length > 0 ?
                attya_responseTimes.reduce((a, b) => a + b, 0) / attya_responseTimes.length : 0;
            const firstTryPct = Math.round((attya_firstTryCount / attya_chords.length) * 100);

            // Update complete display
            document.getElementById('attya_finalChanges').textContent = attya_chords.length;
            document.getElementById('attya_finalAvgTime').textContent = (avgTime / 1000).toFixed(1) + 's';
            document.getElementById('attya_finalFirstTry').textContent = `${firstTryPct}%`;
            document.getElementById('attya_finalMistakes').textContent = attya_mistakes;

            // Show complete display
            document.getElementById('attya_challengeDisplay').classList.add('hidden');
            document.getElementById('attya_completeDisplay').classList.remove('hidden');
            document.getElementById('attya_settingsPanel').classList.remove('hidden');

            // Update button
            const startBtn = document.getElementById('attya_startBtn');
            startBtn.textContent = 'Play Again';
            startBtn.onclick = attyaStartGame;
            startBtn.classList.remove('bg-slate-600', 'hover:bg-slate-500');
            startBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Save history
            const historyEntry = {
                date: new Date().toISOString(),
                changes: attya_chords.length,
                avgTime: avgTime,
                firstTryPct: firstTryPct,
                mistakes: attya_mistakes,
                voicing: document.getElementById('attya_voicingSelect').value
            };

            let history = JSON.parse(localStorage.getItem('attya_history') || '[]');
            history.unshift(historyEntry);
            history = history.slice(0, 20);
            localStorage.setItem('attya_history', JSON.stringify(history));

            attyaRenderHistory();
        }

        function attyaLoadHistory() {
            attyaRenderHistory();
        }

        function attyaRenderHistory() {
            const content = document.getElementById('attya_historyContent');
            let history = JSON.parse(localStorage.getItem('attya_history') || '[]');

            if (history.length === 0) {
                content.innerHTML = '<p class="text-slate-500 text-sm">No practice history yet. Complete a run to see your results here.</p>';
                return;
            }

            const medals = getMedals(history, 'firstTryPct', 'avgTime');

            let html = '<div class="flex justify-between items-center mb-3"><h2 class="text-xl font-semibold text-white">Practice History</h2>';
            html += '<button onclick="attyaClearHistory()" class="text-xs text-slate-500 hover:text-red-400 transition">Clear History</button></div>';
            html += '<div class="space-y-1">';

            history.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const avgTimeStr = (game.avgTime / 1000).toFixed(1) + 's';
                const medal = medals[idx] || '';
                const rowClass = idx % 2 === 0 ? 'bg-slate-700/30' : '';

                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-purple-400 ml-2">${game.voicing}</span></div>
                    <div><span class="font-bold ${game.firstTryPct >= 80 ? 'text-green-400' : game.firstTryPct >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.firstTryPct}%</span>
                    <span class="text-slate-500 text-xs ml-1">(${avgTimeStr})</span>
                    <span class="text-red-400 text-xs ml-1">${game.mistakes}m</span>
                    ${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function attyaClearHistory() {
            if (confirm('Clear all practice history for this chart?')) {
                localStorage.removeItem('attya_history');
                attyaRenderHistory();
            }
        }

        // ============ VOICE LEADING TRAINER MODE ============
        let vl_isPlaying = false;
        let vl_challenge = null; // { sourceChord, targetChord, sourceNotes, targetNotes, common, resolutions }
        let vl_challengeStartTime = null;
        let vl_round = 0;
        let vl_totalRounds = 12;
        let vl_mistakes = 0;
        let vl_firstTryCount = 0;
        let vl_firstTryThisRound = true;
        let vl_responseTimes = [];
        let vl_heldNotes = new Set();
        let vl_waitingForRelease = false;
        let vl_phase = 'source'; // 'source' or 'target' - which chord we're waiting for

        // Progression definitions (ii-V, V-I, ii-V-I)
        const VL_PROGRESSIONS = {
            'ii-V': [
                { from: { root: 2, type: 'm7', name: 'Dm7' }, to: { root: 7, type: 'dom7', name: 'G7' } },
                { from: { root: 9, type: 'm7', name: 'Am7' }, to: { root: 2, type: 'dom7', name: 'D7' } },
                { from: { root: 4, type: 'm7', name: 'Em7' }, to: { root: 9, type: 'dom7', name: 'A7' } },
                { from: { root: 11, type: 'm7', name: 'Bm7' }, to: { root: 4, type: 'dom7', name: 'E7' } },
                { from: { root: 6, type: 'm7', name: 'F#m7' }, to: { root: 11, type: 'dom7', name: 'B7' } },
                { from: { root: 1, type: 'm7', name: 'C#m7' }, to: { root: 6, type: 'dom7', name: 'F#7' } },
                { from: { root: 8, type: 'm7', name: 'Abm7' }, to: { root: 1, type: 'dom7', name: 'Db7' } },
                { from: { root: 3, type: 'm7', name: 'Ebm7' }, to: { root: 8, type: 'dom7', name: 'Ab7' } },
                { from: { root: 10, type: 'm7', name: 'Bbm7' }, to: { root: 3, type: 'dom7', name: 'Eb7' } },
                { from: { root: 5, type: 'm7', name: 'Fm7' }, to: { root: 10, type: 'dom7', name: 'Bb7' } },
                { from: { root: 0, type: 'm7', name: 'Cm7' }, to: { root: 5, type: 'dom7', name: 'F7' } },
                { from: { root: 7, type: 'm7', name: 'Gm7' }, to: { root: 0, type: 'dom7', name: 'C7' } }
            ],
            'V-I': [
                { from: { root: 7, type: 'dom7', name: 'G7' }, to: { root: 0, type: 'maj7', name: 'Cmaj7' } },
                { from: { root: 2, type: 'dom7', name: 'D7' }, to: { root: 7, type: 'maj7', name: 'Gmaj7' } },
                { from: { root: 9, type: 'dom7', name: 'A7' }, to: { root: 2, type: 'maj7', name: 'Dmaj7' } },
                { from: { root: 4, type: 'dom7', name: 'E7' }, to: { root: 9, type: 'maj7', name: 'Amaj7' } },
                { from: { root: 11, type: 'dom7', name: 'B7' }, to: { root: 4, type: 'maj7', name: 'Emaj7' } },
                { from: { root: 6, type: 'dom7', name: 'F#7' }, to: { root: 11, type: 'maj7', name: 'Bmaj7' } },
                { from: { root: 1, type: 'dom7', name: 'Db7' }, to: { root: 6, type: 'maj7', name: 'Gbmaj7' } },
                { from: { root: 8, type: 'dom7', name: 'Ab7' }, to: { root: 3, type: 'maj7', name: 'Ebmaj7' } },
                { from: { root: 3, type: 'dom7', name: 'Eb7' }, to: { root: 8, type: 'maj7', name: 'Abmaj7' } },
                { from: { root: 10, type: 'dom7', name: 'Bb7' }, to: { root: 5, type: 'maj7', name: 'Fmaj7' } },
                { from: { root: 5, type: 'dom7', name: 'F7' }, to: { root: 10, type: 'maj7', name: 'Bbmaj7' } },
                { from: { root: 0, type: 'dom7', name: 'C7' }, to: { root: 5, type: 'maj7', name: 'Fmaj7' } }
            ]
        };

        // Get guide tones (3rd and 7th) for a chord type
        function vlGetGuideTones(root, type) {
            if (type === 'm7') return [(root + 3) % 12, (root + 10) % 12]; // b3, b7
            if (type === 'dom7') return [(root + 4) % 12, (root + 10) % 12]; // 3, b7
            if (type === 'maj7') return [(root + 4) % 12, (root + 11) % 12]; // 3, 7
            return [];
        }

        // Get shell voicing (root + 3rd + 7th)
        function vlGetShellNotes(root, type) {
            const tones = vlGetGuideTones(root, type);
            return [root, ...tones];
        }

        // Get valid intervals for a chord type (like freestyle mode)
        function vlGetValidIntervals(type) {
            // Common to all: root, 5th, 9th, 11th, 13th
            const base = new Set([0, 7, 2, 5, 9]);

            if (type === 'maj7') {
                base.add(4);  // major 3rd
                base.add(11); // major 7th
                base.add(6);  // #11 (common on maj7)
                return base;
            }
            if (type === 'm7') {
                base.add(3);  // minor 3rd
                base.add(10); // minor 7th
                return base;
            }
            if (type === 'dom7') {
                base.add(4);  // major 3rd
                base.add(10); // minor 7th
                base.add(1);  // b9
                base.add(3);  // #9
                base.add(6);  // #11
                base.add(8);  // b13
                return base;
            }
            return base;
        }

        // Validate voicing - requires guide tones, allows extensions (like freestyle)
        function vlIsValidVoicing(heldPitchClasses, root, type, requiredNotes) {
            // Must have all required notes (guide tones)
            for (const pc of requiredNotes) {
                if (!heldPitchClasses.has(pc)) return false;
            }

            // Check that all held notes are valid for this chord type
            const validIntervals = vlGetValidIntervals(type);
            for (const pc of heldPitchClasses) {
                const interval = (pc - root + 12) % 12;
                if (!validIntervals.has(interval)) return false;
            }

            return true;
        }

        // Analyze voice leading between two chords
        function vlAnalyzeVoiceLeading(from, to, voicingType) {
            const fromTones = voicingType === 'guide' ? vlGetGuideTones(from.root, from.type) : vlGetShellNotes(from.root, from.type);
            const toTones = voicingType === 'guide' ? vlGetGuideTones(to.root, to.type) : vlGetShellNotes(to.root, to.type);

            const common = [];
            const resolutions = [];

            fromTones.forEach(pc => {
                if (toTones.includes(pc)) {
                    common.push(NOTE_NAMES[pc]);
                } else {
                    // Find where this note moves to
                    const diffs = toTones.map(t => {
                        let diff = (t - pc + 12) % 12;
                        if (diff > 6) diff = diff - 12; // Get shortest distance
                        return { target: t, diff: diff };
                    });
                    // Find closest target
                    const closest = diffs.reduce((a, b) => Math.abs(a.diff) < Math.abs(b.diff) ? a : b);
                    const direction = closest.diff > 0 ? 'up' : 'down';
                    const steps = Math.abs(closest.diff);
                    const stepName = steps === 1 ? '½ step' : steps === 2 ? 'whole step' : `${steps} semitones`;
                    resolutions.push(`${NOTE_NAMES[pc]} → ${NOTE_NAMES[closest.target]} (${stepName} ${direction})`);
                }
            });

            return { common, resolutions, fromNotes: fromTones, toNotes: toTones };
        }

        function vlStartGame() {
            vl_isPlaying = true;
            vl_round = 0;
            vl_mistakes = 0;
            vl_firstTryCount = 0;
            vl_responseTimes = [];
            vl_heldNotes.clear();
            vl_waitingForRelease = false;

            vl_totalRounds = parseInt(document.getElementById('vl_roundsSelect').value);
            document.getElementById('vl_totalRounds').textContent = vl_totalRounds;

            // Update button
            const startBtn = document.getElementById('vl_startBtn');
            startBtn.textContent = 'Stop';
            startBtn.onclick = vlStopGame;
            startBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            startBtn.classList.add('bg-slate-600', 'hover:bg-slate-500');

            // Hide settings, show challenge
            document.getElementById('vl_settingsPanel').classList.add('hidden');
            document.getElementById('vl_completeDisplay').classList.add('hidden');
            document.getElementById('vl_challengeDisplay').classList.remove('hidden');

            // Reset stats display
            document.getElementById('vl_roundDisplay').textContent = '0';
            document.getElementById('vl_firstTry').textContent = '0%';
            document.getElementById('vl_mistakes').textContent = '0';

            vlRunCountdown(3);
        }

        function vlRunCountdown(count) {
            if (!vl_isPlaying) return;
            const targetChord = document.getElementById('vl_targetChord');
            const sourceChord = document.getElementById('vl_sourceChord');
            sourceChord.textContent = '';
            document.getElementById('vl_sourceNotes').textContent = '';
            document.getElementById('vl_targetHint').textContent = '';
            document.getElementById('vl_feedbackText').textContent = '';
            document.getElementById('vl_commonTones').querySelector('p:last-child').textContent = '';
            document.getElementById('vl_resolutions').querySelector('p:last-child').textContent = '';

            if (count > 0) {
                targetChord.textContent = count;
                setTimeout(() => vlRunCountdown(count - 1), 800);
            } else {
                vlNextChallenge();
            }
        }

        function vlStopGame() {
            vl_isPlaying = false;
            vl_challenge = null;
            vl_heldNotes.clear();

            const startBtn = document.getElementById('vl_startBtn');
            startBtn.textContent = 'Start Game';
            startBtn.onclick = vlStartGame;
            startBtn.classList.remove('bg-slate-600', 'hover:bg-slate-500');
            startBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            document.getElementById('vl_settingsPanel').classList.remove('hidden');
            document.getElementById('vl_challengeDisplay').classList.add('hidden');

            // Clear piano highlights
            vl_heldNotes.forEach(n => highlightKey('vl_pianoSvg', n, 'key-active', false));
        }

        function vlNextChallenge() {
            if (!vl_isPlaying) return;

            vl_round++;
            vl_firstTryThisRound = true;
            vl_phase = 'source'; // Start with source chord
            document.getElementById('vl_roundDisplay').textContent = vl_round;

            if (vl_round > vl_totalRounds) {
                vlEndGame();
                return;
            }

            // Get progression type
            const progType = document.getElementById('vl_progressionSelect').value;
            const voicingType = document.getElementById('vl_voicingSelect').value;

            // Choose a random progression
            let progressions;
            if (progType === 'iiV') {
                progressions = VL_PROGRESSIONS['ii-V'];
            } else if (progType === 'VI') {
                progressions = VL_PROGRESSIONS['V-I'];
            } else {
                // Random or iiVI - mix both
                progressions = [...VL_PROGRESSIONS['ii-V'], ...VL_PROGRESSIONS['V-I']];
            }

            const prog = progressions[Math.floor(Math.random() * progressions.length)];
            const analysis = vlAnalyzeVoiceLeading(prog.from, prog.to, voicingType);

            vl_challenge = {
                sourceChord: prog.from,
                targetChord: prog.to,
                sourceNotes: analysis.fromNotes,
                targetNotes: analysis.toNotes,
                common: analysis.common,
                resolutions: analysis.resolutions,
                voicingType: voicingType
            };

            // Update UI for source phase
            vlUpdatePhaseDisplay();
            vl_challengeStartTime = Date.now();
        }

        function vlUpdatePhaseDisplay() {
            const sourceBox = document.getElementById('vl_sourceBox');
            const targetBox = document.getElementById('vl_targetBox');
            const showAnalysis = document.getElementById('vl_showAnalysis').checked;

            // Display chord names
            document.getElementById('vl_sourceChord').textContent = vl_challenge.sourceChord.name;
            document.getElementById('vl_targetChord').textContent = vl_challenge.targetChord.name;

            if (vl_phase === 'source') {
                // Highlight source box, dim target
                sourceBox.classList.add('border-2', 'border-blue-500');
                sourceBox.classList.remove('opacity-50');
                targetBox.classList.remove('border-2', 'border-blue-500');
                targetBox.classList.add('opacity-50');

                // Show source notes as hint (blue text)
                const sourceNotesEl = document.getElementById('vl_sourceNotes');
                sourceNotesEl.className = 'text-lg text-blue-400';
                if (showAnalysis) {
                    sourceNotesEl.textContent = 'Play: ' + vl_challenge.sourceNotes.map(pc => NOTE_NAMES[pc]).join(' ');
                } else {
                    sourceNotesEl.textContent = 'Play the chord';
                }
                document.getElementById('vl_targetHint').textContent = '';

                // Hide analysis until target phase
                document.getElementById('vl_analysisPanel').classList.add('hidden');
            } else {
                // Highlight target box, show source as completed
                sourceBox.classList.remove('border-2', 'border-blue-500');
                sourceBox.classList.add('opacity-50');
                targetBox.classList.add('border-2', 'border-blue-500');
                targetBox.classList.remove('opacity-50');

                // Show what was played for source (green checkmark)
                document.getElementById('vl_sourceNotes').textContent = '✓ ' + vl_challenge.sourceNotes.map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('vl_sourceNotes').className = 'text-lg text-green-400';

                // Show analysis and target hint
                if (showAnalysis) {
                    document.getElementById('vl_analysisPanel').classList.remove('hidden');
                    document.getElementById('vl_commonTones').querySelector('p:last-child').textContent =
                        vl_challenge.common.length > 0 ? vl_challenge.common.join(', ') + ' stays' : 'No common tones';
                    document.getElementById('vl_resolutions').querySelector('p:last-child').textContent =
                        vl_challenge.resolutions.length > 0 ? vl_challenge.resolutions.join(', ') : 'All common!';
                    document.getElementById('vl_targetHint').textContent = 'Play: ' + vl_challenge.targetNotes.map(pc => NOTE_NAMES[pc]).join(' ');
                } else {
                    document.getElementById('vl_analysisPanel').classList.add('hidden');
                    document.getElementById('vl_targetHint').textContent = 'Now transition...';
                }
            }

            document.getElementById('vl_feedbackText').textContent = '';
        }

        function vlOnNoteOn(midi) {
            if (!vl_isPlaying || !vl_challenge || !vl_challengeStartTime) return;
            if (vl_waitingForRelease) return;

            vl_heldNotes.add(midi);
            highlightKey('vl_pianoSvg', midi, 'key-active', true);

            const heldPitchClasses = new Set([...vl_heldNotes].map(n => n % 12));

            if (vl_phase === 'source') {
                // Validate source chord - requires guide tones, allows extensions
                const chord = vl_challenge.sourceChord;
                const requiredNotes = new Set(vl_challenge.sourceNotes);
                const isValid = vlIsValidVoicing(heldPitchClasses, chord.root, chord.type, requiredNotes);

                // Check for wrong notes (not valid for this chord)
                const validIntervals = vlGetValidIntervals(chord.type);
                const hasWrongNote = [...heldPitchClasses].some(pc => {
                    const interval = (pc - chord.root + 12) % 12;
                    return !validIntervals.has(interval);
                });

                if (isValid) {
                    // Source chord correct! Move to target phase
                    document.getElementById('vl_feedbackText').textContent = '✓ Good!';
                    document.getElementById('vl_feedbackText').className = 'text-lg font-semibold text-center h-7 mb-4 text-green-400';
                    vl_waitingForRelease = 'toTarget'; // Special flag: transition to target after release
                } else if (hasWrongNote) {
                    // Wrong note for this chord
                    vl_mistakes++;
                    vl_firstTryThisRound = false;
                    document.getElementById('vl_mistakes').textContent = vl_mistakes;
                    document.getElementById('vl_feedbackText').textContent = '✗ Wrong note';
                    document.getElementById('vl_feedbackText').className = 'text-lg font-semibold text-center h-7 mb-4 text-red-400';
                }
            } else {
                // Target phase - validate target chord
                const chord = vl_challenge.targetChord;
                const requiredNotes = new Set(vl_challenge.targetNotes);
                const isValid = vlIsValidVoicing(heldPitchClasses, chord.root, chord.type, requiredNotes);

                // Check for wrong notes
                const validIntervals = vlGetValidIntervals(chord.type);
                const hasWrongNote = [...heldPitchClasses].some(pc => {
                    const interval = (pc - chord.root + 12) % 12;
                    return !validIntervals.has(interval);
                });

                if (isValid) {
                    // Target chord correct! Round complete
                    const responseTime = Date.now() - vl_challengeStartTime;
                    vl_responseTimes.push(responseTime);

                    if (vl_firstTryThisRound) {
                        vl_firstTryCount++;
                    }

                    // Update first try percentage
                    const firstTryPct = Math.round((vl_firstTryCount / vl_round) * 100);
                    document.getElementById('vl_firstTry').textContent = `${firstTryPct}%`;

                    // Show feedback
                    document.getElementById('vl_feedbackText').textContent = '✓ Voice leading complete!';
                    document.getElementById('vl_feedbackText').className = 'text-lg font-semibold text-center h-7 mb-4 text-green-400';

                    // Wait for release before next challenge
                    vl_waitingForRelease = 'toNext'; // Special flag: go to next challenge after release
                } else if (hasWrongNote) {
                    // Wrong note
                    vl_mistakes++;
                    vl_firstTryThisRound = false;
                    document.getElementById('vl_mistakes').textContent = vl_mistakes;
                    document.getElementById('vl_feedbackText').textContent = '✗ Wrong note';
                    document.getElementById('vl_feedbackText').className = 'text-lg font-semibold text-center h-7 mb-4 text-red-400';
                }
            }
        }

        function vlOnNoteOff(midi) {
            vl_heldNotes.delete(midi);
            highlightKey('vl_pianoSvg', midi, 'key-active', false);

            if (vl_waitingForRelease && vl_heldNotes.size === 0) {
                const action = vl_waitingForRelease;
                vl_waitingForRelease = false;

                if (action === 'toTarget') {
                    // Just completed source, now show target phase
                    vl_phase = 'target';
                    vlUpdatePhaseDisplay();
                } else if (action === 'toNext') {
                    // Completed target, move to next challenge
                    setTimeout(() => vlNextChallenge(), 300);
                }
            }
        }

        function vlEndGame() {
            vl_isPlaying = false;

            const avgTime = vl_responseTimes.length > 0 ?
                vl_responseTimes.reduce((a, b) => a + b, 0) / vl_responseTimes.length : 0;
            const firstTryPct = Math.round((vl_firstTryCount / vl_totalRounds) * 100);

            // Update complete display
            document.getElementById('vl_finalRounds').textContent = vl_totalRounds;
            document.getElementById('vl_finalAvgTime').textContent = (avgTime / 1000).toFixed(1) + 's';
            document.getElementById('vl_finalFirstTry').textContent = `${firstTryPct}%`;
            document.getElementById('vl_finalMistakes').textContent = vl_mistakes;

            // Show complete display
            document.getElementById('vl_challengeDisplay').classList.add('hidden');
            document.getElementById('vl_completeDisplay').classList.remove('hidden');
            document.getElementById('vl_settingsPanel').classList.remove('hidden');

            // Update button
            const startBtn = document.getElementById('vl_startBtn');
            startBtn.textContent = 'Play Again';
            startBtn.onclick = vlStartGame;
            startBtn.classList.remove('bg-slate-600', 'hover:bg-slate-500');
            startBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Save history
            const historyEntry = {
                date: new Date().toISOString(),
                rounds: vl_totalRounds,
                avgTime: avgTime,
                firstTryPct: firstTryPct,
                mistakes: vl_mistakes,
                config: {
                    progression: document.getElementById('vl_progressionSelect').value,
                    voicing: document.getElementById('vl_voicingSelect').value
                }
            };

            let history = JSON.parse(localStorage.getItem('vl_history') || '[]');
            history.unshift(historyEntry);
            history = history.slice(0, 20);
            localStorage.setItem('vl_history', JSON.stringify(history));

            vlRenderHistory();
        }

        function vlLoadHistory() {
            vlRenderHistory();
        }

        function vlRenderHistory() {
            const content = document.getElementById('vl_historyContent');
            let history = JSON.parse(localStorage.getItem('vl_history') || '[]');

            if (history.length === 0) {
                content.innerHTML = '<p class="text-slate-500 text-sm">No practice history yet. Complete a run to see your results here.</p>';
                return;
            }

            const medals = getMedals(history, 'firstTryPct', 'avgTime');

            let html = '<div class="flex justify-between items-center mb-3"><h2 class="text-xl font-semibold text-white">Practice History</h2>';
            html += '<button onclick="vlClearHistory()" class="text-xs text-slate-500 hover:text-red-400 transition">Clear History</button></div>';
            html += '<div class="space-y-1">';

            history.forEach((game, idx) => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const avgTimeStr = (game.avgTime / 1000).toFixed(1) + 's';
                const medal = medals[idx] || '';
                const rowClass = idx % 2 === 0 ? 'bg-slate-700/30' : '';

                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-purple-400 ml-2">${game.config?.progression || ''} ${game.config?.voicing || ''}</span></div>
                    <div><span class="font-bold ${game.firstTryPct >= 80 ? 'text-green-400' : game.firstTryPct >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.firstTryPct}%</span>
                    <span class="text-slate-500 text-xs ml-1">(${avgTimeStr})</span>
                    <span class="text-red-400 text-xs ml-1">${game.mistakes}m</span>
                    ${medal ? `<span class="ml-1">${medal}</span>` : ''}</div>
                </div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function vlClearHistory() {
            if (confirm('Clear all voice leading practice history?')) {
                localStorage.removeItem('vl_history');
                vlRenderHistory();
            }
        }

        // ============ INIT ============
        drawPiano('previewPianoSvg');
        drawPiano('pianoSvg');
        drawPiano('ch_pianoSvg');
        drawPiano('iivi_pianoSvg');
        drawPiano('sc_pianoSvg');
        drawPiano('ext_pianoSvg');
        drawPiano('alt_pianoSvg');
        drawPiano('adv_pianoSvg');
        drawPiano('miivi_pianoSvg');
        drawPiano('kb_pianoSvg');
        drawPiano('jtou_pianoSvg');
        drawPiano('dom7v_pianoSvg');
        drawPiano('extv_pianoSvg');
        drawPiano('pent_pianoSvg');
        drawPiano('bebop_pianoSvg');
        drawPiano('tritone_pianoSvg');
        drawPiano('shell_pianoSvg');
        drawPiano('upper_pianoSvg');
        drawPiano('freestyle_pianoSvg');
        drawPiano('attya_pianoSvg');
        drawPiano('vl_pianoSvg');
        attyaRenderChartGrid();
        initMIDI();
        intLoadHistory();
        chLoadHistory();
        document.getElementById('ch_handsSelect').addEventListener('change', function() {
            const hint = document.getElementById('ch_settingsHint');
            if (this.value === 'two') {
                hint.innerText = 'Play the chord in two separate octaves (8 notes total). Same chord, both hands.';
            } else {
                hint.innerText = 'Play all 4 notes of the chord (any octave, any voicing). Root + 3rd + 5th + 7th.';
            }
        });
        iiviLoadHistory();
        scLoadHistory();
        extLoadHistory();
        altLoadHistory();
        advLoadHistory();
        miiviLoadHistory();
        kbLoadHistory();
        jtouLoadHistory();
        dom7vLoadHistory();
        extvLoadHistory();
        pentLoadHistory();
        bebopLoadHistory();
        tritoneLoadHistory();
        shellLoadHistory();
        upperLoadHistory();
        freestyleLoadHistory();
        attyaLoadHistory();
        vlLoadHistory();
        loadAllSettings();
        // Show breakdown sections with cumulative stats on page load
        intShowBreakdown();
        chShowBreakdown();
        iiviShowBreakdown();
        scShowBreakdown();
        extShowBreakdown();
        altShowBreakdown();
        advShowBreakdown();
        miiviShowBreakdown();
        kbShowBreakdown();
        jtouShowBreakdown();
        dom7vShowBreakdown();
        extvShowBreakdown();
        pentShowBreakdown();
        bebopShowBreakdown();
        tritoneShowBreakdown();
        shellShowBreakdown();
        upperShowBreakdown();
        freestyleShowBreakdown();
        // Load chord identifier preference
        const savedChordIdPref = localStorage.getItem('chordIdentifierEnabled');
        if (savedChordIdPref === 'false') {
            chordIdentifierEnabled = false;
            document.getElementById('chordIdentifier').classList.add('hidden');
            document.getElementById('chordIdentifierShowBtn').classList.remove('hidden');
        }
        document.getElementById('jtou_voicingSelect').addEventListener('change', function() {
            const hint = document.getElementById('jtou_settingsHint');
            if (this.value === 'no5') {
                hint.innerText = 'V chord has no 5th (4 notes: R-3-b7-#9). In Fm: Dbmaj9 → C7#9 (C-E-Bb-Eb) → Fm9';
            } else {
                hint.innerText = 'The classic Grover Washington Jr. / Bill Withers progression. In Fm: Dbmaj9 → C7#9 → Fm9';
            }
        });
        window.addEventListener('resize', () => { drawPiano('previewPianoSvg'); drawPiano('pianoSvg'); drawPiano('ch_pianoSvg'); drawPiano('iivi_pianoSvg'); drawPiano('sc_pianoSvg'); drawPiano('ext_pianoSvg'); drawPiano('alt_pianoSvg'); drawPiano('adv_pianoSvg'); drawPiano('miivi_pianoSvg'); drawPiano('kb_pianoSvg'); drawPiano('jtou_pianoSvg'); drawPiano('dom7v_pianoSvg'); drawPiano('extv_pianoSvg'); drawPiano('pent_pianoSvg'); drawPiano('bebop_pianoSvg'); drawPiano('tritone_pianoSvg'); drawPiano('shell_pianoSvg'); drawPiano('upper_pianoSvg'); drawPiano('freestyle_pianoSvg'); drawPiano('attya_pianoSvg'); drawPiano('vl_pianoSvg'); });
    </script>
</body>
</html>
