<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Piano Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .key { transition: all 0.1s; }
        .key-white { fill: white; stroke: black; stroke-width: 1px; }
        .key-black { fill: black; stroke: black; stroke-width: 1px; }
        .key-active { fill: #4ade80 !important; }
        .key-wrong { fill: #f87171 !important; }
        .key-start { fill: #60a5fa !important; }
        .key-held { fill: #a78bfa !important; }

        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        .feedback-anim { animation: float-up 1s ease-out forwards; }

        .timer-fast { color: #4ade80; }
        .timer-medium { color: #facc15; }
        .timer-slow { color: #f87171; }

        .mode-btn.active { background-color: #2563eb; color: white; }
        .mode-btn:not(.active):not(:disabled) { background-color: #334155; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans">

    <div class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Header -->
        <header class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white">Jazz Piano Tutor</h1>
            </div>
            <div class="flex items-center gap-3">
                <!-- Collapsed MIDI settings (shown when connected) -->
                <button id="midiSettingsBtn" onclick="toggleMidiSettings()" class="hidden flex items-center gap-2 px-3 py-1 rounded bg-slate-700 hover:bg-slate-600 text-sm transition">
                    <span class="text-slate-400">MIDI:</span>
                    <span id="midiDeviceName" class="text-green-400 font-mono truncate max-w-32"></span>
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="flex items-center gap-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span id="connectionText" class="text-sm font-mono">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- MIDI Connectivity -->
        <div id="midiSection" class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Connect MIDI</h2>
                <button id="midiCollapseBtn" onclick="collapseMidiSettings()" class="hidden flex items-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 hover:text-white text-sm font-medium transition">
                    <span>Close</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">MIDI Input</label>
                    <select id="midiInputSelect" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Input Device</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-2">MIDI Output (optional)</label>
                    <select id="midiOutputSelect" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Output Device</option>
                    </select>
                </div>
            </div>
            <p id="midiHint" class="text-xs text-slate-500 mt-3">Select your MIDI keyboard to start practicing.</p>

            <!-- Preview Piano (hidden by default since mode panels have pianos) -->
            <div id="previewPiano" class="hidden mt-6 pt-6 border-t border-slate-700">
                <p class="text-sm text-slate-400 mb-2">Test your keyboard:</p>
                <div class="w-full overflow-x-auto bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="previewPianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>
            </div>
        </div>

        <!-- Practice Mode Selection -->
        <div id="practiceSection" class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg">
            <div class="flex items-center gap-2 mb-3">
                <h2 class="text-xl font-semibold text-white">Practice Mode</h2>
                <button onclick="document.getElementById('modeInfoModal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition" title="About practice modes">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button id="intervalsMode" onclick="switchMode('intervals')" title="Start here! Learn to quickly identify and play intervals (half steps, whole steps, 3rds, 5ths, etc.)" class="mode-btn active px-4 py-2 rounded text-sm font-semibold transition">
                    1. Intervals
                </button>
                <button id="chordsMode" onclick="switchMode('chords')" title="Build on intervals: play maj7, min7, and dom7 chords quickly in any key" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    2. 7th Chords
                </button>
                <button id="iiviMode" onclick="switchMode('iivi')" title="The most important jazz progression: play ii-V-I in all 12 keys with various voicings" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    3. ii-V-I
                </button>
                <button id="minorIiviMode" onclick="switchMode('minorIivi')" title="Minor key version: iiø7 - V7 - imM7 progression in all 12 minor keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    4. Minor ii-V-i
                </button>
                <button id="dom7vMode" onclick="switchMode('dom7v')" title="Rootless Type A/B voicings (3-5-7-9 and 7-9-3-5) for Maj7, Min7, and Dom7 chords in all 12 keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    5. Rootless
                </button>
                <button id="extvMode" onclick="switchMode('extv')" title="Extended voicings: Maj6/9, Min6/9, and Dom13 in all 12 keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    6. Extended
                </button>
                <button id="r251Mode" onclick="switchMode('r251')" title="Rootless ii-V-I with voice leading: Type A → Type B → Type A" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    7. Rootless ii-V-I
                </button>
                <button id="extMode" onclick="switchMode('ext')" title="Add color: practice 9th, 11th, and 13th extensions on 7th chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    8. Extensions
                </button>
                <button id="altMode" onclick="switchMode('alt')" title="Advanced harmony: practice altered tensions (b9, #9, #11, b13) on dominant chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    9. Altered
                </button>
                <button id="advMode" onclick="switchMode('adv')" title="Beyond basics: half-diminished, diminished 7th, minor-major 7th, and augmented chords" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    10. Adv Chords
                </button>
                <button id="kbMode" onclick="switchMode('kb')" title="Kenny Barron's signature voicing: stacked 5ths between hands for rich minor 11 and maj7#11 sounds" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    11. Kenny Barron
                </button>
                <button id="jtouMode" onclick="switchMode('jtou')" title="Classic progression from 'Just the Two of Us': bVImaj7 - V7#9 - im7 in all minor keys" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    12. JTOU
                </button>
                <button id="scalesMode" onclick="switchMode('scales')" title="Learn scales that work over each chord type using the chord tone + whole step approach" class="mode-btn px-4 py-2 rounded text-sm font-semibold transition">
                    13. Jazz Scales
                </button>
            </div>
        </div>

        <!-- Mode Info Modal -->
        <div id="modeInfoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target === this) this.classList.add('hidden')">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Practice Modes</h3>
                    <button onclick="document.getElementById('modeInfoModal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="text-sm text-slate-300 space-y-4">
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Foundations</div>
                        <p><strong>1-2:</strong> Intervals and 7th chords - the building blocks</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Progressions</div>
                        <p><strong>3-4:</strong> ii-V-I in major and minor keys - the essential jazz movements</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Voicings</div>
                        <p><strong>5-7:</strong> Rootless voicings (Type A/B), extended voicings (6/9, 13), and voice-led progressions</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Color Tones</div>
                        <p><strong>8-9:</strong> Extensions (9, 11, 13) and alterations (b9, #9, #11, b13)</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Advanced</div>
                        <p><strong>10-11:</strong> Half-dim, dim, minMaj7 chords and Kenny Barron's stacked-5ths voicing</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Repertoire</div>
                        <p><strong>12:</strong> "Just the Two of Us" progression (bVImaj7 - V7#9 - im7)</p>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Scales</div>
                        <p><strong>13:</strong> Jazz scales that work over each chord type</p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-4">Hover over any mode button for a description.</p>
            </div>
        </div>

        <!-- ==================== INTERVALS MODE ==================== -->
        <div id="intervalsPanel" class="mode-panel">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Interval Practice</h2>
                        <p class="text-sm text-slate-400">"What's a <span class="text-blue-400">fifth</span> above <span class="text-blue-400">Db</span>?" — Answer in under 2 seconds!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="int_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="int_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-2">Intervals to Practice:</label>
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="1" checked><span>Half step</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="2" checked><span>Whole step</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="3" checked><span>Minor 3rd</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="4" checked><span>Major 3rd</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="5" checked><span>Perfect 4th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="6" checked><span>Tritone</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="7" checked><span>Perfect 5th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="8" checked><span>Minor 6th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="9" checked><span>Major 6th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="10" checked><span>Minor 7th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="11" checked><span>Major 7th</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="int-interval-cb mr-2" value="12" checked><span>Octave</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Direction:</label>
                            <select id="int_directionSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="up">Up only</option>
                                <option value="down">Down only</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="int_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Quick select:</label>
                            <div class="flex gap-2">
                                <button onclick="intSelectIntervals('all')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">All</button>
                                <button onclick="intSelectIntervals('thirds')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">3rds & 5ths</button>
                                <button onclick="intSelectIntervals('none')" class="px-3 py-2 rounded bg-slate-700 text-slate-300 text-xs hover:bg-slate-600">None</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Challenge Display -->
                <div id="int_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Find the note that is a...</p>
                    <p class="text-4xl font-bold mb-2">
                        <span id="int_intervalName" class="text-blue-400">Perfect 5th</span>
                        <span id="int_directionText" class="text-slate-300">above</span>
                    </p>
                    <p class="text-5xl font-bold text-white" id="int_startNote">C</p>
                </div>

                <!-- Game Complete Display -->
                <div id="int_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="int_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="int_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="int_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="int_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="int_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="int_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="int_startBtn" onclick="intStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="int_stopBtn" onclick="intStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="int_playAgainBtn" onclick="intPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="int_newGameBtn" onclick="intNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="int_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="int_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="int_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="int_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="int_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="int_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="intClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="int_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="int_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Interval Breakdown</h2>
                <div id="int_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== 7TH CHORDS MODE ==================== -->
        <div id="chordsPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">7th Chord Practice</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">F minor 7</span> — Answer in under 2 seconds!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="ch_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="ch_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-2">Chord Types to Practice:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="maj7" checked><span>Major 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="min7" checked><span>Minor 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="ch-type-cb mr-2" value="dom7" checked><span>Dominant 7</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="ch_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="36">36 (all chords)</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Hands:</label>
                            <select id="ch_handsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="one" selected>One Hand</option>
                                <option value="two">Two Hands</option>
                            </select>
                        </div>
                    </div>
                    <p id="ch_settingsHint" class="text-xs text-slate-500 mt-3">Play all 4 notes of the chord (any octave, any voicing). Root + 3rd + 5th + 7th.</p>
                </div>

                <!-- Challenge Display -->
                <div id="ch_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2">
                        <span id="ch_chordRoot" class="text-blue-400">C</span>
                        <span id="ch_chordType">maj7</span>
                    </p>
                    <p id="ch_twoHandsIndicator" class="text-sm text-purple-400 hidden">Two Hands (2 octaves)</p>
                    <p id="ch_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="ch_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="ch_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="ch_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="ch_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="ch_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="ch_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="ch_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano (shared, but we'll use same SVG) -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="ch_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="ch_startBtn" onclick="chStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="ch_stopBtn" onclick="chStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="ch_playAgainBtn" onclick="chPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="ch_newGameBtn" onclick="chNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="ch_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="ch_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="ch_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="ch_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="ch_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="ch_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="chClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="ch_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="ch_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="ch_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== ii-V-I MODE ==================== -->
        <div id="iiviPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">ii-V-I Practice</h2>
                        <p class="text-sm text-slate-400">Play the <span class="text-blue-400">ii-V-I</span> progression in any key — under 2 seconds per chord!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="iivi_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="iivi_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="iivi_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full">Full Chords — R-3-5-7 (4 notes)</option>
                                <option value="shell">Shell Voicings — 3rd + 7th only (2 notes)</option>
                                <option value="rootless">Rootless — 3-5-7-9, no root (4 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="iivi_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12 (all keys)</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                    </div>
                    <p id="iivi_settingsHint" class="text-xs text-slate-500 mt-3">Play ii → V → I in sequence. Each chord needs all 4 notes (any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="iivi_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="iivi_challengeLabel" class="text-slate-400 mb-2">ii-V-I in the key of</p>
                    <p class="text-5xl font-bold text-white mb-4" id="iivi_keyDisplay">C</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="iivi_step_ii" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_ii" class="text-lg font-bold">Dm7</span>
                                <span id="iivi_shell_ii" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">ii</span>
                            <div id="iivi_time_ii" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="iivi_step_V" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_V" class="text-lg font-bold">G7</span>
                                <span id="iivi_shell_V" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">V</span>
                            <div id="iivi_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="iivi_step_I" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="iivi_chord_I" class="text-lg font-bold">Cmaj7</span>
                                <span id="iivi_shell_I" class="text-xs text-blue-400 hidden"></span>
                            </div>
                            <span class="text-xs text-slate-400">I</span>
                            <div id="iivi_time_I" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="iivi_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="iivi_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="iivi_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="iivi_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="iivi_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="iivi_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="iivi_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="iivi_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="iivi_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="iivi_startBtn" onclick="iiviStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="iivi_stopBtn" onclick="iiviStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="iivi_playAgainBtn" onclick="iiviPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="iivi_newGameBtn" onclick="iiviNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="iivi_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="iivi_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Chords: <span id="iivi_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="iivi_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="iivi_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="iivi_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="iiviClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="iivi_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="iivi_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="iivi_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== JAZZ SCALES MODE ==================== -->
        <div id="scalesPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Jazz Scales</h2>
                        <p class="text-sm text-slate-400">Play scales using the <span class="text-blue-400">chord tone + whole step</span> principle</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="sc_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="sc_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Types:</label>
                            <select id="sc_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only (Lydian)</option>
                                <option value="min7">Minor 7 only (Dorian)</option>
                                <option value="dom7">Dominant 7 only (Lydian Dom)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="sc_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="sc_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="sc_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Play 7 notes ascending: chord tones (1-3-5-7) + whole step above root, 3rd, and 5th.</p>
                </div>

                <!-- Challenge Display -->
                <div id="sc_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the scale for</p>
                    <p class="text-5xl font-bold text-white mb-2" id="sc_chordDisplay">C maj7</p>
                    <p class="text-2xl text-blue-400 mb-4" id="sc_scaleNameDisplay">Lydian</p>

                    <!-- Scale progress indicator -->
                    <div class="flex justify-center items-center gap-2 mb-4" id="sc_noteProgress">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_0"><span class="sc-hint">1</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_1"><span class="sc-hint">2</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_2"><span class="sc-hint">3</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_3"><span class="sc-hint">#4</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_4"><span class="sc-hint">5</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_5"><span class="sc-hint">6</span></div>
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600" id="sc_note_6"><span class="sc-hint">7</span></div>
                    </div>

                    <p id="sc_expectedNote" class="text-sm text-slate-400 sc-hint">Next: <span class="text-white font-bold" id="sc_expectedNoteValue">C</span></p>
                </div>

                <!-- Game Complete Display -->
                <div id="sc_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="sc_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="sc_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="sc_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="sc_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per scale</p>
                        </div>
                    </div>
                    <div id="sc_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="sc_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="sc_startBtn" onclick="scStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="sc_stopBtn" onclick="scStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="sc_playAgainBtn" onclick="scPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="sc_newGameBtn" onclick="scNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="sc_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="sc_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Notes: <span id="sc_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="sc_mistakesDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="sc_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="scClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="sc_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="sc_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Scale Breakdown</h2>
                <div id="sc_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ EXTENSIONS MODE PANEL ============ -->
        <div id="extPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Chord Extensions</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">extended chords</span>: 9ths, 11ths, and 13ths</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="ext_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="ext_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Base Chord:</label>
                            <select id="ext_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Extension:</label>
                            <select id="ext_extensionSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Extensions</option>
                                <option value="9">9th only (5 notes)</option>
                                <option value="11">11th only (6 notes)</option>
                                <option value="13">13th only (7 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="ext_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="ext_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="ext_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Extensions add color tones above the 7th: 9 = +2, 11 = +5, 13 = +9 from root.</p>
                </div>

                <!-- Challenge Display -->
                <div id="ext_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play all notes of</p>
                    <p class="text-5xl font-bold text-white mb-2" id="ext_chordDisplay">Cmaj9</p>
                    <p class="text-sm text-slate-400 mb-4" id="ext_formulaLine">
                        <span id="ext_noteCount" class="text-blue-400 font-bold">5</span> notes<span id="ext_formulaHint">: <span id="ext_formulaDisplay" class="text-slate-300">1 - 3 - 5 - 7 - 9</span></span>
                    </p>
                    <div class="flex justify-center gap-2 flex-wrap" id="ext_noteIndicators">
                        <!-- Note indicators will be added dynamically -->
                    </div>
                </div>

                <!-- Game Complete Display -->
                <div id="ext_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="ext_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="ext_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="ext_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="ext_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="ext_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="ext_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="ext_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="ext_startBtn" onclick="extStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="ext_stopBtn" onclick="extStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="ext_playAgainBtn" onclick="extPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="ext_newGameBtn" onclick="extNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="ext_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="ext_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="ext_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="ext_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="ext_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="ext_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="extClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="ext_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="ext_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="ext_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ ALTERED EXTENSIONS MODE PANEL ============ -->
        <div id="altPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Altered Extensions</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-red-400">altered dominant</span> chords: b9, #9, #11, b13</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="alt_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="alt_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Alteration:</label>
                            <select id="alt_alterationSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all">All Alterations</option>
                                <option value="b9">b9 only</option>
                                <option value="#9">#9 only</option>
                                <option value="#11">#11 only</option>
                                <option value="b13">b13 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="alt_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full" selected>Full (stacked)</option>
                                <option value="simple">Simplified</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="alt_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                    </div>
                    <p id="alt_voicingHint" class="text-xs text-slate-500 mt-3">Full: #11 and b13 include the 9th (like extended chords). Simplified: only the altered note.</p>
                </div>

                <!-- Challenge Display -->
                <div id="alt_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play all notes of</p>
                    <p class="text-5xl font-bold text-white mb-2" id="alt_chordDisplay">C7b9</p>
                    <p class="text-sm text-slate-400 mb-4">
                        <span id="alt_noteCount" class="text-red-400 font-bold">5</span> notes:
                        <span id="alt_formulaDisplay" class="text-slate-300">1 - 3 - 5 - b7 - b9</span>
                    </p>
                    <div class="flex justify-center gap-2 flex-wrap" id="alt_noteIndicators">
                        <!-- Note indicators will be added dynamically -->
                    </div>
                </div>

                <!-- Game Complete Display -->
                <div id="alt_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="alt_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="alt_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="alt_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="alt_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="alt_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="alt_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="alt_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="alt_startBtn" onclick="altStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="alt_stopBtn" onclick="altStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="alt_playAgainBtn" onclick="altPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="alt_newGameBtn" onclick="altNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="alt_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="alt_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="alt_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="alt_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="alt_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="alt_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="altClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="alt_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="alt_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="alt_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ============ ADVANCED CHORDS MODE PANEL ============ -->
        <div id="advPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Advanced Chord Practice</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-blue-400">C half-dim</span> — Master all jazz chord types!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="adv_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="adv_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="mb-4">
                        <label class="text-sm text-slate-400 block mb-2">Chord Types to Practice:</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="halfdim" checked><span>Half-dim (ø7)</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dim7" checked><span>Dim 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="minMaj7" checked><span>Min-Maj 7</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="maj6" checked><span>Major 6</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="min6" checked><span>Minor 6</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom7sharp5" checked><span>7#5</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom13"><span>Dom 13</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" class="adv-type-cb mr-2" value="dom7alt"><span>7alt</span></label>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="adv_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="36">36</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="adv_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="adv_showHints" class="text-sm text-slate-400">Show hints</label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Play all notes of the chord (any octave, any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="adv_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this chord:</p>
                    <p class="text-5xl font-bold text-white mb-2">
                        <span id="adv_chordRoot" class="text-blue-400">C</span>
                        <span id="adv_chordType">ø7</span>
                    </p>
                    <p id="adv_chordFormula" class="text-sm text-slate-500 mb-2">R b3 b5 b7</p>
                    <p id="adv_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="adv_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="adv_finalScore" class="text-3xl font-bold text-white">0/20</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="adv_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="adv_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="adv_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">first-try only</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="adv_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="adv_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="adv_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="adv_startBtn" onclick="advStartGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="adv_stopBtn" onclick="advStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="adv_playAgainBtn" onclick="advPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="adv_newGameBtn" onclick="advNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="adv_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="adv_totalRoundsDisplay" class="font-mono text-slate-400">20</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="adv_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="adv_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="adv_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="adv_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="advClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="adv_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="adv_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Chord Breakdown</h2>
                <div id="adv_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== MINOR ii-V-i MODE ==================== -->
        <div id="minorIiviPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Minor ii-V-i Practice</h2>
                        <p class="text-sm text-slate-400">Play the <span class="text-purple-400">minor ii-V-i</span> progression — iiø7 → V7 → imM7</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="miivi_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="miivi_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="miivi_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12 (all keys)</option>
                                <option value="24">24</option>
                            </select>
                        </div>
                    </div>
                    <p id="miivi_settingsHint" class="text-xs text-slate-500 mt-3">Play iiø7 → V7 → imM7 in sequence. Each chord needs all 4 notes (any voicing).</p>
                </div>

                <!-- Challenge Display -->
                <div id="miivi_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="miivi_challengeLabel" class="text-slate-400 mb-2">Minor ii-V-i in</p>
                    <p class="text-5xl font-bold text-white mb-4" id="miivi_keyDisplay">C</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="miivi_step_ii" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_ii" class="text-lg font-bold">Dø7</span>
                            </div>
                            <span class="text-xs text-slate-400">iiø7</span>
                            <div id="miivi_time_ii" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="miivi_step_V" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_V" class="text-lg font-bold">G7</span>
                            </div>
                            <span class="text-xs text-slate-400">V7</span>
                            <div id="miivi_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="miivi_step_i" class="text-center">
                            <div class="w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="miivi_chord_i" class="text-lg font-bold">CmM7</span>
                            </div>
                            <span class="text-xs text-slate-400">imM7</span>
                            <div id="miivi_time_i" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="miivi_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="miivi_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="miivi_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="miivi_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="miivi_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="miivi_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="miivi_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="miivi_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="miivi_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="miivi_startBtn" onclick="miiviStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="miivi_stopBtn" onclick="miiviStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="miivi_playAgainBtn" onclick="miiviPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="miivi_newGameBtn" onclick="miiviNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="miivi_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="miivi_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Chords: <span id="miivi_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="miivi_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="miivi_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="miivi_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="miiviClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="miivi_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="miivi_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="miivi_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== KENNY BARRON MODE ==================== -->
        <div id="kbPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Kenny Barron Voicing</h2>
                        <p class="text-sm text-slate-400">Play the <span class="text-teal-400">Kenny Barron</span> voicing — stacked 5ths!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="kb_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="kb_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="kb_chordType" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="minor">Minor 11 only</option>
                                <option value="major">Major 7#11 only</option>
                                <option value="both" selected>Both (random)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="kb_voicingType" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="full" selected>Full (6 notes)</option>
                                <option value="sawnoff">Sawn-off (5 notes)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="kb_rounds" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="12" selected>12 (all keys)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="kb_showHints" class="w-4 h-4 rounded">
                                <span>Show hints</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-3">Left Hand: R-5-9 (stacked 5ths) | Right Hand: 3-7-11 (stacked 5ths, half step up)</p>
                </div>

                <!-- Challenge Display -->
                <div id="kb_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play this voicing:</p>
                    <p class="text-5xl font-bold text-teal-400 mb-4" id="kb_chordDisplay">Cm11</p>

                    <!-- Voicing Diagram -->
                    <div class="flex justify-center items-center gap-8 mb-4">
                        <div class="text-center">
                            <div class="w-24 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span class="text-xs text-slate-500">LEFT HAND</span>
                                <span id="kb_lhNotes" class="text-sm font-mono text-slate-300">R - 5 - 9</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-24 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span class="text-xs text-slate-500">RIGHT HAND</span>
                                <span id="kb_rhNotes" class="text-sm font-mono text-slate-300">b3 - b7 - 11</span>
                            </div>
                        </div>
                    </div>

                    <!-- Note Indicators -->
                    <div class="flex justify-center gap-2 mb-4">
                        <div id="kb_noteIndicators" class="flex gap-1"></div>
                    </div>

                    <p id="kb_heldNotes" class="text-sm text-slate-500">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="kb_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="kb_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="kb_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="kb_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="kb_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per voicing</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="kb_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="kb_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="kb_startBtn" onclick="kbStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="kb_stopBtn" onclick="kbStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="kb_playAgainBtn" onclick="kbPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="kb_newGameBtn" onclick="kbNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="kb_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="kb_totalRounds" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="kb_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="kb_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="kb_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="kb_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="kbClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="kb_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="kb_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="kb_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== JUST THE TWO OF US MODE ==================== -->
        <div id="jtouPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Just the Two of Us</h2>
                        <p class="text-sm text-slate-400">Play <span class="text-pink-400">bVImaj9 → V7#9 → im9</span> in every key!</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="jtou_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="jtou_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing:</label>
                            <select id="jtou_voicingSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="no5" selected>No 5th on V chord</option>
                                <option value="full">Full (with 5ths)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="jtou_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="12" selected>12 (all keys)</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
                                <input type="checkbox" id="jtou_showHints" class="w-4 h-4 rounded">
                                <span>Show hints</span>
                            </label>
                        </div>
                    </div>
                    <p id="jtou_settingsHint" class="text-xs text-slate-500 mt-3">The classic Grover Washington Jr. / Bill Withers progression. In Fm: Dbmaj9 → C7#9 → Fm9</p>
                </div>

                <!-- Challenge Display -->
                <div id="jtou_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p id="jtou_challengeLabel" class="text-slate-400 mb-2">Just the Two of Us in</p>
                    <p class="text-5xl font-bold text-white mb-4" id="jtou_keyDisplay">Fm</p>

                    <!-- Progression indicator -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="jtou_step_bVI" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_bVI" class="text-lg font-bold">Dbmaj7</span>
                                <span id="jtou_notes_bVI" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">bVImaj9</span>
                            <div id="jtou_time_bVI" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="jtou_step_V" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_V" class="text-lg font-bold">C7#9</span>
                                <span id="jtou_notes_V" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">V7#9</span>
                            <div id="jtou_time_V" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                        <div class="text-2xl text-slate-600">→</div>
                        <div id="jtou_step_i" class="text-center">
                            <div class="w-28 h-20 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600">
                                <span id="jtou_chord_i" class="text-lg font-bold">Fm7</span>
                                <span id="jtou_notes_i" class="text-xs text-pink-300"></span>
                            </div>
                            <span class="text-xs text-slate-400">im9</span>
                            <div id="jtou_time_i" class="text-xs text-slate-500 mt-1">--</div>
                        </div>
                    </div>

                    <p id="jtou_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="jtou_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="jtou_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="jtou_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="jtou_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="jtou_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="jtou_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                </div>

                <!-- Piano -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="jtou_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="jtou_startBtn" onclick="jtouStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="jtou_stopBtn" onclick="jtouStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="jtou_playAgainBtn" onclick="jtouPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="jtou_newGameBtn" onclick="jtouNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="jtou_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="jtou_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="jtou_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="jtou_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="jtou_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="jtou_feedbackArea" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="jtouClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="jtou_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="jtou_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Breakdown</h2>
                <div id="jtou_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== ROOTLESS VOICINGS MODE ==================== -->
        <div id="dom7vPanel" class="mode-panel hidden">
            <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-1">Rootless Voicings</h2>
                        <p class="text-sm text-slate-400">Type A voicing: <span class="text-orange-400">3rd - 5th - 7th - 9th</span> (no root)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Avg Time</p>
                        <p id="dom7v_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="dom7v_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="dom7v_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all" selected>All Types</option>
                                <option value="maj7">Major 7 only</option>
                                <option value="min7">Minor 7 only</option>
                                <option value="dom7">Dominant 7 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Voicing Type:</label>
                            <select id="dom7v_voicingTypeSelect" onchange="dom7vUpdateSettingsHint()" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="A" selected>Type A (3-5-7-9)</option>
                                <option value="B">Type B (7-9-3-5)</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="dom7v_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                                <option value="36">36</option>
                                <option value="72">72 (all keys x types x voicings)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="dom7v_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="dom7v_showHints" class="text-sm text-slate-400">Show note names</label>
                        </div>
                    </div>
                    <p id="dom7v_settingsHint" class="text-xs text-slate-500 mt-3">Type A: 3-5-7-9 (from bottom). Type B: 7-9-3-5 (inverted, voice-leads smoothly with A).</p>
                </div>

                <!-- Challenge Display -->
                <div id="dom7v_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the rootless voicing for</p>
                    <p class="text-5xl font-bold text-white mb-3">
                        <span id="dom7v_chordDisplay">CMaj7</span>
                        <span id="dom7v_voicingTypeDisplay" class="text-2xl text-orange-400 ml-2"></span>
                    </p>
                    <p id="dom7v_formulaLine" class="text-sm text-slate-400 mb-4">
                        <span class="text-orange-400 font-bold">4</span> notes:
                        <span id="dom7v_formulaHint" class="text-slate-300">3 - 5 - 7 - 9</span>
                    </p>
                    <p id="dom7v_noteHint" class="text-lg text-orange-300 mb-4 hidden">E - G - B - D</p>
                    <p id="dom7v_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="dom7v_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="dom7v_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="dom7v_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="dom7v_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="dom7v_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="dom7v_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="dom7v_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano Display -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="dom7v_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="dom7v_startBtn" onclick="dom7vStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="dom7v_stopBtn" onclick="dom7vStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="dom7v_playAgainBtn" onclick="dom7vPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="dom7v_newGameBtn" onclick="dom7vNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="dom7v_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="dom7v_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="dom7v_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="dom7v_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="dom7v_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="dom7v_feedbackFloat" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="dom7vClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="dom7v_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="dom7v_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Voicing Breakdown</h2>
                <div id="dom7v_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== EXTENDED VOICINGS MODE ==================== -->
        <div id="extvPanel" class="mode-panel hidden">
            <!-- Header -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6 relative">
                <h1 class="text-2xl font-bold mb-2 text-white">Extended Voicings Practice</h1>
                <p class="text-slate-400 mb-4">Maj6/9, Min6/9, and Dom13 voicings in all 12 keys</p>

                <!-- Stats Row -->
                <div class="flex gap-6 mb-4">
                    <div class="text-center">
                        <p class="text-sm text-slate-400">Avg Response</p>
                        <p id="extv_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="extv_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Chord Type:</label>
                            <select id="extv_chordTypeSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="all" selected>All Types</option>
                                <option value="maj69">Maj6/9 only</option>
                                <option value="min69">Min6/9 only</option>
                                <option value="dom13">Dom13 only</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="extv_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                                <option value="24">24</option>
                                <option value="36">36 (all keys x 3 types)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="extv_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="extv_showHints" class="text-sm text-slate-400">Show note names</label>
                        </div>
                    </div>
                    <p id="extv_settingsHint" class="text-xs text-slate-500 mt-3">Maj6/9: 3-5-6-9. Min6/9: b3-5-6-9. Dom13: 3-13-7-9 (soulful dominant sound).</p>
                </div>

                <!-- Challenge Display -->
                <div id="extv_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Play the extended voicing for</p>
                    <p class="text-5xl font-bold text-white mb-3" id="extv_chordDisplay">CMaj6/9</p>
                    <p id="extv_formulaLine" class="text-sm text-slate-400 mb-4">
                        <span class="text-orange-400 font-bold">4</span> notes:
                        <span id="extv_formulaHint" class="text-slate-300">3 - 5 - 6 - 9</span>
                    </p>
                    <p id="extv_noteHint" class="text-lg text-orange-300 mb-4 hidden">E - G - A - D</p>
                    <p id="extv_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="extv_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="extv_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">first-try correct</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="extv_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="extv_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">mistakes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="extv_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per chord</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="extv_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;2s</p>
                        </div>
                    </div>
                    <div id="extv_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano Display -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="extv_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="extv_startBtn" onclick="extvStartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="extv_stopBtn" onclick="extvStopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="extv_playAgainBtn" onclick="extvPlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="extv_newGameBtn" onclick="extvNewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="extv_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="extv_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="extv_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="extv_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="extv_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="extv_feedbackFloat" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="extvClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="extv_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="extv_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Voicing Breakdown</h2>
                <div id="extv_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- ==================== ROOTLESS ii-V-I MODE ==================== -->
        <div id="r251Panel" class="mode-panel hidden">
            <!-- Header -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6 relative">
                <h1 class="text-2xl font-bold mb-2 text-white">Rootless ii-V-I Practice</h1>
                <p class="text-slate-400 mb-4">Voice-led progressions: Type A → Type B → Type A</p>

                <!-- Stats Row -->
                <div class="flex gap-6 mb-4">
                    <div class="text-center">
                        <p class="text-sm text-slate-400">Avg Response</p>
                        <p id="r251_responseTime" class="text-2xl font-mono timer-fast">--</p>
                    </div>
                </div>

                <!-- Settings -->
                <div id="r251_settingsPanel" class="mb-6 p-4 bg-slate-900 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="text-sm text-slate-400 block mb-2">Rounds:</label>
                            <select id="r251_roundsSelect" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                                <option value="4">4</option>
                                <option value="6">6</option>
                                <option value="12" selected>12 (all keys)</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <input type="checkbox" id="r251_showHints" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                            <label for="r251_showHints" class="text-sm text-slate-400">Show note names</label>
                        </div>
                    </div>
                    <p id="r251_settingsHint" class="text-xs text-slate-500 mt-3">ii (m7 Type A) → V (dom7 Type B) → I (Maj7 Type A). Smooth voice leading with minimal hand movement.</p>
                </div>

                <!-- Challenge Display -->
                <div id="r251_challengeDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-slate-400 mb-2">Key of <span id="r251_keyDisplay" class="text-white font-bold">C</span></p>

                    <!-- Progression Display -->
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div id="r251_chord1Box" class="p-4 rounded-lg bg-slate-800 border-2 border-slate-600 min-w-[100px]">
                            <p class="text-sm text-slate-400">ii</p>
                            <p id="r251_chord1Name" class="text-2xl font-bold text-slate-500">Dm7</p>
                            <p class="text-xs text-slate-500">(A)</p>
                        </div>
                        <span class="text-slate-500 text-2xl">→</span>
                        <div id="r251_chord2Box" class="p-4 rounded-lg bg-slate-800 border-2 border-slate-600 min-w-[100px]">
                            <p class="text-sm text-slate-400">V</p>
                            <p id="r251_chord2Name" class="text-2xl font-bold text-slate-500">G7</p>
                            <p class="text-xs text-slate-500">(B)</p>
                        </div>
                        <span class="text-slate-500 text-2xl">→</span>
                        <div id="r251_chord3Box" class="p-4 rounded-lg bg-slate-800 border-2 border-slate-600 min-w-[100px]">
                            <p class="text-sm text-slate-400">I</p>
                            <p id="r251_chord3Name" class="text-2xl font-bold text-slate-500">CMaj7</p>
                            <p class="text-xs text-slate-500">(A)</p>
                        </div>
                    </div>

                    <p id="r251_formulaLine" class="text-sm text-slate-400 mb-4">
                        <span class="text-orange-400 font-bold">4</span> notes:
                        <span id="r251_formulaHint" class="text-slate-300">b3 - 5 - b7 - 9</span>
                    </p>
                    <p id="r251_noteHint" class="text-lg text-orange-300 mb-4 hidden">F - A - C - E</p>
                    <p id="r251_heldNotes" class="text-sm text-slate-500 mt-2">Holding: --</p>
                </div>

                <!-- Game Complete Display -->
                <div id="r251_gameCompleteDisplay" class="mb-6 p-8 bg-slate-900 rounded-lg text-center hidden">
                    <p class="text-2xl font-bold text-green-400 mb-4">Game Complete!</p>
                    <div class="grid grid-cols-5 gap-4 mb-4">
                        <div>
                            <p class="text-slate-400 text-sm">Score</p>
                            <p id="r251_finalScore" class="text-3xl font-bold text-white">0/12</p>
                            <p class="text-xs text-slate-500">progressions</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Accuracy</p>
                            <p id="r251_finalAccuracy" class="text-3xl font-bold text-blue-400">0%</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Mistakes</p>
                            <p id="r251_finalMistakes" class="text-3xl font-bold text-red-400">0</p>
                            <p class="text-xs text-slate-500">wrong notes</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Avg Time</p>
                            <p id="r251_finalAvgTime" class="text-3xl font-bold text-purple-400">0s</p>
                            <p class="text-xs text-slate-500">per progression</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Slow</p>
                            <p id="r251_finalSlow" class="text-3xl font-bold text-yellow-400">0</p>
                            <p class="text-xs text-slate-500">responses &gt;6s</p>
                        </div>
                    </div>
                    <div id="r251_finalWeakAreas" class="text-yellow-400 text-sm mb-4"></div>
                </div>

                <!-- Piano Display -->
                <div class="w-full overflow-x-auto mb-6 bg-slate-900 rounded-lg p-2 border border-slate-700">
                    <svg id="r251_pianoSvg" viewBox="0 0 1000 120" class="w-full h-32"></svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center">
                    <div class="space-x-4">
                        <button id="r251_startBtn" onclick="r251StartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition">
                            Start Game
                        </button>
                        <button id="r251_stopBtn" onclick="r251StopGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Stop
                        </button>
                        <button id="r251_playAgainBtn" onclick="r251PlayAgain()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Play Again
                        </button>
                        <button id="r251_newGameBtn" onclick="r251NewGame()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded transition hidden">
                            Change Settings
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Round</p>
                        <span id="r251_roundDisplay" class="text-2xl font-mono text-white">0</span>
                        <span class="text-slate-500">/</span>
                        <span id="r251_totalRoundsDisplay" class="font-mono text-slate-400">12</span>
                        <div class="flex gap-3 justify-end mt-1 text-xs">
                            <span class="text-green-400">Score: <span id="r251_scoreDisplay" class="font-mono">0</span></span>
                            <span class="text-red-400">Mistakes: <span id="r251_mistakesDisplay" class="font-mono">0</span></span>
                            <span class="text-yellow-400">Slow: <span id="r251_slowDisplay" class="font-mono">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Floating feedback -->
                <div id="r251_feedbackFloat" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>

            <!-- History -->
            <div class="bg-slate-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Game History</h2>
                    <button onclick="r251ClearHistory()" class="text-xs text-slate-500 hover:text-slate-300">Clear History</button>
                </div>
                <div id="r251_historyContent" class="bg-slate-900 rounded p-4 text-slate-300 min-h-[80px]">
                    <p class="italic text-slate-500">No games played yet.</p>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="r251_breakdownSection" class="bg-slate-800 rounded-lg p-6 shadow-lg hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Progression Breakdown</h2>
                <div id="r251_breakdownGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-slate-500 text-sm mt-8 pt-4 border-t border-slate-700">
            Feedback? DM <a href="https://twitter.com/dksf" target="_blank" class="text-blue-400 hover:text-blue-300">@dksf</a> on Twitter/X
        </footer>

    </div>

    <script>
        // ============ CONFIGURATION ============
        const NOTE_NAMES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const INTERVAL_NAMES = {
            1: 'Half step', 2: 'Whole step', 3: 'Minor 3rd', 4: 'Major 3rd',
            5: 'Perfect 4th', 6: 'Tritone', 7: 'Perfect 5th', 8: 'Minor 6th',
            9: 'Major 6th', 10: 'Minor 7th', 11: 'Major 7th', 12: 'Octave'
        };
        const CHORD_TYPES = {
            'maj7': { name: 'maj7', display: 'maj7', intervals: [0, 4, 7, 11] }, // R, M3, P5, M7
            'min7': { name: 'min7', display: 'min7', intervals: [0, 3, 7, 10] }, // R, m3, P5, m7
            'dom7': { name: 'dom7', display: '7', intervals: [0, 4, 7, 10] }     // R, M3, P5, m7
        };

        // ============ GLOBAL STATE ============
        let midiAccess = null;
        let selectedInput = null;
        let currentMode = 'intervals'; // 'intervals' or 'chords'
        let heldNotes = new Set(); // Currently held MIDI notes

        // ============ MODE SWITCHING ============
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const modeButtons = { intervals: 'intervalsMode', chords: 'chordsMode', iivi: 'iiviMode', scales: 'scalesMode', ext: 'extMode', alt: 'altMode', adv: 'advMode', minorIivi: 'minorIiviMode', kb: 'kbMode', jtou: 'jtouMode', dom7v: 'dom7vMode', extv: 'extvMode', r251: 'r251Mode' };
            const modePanels = { intervals: 'intervalsPanel', chords: 'chordsPanel', iivi: 'iiviPanel', scales: 'scalesPanel', ext: 'extPanel', alt: 'altPanel', adv: 'advPanel', minorIivi: 'minorIiviPanel', kb: 'kbPanel', jtou: 'jtouPanel', dom7v: 'dom7vPanel', extv: 'extvPanel', r251: 'r251Panel' };
            document.getElementById(modeButtons[mode]).classList.add('active');
            document.querySelectorAll('.mode-panel').forEach(panel => panel.classList.add('hidden'));
            document.getElementById(modePanels[mode]).classList.remove('hidden');
        }

        // ============ MIDI SETUP ============
        async function initMIDI() {
            try {
                if (!navigator.requestMIDIAccess) {
                    updateStatus(false, "Web MIDI not supported");
                    return;
                }
                midiAccess = await navigator.requestMIDIAccess();
                updateStatus(true, "MIDI Ready");
                populateDevices();
                midiAccess.onstatechange = populateDevices;
            } catch (err) {
                updateStatus(false, "MIDI Error: " + err.message);
            }
        }

        function populateDevices() {
            const inputSelect = document.getElementById('midiInputSelect');
            const outputSelect = document.getElementById('midiOutputSelect');
            const savedInput = localStorage.getItem('midiInput');
            const savedOutput = localStorage.getItem('midiOutput');

            inputSelect.innerHTML = '<option value="">Select Input Device</option>';
            outputSelect.innerHTML = '<option value="">Select Output Device</option>';

            for (let input of midiAccess.inputs.values()) {
                const opt = document.createElement('option');
                opt.value = input.id;
                opt.text = input.name;
                inputSelect.appendChild(opt);
            }

            for (let output of midiAccess.outputs.values()) {
                const opt = document.createElement('option');
                opt.value = output.id;
                opt.text = output.name;
                outputSelect.appendChild(opt);
            }

            if (savedInput && midiAccess.inputs.get(savedInput)) {
                inputSelect.value = savedInput;
                connectInput(savedInput);
            }
            if (savedOutput && midiAccess.outputs.get(savedOutput)) {
                outputSelect.value = savedOutput;
            }
        }

        function connectInput(id) {
            if (selectedInput) selectedInput.onmidimessage = null;
            if (id) {
                selectedInput = midiAccess.inputs.get(id);
                selectedInput.onmidimessage = handleMIDI;
                updateStatus(true, `Connected: ${selectedInput.name}`);
                localStorage.setItem('midiInput', id);

                // Show game content and enable MIDI collapse
                onMidiConnected(selectedInput.name);
            } else {
                onMidiDisconnected();
            }
        }

        let midiSettingsCollapsed = false;

        function onMidiConnected(deviceName) {
            // Show practice section and game panel
            document.getElementById('practiceSection').classList.remove('hidden');
            document.getElementById('intervalsPanel').classList.remove('hidden');

            // Update header with device name
            document.getElementById('midiDeviceName').innerText = deviceName;

            // Hide the preview piano
            document.getElementById('previewPiano').classList.add('hidden');

            // Auto-collapse MIDI settings
            collapseMidiSettings();
        }

        function onMidiDisconnected() {
            // Re-show MIDI settings section
            document.getElementById('midiCollapseBtn').classList.add('hidden');
            document.getElementById('midiSettingsBtn').classList.add('hidden');
            document.getElementById('midiSection').classList.remove('hidden');
            midiSettingsCollapsed = false;
        }

        function collapseMidiSettings() {
            midiSettingsCollapsed = true;
            document.getElementById('midiSection').classList.add('hidden');
            document.getElementById('midiSettingsBtn').classList.remove('hidden');
            document.getElementById('midiCollapseBtn').classList.add('hidden');
        }

        function toggleMidiSettings() {
            if (midiSettingsCollapsed) {
                midiSettingsCollapsed = false;
                document.getElementById('midiSection').classList.remove('hidden');
                document.getElementById('midiSettingsBtn').classList.add('hidden');
                document.getElementById('midiCollapseBtn').classList.remove('hidden');
            } else {
                collapseMidiSettings();
            }
        }

        document.getElementById('midiInputSelect').addEventListener('change', (e) => connectInput(e.target.value));
        document.getElementById('midiOutputSelect').addEventListener('change', (e) => {
            if (e.target.value) localStorage.setItem('midiOutput', e.target.value);
        });
        document.getElementById('iivi_voicingSelect').addEventListener('change', (e) => {
            const hint = document.getElementById('iivi_settingsHint');
            if (e.target.value === 'shell') {
                hint.innerText = 'Play only the 3rd and 7th of each chord (shell voicings). Notice how one note stays the same!';
            } else if (e.target.value === 'rootless') {
                hint.innerText = 'Play 3-5-7-9 without the root. V chord uses 13th instead of 5th. Left hand voicing style.';
            } else {
                hint.innerText = 'Play ii → V → I in sequence. Each chord needs all 4 notes (any voicing).';
            }
        });

        function updateStatus(connected, msg) {
            document.getElementById('connectionStatus').className =
                `w-3 h-3 rounded-full ${connected ? 'bg-green-500 shadow-[0_0_10px_rgba(74,222,128,0.5)]' : 'bg-red-500'}`;
            document.getElementById('connectionText').innerText = msg;
        }

        function handleMIDI(msg) {
            const [cmd, note, vel] = msg.data;
            if ((cmd & 0xF0) === 144 && vel > 0) {
                heldNotes.add(note);
                // Highlight preview piano (for testing before game starts)
                highlightKey('previewPianoSvg', note, 'key-active');
                if (currentMode === 'intervals') intOnNoteOn(note);
                else if (currentMode === 'chords') chOnNoteOn(note);
                else if (currentMode === 'iivi') iiviOnNoteOn(note);
                else if (currentMode === 'scales') scOnNoteOn(note);
                else if (currentMode === 'ext') extOnNoteOn(note);
                else if (currentMode === 'alt') altOnNoteOn(note);
                else if (currentMode === 'adv') advOnNoteOn(note);
                else if (currentMode === 'minorIivi') miiviOnNoteOn(note);
                else if (currentMode === 'kb') kbHandleNoteOn(note);
                else if (currentMode === 'jtou') jtouOnNoteOn(note);
                else if (currentMode === 'dom7v') dom7vOnNoteOn(note);
                else if (currentMode === 'extv') extvOnNoteOn(note);
                else if (currentMode === 'r251') r251OnNoteOn(note);
            } else if ((cmd & 0xF0) === 128 || ((cmd & 0xF0) === 144 && vel === 0)) {
                heldNotes.delete(note);
                // Clear preview piano highlight
                highlightKey('previewPianoSvg', note, 'key-active', false);
                if (currentMode === 'intervals') intOnNoteOff(note);
                else if (currentMode === 'chords') chOnNoteOff(note);
                else if (currentMode === 'iivi') iiviOnNoteOff(note);
                else if (currentMode === 'scales') scOnNoteOff(note);
                else if (currentMode === 'ext') extOnNoteOff(note);
                else if (currentMode === 'alt') altOnNoteOff(note);
                else if (currentMode === 'adv') advOnNoteOff(note);
                else if (currentMode === 'minorIivi') miiviOnNoteOff(note);
                else if (currentMode === 'kb') kbHandleNoteOff(note);
                else if (currentMode === 'jtou') jtouOnNoteOff(note);
                else if (currentMode === 'dom7v') dom7vOnNoteOff(note);
                else if (currentMode === 'extv') extvOnNoteOff(note);
                else if (currentMode === 'r251') r251OnNoteOff(note);
            }
        }

        // ============ PIANO VISUALIZATION ============
        function drawPiano(svgId) {
            const svg = document.getElementById(svgId);
            svg.innerHTML = '';
            const startNote = 36, endNote = 84;
            const whiteW = 24, blackW = 14, height = 120;
            let x = 0;

            // Count white keys to calculate total width
            let whiteKeyCount = 0;
            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) whiteKeyCount++;
            }
            const totalWidth = whiteKeyCount * whiteW;
            svg.setAttribute("viewBox", `0 0 ${totalWidth} ${height}`);

            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x);
                    rect.setAttribute("y", 0);
                    rect.setAttribute("width", whiteW);
                    rect.setAttribute("height", height);
                    rect.setAttribute("class", "key key-white");
                    rect.setAttribute("data-note", i);
                    rect.setAttribute("data-piano", svgId);
                    svg.appendChild(rect);
                    x += whiteW;
                }
            }

            x = 0;
            for (let i = startNote; i <= endNote; i++) {
                if (![1, 3, 6, 8, 10].includes(i % 12)) {
                    x += whiteW;
                } else {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x - blackW / 2);
                    rect.setAttribute("y", 0);
                    rect.setAttribute("width", blackW);
                    rect.setAttribute("height", height * 0.6);
                    rect.setAttribute("class", "key key-black");
                    rect.setAttribute("data-note", i);
                    rect.setAttribute("data-piano", svgId);
                    svg.appendChild(rect);
                }
            }
        }

        function highlightKey(svgId, midi, className, add = true) {
            const key = document.querySelector(`#${svgId} [data-note="${midi}"]`);
            if (key) {
                if (add) key.classList.add(className);
                else key.classList.remove(className);
            }
        }

        function clearAllHighlights(svgId) {
            document.querySelectorAll(`#${svgId} .key`).forEach(k => {
                k.classList.remove('key-active', 'key-wrong', 'key-start', 'key-held');
            });
        }

        // ==================== INTERVALS MODE ====================
        let int_isPlaying = false;
        let int_challenge = null;
        let int_usedChallenges = new Set(); // Track all challenges in this game to avoid repeats
        let int_challengeStartTime = null;
        let int_config = null;
        let int_currentRound = 0;
        let int_firstTryCorrect = 0;
        let int_totalMistakes = 0;
        let int_slowCount = 0; // Intervals taking > 2 seconds
        let int_roundHadMistake = false;
        let int_stats = {};
        let int_allTimes = [];
        let int_history = [];
        let int_cumulativeStats = {}; // Persistent stats across all games

        function intSelectIntervals(preset) {
            document.querySelectorAll('.int-interval-cb').forEach(cb => {
                if (preset === 'all') cb.checked = true;
                else if (preset === 'none') cb.checked = false;
                else if (preset === 'thirds') cb.checked = [3, 4, 7].includes(parseInt(cb.value));
            });
        }

        function intStartGame() {
            saveAllSettings();
            const intervals = Array.from(document.querySelectorAll('.int-interval-cb:checked')).map(cb => parseInt(cb.value));
            if (intervals.length === 0) { alert('Select at least one interval!'); return; }

            int_config = {
                intervals,
                direction: document.getElementById('int_directionSelect').value,
                totalRounds: parseInt(document.getElementById('int_roundsSelect').value)
            };
            int_currentRound = 0;
            int_firstTryCorrect = 0;
            int_totalMistakes = 0;
            int_slowCount = 0;
            int_roundHadMistake = false;
            int_usedChallenges = new Set();
            int_stats = {};
            int_allTimes = [];

            document.getElementById('int_roundDisplay').innerText = '0';
            document.getElementById('int_totalRoundsDisplay').innerText = int_config.totalRounds;
            document.getElementById('int_responseTime').innerText = '--';
            document.getElementById('int_scoreDisplay').innerText = '0';
            document.getElementById('int_slowDisplay').innerText = '0';
            document.getElementById('int_mistakesDisplay').innerText = '0';
            document.getElementById('int_startBtn').classList.add('hidden');
            document.getElementById('int_stopBtn').classList.remove('hidden');
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_settingsPanel').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');

            intRunCountdown(3);
        }

        function intRunCountdown(count) {
            if (count > 0) {
                document.getElementById('int_intervalName').innerText = '';
                document.getElementById('int_directionText').innerText = 'Get ready...';
                document.getElementById('int_startNote').innerText = count;
                document.getElementById('int_startNote').classList.add('text-blue-400');
                setTimeout(() => intRunCountdown(count - 1), 800);
            } else {
                document.getElementById('int_startNote').classList.remove('text-blue-400');
                int_isPlaying = true;
                intNextChallenge();
            }
        }

        function intStopGame() {
            int_isPlaying = false;
            int_challenge = null;
            clearAllHighlights('pianoSvg');
            intShowGameComplete();
        }

        function intNextChallenge() {
            if (!int_isPlaying) return;
            if (int_currentRound >= int_config.totalRounds) { intEndGame(); return; }

            clearAllHighlights('pianoSvg');
            int_currentRound++;
            int_roundHadMistake = false;

            // Calculate max possible unique challenges and reset if exhausted
            const numIntervals = int_config.intervals.length;
            const numDirections = int_config.direction === 'both' ? 2 : 1;
            const maxUnique = numIntervals * 12 * numDirections; // intervals × pitch classes × directions
            if (int_usedChallenges.size >= maxUnique) {
                int_usedChallenges = new Set();
            }

            let interval, dir, startMidi, startPitchClass, challengeKey;
            let attempts = 0;
            do {
                interval = int_config.intervals[Math.floor(Math.random() * int_config.intervals.length)];
                dir = int_config.direction;
                if (dir === 'both') dir = Math.random() < 0.5 ? 'up' : 'down';

                if (dir === 'up') startMidi = Math.floor(Math.random() * (72 - interval - 48 + 1)) + 48;
                else startMidi = Math.floor(Math.random() * (72 - 48 - interval + 1)) + 48 + interval;

                startPitchClass = startMidi % 12;
                challengeKey = `${interval}-${startPitchClass}-${dir}`;
                attempts++;
            } while (int_usedChallenges.has(challengeKey) && attempts < 50);

            int_usedChallenges.add(challengeKey);
            const targetMidi = dir === 'up' ? startMidi + interval : startMidi - interval;
            int_challenge = { startMidi, interval, direction: dir, targetMidi };
            int_challengeStartTime = Date.now();

            document.getElementById('int_startNote').innerText = NOTE_NAMES[startPitchClass];
            document.getElementById('int_intervalName').innerText = INTERVAL_NAMES[interval];
            document.getElementById('int_directionText').innerText = dir === 'up' ? 'above' : 'below';
            document.getElementById('int_roundDisplay').innerText = int_currentRound;

            highlightKey('pianoSvg', startMidi, 'key-start');
        }

        function intOnNoteOn(midi) {
            if (!int_isPlaying || !int_challenge) {
                highlightKey('pianoSvg', midi, 'key-active');
                return;
            }

            if (midi === int_challenge.startMidi) { highlightKey('pianoSvg', midi, 'key-start'); return; }
            if (int_challenge.interval !== 12 && (midi % 12) === (int_challenge.startMidi % 12)) {
                highlightKey('pianoSvg', midi, 'key-start'); return;
            }

            const responseTime = (Date.now() - int_challengeStartTime) / 1000;
            const isCorrect = (midi % 12) === (int_challenge.targetMidi % 12);
            const interval = int_challenge.interval;
            const rootName = NOTE_NAMES[int_challenge.startMidi % 12];
            const statKey = `${rootName} ${INTERVAL_NAMES[interval]}`;

            if (!int_stats[statKey]) int_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
            int_stats[statKey].total++;

            if (isCorrect) {
                // Track slow responses (> 2 seconds)
                const wasSlow = responseTime > 2;
                if (wasSlow) {
                    int_slowCount++;
                    int_stats[statKey].slow++;
                    document.getElementById('int_slowDisplay').innerText = int_slowCount;
                }

                if (!int_roundHadMistake) {
                    int_firstTryCorrect++;
                    int_stats[statKey].firstTry++;
                    int_stats[statKey].times.push(responseTime);
                    int_allTimes.push(responseTime);
                    intShowFeedback('✓', true, responseTime);
                    intUpdateResponseTime(responseTime);
                } else {
                    intShowFeedback('✓', true);
                }
                highlightKey('pianoSvg', midi, 'key-active');
                intUpdateScoreDisplay();
                int_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { int_isPlaying = true; intNextChallenge(); }, 400);
            } else {
                int_totalMistakes++;
                int_roundHadMistake = true;
                highlightKey('pianoSvg', midi, 'key-wrong');
                intShowFeedback('✗', false);
                intUpdateScoreDisplay();
            }
        }

        function intOnNoteOff(midi) {
            highlightKey('pianoSvg', midi, 'key-active', false);
            highlightKey('pianoSvg', midi, 'key-wrong', false);
        }

        function intUpdateResponseTime(seconds) {
            const el = document.getElementById('int_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function intUpdateScoreDisplay() {
            document.getElementById('int_scoreDisplay').innerText = int_firstTryCorrect;
            document.getElementById('int_mistakesDisplay').innerText = int_totalMistakes;
        }

        function intShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('int_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function intEndGame() {
            int_isPlaying = false;
            int_challenge = null;
            clearAllHighlights('pianoSvg');

            const accuracy = int_config.totalRounds > 0 ? Math.round((int_firstTryCorrect / int_config.totalRounds) * 100) : 0;
            const avgTime = int_allTimes.length > 0 ? int_allTimes.reduce((a, b) => a + b, 0) / int_allTimes.length : 0;

            int_history.unshift({
                date: new Date().toISOString(),
                config: { ...int_config },
                score: int_firstTryCorrect,
                totalRounds: int_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: int_totalMistakes,
                slowCount: int_slowCount,
                stats: JSON.parse(JSON.stringify(int_stats))
            });
            if (int_history.length > 50) int_history.pop();
            localStorage.setItem('intervalGameHistory', JSON.stringify(int_history));
            intUpdateCumulativeStats();

            intShowGameComplete();
        }

        function intShowGameComplete() {
            const accuracy = int_currentRound > 0 ? Math.round((int_firstTryCorrect / int_currentRound) * 100) : 0;
            const avgTime = int_allTimes.length > 0 ? int_allTimes.reduce((a, b) => a + b, 0) / int_allTimes.length : 0;

            document.getElementById('int_finalScore').innerText = `${int_firstTryCorrect}/${int_currentRound}`;
            document.getElementById('int_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('int_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('int_finalMistakes').innerText = int_totalMistakes;
            document.getElementById('int_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('int_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('int_finalSlow').innerText = int_slowCount;
            document.getElementById('int_finalSlow').className = `text-3xl font-bold ${int_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(int_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('int_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('int_challengeDisplay').classList.add('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('int_stopBtn').classList.add('hidden');
            document.getElementById('int_playAgainBtn').classList.remove('hidden');
            document.getElementById('int_newGameBtn').classList.remove('hidden');

            intShowBreakdown();
            intRenderHistory();
        }

        function intShowBreakdown() {
            const grid = document.getElementById('int_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(int_stats).length === 0) { document.getElementById('int_breakdownSection').classList.add('hidden'); return; }

            for (const [interval, data] of Object.entries(int_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${interval}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('int_breakdownSection').classList.remove('hidden');
        }

        function intPlayAgain() {
            int_currentRound = 0; int_firstTryCorrect = 0; int_totalMistakes = 0; int_slowCount = 0; int_roundHadMistake = false; int_usedChallenges = new Set(); int_stats = {}; int_allTimes = [];
            document.getElementById('int_roundDisplay').innerText = '0';
            document.getElementById('int_responseTime').innerText = '--';
            document.getElementById('int_scoreDisplay').innerText = '0';
            document.getElementById('int_mistakesDisplay').innerText = '0';
            document.getElementById('int_slowDisplay').innerText = '0';
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_stopBtn').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.remove('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');
            intRunCountdown(3);
        }

        function intNewGame() {
            document.getElementById('int_settingsPanel').classList.remove('hidden');
            document.getElementById('int_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('int_challengeDisplay').classList.add('hidden');
            document.getElementById('int_playAgainBtn').classList.add('hidden');
            document.getElementById('int_newGameBtn').classList.add('hidden');
            document.getElementById('int_startBtn').classList.remove('hidden');
            document.getElementById('int_breakdownSection').classList.add('hidden');
        }

        function intLoadHistory() {
            const saved = localStorage.getItem('intervalGameHistory');
            if (saved) { int_history = JSON.parse(saved); intRenderHistory(); }
            const savedCumulative = localStorage.getItem('intervalCumulativeStats');
            if (savedCumulative) { int_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function intClearHistory() {
            if (confirm('Clear interval game history?')) { int_history = []; localStorage.setItem('intervalGameHistory', '[]'); intRenderHistory(); }
        }

        function intUpdateCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [intervalName, data] of Object.entries(int_stats)) {
                if (!int_cumulativeStats[intervalName]) {
                    int_cumulativeStats[intervalName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                int_cumulativeStats[intervalName].attempts += data.total;
                int_cumulativeStats[intervalName].firstTry += data.firstTry;
                int_cumulativeStats[intervalName].totalTime += data.times.reduce((a, b) => a + b, 0);
                int_cumulativeStats[intervalName].slow += data.slow || 0;
            }
            localStorage.setItem('intervalCumulativeStats', JSON.stringify(int_cumulativeStats));
        }

        function intGetProblemAreas() {
            // Return intervals sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(int_cumulativeStats)) {
                if (data.attempts >= 5) { // Only include intervals with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    // Combined problem score: lower success + higher slow = more problematic
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function intRenderHistory() {
            const content = document.getElementById('int_historyContent');
            if (int_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = int_history.length;
            const avgAccuracy = Math.round(int_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Find best game: highest accuracy, then lowest slow count, then fastest time
            // Only games with slow data can qualify for personal best
            const displayedGames = int_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: direction and interval count
                const dir = game.config?.direction === 'up' ? '↑' : game.config?.direction === 'down' ? '↓' : '↕';
                const intCount = game.config?.intervals?.length || '?';
                const configStr = `${dir} ${intCount}int`;
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = intGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== 7TH CHORDS MODE ====================
        let ch_isPlaying = false;
        let ch_challenge = null; // { root: 0-11, type: 'maj7'|'min7'|'dom7', requiredPitchClasses: Set }
        let ch_usedChallenges = new Set(); // Track all challenges in this game to avoid repeats
        let ch_challengeStartTime = null;
        let ch_config = null;
        let ch_currentRound = 0;
        let ch_firstTryCorrect = 0;
        let ch_totalMistakes = 0;
        let ch_roundHadMistake = false;
        let ch_attemptHadMistake = false; // Tracks mistakes within a single attempt (while holding notes)
        let ch_stats = {}; // { 'C maj7': { firstTry, total, times } }
        let ch_allTimes = [];
        let ch_slowCount = 0; // Chords taking > 2 seconds
        let ch_history = [];
        let ch_cumulativeStats = {}; // Persistent stats across all games

        function chStartGame() {
            saveAllSettings();
            const types = Array.from(document.querySelectorAll('.ch-type-cb:checked')).map(cb => cb.value);
            if (types.length === 0) { alert('Select at least one chord type!'); return; }

            const twoHands = document.getElementById('ch_handsSelect').value === 'two';
            ch_config = {
                types,
                totalRounds: parseInt(document.getElementById('ch_roundsSelect').value),
                twoHands
            };
            ch_currentRound = 0; ch_firstTryCorrect = 0; ch_totalMistakes = 0; ch_slowCount = 0; ch_roundHadMistake = false; ch_attemptHadMistake = false; ch_usedChallenges = new Set(); ch_stats = {}; ch_allTimes = [];

            document.getElementById('ch_roundDisplay').innerText = '0';
            document.getElementById('ch_totalRoundsDisplay').innerText = ch_config.totalRounds;
            document.getElementById('ch_responseTime').innerText = '--';
            document.getElementById('ch_scoreDisplay').innerText = '0';
            document.getElementById('ch_mistakesDisplay').innerText = '0';
            document.getElementById('ch_slowDisplay').innerText = '0';
            document.getElementById('ch_startBtn').classList.add('hidden');
            document.getElementById('ch_stopBtn').classList.remove('hidden');
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_settingsPanel').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
            document.getElementById('ch_twoHandsIndicator').classList.toggle('hidden', !ch_config.twoHands);

            chRunCountdown(3);
        }

        function chRunCountdown(count) {
            if (count > 0) {
                document.getElementById('ch_chordRoot').innerText = count;
                document.getElementById('ch_chordType').innerText = '';
                document.getElementById('ch_heldNotes').innerText = 'Get ready...';
                setTimeout(() => chRunCountdown(count - 1), 800);
            } else {
                ch_isPlaying = true;
                chNextChallenge();
            }
        }

        function chStopGame() {
            ch_isPlaying = false;
            ch_challenge = null;
            clearAllHighlights('ch_pianoSvg');
            chShowGameComplete();
        }

        function chNextChallenge() {
            if (!ch_isPlaying) return;
            if (ch_currentRound >= ch_config.totalRounds) { chEndGame(); return; }

            clearAllHighlights('ch_pianoSvg');
            ch_currentRound++;
            ch_roundHadMistake = false;
            ch_attemptHadMistake = false;

            // Reset if all combinations have been used (12 roots × number of chord types)
            const maxUnique = 12 * ch_config.types.length;
            if (ch_usedChallenges.size >= maxUnique) {
                ch_usedChallenges = new Set();
            }

            let root, type, challengeKey;
            let attempts = 0;
            do {
                root = Math.floor(Math.random() * 12);
                type = ch_config.types[Math.floor(Math.random() * ch_config.types.length)];
                challengeKey = `${root}-${type}`;
                attempts++;
            } while (ch_usedChallenges.has(challengeKey) && attempts < 50);

            ch_usedChallenges.add(challengeKey);
            const chordDef = CHORD_TYPES[type];
            const requiredPitchClasses = new Set(chordDef.intervals.map(i => (root + i) % 12));

            ch_challenge = { root, type, requiredPitchClasses, name: `${NOTE_NAMES[root]} ${chordDef.display}` };
            ch_challengeStartTime = Date.now();

            document.getElementById('ch_chordRoot').innerText = NOTE_NAMES[root];
            document.getElementById('ch_chordType').innerText = chordDef.display;
            document.getElementById('ch_heldNotes').innerText = 'Holding: --';
            document.getElementById('ch_roundDisplay').innerText = ch_currentRound;
        }

        function chOnNoteOn(midi) {
            highlightKey('ch_pianoSvg', midi, 'key-held');

            if (!ch_isPlaying || !ch_challenge) return;

            // Check if this note is a wrong note (not in the required chord)
            const notePitchClass = midi % 12;
            const isWrongNote = !ch_challenge.requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                // Only count as a new mistake if this is the first wrong note of this attempt
                if (!ch_attemptHadMistake) {
                    ch_totalMistakes++;
                    ch_attemptHadMistake = true;
                    ch_roundHadMistake = true;
                    chShowFeedback('✗', false);
                    chUpdateScoreDisplay();
                }
                highlightKey('ch_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('ch_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held (need exactly the 4 pitch classes)
            const hasAllRequired = [...ch_challenge.requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            // For two-hand mode, check that notes span at least 2 octaves
            const heldOctaves = new Set([...heldNotes].map(n => Math.floor(n / 12)));
            const hasTwoOctaves = heldOctaves.size >= 2;
            const minNotes = ch_config.twoHands ? 8 : 4; // 4 notes per hand in two-hand mode
            const octaveRequirementMet = !ch_config.twoHands || hasTwoOctaves;

            if (hasAllRequired && heldNotes.size >= minNotes && octaveRequirementMet) {
                const responseTime = (Date.now() - ch_challengeStartTime) / 1000;
                const chordKey = ch_challenge.name;

                if (!ch_stats[chordKey]) ch_stats[chordKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                ch_stats[chordKey].total++;

                // Correct chord (we already counted mistakes above if any wrong notes were pressed)
                if (!ch_roundHadMistake) {
                    ch_firstTryCorrect++;
                    ch_stats[chordKey].firstTry++;
                    ch_stats[chordKey].times.push(responseTime);
                    ch_allTimes.push(responseTime);
                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        ch_slowCount++;
                        ch_stats[chordKey].slow++;
                        document.getElementById('ch_slowDisplay').innerText = ch_slowCount;
                    }
                    chShowFeedback('✓', true, responseTime);
                    chUpdateResponseTime(responseTime);
                } else {
                    chShowFeedback('✓', true);
                }
                chUpdateScoreDisplay();

                // Highlight correct notes green
                heldNotes.forEach(n => {
                    if (ch_challenge.requiredPitchClasses.has(n % 12)) {
                        highlightKey('ch_pianoSvg', n, 'key-active');
                    }
                });

                ch_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { ch_isPlaying = true; chNextChallenge(); }, 600);
            }
        }

        function chOnNoteOff(midi) {
            highlightKey('ch_pianoSvg', midi, 'key-held', false);
            highlightKey('ch_pianoSvg', midi, 'key-active', false);
            highlightKey('ch_pianoSvg', midi, 'key-wrong', false);

            if (ch_isPlaying && ch_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('ch_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
                // Note: Don't reset ch_attemptHadMistake here - it's reset when moving to next chord
            }
        }

        function chUpdateResponseTime(seconds) {
            const el = document.getElementById('ch_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function chUpdateScoreDisplay() {
            document.getElementById('ch_scoreDisplay').innerText = ch_firstTryCorrect;
            document.getElementById('ch_mistakesDisplay').innerText = ch_totalMistakes;
        }

        function chShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('ch_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function chEndGame() {
            ch_isPlaying = false;
            ch_challenge = null;
            clearAllHighlights('ch_pianoSvg');

            const accuracy = ch_config.totalRounds > 0 ? Math.round((ch_firstTryCorrect / ch_config.totalRounds) * 100) : 0;
            const avgTime = ch_allTimes.length > 0 ? ch_allTimes.reduce((a, b) => a + b, 0) / ch_allTimes.length : 0;

            ch_history.unshift({
                date: new Date().toISOString(),
                config: { ...ch_config },
                score: ch_firstTryCorrect,
                totalRounds: ch_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: ch_totalMistakes,
                slowCount: ch_slowCount,
                stats: JSON.parse(JSON.stringify(ch_stats))
            });
            if (ch_history.length > 50) ch_history.pop();
            localStorage.setItem('chordsGameHistory', JSON.stringify(ch_history));
            chUpdateCumulativeStats();

            chShowGameComplete();
        }

        function chShowGameComplete() {
            const accuracy = ch_currentRound > 0 ? Math.round((ch_firstTryCorrect / ch_currentRound) * 100) : 0;
            const avgTime = ch_allTimes.length > 0 ? ch_allTimes.reduce((a, b) => a + b, 0) / ch_allTimes.length : 0;

            document.getElementById('ch_finalScore').innerText = `${ch_firstTryCorrect}/${ch_currentRound}`;
            document.getElementById('ch_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('ch_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('ch_finalMistakes').innerText = ch_totalMistakes;
            document.getElementById('ch_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('ch_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('ch_finalSlow').innerText = ch_slowCount;
            document.getElementById('ch_finalSlow').className = `text-3xl font-bold ${ch_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(ch_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('ch_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('ch_challengeDisplay').classList.add('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('ch_stopBtn').classList.add('hidden');
            document.getElementById('ch_playAgainBtn').classList.remove('hidden');
            document.getElementById('ch_newGameBtn').classList.remove('hidden');

            chShowBreakdown();
            chRenderHistory();
        }

        function chShowBreakdown() {
            const grid = document.getElementById('ch_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(ch_stats).length === 0) { document.getElementById('ch_breakdownSection').classList.add('hidden'); return; }

            for (const [chord, data] of Object.entries(ch_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chord}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('ch_breakdownSection').classList.remove('hidden');
        }

        function chPlayAgain() {
            ch_currentRound = 0; ch_firstTryCorrect = 0; ch_totalMistakes = 0; ch_slowCount = 0; ch_roundHadMistake = false; ch_attemptHadMistake = false; ch_usedChallenges = new Set(); ch_stats = {}; ch_allTimes = [];
            document.getElementById('ch_roundDisplay').innerText = '0';
            document.getElementById('ch_responseTime').innerText = '--';
            document.getElementById('ch_scoreDisplay').innerText = '0';
            document.getElementById('ch_mistakesDisplay').innerText = '0';
            document.getElementById('ch_slowDisplay').innerText = '0';
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_stopBtn').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.remove('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
            document.getElementById('ch_twoHandsIndicator').classList.toggle('hidden', !ch_config.twoHands);
            chRunCountdown(3);
        }

        function chNewGame() {
            document.getElementById('ch_settingsPanel').classList.remove('hidden');
            document.getElementById('ch_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ch_challengeDisplay').classList.add('hidden');
            document.getElementById('ch_playAgainBtn').classList.add('hidden');
            document.getElementById('ch_newGameBtn').classList.add('hidden');
            document.getElementById('ch_startBtn').classList.remove('hidden');
            document.getElementById('ch_breakdownSection').classList.add('hidden');
        }

        function chLoadHistory() {
            const saved = localStorage.getItem('chordsGameHistory');
            if (saved) { ch_history = JSON.parse(saved); chRenderHistory(); }
            const savedCumulative = localStorage.getItem('chordsCumulativeStats');
            if (savedCumulative) { ch_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function chUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(ch_stats)) {
                if (!ch_cumulativeStats[chordName]) {
                    ch_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                ch_cumulativeStats[chordName].attempts += data.total;
                ch_cumulativeStats[chordName].firstTry += data.firstTry;
                ch_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                ch_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('chordsCumulativeStats', JSON.stringify(ch_cumulativeStats));
        }

        function chGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(ch_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function chClearHistory() {
            if (confirm('Clear chord game history?')) { ch_history = []; localStorage.setItem('chordsGameHistory', '[]'); chRenderHistory(); }
        }

        function chRenderHistory() {
            const content = document.getElementById('ch_historyContent');
            if (ch_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = ch_history.length;
            const avgAccuracy = Math.round(ch_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Find best game from displayed games: highest accuracy, then lowest slow count, then fastest time
            // Only games with slow data can qualify for personal best
            const displayedGames = ch_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config indicators
                const types = game.config?.types || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                const twoHands = game.config?.twoHands ? '2H' : '';
                const configStr = [typeStr, twoHands].filter(Boolean).join(' ');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = chGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== ii-V-I MODE ====================
        let iivi_isPlaying = false;
        let iivi_challenge = null; // { key: 0-11, chords: [{root, type, pitchClasses}, ...], currentStep: 0-2 }
        let iivi_usedKeys = new Set(); // Track all keys in this game to avoid repeats
        let iivi_challengeStartTime = null;
        let iivi_stepStartTime = null;
        let iivi_config = null;
        let iivi_currentRound = 0;
        let iivi_firstTryCorrect = 0;
        let iivi_totalMistakes = 0;
        let iivi_roundHadMistake = false;
        let iivi_attemptHadMistake = false;
        let iivi_stats = {}; // { 'C': { firstTry, total, times } }
        let iivi_allTimes = [];
        let iivi_slowCount = 0; // Chords taking > 2 seconds
        let iivi_history = [];
        let iivi_cumulativeStats = {}; // Persistent stats across all games
        let iivi_stepTimes = []; // Times for ii, V, I in current round

        function iiviGetProgression(key) {
            // ii = minor 7 built on 2nd degree
            // V = dominant 7 built on 5th degree
            // I = major 7 built on root
            const iiRoot = (key + 2) % 12;
            const VRoot = (key + 7) % 12;
            const IRoot = key;

            // Shell voicings: 3rd and 7th only
            // min7: 3rd = root+3, 7th = root+10
            // dom7: 3rd = root+4, 7th = root+10
            // maj7: 3rd = root+4, 7th = root+11
            const iiThird = (iiRoot + 3) % 12;
            const iiSeventh = (iiRoot + 10) % 12;
            const VThird = (VRoot + 4) % 12;
            const VSeventh = (VRoot + 10) % 12;
            const IThird = (IRoot + 4) % 12;
            const ISeventh = (IRoot + 11) % 12;

            // Rootless voicings: 3-5-7-9 (no root)
            // min7: b3-5-b7-9 → intervals 3, 7, 10, 2 (9th = 14 % 12 = 2)
            // dom7: 3-13-b7-9 → intervals 4, 9, 10, 2 (uses 13 instead of 5)
            // maj7: 3-5-7-9 → intervals 4, 7, 11, 2
            const iiRootless = [3, 7, 10, 2].map(i => (iiRoot + i) % 12);
            const VRootless = [4, 9, 10, 2].map(i => (VRoot + i) % 12);  // 9 = 13th
            const IRootless = [4, 7, 11, 2].map(i => (IRoot + i) % 12);

            return [
                {
                    root: iiRoot,
                    type: 'min7',
                    name: NOTE_NAMES[iiRoot] + 'm7',
                    rootlessName: NOTE_NAMES[iiRoot] + 'm9',
                    pitchClasses: new Set(CHORD_TYPES.min7.intervals.map(i => (iiRoot + i) % 12)),
                    shellPitchClasses: new Set([iiThird, iiSeventh]),
                    shellNames: NOTE_NAMES[iiThird] + ' + ' + NOTE_NAMES[iiSeventh],
                    rootlessPitchClasses: new Set(iiRootless),
                    rootlessNames: iiRootless.map(pc => NOTE_NAMES[pc]).join(' ')
                },
                {
                    root: VRoot,
                    type: 'dom7',
                    name: NOTE_NAMES[VRoot] + '7',
                    rootlessName: NOTE_NAMES[VRoot] + '13',
                    pitchClasses: new Set(CHORD_TYPES.dom7.intervals.map(i => (VRoot + i) % 12)),
                    shellPitchClasses: new Set([VThird, VSeventh]),
                    shellNames: NOTE_NAMES[VSeventh] + ' + ' + NOTE_NAMES[VThird],
                    rootlessPitchClasses: new Set(VRootless),
                    rootlessNames: VRootless.map(pc => NOTE_NAMES[pc]).join(' ')
                },
                {
                    root: IRoot,
                    type: 'maj7',
                    name: NOTE_NAMES[IRoot] + 'maj7',
                    rootlessName: NOTE_NAMES[IRoot] + 'maj9',
                    pitchClasses: new Set(CHORD_TYPES.maj7.intervals.map(i => (IRoot + i) % 12)),
                    shellPitchClasses: new Set([IThird, ISeventh]),
                    shellNames: NOTE_NAMES[IThird] + ' + ' + NOTE_NAMES[ISeventh],
                    rootlessPitchClasses: new Set(IRootless),
                    rootlessNames: IRootless.map(pc => NOTE_NAMES[pc]).join(' ')
                }
            ];
        }

        function iiviStartGame() {
            saveAllSettings();
            iivi_config = {
                totalRounds: parseInt(document.getElementById('iivi_roundsSelect').value),
                voicing: document.getElementById('iivi_voicingSelect').value // 'full' or 'shell'
            };
            iivi_currentRound = 0; iivi_firstTryCorrect = 0; iivi_totalMistakes = 0; iivi_slowCount = 0;
            iivi_roundHadMistake = false; iivi_attemptHadMistake = false; iivi_usedKeys = new Set();
            iivi_stats = {}; iivi_allTimes = [];

            document.getElementById('iivi_roundDisplay').innerText = '0';
            document.getElementById('iivi_totalRoundsDisplay').innerText = iivi_config.totalRounds;
            document.getElementById('iivi_responseTime').innerText = '--';
            document.getElementById('iivi_scoreDisplay').innerText = '0';
            document.getElementById('iivi_mistakesDisplay').innerText = '0';
            document.getElementById('iivi_slowDisplay').innerText = '0';
            document.getElementById('iivi_startBtn').classList.add('hidden');
            document.getElementById('iivi_stopBtn').classList.remove('hidden');
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_settingsPanel').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');

            // Update label based on voicing mode
            if (iivi_config.voicing === 'shell') {
                document.getElementById('iivi_challengeLabel').innerText = 'Shell voicings (3rd + 7th) in';
            } else if (iivi_config.voicing === 'rootless') {
                document.getElementById('iivi_challengeLabel').innerText = 'Rootless voicings (no root) in';
            } else {
                document.getElementById('iivi_challengeLabel').innerText = 'ii-V-I in the key of';
            }

            iiviRunCountdown(3);
        }

        function iiviRunCountdown(count) {
            if (count > 0) {
                document.getElementById('iivi_keyDisplay').innerText = count;
                document.getElementById('iivi_chord_ii').innerText = '...';
                document.getElementById('iivi_chord_V').innerText = '...';
                document.getElementById('iivi_chord_I').innerText = '...';
                document.getElementById('iivi_shell_ii').innerText = '';
                document.getElementById('iivi_shell_V').innerText = '';
                document.getElementById('iivi_shell_I').innerText = '';
                document.getElementById('iivi_heldNotes').innerText = 'Get ready...';
                iiviResetStepStyles();
                setTimeout(() => iiviRunCountdown(count - 1), 800);
            } else {
                iivi_isPlaying = true;
                iiviNextChallenge();
            }
        }

        function iiviResetStepStyles() {
            ['ii', 'V', 'I'].forEach(step => {
                const el = document.querySelector(`#iivi_step_${step} > div`);
                el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                document.getElementById(`iivi_time_${step}`).innerText = '--';
            });
        }

        function iiviHighlightCurrentStep() {
            const steps = ['ii', 'V', 'I'];
            steps.forEach((step, idx) => {
                const el = document.querySelector(`#iivi_step_${step} > div`);
                if (idx < iivi_challenge.currentStep) {
                    // Completed
                    el.className = 'w-20 h-16 rounded-lg bg-green-700 flex flex-col items-center justify-center mb-1 border-2 border-green-500';
                } else if (idx === iivi_challenge.currentStep) {
                    // Current
                    el.className = 'w-20 h-16 rounded-lg bg-blue-700 flex flex-col items-center justify-center mb-1 border-2 border-blue-400';
                } else {
                    // Upcoming
                    el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                }
            });
        }

        function iiviStopGame() {
            iivi_isPlaying = false;
            iivi_challenge = null;
            clearAllHighlights('iivi_pianoSvg');
            iiviShowGameComplete();
        }

        function iiviNextChallenge() {
            if (!iivi_isPlaying) return;
            if (iivi_currentRound >= iivi_config.totalRounds) { iiviEndGame(); return; }

            clearAllHighlights('iivi_pianoSvg');
            iivi_currentRound++;
            iivi_roundHadMistake = false;
            iivi_attemptHadMistake = false;
            iivi_stepTimes = [];

            // Reset used keys if all 12 have been used (allows cycling through again)
            if (iivi_usedKeys.size >= 12) {
                iivi_usedKeys.clear();
            }

            // Pick randomly from remaining unused keys
            const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const unusedKeys = allKeys.filter(k => !iivi_usedKeys.has(k));
            const key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];

            iivi_usedKeys.add(key);
            const chords = iiviGetProgression(key);

            iivi_challenge = { key, chords, currentStep: 0 };
            iivi_challengeStartTime = Date.now();
            iivi_stepStartTime = Date.now();

            document.getElementById('iivi_keyDisplay').innerText = NOTE_NAMES[key];
            document.getElementById('iivi_heldNotes').innerText = 'Holding: --';
            document.getElementById('iivi_roundDisplay').innerText = iivi_currentRound;

            // Display chord names based on voicing mode
            const isRootless = iivi_config.voicing === 'rootless';
            document.getElementById('iivi_chord_ii').innerText = isRootless ? chords[0].rootlessName : chords[0].name;
            document.getElementById('iivi_chord_V').innerText = isRootless ? chords[1].rootlessName : chords[1].name;
            document.getElementById('iivi_chord_I').innerText = isRootless ? chords[2].rootlessName : chords[2].name;

            // Show/hide note hints based on voicing mode
            const isShell = iivi_config.voicing === 'shell';
            const showHint = isShell || isRootless;
            document.getElementById('iivi_shell_ii').innerText = isRootless ? chords[0].rootlessNames : chords[0].shellNames;
            document.getElementById('iivi_shell_V').innerText = isRootless ? chords[1].rootlessNames : chords[1].shellNames;
            document.getElementById('iivi_shell_I').innerText = isRootless ? chords[2].rootlessNames : chords[2].shellNames;
            document.getElementById('iivi_shell_ii').classList.toggle('hidden', !showHint);
            document.getElementById('iivi_shell_V').classList.toggle('hidden', !showHint);
            document.getElementById('iivi_shell_I').classList.toggle('hidden', !showHint);

            iiviResetStepStyles();
            iiviHighlightCurrentStep();
        }

        function iiviOnNoteOn(midi) {
            highlightKey('iivi_pianoSvg', midi, 'key-held');

            if (!iivi_isPlaying || !iivi_challenge) return;

            const currentChord = iivi_challenge.chords[iivi_challenge.currentStep];
            const notePitchClass = midi % 12;
            const voicing = iivi_config.voicing;
            const requiredPitchClasses = voicing === 'shell' ? currentChord.shellPitchClasses
                : voicing === 'rootless' ? currentChord.rootlessPitchClasses
                : currentChord.pitchClasses;
            const requiredNotes = voicing === 'shell' ? 2 : 4;
            const isWrongNote = !requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!iivi_attemptHadMistake) {
                    iivi_totalMistakes++;
                    iivi_attemptHadMistake = true;
                    iivi_roundHadMistake = true;
                    iiviShowFeedback('✗', false);
                    iiviUpdateScoreDisplay();
                }
                highlightKey('iivi_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('iivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if current chord is complete
            const hasAllRequired = [...requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= requiredNotes) {
                const stepTime = (Date.now() - iivi_stepStartTime) / 1000;
                iivi_stepTimes.push(stepTime);

                // Track slow responses (> 2 seconds)
                if (stepTime > 2) {
                    iivi_slowCount++;
                    document.getElementById('iivi_slowDisplay').innerText = iivi_slowCount;
                }

                // Show time for this step
                const stepNames = ['ii', 'V', 'I'];
                document.getElementById(`iivi_time_${stepNames[iivi_challenge.currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                // Highlight correct notes
                heldNotes.forEach(n => {
                    if (requiredPitchClasses.has(n % 12)) {
                        highlightKey('iivi_pianoSvg', n, 'key-active');
                    }
                });

                // Score this chord individually
                if (!iivi_attemptHadMistake) {
                    iivi_firstTryCorrect++;
                }

                // Move to next step
                iivi_challenge.currentStep++;
                iivi_attemptHadMistake = false; // Reset for next chord
                iiviUpdateScoreDisplay();

                if (iivi_challenge.currentStep >= 3) {
                    // Progression complete!
                    iivi_isPlaying = false; // Prevent mistakes during transition
                    const avgTime = iivi_stepTimes.reduce((a, b) => a + b, 0) / iivi_stepTimes.length;
                    const keyName = NOTE_NAMES[iivi_challenge.key];

                    if (!iivi_stats[keyName]) iivi_stats[keyName] = { firstTry: 0, total: 0, times: [], slow: 0 };
                    iivi_stats[keyName].total++;

                    // Check if any step was slow (> 2 seconds)
                    const hadSlowStep = iivi_stepTimes.some(t => t > 2);
                    if (hadSlowStep) {
                        iivi_stats[keyName].slow++;
                    }

                    if (!iivi_roundHadMistake) {
                        iivi_stats[keyName].firstTry++;
                        iivi_stats[keyName].times.push(avgTime);
                    }
                    iivi_allTimes.push(avgTime);
                    iiviShowFeedback('✓', true);
                    iiviUpdateResponseTime(avgTime);

                    setTimeout(() => { iivi_isPlaying = true; iiviNextChallenge(); }, 800);
                } else {
                    // Move to next chord
                    iivi_stepStartTime = Date.now();
                    iiviHighlightCurrentStep();
                    iiviShowFeedback('✓', true, stepTime);
                }
            }
        }

        function iiviOnNoteOff(midi) {
            highlightKey('iivi_pianoSvg', midi, 'key-held', false);
            highlightKey('iivi_pianoSvg', midi, 'key-active', false);
            highlightKey('iivi_pianoSvg', midi, 'key-wrong', false);

            if (iivi_isPlaying && iivi_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('iivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
                // Note: Don't reset iivi_attemptHadMistake here - it's reset when moving to next chord
            }
        }

        function iiviUpdateResponseTime(seconds) {
            const el = document.getElementById('iivi_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function iiviUpdateScoreDisplay() {
            document.getElementById('iivi_scoreDisplay').innerText = iivi_firstTryCorrect;
            document.getElementById('iivi_mistakesDisplay').innerText = iivi_totalMistakes;
        }

        function iiviShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('iivi_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function iiviEndGame() {
            iivi_isPlaying = false;
            iivi_challenge = null;
            clearAllHighlights('iivi_pianoSvg');

            const totalChords = iivi_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((iivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = iivi_allTimes.length > 0 ? iivi_allTimes.reduce((a, b) => a + b, 0) / iivi_allTimes.length : 0;

            iivi_history.unshift({
                date: new Date().toISOString(),
                config: { ...iivi_config },
                score: iivi_firstTryCorrect,
                totalRounds: iivi_config.totalRounds,
                totalChords: totalChords,
                accuracy, avgTime,
                totalMistakes: iivi_totalMistakes,
                slowCount: iivi_slowCount,
                stats: JSON.parse(JSON.stringify(iivi_stats))
            });
            if (iivi_history.length > 50) iivi_history.pop();
            localStorage.setItem('iiviGameHistory', JSON.stringify(iivi_history));
            iiviUpdateCumulativeStats();

            iiviShowGameComplete();
        }

        function iiviShowGameComplete() {
            const totalChords = iivi_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((iivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = iivi_allTimes.length > 0 ? iivi_allTimes.reduce((a, b) => a + b, 0) / iivi_allTimes.length : 0;

            document.getElementById('iivi_finalScore').innerText = `${iivi_firstTryCorrect}/${totalChords} chords`;
            document.getElementById('iivi_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('iivi_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('iivi_finalMistakes').innerText = iivi_totalMistakes;
            document.getElementById('iivi_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('iivi_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('iivi_finalSlow').innerText = iivi_slowCount;
            document.getElementById('iivi_finalSlow').className = `text-3xl font-bold ${iivi_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(iivi_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('iivi_finalWeakAreas').innerText = weak.length > 0 ? `Focus on keys: ${weak.join(', ')}` : '';

            document.getElementById('iivi_challengeDisplay').classList.add('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('iivi_stopBtn').classList.add('hidden');
            document.getElementById('iivi_playAgainBtn').classList.remove('hidden');
            document.getElementById('iivi_newGameBtn').classList.remove('hidden');

            iiviShowBreakdown();
            iiviRenderHistory();
        }

        function iiviShowBreakdown() {
            const grid = document.getElementById('iivi_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(iivi_stats).length === 0) { document.getElementById('iivi_breakdownSection').classList.add('hidden'); return; }

            for (const [key, data] of Object.entries(iivi_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">Key of ${key}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('iivi_breakdownSection').classList.remove('hidden');
        }

        function iiviPlayAgain() {
            iivi_currentRound = 0; iivi_firstTryCorrect = 0; iivi_totalMistakes = 0; iivi_slowCount = 0;
            iivi_roundHadMistake = false; iivi_attemptHadMistake = false; iivi_usedKeys = new Set();
            iivi_stats = {}; iivi_allTimes = [];
            document.getElementById('iivi_roundDisplay').innerText = '0';
            document.getElementById('iivi_responseTime').innerText = '--';
            document.getElementById('iivi_scoreDisplay').innerText = '0';
            document.getElementById('iivi_mistakesDisplay').innerText = '0';
            document.getElementById('iivi_slowDisplay').innerText = '0';
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_stopBtn').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');
            iiviRunCountdown(3);
        }

        function iiviNewGame() {
            document.getElementById('iivi_settingsPanel').classList.remove('hidden');
            document.getElementById('iivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('iivi_challengeDisplay').classList.add('hidden');
            document.getElementById('iivi_playAgainBtn').classList.add('hidden');
            document.getElementById('iivi_newGameBtn').classList.add('hidden');
            document.getElementById('iivi_startBtn').classList.remove('hidden');
            document.getElementById('iivi_breakdownSection').classList.add('hidden');
        }

        function iiviLoadHistory() {
            const saved = localStorage.getItem('iiviGameHistory');
            if (saved) { iivi_history = JSON.parse(saved); iiviRenderHistory(); }
            const savedCumulative = localStorage.getItem('iiviCumulativeStats');
            if (savedCumulative) { iivi_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function iiviUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(iivi_stats)) {
                if (!iivi_cumulativeStats[keyName]) {
                    iivi_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                iivi_cumulativeStats[keyName].attempts += data.total;
                iivi_cumulativeStats[keyName].firstTry += data.firstTry;
                iivi_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                iivi_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('iiviCumulativeStats', JSON.stringify(iivi_cumulativeStats));
        }

        function iiviGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(iivi_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function iiviClearHistory() {
            if (confirm('Clear ii-V-I game history?')) { iivi_history = []; localStorage.setItem('iiviGameHistory', '[]'); iiviRenderHistory(); }
        }

        function iiviRenderHistory() {
            const content = document.getElementById('iivi_historyContent');
            if (iivi_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = iivi_history.length;
            const avgAccuracy = Math.min(100, Math.round(iivi_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            // Find best game from displayed games: highest accuracy, then lowest slow count, then fastest time
            // Only games with slow data can qualify for personal best
            const displayedGames = iivi_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.min(100, Math.max(...gamesWithSlowData.map(g => Math.min(g.accuracy, 100)))) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => Math.min(g.accuracy, 100) === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && Math.min(g.accuracy, 100) === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const totalChords = game.totalChords || game.totalRounds * 3;
                const chordScore = game.score !== undefined ? Math.min(game.score, totalChords) : Math.round(Math.min(game.accuracy, 100) * totalChords / 100);
                const displayAccuracy = Math.min(game.accuracy, 100);
                // Config: voicing type
                const voicing = game.config?.voicing === 'shell' ? 'shell' : game.config?.voicing === 'rootless' ? 'rootless' : 'full';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${chordScore}/${totalChords}</span><span class="text-xs text-purple-400 ml-1">${voicing}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = iiviGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ==================== JAZZ SCALES MODE ====================
        let sc_isPlaying = false;
        let sc_challenge = null; // { root: 0-11, chordType: 'maj7'|'min7'|'dom7', scaleName: string, scaleNotes: [pitchClasses], currentNoteIndex: 0 }
        let sc_usedChallenges = new Set();
        let sc_challengeStartTime = null;
        let sc_config = null;
        let sc_currentRound = 0;
        let sc_firstTryCorrect = 0;
        let sc_totalMistakes = 0;
        let sc_roundHadMistake = false;
        let sc_noteHadMistake = false;
        let sc_stats = {};
        let sc_allTimes = [];
        let sc_history = [];
        let sc_cumulativeStats = {}; // Persistent stats across all games

        // Scale intervals from root (chord tone + whole step principle)
        const SCALE_TYPES = {
            'maj7': {
                name: 'Lydian',
                intervals: [0, 2, 4, 6, 7, 9, 11], // 1 2 3 #4 5 6 7
                degrees: ['1', '2', '3', '#4', '5', '6', '7']
            },
            'min7': {
                name: 'Dorian',
                intervals: [0, 2, 3, 5, 7, 9, 10], // 1 2 b3 4 5 6 b7
                degrees: ['1', '2', 'b3', '4', '5', '6', 'b7']
            },
            'dom7': {
                name: 'Lydian Dom',
                intervals: [0, 2, 4, 6, 7, 9, 10], // 1 2 3 #4 5 6 b7
                degrees: ['1', '2', '3', '#4', '5', '6', 'b7']
            }
        };

        // Extension intervals: 9=2, 11=5, 13=9 (semitones from root)
        const EXTENSION_INTERVALS = { '9': 2, '11': 5, '13': 9 };

        // Get extended chord pitch classes
        function getExtendedChord(root, chordType, extension) {
            const base = CHORD_TYPES[chordType].intervals.map(i => (root + i) % 12);
            const extIntervals = [];
            if (extension === '9' || extension === '11' || extension === '13') extIntervals.push(2);
            if (extension === '11' || extension === '13') extIntervals.push(5);
            if (extension === '13') extIntervals.push(9);
            const extNotes = extIntervals.map(i => (root + i) % 12);
            const allNotes = [...base, ...extNotes];

            // Build display name
            const rootName = NOTE_NAMES[root];
            let chordName = '';
            if (chordType === 'maj7') {
                chordName = rootName + 'maj' + extension;
            } else if (chordType === 'min7') {
                chordName = rootName + 'm' + extension;
            } else { // dom7
                chordName = rootName + extension;
            }

            // Build formula
            const formulas = {
                '9': ['1', '3', '5', '7', '9'],
                '11': ['1', '3', '5', '7', '9', '11'],
                '13': ['1', '3', '5', '7', '9', '11', '13']
            };

            // Get actual note names for display
            const noteNames = allNotes.map(pc => NOTE_NAMES[pc]);

            return {
                root,
                chordType,
                extension,
                chordName,
                pitchClasses: new Set(allNotes),
                noteCount: allNotes.length,
                formula: formulas[extension],
                noteNames
            };
        }

        function scGetScale(root, chordType) {
            const scaleType = SCALE_TYPES[chordType];
            const scaleNotes = scaleType.intervals.map(i => (root + i) % 12);
            const chordDisplay = NOTE_NAMES[root] + (chordType === 'maj7' ? ' maj7' : chordType === 'min7' ? ' min7' : ' 7');
            return {
                root,
                chordType,
                chordDisplay,
                scaleName: scaleType.name,
                scaleNotes,
                degrees: scaleType.degrees
            };
        }

        function scStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('sc_chordTypeSelect').value;
            const showHints = document.getElementById('sc_showHints').checked;
            sc_config = {
                totalRounds: parseInt(document.getElementById('sc_roundsSelect').value),
                chordTypes: chordTypeSetting === 'all' ? ['maj7', 'min7', 'dom7'] : [chordTypeSetting],
                showHints
            };
            sc_currentRound = 0; sc_firstTryCorrect = 0; sc_totalMistakes = 0;
            sc_roundHadMistake = false; sc_noteHadMistake = false; sc_usedChallenges = new Set();
            sc_stats = {}; sc_allTimes = [];

            document.getElementById('sc_roundDisplay').innerText = '0';
            document.getElementById('sc_totalRoundsDisplay').innerText = sc_config.totalRounds;
            document.getElementById('sc_responseTime').innerText = '--';
            document.getElementById('sc_scoreDisplay').innerText = '0';
            document.getElementById('sc_mistakesDisplay').innerText = '0';
            document.getElementById('sc_startBtn').classList.add('hidden');
            document.getElementById('sc_stopBtn').classList.remove('hidden');
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_settingsPanel').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');

            // Show/hide hints based on setting
            document.querySelectorAll('.sc-hint').forEach(el => {
                el.style.visibility = showHints ? 'visible' : 'hidden';
            });

            scRunCountdown(3);
        }

        function scRunCountdown(count) {
            if (count > 0) {
                document.getElementById('sc_chordDisplay').innerText = count;
                document.getElementById('sc_scaleNameDisplay').innerText = '';
                document.getElementById('sc_expectedNote').innerHTML = 'Get ready...';
                scResetNoteProgress();
                setTimeout(() => scRunCountdown(count - 1), 800);
            } else {
                sc_isPlaying = true;
                scNextChallenge();
            }
        }

        function scResetNoteProgress() {
            for (let i = 0; i < 7; i++) {
                const el = document.getElementById(`sc_note_${i}`);
                el.className = 'w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600';
            }
        }

        function scUpdateNoteProgress() {
            const degrees = sc_challenge.degrees;
            const showHints = sc_config.showHints;
            for (let i = 0; i < 7; i++) {
                const el = document.getElementById(`sc_note_${i}`);
                // Show degree hint or just position number based on setting
                el.innerHTML = showHints ? degrees[i] : (i < sc_challenge.currentNoteIndex ? '✓' : '');
                if (i < sc_challenge.currentNoteIndex) {
                    el.className = 'w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-sm font-bold border-2 border-green-400';
                } else if (i === sc_challenge.currentNoteIndex) {
                    el.className = 'w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold border-2 border-blue-400';
                } else {
                    el.className = 'w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold border-2 border-slate-600';
                }
            }
        }

        function scStopGame() {
            sc_isPlaying = false;
            sc_challenge = null;
            clearAllHighlights('sc_pianoSvg');
            scShowGameComplete();
        }

        function scNextChallenge() {
            if (!sc_isPlaying) return;
            if (sc_currentRound >= sc_config.totalRounds) { scEndGame(); return; }

            clearAllHighlights('sc_pianoSvg');
            sc_currentRound++;
            sc_roundHadMistake = false;
            sc_noteHadMistake = false;

            // Generate unique challenge
            const maxChallenges = 12 * sc_config.chordTypes.length;
            if (sc_usedChallenges.size >= maxChallenges) {
                sc_usedChallenges.clear();
            }

            let root, chordType, challengeKey;
            let attempts = 0;
            do {
                root = Math.floor(Math.random() * 12);
                chordType = sc_config.chordTypes[Math.floor(Math.random() * sc_config.chordTypes.length)];
                challengeKey = `${root}-${chordType}`;
                attempts++;
            } while (sc_usedChallenges.has(challengeKey) && attempts < 50);

            sc_usedChallenges.add(challengeKey);
            const scale = scGetScale(root, chordType);

            sc_challenge = { ...scale, currentNoteIndex: 0 };
            sc_challengeStartTime = Date.now();

            document.getElementById('sc_chordDisplay').innerText = scale.chordDisplay;
            document.getElementById('sc_scaleNameDisplay').innerText = scale.scaleName;
            document.getElementById('sc_roundDisplay').innerText = sc_currentRound;

            scUpdateNoteProgress();
            scUpdateExpectedNote();
        }

        function scUpdateExpectedNote() {
            if (!sc_challenge || sc_challenge.currentNoteIndex >= 7) return;
            if (sc_config.showHints) {
                const expectedPitchClass = sc_challenge.scaleNotes[sc_challenge.currentNoteIndex];
                document.getElementById('sc_expectedNote').innerHTML = `Next: <span class="text-white font-bold">${NOTE_NAMES[expectedPitchClass]}</span>`;
            } else {
                document.getElementById('sc_expectedNote').innerHTML = `<span class="text-slate-500">Note ${sc_challenge.currentNoteIndex + 1} of 7</span>`;
            }
        }

        function scOnNoteOn(midi) {
            highlightKey('sc_pianoSvg', midi, 'key-held');

            if (!sc_isPlaying || !sc_challenge) return;
            if (sc_challenge.currentNoteIndex >= 7) return;

            const notePitchClass = midi % 12;
            const expectedPitchClass = sc_challenge.scaleNotes[sc_challenge.currentNoteIndex];

            if (notePitchClass === expectedPitchClass) {
                // Correct note!
                highlightKey('sc_pianoSvg', midi, 'key-active');

                // Score this note individually
                if (!sc_noteHadMistake) {
                    sc_firstTryCorrect++;
                }

                sc_challenge.currentNoteIndex++;
                sc_noteHadMistake = false; // Reset for next note
                scUpdateNoteProgress();
                scUpdateScoreDisplay();

                if (sc_challenge.currentNoteIndex >= 7) {
                    // Scale complete!
                    const scaleTime = (Date.now() - sc_challengeStartTime) / 1000;
                    const statKey = sc_challenge.chordDisplay;

                    if (!sc_stats[statKey]) sc_stats[statKey] = { firstTry: 0, total: 0, times: [] };
                    sc_stats[statKey].total++;

                    if (!sc_roundHadMistake) {
                        sc_stats[statKey].firstTry++;
                        sc_stats[statKey].times.push(scaleTime);
                        sc_allTimes.push(scaleTime);
                        scShowFeedback('✓', true, scaleTime);
                        scUpdateResponseTime(scaleTime);
                    } else {
                        scShowFeedback('✓', true);
                    }
                    document.getElementById('sc_expectedNote').innerHTML = '<span class="text-green-400">Complete!</span>';

                    sc_isPlaying = false; // Prevent mistakes during transition
                    setTimeout(() => { sc_isPlaying = true; scNextChallenge(); }, 800);
                } else {
                    scUpdateExpectedNote();
                }
            } else {
                // Wrong note!
                if (!sc_noteHadMistake) {
                    sc_totalMistakes++;
                    sc_noteHadMistake = true;
                    sc_roundHadMistake = true;
                    scShowFeedback('✗', false);
                    scUpdateScoreDisplay();
                }
                highlightKey('sc_pianoSvg', midi, 'key-wrong');
            }
        }

        function scOnNoteOff(midi) {
            highlightKey('sc_pianoSvg', midi, 'key-held', false);
            highlightKey('sc_pianoSvg', midi, 'key-active', false);
            highlightKey('sc_pianoSvg', midi, 'key-wrong', false);
        }

        function scUpdateResponseTime(seconds) {
            const el = document.getElementById('sc_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 3 ? 'timer-fast' : seconds < 6 ? 'timer-medium' : 'timer-slow');
        }

        function scUpdateScoreDisplay() {
            document.getElementById('sc_scoreDisplay').innerText = sc_firstTryCorrect;
            document.getElementById('sc_mistakesDisplay').innerText = sc_totalMistakes;
        }

        function scShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('sc_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function scEndGame() {
            sc_isPlaying = false;
            sc_challenge = null;
            clearAllHighlights('sc_pianoSvg');

            const totalNotes = sc_config.totalRounds * 7;
            const accuracy = totalNotes > 0 ? Math.min(100, Math.round((sc_firstTryCorrect / totalNotes) * 100)) : 0;
            const avgTime = sc_allTimes.length > 0 ? sc_allTimes.reduce((a, b) => a + b, 0) / sc_allTimes.length : 0;

            sc_history.unshift({
                date: new Date().toISOString(),
                config: { ...sc_config },
                score: sc_firstTryCorrect,
                totalRounds: sc_config.totalRounds,
                totalNotes: totalNotes,
                accuracy, avgTime,
                totalMistakes: sc_totalMistakes,
                stats: JSON.parse(JSON.stringify(sc_stats))
            });
            if (sc_history.length > 50) sc_history.pop();
            localStorage.setItem('scGameHistory', JSON.stringify(sc_history));
            scUpdateCumulativeStats();

            scShowGameComplete();
        }

        function scShowGameComplete() {
            const totalNotes = sc_currentRound * 7;
            const accuracy = totalNotes > 0 ? Math.min(100, Math.round((sc_firstTryCorrect / totalNotes) * 100)) : 0;
            const avgTime = sc_allTimes.length > 0 ? sc_allTimes.reduce((a, b) => a + b, 0) / sc_allTimes.length : 0;

            document.getElementById('sc_finalScore').innerText = `${sc_firstTryCorrect}/${totalNotes} notes`;
            document.getElementById('sc_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('sc_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('sc_finalMistakes').innerText = sc_totalMistakes;
            document.getElementById('sc_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('sc_finalAvgTime').className = `text-3xl font-bold ${avgTime < 3 ? 'text-green-400' : avgTime < 6 ? 'text-yellow-400' : 'text-red-400'}`;

            const weak = Object.entries(sc_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('sc_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('sc_challengeDisplay').classList.add('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('sc_stopBtn').classList.add('hidden');
            document.getElementById('sc_playAgainBtn').classList.remove('hidden');
            document.getElementById('sc_newGameBtn').classList.remove('hidden');

            scShowBreakdown();
            scRenderHistory();
        }

        function scShowBreakdown() {
            const grid = document.getElementById('sc_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(sc_stats).length === 0) { document.getElementById('sc_breakdownSection').classList.add('hidden'); return; }

            for (const [scale, data] of Object.entries(sc_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${scale}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('sc_breakdownSection').classList.remove('hidden');
        }

        function scPlayAgain() {
            sc_currentRound = 0; sc_firstTryCorrect = 0; sc_totalMistakes = 0;
            sc_roundHadMistake = false; sc_noteHadMistake = false; sc_usedChallenges = new Set();
            sc_stats = {}; sc_allTimes = [];
            document.getElementById('sc_roundDisplay').innerText = '0';
            document.getElementById('sc_responseTime').innerText = '--';
            document.getElementById('sc_scoreDisplay').innerText = '0';
            document.getElementById('sc_mistakesDisplay').innerText = '0';
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_stopBtn').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.remove('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');
            scRunCountdown(3);
        }

        function scNewGame() {
            document.getElementById('sc_settingsPanel').classList.remove('hidden');
            document.getElementById('sc_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('sc_challengeDisplay').classList.add('hidden');
            document.getElementById('sc_playAgainBtn').classList.add('hidden');
            document.getElementById('sc_newGameBtn').classList.add('hidden');
            document.getElementById('sc_startBtn').classList.remove('hidden');
            document.getElementById('sc_breakdownSection').classList.add('hidden');
        }

        function scLoadHistory() {
            const saved = localStorage.getItem('scGameHistory');
            if (saved) { sc_history = JSON.parse(saved); scRenderHistory(); }
            const savedCumulative = localStorage.getItem('scCumulativeStats');
            if (savedCumulative) { sc_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function scUpdateCumulativeStats() {
            for (const [scaleName, data] of Object.entries(sc_stats)) {
                if (!sc_cumulativeStats[scaleName]) {
                    sc_cumulativeStats[scaleName] = { attempts: 0, firstTry: 0, totalTime: 0 };
                }
                sc_cumulativeStats[scaleName].attempts += data.total;
                sc_cumulativeStats[scaleName].firstTry += data.firstTry;
                sc_cumulativeStats[scaleName].totalTime += data.times.reduce((a, b) => a + b, 0);
            }
            localStorage.setItem('scCumulativeStats', JSON.stringify(sc_cumulativeStats));
        }

        function scGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(sc_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = 100 - successRate; // No slow tracking for scales
                    areas.push({ name, successRate, slowRate: 0, avgTime, attempts: data.attempts, firstTry: data.firstTry, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function scClearHistory() {
            if (confirm('Clear jazz scales game history?')) { sc_history = []; localStorage.setItem('scGameHistory', '[]'); scRenderHistory(); }
        }

        function scRenderHistory() {
            const content = document.getElementById('sc_historyContent');
            if (sc_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = sc_history.length;
            const avgAccuracy = Math.min(100, Math.round(sc_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            // Find best game from displayed games: highest accuracy, then fastest time as tiebreaker
            const displayedGames = sc_history.slice(0, 10);
            const bestAccuracy = Math.min(100, Math.max(...displayedGames.map(g => Math.min(g.accuracy, 100))));
            const gamesWithBestAccuracy = displayedGames.filter(g => Math.min(g.accuracy, 100) === bestAccuracy);
            const bestTime = Math.min(...gamesWithBestAccuracy.map(g => g.avgTime));
            const isBest = (g) => Math.min(g.accuracy, 100) === bestAccuracy && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const totalNotes = game.totalNotes || game.totalRounds * 7;
                const noteScore = game.score !== undefined ? Math.min(game.score, totalNotes) : Math.round(Math.min(game.accuracy, 100) * totalNotes / 100);
                const displayAccuracy = Math.min(game.accuracy, 100);
                // Config: chord types
                const types = game.config?.chordTypes || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${noteScore}/${totalNotes}</span><span class="text-xs text-purple-400 ml-1">${typeStr}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = scGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500">(✗=mistakes)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = hasMistakes ? `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>` : `<span class="text-slate-500">-</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ EXTENSIONS MODE ============
        let ext_isPlaying = false;
        let ext_config = { totalRounds: 12, chordTypes: ['maj7', 'min7', 'dom7'], extensions: ['9', '11', '13'] };
        let ext_currentRound = 0;
        let ext_firstTryCorrect = 0;
        let ext_totalMistakes = 0;
        let ext_roundHadMistake = false;
        let ext_challenge = null;
        let ext_startTime = null;
        let ext_usedChallenges = new Set();
        let ext_stats = {};
        let ext_allTimes = [];
        let ext_slowCount = 0; // Chords taking > 2 seconds
        let ext_history = [];
        let ext_cumulativeStats = {}; // Persistent stats across all games
        let ext_playedPitchClasses = new Set();

        function extStartGame() {
            saveAllSettings();
            const chordTypeSetting = document.getElementById('ext_chordTypeSelect').value;
            const extensionSetting = document.getElementById('ext_extensionSelect').value;
            const showHints = document.getElementById('ext_showHints').checked;
            ext_config = {
                totalRounds: parseInt(document.getElementById('ext_roundsSelect').value),
                chordTypes: chordTypeSetting === 'all' ? ['maj7', 'min7', 'dom7'] : [chordTypeSetting],
                extensions: extensionSetting === 'all' ? ['9', '11', '13'] : [extensionSetting],
                showHints
            };
            ext_currentRound = 0; ext_firstTryCorrect = 0; ext_totalMistakes = 0; ext_slowCount = 0;
            ext_roundHadMistake = false; ext_usedChallenges = new Set();
            ext_stats = {}; ext_allTimes = [];

            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_totalRoundsDisplay').innerText = ext_config.totalRounds;
            document.getElementById('ext_responseTime').innerText = '--';
            document.getElementById('ext_scoreDisplay').innerText = '0';
            document.getElementById('ext_mistakesDisplay').innerText = '0';
            document.getElementById('ext_slowDisplay').innerText = '0';
            document.getElementById('ext_startBtn').classList.add('hidden');
            document.getElementById('ext_stopBtn').classList.remove('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_settingsPanel').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.remove('hidden');
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');

            // Show/hide formula hint based on setting
            document.getElementById('ext_formulaHint').style.display = showHints ? 'inline' : 'none';

            extRunCountdown(3);
        }

        function extRunCountdown(count) {
            if (count > 0) {
                document.getElementById('ext_chordDisplay').innerText = count;
                document.getElementById('ext_noteCount').innerText = '';
                document.getElementById('ext_formulaDisplay').innerText = 'Get ready...';
                document.getElementById('ext_noteIndicators').innerHTML = '';
                setTimeout(() => extRunCountdown(count - 1), 800);
            } else {
                ext_isPlaying = true;
                extNextChallenge();
            }
        }

        function extStopGame() {
            ext_isPlaying = false;
            ext_challenge = null;
            clearAllHighlights('ext_pianoSvg');
            extShowGameComplete();
        }

        function extNextChallenge() {
            if (ext_currentRound >= ext_config.totalRounds) {
                ext_isPlaying = false;
                extShowGameComplete();
                return;
            }

            ext_currentRound++;
            ext_roundHadMistake = false;
            ext_playedPitchClasses = new Set();
            clearAllHighlights('ext_pianoSvg');
            document.getElementById('ext_roundDisplay').innerText = ext_currentRound;

            // Generate challenge (avoid duplicates)
            let challenge;
            let attempts = 0;
            do {
                const root = Math.floor(Math.random() * 12);
                const chordType = ext_config.chordTypes[Math.floor(Math.random() * ext_config.chordTypes.length)];
                const extension = ext_config.extensions[Math.floor(Math.random() * ext_config.extensions.length)];
                const key = `${root}-${chordType}-${extension}`;
                if (!ext_usedChallenges.has(key) || attempts > 50) {
                    ext_usedChallenges.add(key);
                    challenge = getExtendedChord(root, chordType, extension);
                    break;
                }
                attempts++;
            } while (true);

            ext_challenge = challenge;
            ext_startTime = Date.now();

            // Update display
            document.getElementById('ext_chordDisplay').innerText = challenge.chordName;
            document.getElementById('ext_noteCount').innerText = challenge.noteCount;
            document.getElementById('ext_formulaDisplay').innerText = challenge.formula.join(' - ');

            // Create note indicators
            extUpdateNoteIndicators();
            ext_isPlaying = true; // Re-enable input for new challenge
        }

        function extUpdateNoteIndicators() {
            const container = document.getElementById('ext_noteIndicators');
            const showHints = ext_config.showHints;
            let html = '';
            ext_challenge.noteNames.forEach((name, i) => {
                const pc = [...ext_challenge.pitchClasses][i];
                const isPlayed = ext_playedPitchClasses.has(pc);
                const colorClass = isPlayed ? 'bg-green-600 border-green-400' : 'bg-slate-700 border-slate-600';
                // Show note name if hints enabled, otherwise just show checkmark when played
                const content = showHints ? name : (isPlayed ? '✓' : '');
                html += `<div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center text-sm font-bold border-2">${content}</div>`;
            });
            container.innerHTML = html;
        }

        function extOnNoteOn(midi) {
            highlightKey('ext_pianoSvg', midi, 'key-held');
            if (!ext_isPlaying || !ext_challenge) return;

            const notePitchClass = midi % 12;

            if (ext_challenge.pitchClasses.has(notePitchClass)) {
                // Correct note
                highlightKey('ext_pianoSvg', midi, 'key-active');
                ext_playedPitchClasses.add(notePitchClass);
                extUpdateNoteIndicators();

                // Check if all notes played
                if (ext_playedPitchClasses.size === ext_challenge.noteCount) {
                    ext_isPlaying = false; // Prevent mistakes during transition
                    const elapsed = ((Date.now() - ext_startTime) / 1000).toFixed(2);
                    const responseTime = parseFloat(elapsed);
                    ext_allTimes.push(responseTime);

                    // Track stats by full chord name (includes root)
                    const statKey = ext_challenge.chordName;
                    if (!ext_stats[statKey]) ext_stats[statKey] = { correct: 0, total: 0, slow: 0 };
                    ext_stats[statKey].total++;

                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        ext_slowCount++;
                        ext_stats[statKey].slow++;
                        document.getElementById('ext_slowDisplay').innerText = ext_slowCount;
                    }
                    document.getElementById('ext_responseTime').innerText = elapsed + 's';

                    if (!ext_roundHadMistake) {
                        ext_firstTryCorrect++;
                        ext_stats[statKey].correct++;
                        extShowFeedback('✓', true);
                    } else {
                        extShowFeedback('✓', true);
                    }
                    document.getElementById('ext_scoreDisplay').innerText = ext_firstTryCorrect;

                    setTimeout(() => extNextChallenge(), 1000);
                }
            } else {
                // Wrong note
                if (!ext_roundHadMistake) {
                    ext_totalMistakes++;
                    ext_roundHadMistake = true;
                    extShowFeedback('✗', false);
                    document.getElementById('ext_mistakesDisplay').innerText = ext_totalMistakes;
                }
                highlightKey('ext_pianoSvg', midi, 'key-wrong');
                setTimeout(() => clearHighlight('ext_pianoSvg', midi), 300);
            }
        }

        function extOnNoteOff(midi) {
            clearHighlight('ext_pianoSvg', midi);
        }

        function extShowFeedback(text, isCorrect) {
            const area = document.getElementById('ext_feedbackArea');
            const div = document.createElement('div');
            div.className = `text-6xl font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'} feedback-float`;
            div.innerText = text;
            area.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function extShowGameComplete() {
            document.getElementById('ext_stopBtn').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.add('hidden');
            document.getElementById('ext_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('ext_playAgainBtn').classList.remove('hidden');
            document.getElementById('ext_newGameBtn').classList.remove('hidden');

            const accuracy = ext_currentRound > 0 ? Math.round((ext_firstTryCorrect / ext_currentRound) * 100) : 0;
            const avgTime = ext_allTimes.length > 0 ? (ext_allTimes.reduce((a, b) => a + b, 0) / ext_allTimes.length).toFixed(1) : 0;

            document.getElementById('ext_finalScore').innerText = `${ext_firstTryCorrect}/${ext_currentRound}`;
            document.getElementById('ext_finalAccuracy').innerText = accuracy + '%';
            document.getElementById('ext_finalMistakes').innerText = ext_totalMistakes;
            document.getElementById('ext_finalAvgTime').innerText = avgTime + 's';
            document.getElementById('ext_finalSlow').innerText = ext_slowCount;
            document.getElementById('ext_finalSlow').className = `text-3xl font-bold ${ext_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Weak areas
            const weakAreas = [];
            for (const [key, stats] of Object.entries(ext_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                if (pct < 70) {
                    const [chordType, ext] = key.split('-');
                    const typeName = chordType === 'maj7' ? 'maj' : chordType === 'min7' ? 'min' : 'dom';
                    weakAreas.push(`${typeName}${ext} (${pct}%)`);
                }
            }
            document.getElementById('ext_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Practice more: ' + weakAreas.join(', ') : '';

            // Save history
            ext_history.unshift({ date: new Date().toISOString(), score: ext_firstTryCorrect, totalRounds: ext_currentRound, accuracy, avgTime: parseFloat(avgTime), mistakes: ext_totalMistakes, slowCount: ext_slowCount });
            localStorage.setItem('extGameHistory', JSON.stringify(ext_history.slice(0, 50)));
            extSaveCumulativeStats();
            extRenderHistory();

            // Breakdown
            extShowBreakdown();
        }

        function extShowBreakdown() {
            const grid = document.getElementById('ext_breakdownGrid');
            grid.innerHTML = '';
            document.getElementById('ext_breakdownSection').classList.remove('hidden');

            for (const [key, stats] of Object.entries(ext_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                const [chordType, ext] = key.split('-');
                const typeName = chordType === 'maj7' ? 'maj' : chordType === 'min7' ? 'min' : 'dom';
                const colorClass = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                grid.innerHTML += `<div class="p-3 rounded border ${colorClass}">
                    <p class="font-bold text-white">${typeName}${ext}</p>
                    <p class="text-sm text-slate-300">${stats.correct}/${stats.total} (${pct}%)</p>
                </div>`;
            }
        }

        function extPlayAgain() {
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');
            document.getElementById('ext_challengeDisplay').classList.remove('hidden');
            document.getElementById('ext_stopBtn').classList.remove('hidden');
            ext_currentRound = 0; ext_firstTryCorrect = 0; ext_totalMistakes = 0; ext_slowCount = 0;
            ext_usedChallenges.clear(); ext_stats = {}; ext_allTimes = [];
            document.getElementById('ext_scoreDisplay').innerText = '0';
            document.getElementById('ext_mistakesDisplay').innerText = '0';
            document.getElementById('ext_slowDisplay').innerText = '0';
            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_responseTime').innerText = '--';
            extRunCountdown(3);
        }

        function extNewGame() {
            document.getElementById('ext_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('ext_playAgainBtn').classList.add('hidden');
            document.getElementById('ext_newGameBtn').classList.add('hidden');
            document.getElementById('ext_settingsPanel').classList.remove('hidden');
            document.getElementById('ext_startBtn').classList.remove('hidden');
            document.getElementById('ext_breakdownSection').classList.add('hidden');
            document.getElementById('ext_roundDisplay').innerText = '0';
            document.getElementById('ext_responseTime').innerText = '--';
        }

        function extLoadHistory() {
            const saved = localStorage.getItem('extGameHistory');
            if (saved) { ext_history = JSON.parse(saved); extRenderHistory(); }
            const savedCumulative = localStorage.getItem('extCumulativeStats');
            if (savedCumulative) { ext_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function extSaveCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [chordName, data] of Object.entries(ext_stats)) {
                if (!ext_cumulativeStats[chordName]) {
                    ext_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, slow: 0 };
                }
                ext_cumulativeStats[chordName].attempts += data.total;
                ext_cumulativeStats[chordName].firstTry += data.correct;
                ext_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('extCumulativeStats', JSON.stringify(ext_cumulativeStats));
        }

        function extGetProblemAreas() {
            // Return chords sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(ext_cumulativeStats)) {
                if (data.attempts >= 3) { // Only include chords with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function extClearHistory() {
            if (confirm('Clear extensions game history?')) { ext_history = []; localStorage.setItem('extGameHistory', '[]'); extRenderHistory(); }
        }

        function extRenderHistory() {
            const content = document.getElementById('ext_historyContent');
            if (ext_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = ext_history.length;
            const avgAccuracy = Math.round(ext_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Find best game from displayed games: highest accuracy, then lowest slow count, then fastest time
            // Only games with slow data can qualify for personal best
            const displayedGames = ext_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: chord types and extensions
                const types = game.config?.chordTypes || ['maj7', 'min7', 'dom7'];
                const typeStr = types.length === 3 ? 'all' : types.map(t => t.replace('7', '')).join('/');
                const exts = game.config?.extensions || ['9', '11', '13'];
                const extStr = exts.length === 3 ? '' : exts.join('/');
                const configStr = [typeStr, extStr].filter(Boolean).join(' ');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${configStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = extGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ALTERED EXTENSIONS MODE ============
        // Altered intervals: b9=1, #9=3, #11=6, b13=8 (semitones from root)
        const ALTERED_INTERVALS = {
            'b9': { interval: 1, formula: 'b9' },
            '#9': { interval: 3, formula: '#9' },
            '#11': { interval: 6, formula: '#11' },
            'b13': { interval: 8, formula: 'b13' }
        };

        function getAlteredChord(root, alteration, voicing = 'full') {
            // Base dom7: 0, 4, 7, 10 (R, 3, 5, b7)
            const base = [0, 4, 7, 10].map(i => (root + i) % 12);
            const altInterval = ALTERED_INTERVALS[alteration].interval;
            const altNote = (root + altInterval) % 12;

            // For full voicing, #11 and b13 include the natural 9th (like extended chords)
            const includeNinth = voicing === 'full' && (alteration === '#11' || alteration === 'b13');
            const ninthNote = (root + 2) % 12; // natural 9th = 2 semitones

            let allNotes, formula;
            if (includeNinth) {
                allNotes = [...base, ninthNote, altNote];
                formula = ['1', '3', '5', 'b7', '9', alteration];
            } else {
                allNotes = [...base, altNote];
                formula = ['1', '3', '5', 'b7', alteration];
            }

            // Build display name
            const rootName = NOTE_NAMES[root];
            const chordName = rootName + '7' + alteration;

            // Get actual note names for display
            const noteNames = allNotes.map(pc => NOTE_NAMES[pc]);

            return {
                root,
                alteration,
                chordName,
                pitchClasses: new Set(allNotes),
                noteCount: allNotes.length,
                formula,
                noteNames
            };
        }

        let alt_isPlaying = false;
        let alt_config = { totalRounds: 12, alterations: ['b9', '#9', '#11', 'b13'] };
        let alt_currentRound = 0;
        let alt_firstTryCorrect = 0;
        let alt_totalMistakes = 0;
        let alt_roundHadMistake = false;
        let alt_challenge = null;
        let alt_startTime = null;
        let alt_usedChallenges = new Set();
        let alt_stats = {};
        let alt_allTimes = [];
        let alt_slowCount = 0; // Chords taking > 2 seconds
        let alt_history = [];
        let alt_cumulativeStats = {}; // Persistent stats across all games
        let alt_playedPitchClasses = new Set();

        function altStartGame() {
            saveAllSettings();
            const alterationSetting = document.getElementById('alt_alterationSelect').value;
            const voicingSetting = document.getElementById('alt_voicingSelect').value;
            alt_config = {
                totalRounds: parseInt(document.getElementById('alt_roundsSelect').value),
                alterations: alterationSetting === 'all' ? ['b9', '#9', '#11', 'b13'] : [alterationSetting],
                voicing: voicingSetting
            };
            alt_currentRound = 0; alt_firstTryCorrect = 0; alt_totalMistakes = 0; alt_slowCount = 0;
            alt_roundHadMistake = false; alt_usedChallenges = new Set();
            alt_stats = {}; alt_allTimes = [];

            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_totalRoundsDisplay').innerText = alt_config.totalRounds;
            document.getElementById('alt_responseTime').innerText = '--';
            document.getElementById('alt_scoreDisplay').innerText = '0';
            document.getElementById('alt_mistakesDisplay').innerText = '0';
            document.getElementById('alt_slowDisplay').innerText = '0';
            document.getElementById('alt_startBtn').classList.add('hidden');
            document.getElementById('alt_stopBtn').classList.remove('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_settingsPanel').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.remove('hidden');
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');

            altRunCountdown(3);
        }

        function altRunCountdown(count) {
            if (count > 0) {
                document.getElementById('alt_chordDisplay').innerText = count;
                document.getElementById('alt_noteCount').innerText = '';
                document.getElementById('alt_formulaDisplay').innerText = 'Get ready...';
                document.getElementById('alt_noteIndicators').innerHTML = '';
                setTimeout(() => altRunCountdown(count - 1), 800);
            } else {
                alt_isPlaying = true;
                altNextChallenge();
            }
        }

        function altStopGame() {
            alt_isPlaying = false;
            alt_challenge = null;
            clearAllHighlights('alt_pianoSvg');
            altShowGameComplete();
        }

        function altNextChallenge() {
            if (alt_currentRound >= alt_config.totalRounds) {
                alt_isPlaying = false;
                altShowGameComplete();
                return;
            }

            alt_currentRound++;
            alt_roundHadMistake = false;
            alt_playedPitchClasses = new Set();
            clearAllHighlights('alt_pianoSvg');
            document.getElementById('alt_roundDisplay').innerText = alt_currentRound;

            // Generate challenge (avoid duplicates)
            let challenge;
            let attempts = 0;
            do {
                const root = Math.floor(Math.random() * 12);
                const alteration = alt_config.alterations[Math.floor(Math.random() * alt_config.alterations.length)];
                const key = `${root}-${alteration}`;
                if (!alt_usedChallenges.has(key) || attempts > 50) {
                    alt_usedChallenges.add(key);
                    challenge = getAlteredChord(root, alteration, alt_config.voicing);
                    break;
                }
                attempts++;
            } while (true);

            alt_challenge = challenge;
            alt_startTime = Date.now();

            // Update display
            document.getElementById('alt_chordDisplay').innerText = challenge.chordName;
            document.getElementById('alt_noteCount').innerText = challenge.noteCount;
            document.getElementById('alt_formulaDisplay').innerText = challenge.formula.join(' - ');

            // Create note indicators
            altUpdateNoteIndicators();
        }

        function altUpdateNoteIndicators() {
            const container = document.getElementById('alt_noteIndicators');
            let html = '';
            alt_challenge.noteNames.forEach((name, i) => {
                const pc = [...alt_challenge.pitchClasses][i];
                const isPlayed = alt_playedPitchClasses.has(pc);
                const colorClass = isPlayed ? 'bg-green-600 border-green-400' : 'bg-slate-700 border-slate-600';
                html += `<div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center text-sm font-bold border-2">${name}</div>`;
            });
            container.innerHTML = html;
        }

        function altOnNoteOn(midi) {
            highlightKey('alt_pianoSvg', midi, 'key-held');
            if (!alt_isPlaying || !alt_challenge) return;

            const notePitchClass = midi % 12;

            if (alt_challenge.pitchClasses.has(notePitchClass)) {
                // Correct note
                highlightKey('alt_pianoSvg', midi, 'key-active');
                alt_playedPitchClasses.add(notePitchClass);
                altUpdateNoteIndicators();

                // Check if all notes played
                if (alt_playedPitchClasses.size === alt_challenge.noteCount) {
                    const elapsed = ((Date.now() - alt_startTime) / 1000).toFixed(2);
                    const responseTime = parseFloat(elapsed);
                    alt_allTimes.push(responseTime);

                    // Track stats by full chord name (includes root)
                    const statKey = alt_challenge.chordName;
                    if (!alt_stats[statKey]) alt_stats[statKey] = { correct: 0, total: 0, slow: 0 };
                    alt_stats[statKey].total++;

                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        alt_slowCount++;
                        alt_stats[statKey].slow++;
                        document.getElementById('alt_slowDisplay').innerText = alt_slowCount;
                    }
                    document.getElementById('alt_responseTime').innerText = elapsed + 's';

                    if (!alt_roundHadMistake) {
                        alt_firstTryCorrect++;
                        alt_stats[statKey].correct++;
                    }
                    altShowFeedback('✓', true);
                    document.getElementById('alt_scoreDisplay').innerText = alt_firstTryCorrect;

                    alt_isPlaying = false; // Prevent mistakes during transition
                    setTimeout(() => { alt_isPlaying = true; altNextChallenge(); }, 1000);
                }
            } else {
                // Wrong note
                if (!alt_roundHadMistake) {
                    alt_totalMistakes++;
                    alt_roundHadMistake = true;
                    altShowFeedback('✗', false);
                    document.getElementById('alt_mistakesDisplay').innerText = alt_totalMistakes;
                }
                highlightKey('alt_pianoSvg', midi, 'key-wrong');
                setTimeout(() => clearHighlight('alt_pianoSvg', midi), 300);
            }
        }

        function altOnNoteOff(midi) {
            clearHighlight('alt_pianoSvg', midi);
        }

        function altShowFeedback(text, isCorrect) {
            const area = document.getElementById('alt_feedbackArea');
            const div = document.createElement('div');
            div.className = `text-6xl font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'} feedback-float`;
            div.innerText = text;
            area.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        function altShowGameComplete() {
            document.getElementById('alt_stopBtn').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.add('hidden');
            document.getElementById('alt_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('alt_playAgainBtn').classList.remove('hidden');
            document.getElementById('alt_newGameBtn').classList.remove('hidden');

            const accuracy = alt_currentRound > 0 ? Math.round((alt_firstTryCorrect / alt_currentRound) * 100) : 0;
            const avgTime = alt_allTimes.length > 0 ? (alt_allTimes.reduce((a, b) => a + b, 0) / alt_allTimes.length).toFixed(1) : 0;

            document.getElementById('alt_finalScore').innerText = `${alt_firstTryCorrect}/${alt_currentRound}`;
            document.getElementById('alt_finalAccuracy').innerText = accuracy + '%';
            document.getElementById('alt_finalMistakes').innerText = alt_totalMistakes;
            document.getElementById('alt_finalAvgTime').innerText = avgTime + 's';
            document.getElementById('alt_finalSlow').innerText = alt_slowCount;
            document.getElementById('alt_finalSlow').className = `text-3xl font-bold ${alt_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Weak areas
            const weakAreas = [];
            for (const [key, stats] of Object.entries(alt_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                if (pct < 70) weakAreas.push(`7${key} (${pct}%)`);
            }
            document.getElementById('alt_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Practice more: ' + weakAreas.join(', ') : '';

            // Save history
            alt_history.unshift({ date: new Date().toISOString(), score: alt_firstTryCorrect, totalRounds: alt_currentRound, accuracy, avgTime: parseFloat(avgTime), mistakes: alt_totalMistakes, slowCount: alt_slowCount });
            localStorage.setItem('altGameHistory', JSON.stringify(alt_history.slice(0, 50)));
            altSaveCumulativeStats();
            altRenderHistory();

            // Breakdown
            altShowBreakdown();
        }

        function altShowBreakdown() {
            const grid = document.getElementById('alt_breakdownGrid');
            grid.innerHTML = '';
            document.getElementById('alt_breakdownSection').classList.remove('hidden');

            for (const [key, stats] of Object.entries(alt_stats)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                const colorClass = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                grid.innerHTML += `<div class="p-3 rounded border ${colorClass}">
                    <p class="font-bold text-white">7${key}</p>
                    <p class="text-sm text-slate-300">${stats.correct}/${stats.total} (${pct}%)</p>
                </div>`;
            }
        }

        function altPlayAgain() {
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');
            document.getElementById('alt_challengeDisplay').classList.remove('hidden');
            document.getElementById('alt_stopBtn').classList.remove('hidden');
            alt_currentRound = 0; alt_firstTryCorrect = 0; alt_totalMistakes = 0; alt_slowCount = 0;
            alt_usedChallenges.clear(); alt_stats = {}; alt_allTimes = [];
            document.getElementById('alt_scoreDisplay').innerText = '0';
            document.getElementById('alt_mistakesDisplay').innerText = '0';
            document.getElementById('alt_slowDisplay').innerText = '0';
            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_responseTime').innerText = '--';
            altRunCountdown(3);
        }

        function altNewGame() {
            document.getElementById('alt_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('alt_playAgainBtn').classList.add('hidden');
            document.getElementById('alt_newGameBtn').classList.add('hidden');
            document.getElementById('alt_settingsPanel').classList.remove('hidden');
            document.getElementById('alt_startBtn').classList.remove('hidden');
            document.getElementById('alt_breakdownSection').classList.add('hidden');
            document.getElementById('alt_roundDisplay').innerText = '0';
            document.getElementById('alt_responseTime').innerText = '--';
        }

        function altLoadHistory() {
            const saved = localStorage.getItem('altGameHistory');
            if (saved) { alt_history = JSON.parse(saved); altRenderHistory(); }
            const savedCumulative = localStorage.getItem('altCumulativeStats');
            if (savedCumulative) { alt_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function altSaveCumulativeStats() {
            // Merge current game stats into cumulative stats
            for (const [chordName, data] of Object.entries(alt_stats)) {
                if (!alt_cumulativeStats[chordName]) {
                    alt_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, slow: 0 };
                }
                alt_cumulativeStats[chordName].attempts += data.total;
                alt_cumulativeStats[chordName].firstTry += data.correct;
                alt_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('altCumulativeStats', JSON.stringify(alt_cumulativeStats));
        }

        function altGetProblemAreas() {
            // Return chords sorted by combined problem score (mistakes + slow)
            const areas = [];
            for (const [name, data] of Object.entries(alt_cumulativeStats)) {
                if (data.attempts >= 3) { // Only include chords with enough data
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function altClearHistory() {
            if (confirm('Clear altered extensions game history?')) { alt_history = []; localStorage.setItem('altGameHistory', '[]'); altRenderHistory(); }
        }

        function altRenderHistory() {
            const content = document.getElementById('alt_historyContent');
            if (alt_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = alt_history.length;
            const avgAccuracy = Math.round(alt_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Find best game from displayed games: highest accuracy, then lowest slow count, then fastest time
            // Only games with slow data can qualify for personal best
            const displayedGames = alt_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                // Config: alterations
                const alts = game.config?.alterations || ['b9', '#9', '#11', 'b13'];
                const altStr = alts.length === 4 ? 'all' : alts.join('/');
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${altStr}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = altGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ADVANCED CHORDS MODE ============
        const ADV_CHORD_TYPES = {
            'halfdim': { name: 'halfdim', display: 'ø7', intervals: [0, 3, 6, 10], formula: 'R b3 b5 b7', noteCount: 4 },
            'dim7': { name: 'dim7', display: 'dim7', intervals: [0, 3, 6, 9], formula: 'R b3 b5 bb7', noteCount: 4 },
            'minMaj7': { name: 'minMaj7', display: 'mM7', intervals: [0, 3, 7, 11], formula: 'R b3 5 7', noteCount: 4 },
            'maj6': { name: 'maj6', display: '6', intervals: [0, 4, 7, 9], formula: 'R 3 5 6', noteCount: 4 },
            'min6': { name: 'min6', display: 'm6', intervals: [0, 3, 7, 9], formula: 'R b3 5 6', noteCount: 4 },
            'dom7sharp5': { name: 'dom7sharp5', display: '7#5', intervals: [0, 4, 8, 10], formula: 'R 3 #5 b7', noteCount: 4 },
            'dom13': { name: 'dom13', display: '13', intervals: [0, 4, 7, 10, 14, 21], formula: 'R 3 5 b7 9 13', noteCount: 5 }, // min 5 notes
            'dom7alt': { name: 'dom7alt', display: '7alt', intervals: [0, 4, 10, 3, 8], formula: 'R 3 b7 #9 b13', noteCount: 5 } // no 5th
        };

        let adv_isPlaying = false;
        let adv_challenge = null;
        let adv_usedChallenges = new Set();
        let adv_challengeStartTime = null;
        let adv_config = null;
        let adv_currentRound = 0;
        let adv_firstTryCorrect = 0;
        let adv_totalMistakes = 0;
        let adv_roundHadMistake = false;
        let adv_attemptHadMistake = false;
        let adv_stats = {};
        let adv_allTimes = [];
        let adv_slowCount = 0; // Chords taking > 2 seconds
        let adv_history = [];
        let adv_cumulativeStats = {}; // Persistent stats across all games

        function advStartGame() {
            saveAllSettings();
            const types = Array.from(document.querySelectorAll('.adv-type-cb:checked')).map(cb => cb.value);
            if (types.length === 0) { alert('Select at least one chord type!'); return; }

            const showHints = document.getElementById('adv_showHints').checked;
            adv_config = {
                types,
                totalRounds: parseInt(document.getElementById('adv_roundsSelect').value),
                showHints
            };
            adv_currentRound = 0; adv_firstTryCorrect = 0; adv_totalMistakes = 0; adv_slowCount = 0;
            adv_roundHadMistake = false; adv_attemptHadMistake = false;
            adv_usedChallenges = new Set(); adv_stats = {}; adv_allTimes = [];

            document.getElementById('adv_roundDisplay').innerText = '0';
            document.getElementById('adv_totalRoundsDisplay').innerText = adv_config.totalRounds;
            document.getElementById('adv_responseTime').innerText = '--';
            document.getElementById('adv_scoreDisplay').innerText = '0';
            document.getElementById('adv_mistakesDisplay').innerText = '0';
            document.getElementById('adv_slowDisplay').innerText = '0';
            document.getElementById('adv_startBtn').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.remove('hidden');
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_settingsPanel').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');

            // Show/hide formula hint based on setting
            document.getElementById('adv_chordFormula').style.display = showHints ? 'block' : 'none';

            advRunCountdown(3);
        }

        function advRunCountdown(count) {
            if (count > 0) {
                document.getElementById('adv_chordRoot').innerText = count;
                document.getElementById('adv_chordType').innerText = '';
                document.getElementById('adv_chordFormula').innerText = '';
                document.getElementById('adv_heldNotes').innerText = 'Get ready...';
                setTimeout(() => advRunCountdown(count - 1), 800);
            } else {
                adv_isPlaying = true;
                advNextChallenge();
            }
        }

        function advStopGame() {
            adv_isPlaying = false;
            adv_challenge = null;
            clearAllHighlights('adv_pianoSvg');
            document.getElementById('adv_settingsPanel').classList.remove('hidden');
            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.add('hidden');
            document.getElementById('adv_startBtn').classList.remove('hidden');
        }

        function advNextChallenge() {
            if (!adv_isPlaying) return;
            if (adv_currentRound >= adv_config.totalRounds) { advEndGame(); return; }

            clearAllHighlights('adv_pianoSvg');
            adv_currentRound++;
            adv_roundHadMistake = false;
            adv_attemptHadMistake = false;

            document.getElementById('adv_roundDisplay').innerText = adv_currentRound;

            // Reset if all combinations have been used
            const maxUnique = 12 * adv_config.types.length;
            if (adv_usedChallenges.size >= maxUnique) {
                adv_usedChallenges.clear();
            }

            let root, type, challengeKey;
            let attempts = 0;
            do {
                root = Math.floor(Math.random() * 12);
                type = adv_config.types[Math.floor(Math.random() * adv_config.types.length)];
                challengeKey = `${root}-${type}`;
                attempts++;
            } while (adv_usedChallenges.has(challengeKey) && attempts < 100);

            adv_usedChallenges.add(challengeKey);

            const chordDef = ADV_CHORD_TYPES[type];
            const requiredPitchClasses = new Set(chordDef.intervals.map(i => (root + i) % 12));

            adv_challenge = {
                root,
                type,
                requiredPitchClasses,
                noteCount: chordDef.noteCount,
                name: `${NOTE_NAMES[root]} ${chordDef.display}`
            };
            adv_challengeStartTime = Date.now();

            document.getElementById('adv_chordRoot').innerText = NOTE_NAMES[root];
            document.getElementById('adv_chordType').innerText = chordDef.display;
            document.getElementById('adv_chordFormula').innerText = chordDef.formula;
            document.getElementById('adv_heldNotes').innerText = 'Holding: --';
        }

        function advOnNoteOn(midi) {
            highlightKey('adv_pianoSvg', midi, 'key-held');

            if (!adv_isPlaying || !adv_challenge) return;

            const notePitchClass = midi % 12;
            const isWrongNote = !adv_challenge.requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!adv_attemptHadMistake) {
                    adv_totalMistakes++;
                    adv_attemptHadMistake = true;
                    adv_roundHadMistake = true;
                    advShowFeedback('✗', false);
                    advUpdateScoreDisplay();
                }
                highlightKey('adv_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('adv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const hasAllRequired = [...adv_challenge.requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= adv_challenge.noteCount) {
                const responseTime = (Date.now() - adv_challengeStartTime) / 1000;
                const chordKey = adv_challenge.name;

                if (!adv_stats[chordKey]) adv_stats[chordKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                adv_stats[chordKey].total++;

                if (!adv_roundHadMistake) {
                    adv_firstTryCorrect++;
                    adv_stats[chordKey].firstTry++;
                    adv_stats[chordKey].times.push(responseTime);
                    adv_allTimes.push(responseTime);
                    // Track slow responses (> 2 seconds)
                    const wasSlow = responseTime > 2;
                    if (wasSlow) {
                        adv_slowCount++;
                        adv_stats[chordKey].slow++;
                        document.getElementById('adv_slowDisplay').innerText = adv_slowCount;
                    }
                    advShowFeedback('✓', true, responseTime);
                    advUpdateResponseTime(responseTime);
                } else {
                    advShowFeedback('✓', true);
                }
                advUpdateScoreDisplay();

                // Highlight correct notes green
                heldNotes.forEach(n => {
                    if (adv_challenge.requiredPitchClasses.has(n % 12)) {
                        highlightKey('adv_pianoSvg', n, 'key-active');
                    }
                });

                adv_isPlaying = false; // Prevent mistakes during transition
                setTimeout(() => { adv_isPlaying = true; advNextChallenge(); }, 600);
            }
        }

        function advOnNoteOff(midi) {
            highlightKey('adv_pianoSvg', midi, 'key-held', false);
            highlightKey('adv_pianoSvg', midi, 'key-active', false);
            highlightKey('adv_pianoSvg', midi, 'key-wrong', false);

            if (adv_isPlaying && adv_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('adv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function advUpdateResponseTime(seconds) {
            const el = document.getElementById('adv_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function advUpdateScoreDisplay() {
            document.getElementById('adv_scoreDisplay').innerText = adv_firstTryCorrect;
            document.getElementById('adv_mistakesDisplay').innerText = adv_totalMistakes;
        }

        function advShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('adv_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function advEndGame() {
            adv_isPlaying = false;
            adv_challenge = null;
            clearAllHighlights('adv_pianoSvg');

            const accuracy = adv_config.totalRounds > 0 ? Math.min(100, Math.round((adv_firstTryCorrect / adv_config.totalRounds) * 100)) : 0;
            const avgTime = adv_allTimes.length > 0 ? adv_allTimes.reduce((a, b) => a + b, 0) / adv_allTimes.length : 0;

            adv_history.unshift({
                date: new Date().toISOString(),
                config: { ...adv_config },
                score: adv_firstTryCorrect,
                totalRounds: adv_config.totalRounds,
                accuracy, avgTime,
                totalMistakes: adv_totalMistakes,
                slowCount: adv_slowCount,
                stats: JSON.parse(JSON.stringify(adv_stats))
            });
            if (adv_history.length > 50) adv_history.pop();
            localStorage.setItem('advGameHistory', JSON.stringify(adv_history));
            advUpdateCumulativeStats();

            advShowGameComplete();
        }

        function advShowGameComplete() {
            const accuracy = adv_currentRound > 0 ? Math.min(100, Math.round((adv_firstTryCorrect / adv_currentRound) * 100)) : 0;
            const avgTime = adv_allTimes.length > 0 ? adv_allTimes.reduce((a, b) => a + b, 0) / adv_allTimes.length : 0;

            document.getElementById('adv_finalScore').innerText = `${adv_firstTryCorrect}/${adv_currentRound}`;
            document.getElementById('adv_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('adv_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('adv_finalMistakes').innerText = adv_totalMistakes;
            document.getElementById('adv_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('adv_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('adv_finalSlow').innerText = adv_slowCount;
            document.getElementById('adv_finalSlow').className = `text-3xl font-bold ${adv_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(adv_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('adv_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('adv_stopBtn').classList.add('hidden');
            document.getElementById('adv_playAgainBtn').classList.remove('hidden');
            document.getElementById('adv_newGameBtn').classList.remove('hidden');

            advShowBreakdown();
            advRenderHistory();
        }

        function advShowBreakdown() {
            const grid = document.getElementById('adv_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(adv_stats).length === 0) { document.getElementById('adv_breakdownSection').classList.add('hidden'); return; }

            for (const [chord, data] of Object.entries(adv_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chord}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('adv_breakdownSection').classList.remove('hidden');
        }

        function advPlayAgain() {
            adv_currentRound = 0; adv_firstTryCorrect = 0; adv_totalMistakes = 0; adv_slowCount = 0;
            adv_roundHadMistake = false; adv_attemptHadMistake = false;
            adv_usedChallenges = new Set(); adv_stats = {}; adv_allTimes = [];
            document.getElementById('adv_roundDisplay').innerText = '0';
            document.getElementById('adv_responseTime').innerText = '--';
            document.getElementById('adv_scoreDisplay').innerText = '0';
            document.getElementById('adv_mistakesDisplay').innerText = '0';
            document.getElementById('adv_slowDisplay').innerText = '0';
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_stopBtn').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.remove('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');
            advRunCountdown(3);
        }

        function advNewGame() {
            document.getElementById('adv_settingsPanel').classList.remove('hidden');
            document.getElementById('adv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('adv_challengeDisplay').classList.add('hidden');
            document.getElementById('adv_playAgainBtn').classList.add('hidden');
            document.getElementById('adv_newGameBtn').classList.add('hidden');
            document.getElementById('adv_startBtn').classList.remove('hidden');
            document.getElementById('adv_breakdownSection').classList.add('hidden');
        }

        function advLoadHistory() {
            const saved = localStorage.getItem('advGameHistory');
            if (saved) { adv_history = JSON.parse(saved); advRenderHistory(); }
            const savedCumulative = localStorage.getItem('advCumulativeStats');
            if (savedCumulative) { adv_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function advUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(adv_stats)) {
                if (!adv_cumulativeStats[chordName]) {
                    adv_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                adv_cumulativeStats[chordName].attempts += data.total;
                adv_cumulativeStats[chordName].firstTry += data.firstTry;
                adv_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                adv_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('advCumulativeStats', JSON.stringify(adv_cumulativeStats));
        }

        function advGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(adv_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function advClearHistory() {
            if (confirm('Clear Advanced Chords game history?')) { adv_history = []; localStorage.setItem('advGameHistory', '[]'); advRenderHistory(); }
        }

        function advRenderHistory() {
            const content = document.getElementById('adv_historyContent');
            if (adv_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = adv_history.length;
            const avgAccuracy = Math.min(100, Math.round(adv_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            // Only games with slow data can qualify for personal best
            const displayedGames = adv_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.min(100, Math.max(...gamesWithSlowData.map(g => Math.min(g.accuracy, 100)))) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => Math.min(g.accuracy, 100) === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && Math.min(g.accuracy, 100) === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const types = game.config?.types || [];
                const typeStr = types.length >= 6 ? 'all' : types.slice(0, 3).map(t => ADV_CHORD_TYPES[t]?.display || t).join('/') + (types.length > 3 ? '...' : '');
                const displayAccuracy = Math.min(game.accuracy, 100);
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-purple-400 ml-1">${typeStr}</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = advGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ MINOR ii-V-i MODE ============
        // Minor ii-V-i chord intervals (not in CHORD_TYPES)
        const MINOR_IIVI_CHORDS = {
            'halfdim': { intervals: [0, 3, 6, 10], display: 'ø7' },  // R b3 b5 b7
            'dom7': { intervals: [0, 4, 7, 10], display: '7' },       // R 3 5 b7
            'minMaj7': { intervals: [0, 3, 7, 11], display: 'mM7' }   // R b3 5 7
        };

        let miivi_isPlaying = false;
        let miivi_challenge = null;
        let miivi_usedKeys = new Set();
        let miivi_challengeStartTime = null;
        let miivi_stepStartTime = null;
        let miivi_stepTimes = [];
        let miivi_config = null;
        let miivi_currentRound = 0;
        let miivi_firstTryCorrect = 0;
        let miivi_totalMistakes = 0;
        let miivi_roundHadMistake = false;
        let miivi_attemptHadMistake = false;
        let miivi_stats = {};
        let miivi_allTimes = [];
        let miivi_slowCount = 0; // Chords taking > 2 seconds
        let miivi_history = [];
        let miivi_cumulativeStats = {}; // Persistent stats across all games

        function miiviGetProgression(key) {
            // Minor ii-V-i:
            // ii = half-diminished built on 2nd degree
            // V = dominant 7 built on 5th degree
            // i = minor-major 7 built on root
            const iiRoot = (key + 2) % 12;
            const VRoot = (key + 7) % 12;
            const iRoot = key;

            return [
                {
                    root: iiRoot,
                    type: 'halfdim',
                    name: NOTE_NAMES[iiRoot] + 'ø7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.halfdim.intervals.map(i => (iiRoot + i) % 12))
                },
                {
                    root: VRoot,
                    type: 'dom7',
                    name: NOTE_NAMES[VRoot] + '7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.dom7.intervals.map(i => (VRoot + i) % 12))
                },
                {
                    root: iRoot,
                    type: 'minMaj7',
                    name: NOTE_NAMES[iRoot] + 'mM7',
                    pitchClasses: new Set(MINOR_IIVI_CHORDS.minMaj7.intervals.map(i => (iRoot + i) % 12))
                }
            ];
        }

        function miiviStartGame() {
            saveAllSettings();
            miivi_config = {
                totalRounds: parseInt(document.getElementById('miivi_roundsSelect').value)
            };
            miivi_currentRound = 0; miivi_firstTryCorrect = 0; miivi_totalMistakes = 0; miivi_slowCount = 0;
            miivi_roundHadMistake = false; miivi_attemptHadMistake = false; miivi_usedKeys = new Set();
            miivi_stats = {}; miivi_allTimes = [];

            document.getElementById('miivi_roundDisplay').innerText = '0';
            document.getElementById('miivi_totalRoundsDisplay').innerText = miivi_config.totalRounds;
            document.getElementById('miivi_responseTime').innerText = '--';
            document.getElementById('miivi_scoreDisplay').innerText = '0';
            document.getElementById('miivi_mistakesDisplay').innerText = '0';
            document.getElementById('miivi_slowDisplay').innerText = '0';
            document.getElementById('miivi_startBtn').classList.add('hidden');
            document.getElementById('miivi_stopBtn').classList.remove('hidden');
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_settingsPanel').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');

            miiviRunCountdown(3);
        }

        function miiviRunCountdown(count) {
            if (count > 0) {
                document.getElementById('miivi_keyDisplay').innerText = count;
                document.getElementById('miivi_chord_ii').innerText = '...';
                document.getElementById('miivi_chord_V').innerText = '...';
                document.getElementById('miivi_chord_i').innerText = '...';
                document.getElementById('miivi_heldNotes').innerText = 'Get ready...';
                miiviResetStepStyles();
                setTimeout(() => miiviRunCountdown(count - 1), 800);
            } else {
                miivi_isPlaying = true;
                miiviNextChallenge();
            }
        }

        function miiviResetStepStyles() {
            ['ii', 'V', 'i'].forEach(step => {
                const el = document.querySelector(`#miivi_step_${step} > div`);
                el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                document.getElementById(`miivi_time_${step}`).innerText = '--';
            });
        }

        function miiviHighlightCurrentStep() {
            const steps = ['ii', 'V', 'i'];
            steps.forEach((step, idx) => {
                const el = document.querySelector(`#miivi_step_${step} > div`);
                if (idx < miivi_challenge.currentStep) {
                    el.className = 'w-20 h-16 rounded-lg bg-green-700 flex flex-col items-center justify-center mb-1 border-2 border-green-500';
                } else if (idx === miivi_challenge.currentStep) {
                    el.className = 'w-20 h-16 rounded-lg bg-purple-700 flex flex-col items-center justify-center mb-1 border-2 border-purple-400';
                } else {
                    el.className = 'w-20 h-16 rounded-lg bg-slate-700 flex flex-col items-center justify-center mb-1 border-2 border-slate-600';
                }
            });
        }

        function miiviStopGame() {
            miivi_isPlaying = false;
            miivi_challenge = null;
            clearAllHighlights('miivi_pianoSvg');
            miiviShowGameComplete();
        }

        function miiviNextChallenge() {
            if (!miivi_isPlaying) return;
            if (miivi_currentRound >= miivi_config.totalRounds) { miiviEndGame(); return; }

            clearAllHighlights('miivi_pianoSvg');
            miivi_currentRound++;
            miivi_roundHadMistake = false;
            miivi_attemptHadMistake = false;
            miivi_stepTimes = [];

            if (miivi_usedKeys.size >= 12) {
                miivi_usedKeys.clear();
            }

            // Pick randomly from remaining unused keys
            const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const unusedKeys = allKeys.filter(k => !miivi_usedKeys.has(k));
            const key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            miivi_usedKeys.add(key);
            const chords = miiviGetProgression(key);

            miivi_challenge = { key, chords, currentStep: 0 };
            miivi_challengeStartTime = Date.now();
            miivi_stepStartTime = Date.now();

            document.getElementById('miivi_keyDisplay').innerText = NOTE_NAMES[key] + ' minor';
            document.getElementById('miivi_chord_ii').innerText = chords[0].name;
            document.getElementById('miivi_chord_V').innerText = chords[1].name;
            document.getElementById('miivi_chord_i').innerText = chords[2].name;
            document.getElementById('miivi_heldNotes').innerText = 'Holding: --';
            document.getElementById('miivi_roundDisplay').innerText = miivi_currentRound;

            miiviResetStepStyles();
            miiviHighlightCurrentStep();
        }

        function miiviOnNoteOn(midi) {
            highlightKey('miivi_pianoSvg', midi, 'key-held');

            if (!miivi_isPlaying || !miivi_challenge) return;

            const currentChord = miivi_challenge.chords[miivi_challenge.currentStep];
            const notePitchClass = midi % 12;
            const requiredPitchClasses = currentChord.pitchClasses;
            const isWrongNote = !requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!miivi_attemptHadMistake) {
                    miivi_totalMistakes++;
                    miivi_attemptHadMistake = true;
                    miivi_roundHadMistake = true;
                    miiviShowFeedback('✗', false);
                    miiviUpdateScoreDisplay();
                }
                highlightKey('miivi_pianoSvg', midi, 'key-wrong');
            }

            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('miivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            const hasAllRequired = [...requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= 4) {
                const stepTime = (Date.now() - miivi_stepStartTime) / 1000;
                miivi_stepTimes.push(stepTime);

                // Track slow responses (> 2 seconds)
                if (stepTime > 2) {
                    miivi_slowCount++;
                    document.getElementById('miivi_slowDisplay').innerText = miivi_slowCount;
                }

                const stepNames = ['ii', 'V', 'i'];
                document.getElementById(`miivi_time_${stepNames[miivi_challenge.currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                heldNotes.forEach(n => {
                    if (requiredPitchClasses.has(n % 12)) {
                        highlightKey('miivi_pianoSvg', n, 'key-active');
                    }
                });

                const keyName = NOTE_NAMES[miivi_challenge.key] + 'm';
                if (!miivi_stats[keyName]) miivi_stats[keyName] = { firstTry: 0, total: 0, times: [], slow: 0 };

                // Track slow for this key if step was slow
                const wasSlow = stepTime > 2;
                if (wasSlow) {
                    miivi_stats[keyName].slow++;
                }

                if (!miivi_attemptHadMistake) {
                    miivi_firstTryCorrect++;
                    miivi_stats[keyName].firstTry++;
                    miivi_stats[keyName].times.push(stepTime);
                    miivi_allTimes.push(stepTime);
                    miiviShowFeedback('✓', true, stepTime);
                } else {
                    miiviShowFeedback('✓', true);
                }
                miivi_stats[keyName].total++;
                miiviUpdateScoreDisplay();

                miivi_attemptHadMistake = false;

                if (miivi_challenge.currentStep < 2) {
                    miivi_challenge.currentStep++;
                    miivi_stepStartTime = Date.now();
                    setTimeout(() => {
                        clearAllHighlights('miivi_pianoSvg');
                        miiviHighlightCurrentStep();
                    }, 400);
                } else {
                    // Progression complete!
                    miivi_isPlaying = false; // Prevent mistakes during transition
                    const avgChordTime = miivi_stepTimes.reduce((a, b) => a + b, 0) / miivi_stepTimes.length;
                    miiviUpdateResponseTime(avgChordTime);
                    setTimeout(() => { miivi_isPlaying = true; miiviNextChallenge(); }, 600);
                }
            }
        }

        function miiviOnNoteOff(midi) {
            highlightKey('miivi_pianoSvg', midi, 'key-held', false);
            highlightKey('miivi_pianoSvg', midi, 'key-active', false);
            highlightKey('miivi_pianoSvg', midi, 'key-wrong', false);

            if (miivi_isPlaying && miivi_challenge) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('miivi_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function miiviUpdateResponseTime(seconds) {
            const el = document.getElementById('miivi_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function miiviUpdateScoreDisplay() {
            document.getElementById('miivi_scoreDisplay').innerText = miivi_firstTryCorrect;
            document.getElementById('miivi_mistakesDisplay').innerText = miivi_totalMistakes;
        }

        function miiviShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('miivi_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function miiviEndGame() {
            miivi_isPlaying = false;
            miivi_challenge = null;
            clearAllHighlights('miivi_pianoSvg');

            const totalChords = miivi_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((miivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = miivi_allTimes.length > 0 ? miivi_allTimes.reduce((a, b) => a + b, 0) / miivi_allTimes.length : 0;

            miivi_history.unshift({
                date: new Date().toISOString(),
                config: { ...miivi_config },
                score: miivi_firstTryCorrect,
                totalChords,
                accuracy, avgTime,
                totalMistakes: miivi_totalMistakes,
                slowCount: miivi_slowCount,
                stats: JSON.parse(JSON.stringify(miivi_stats))
            });
            if (miivi_history.length > 50) miivi_history.pop();
            localStorage.setItem('minorIiviGameHistory', JSON.stringify(miivi_history));
            miiviUpdateCumulativeStats();

            miiviShowGameComplete();
        }

        function miiviShowGameComplete() {
            const totalChords = miivi_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((miivi_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = miivi_allTimes.length > 0 ? miivi_allTimes.reduce((a, b) => a + b, 0) / miivi_allTimes.length : 0;

            document.getElementById('miivi_finalScore').innerText = `${miivi_firstTryCorrect}/${totalChords}`;
            document.getElementById('miivi_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('miivi_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('miivi_finalMistakes').innerText = miivi_totalMistakes;
            document.getElementById('miivi_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('miivi_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('miivi_finalSlow').innerText = miivi_slowCount;
            document.getElementById('miivi_finalSlow').className = `text-3xl font-bold ${miivi_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            const weak = Object.entries(miivi_stats).filter(([_, s]) => s.total >= 2 && (s.firstTry / s.total) < 0.7).map(([name, _]) => name);
            document.getElementById('miivi_finalWeakAreas').innerText = weak.length > 0 ? `Focus on: ${weak.join(', ')}` : '';

            document.getElementById('miivi_challengeDisplay').classList.add('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('miivi_stopBtn').classList.add('hidden');
            document.getElementById('miivi_playAgainBtn').classList.remove('hidden');
            document.getElementById('miivi_newGameBtn').classList.remove('hidden');

            miiviShowBreakdown();
            miiviRenderHistory();
        }

        function miiviShowBreakdown() {
            const grid = document.getElementById('miivi_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(miivi_stats).length === 0) { document.getElementById('miivi_breakdownSection').classList.add('hidden'); return; }

            for (const [keyName, data] of Object.entries(miivi_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('miivi_breakdownSection').classList.remove('hidden');
        }

        function miiviPlayAgain() {
            miivi_currentRound = 0; miivi_firstTryCorrect = 0; miivi_totalMistakes = 0; miivi_slowCount = 0;
            miivi_roundHadMistake = false; miivi_attemptHadMistake = false;
            miivi_usedKeys = new Set(); miivi_stats = {}; miivi_allTimes = [];
            document.getElementById('miivi_roundDisplay').innerText = '0';
            document.getElementById('miivi_responseTime').innerText = '--';
            document.getElementById('miivi_scoreDisplay').innerText = '0';
            document.getElementById('miivi_mistakesDisplay').innerText = '0';
            document.getElementById('miivi_slowDisplay').innerText = '0';
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_stopBtn').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.remove('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');
            miiviRunCountdown(3);
        }

        function miiviNewGame() {
            document.getElementById('miivi_settingsPanel').classList.remove('hidden');
            document.getElementById('miivi_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('miivi_challengeDisplay').classList.add('hidden');
            document.getElementById('miivi_playAgainBtn').classList.add('hidden');
            document.getElementById('miivi_newGameBtn').classList.add('hidden');
            document.getElementById('miivi_startBtn').classList.remove('hidden');
            document.getElementById('miivi_breakdownSection').classList.add('hidden');
        }

        function miiviLoadHistory() {
            const saved = localStorage.getItem('minorIiviGameHistory');
            if (saved) { miivi_history = JSON.parse(saved); miiviRenderHistory(); }
            const savedCumulative = localStorage.getItem('miiviCumulativeStats');
            if (savedCumulative) { miivi_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function miiviUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(miivi_stats)) {
                if (!miivi_cumulativeStats[keyName]) {
                    miivi_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                miivi_cumulativeStats[keyName].attempts += data.total;
                miivi_cumulativeStats[keyName].firstTry += data.firstTry;
                miivi_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                miivi_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('miiviCumulativeStats', JSON.stringify(miivi_cumulativeStats));
        }

        function miiviGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(miivi_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function miiviClearHistory() {
            if (confirm('Clear Minor ii-V-i game history?')) { miivi_history = []; localStorage.setItem('minorIiviGameHistory', '[]'); miiviRenderHistory(); }
        }

        function miiviRenderHistory() {
            const content = document.getElementById('miivi_historyContent');
            if (miivi_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = miivi_history.length;
            const avgAccuracy = Math.min(100, Math.round(miivi_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            // Only games with slow data can qualify for personal best
            const displayedGames = miivi_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.min(100, Math.max(...gamesWithSlowData.map(g => Math.min(g.accuracy, 100)))) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => Math.min(g.accuracy, 100) === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && Math.min(g.accuracy, 100) === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const rounds = game.config?.totalRounds || (game.totalChords / 3);
                const displayAccuracy = Math.min(game.accuracy, 100);
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${rounds}r</span><span class="text-xs text-purple-400 ml-1">minor</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = miiviGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ KENNY BARRON MODE ============
        // Kenny Barron voicing: stacked 5ths
        // Minor 11: LH (R-5-9), RH (b3-b7-11) - intervals [0,7,2] + [3,10,5]
        // Major 7#11: LH (R-5-9), RH (3-7-#11) - intervals [0,7,2] + [4,11,6]

        const KB_VOICINGS = {
            minor: {
                name: 'm11',
                lh: [0, 7, 2],      // R, 5, 9 (mod 12)
                rh: [3, 10, 5],     // b3, b7, 11 (mod 12)
                lhLabels: ['R', '5', '9'],
                rhLabels: ['b3', 'b7', '11']
            },
            major: {
                name: 'maj7#11',
                lh: [0, 7, 2],      // R, 5, 9 (mod 12)
                rh: [4, 11, 6],     // 3, 7, #11 (mod 12)
                lhLabels: ['R', '5', '9'],
                rhLabels: ['3', '7', '#11']
            }
        };

        let kb_gameActive = false;
        let kb_isPlaying = false;
        let kb_config = {};
        let kb_challenge = null;
        let kb_currentRound = 0;
        let kb_usedKeys = new Set();
        let kb_startTime = null;
        let kb_timerInterval = null;
        let kb_history = [];
        let kb_cumulativeStats = {}; // Persistent stats across all games
        let kb_stats = {};
        let kb_allTimes = [];
        let kb_slowCount = 0; // Chords taking > 2 seconds
        let kb_firstTryCorrect = 0;
        let kb_totalMistakes = 0;
        let kb_roundHadMistake = false;

        function kbStartGame() {
            saveAllSettings();
            const chordType = document.getElementById('kb_chordType').value;
            const voicingType = document.getElementById('kb_voicingType').value;
            const totalRounds = parseInt(document.getElementById('kb_rounds').value);
            const showHints = document.getElementById('kb_showHints').checked;

            kb_config = { chordType, voicingType, totalRounds, showHints };
            kb_currentRound = 0;
            kb_usedKeys = new Set();
            kb_stats = {};
            kb_allTimes = [];
            kb_slowCount = 0;
            kb_firstTryCorrect = 0;
            kb_totalMistakes = 0;

            document.getElementById('kb_settingsPanel').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.remove('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_totalRounds').innerText = totalRounds;
            document.getElementById('kb_roundDisplay').innerText = '0';
            document.getElementById('kb_scoreDisplay').innerText = '0';
            document.getElementById('kb_mistakesDisplay').innerText = '0';
            document.getElementById('kb_slowDisplay').innerText = '0';
            document.getElementById('kb_responseTime').innerText = '--';

            document.getElementById('kb_startBtn').classList.add('hidden');
            document.getElementById('kb_stopBtn').classList.remove('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');

            kbRunCountdown(3);
        }

        function kbRunCountdown(count) {
            if (count > 0) {
                document.getElementById('kb_chordDisplay').innerText = count;
                document.getElementById('kb_lhNotes').innerText = '...';
                document.getElementById('kb_rhNotes').innerText = '...';
                document.getElementById('kb_heldNotes').innerText = 'Get ready...';
                document.getElementById('kb_noteIndicators').innerHTML = '';
                setTimeout(() => kbRunCountdown(count - 1), 800);
            } else {
                kb_isPlaying = true;
                kbNextChallenge();
            }
        }

        function kbStopGame() {
            kb_gameActive = false;
            kb_isPlaying = false;
            if (kb_timerInterval) clearInterval(kb_timerInterval);
            clearAllHighlights('kb_pianoSvg');
            document.getElementById('kb_settingsPanel').classList.remove('hidden');
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_startBtn').classList.remove('hidden');
            document.getElementById('kb_stopBtn').classList.add('hidden');
        }

        function kbGetVoicing(root, type) {
            const voicing = KB_VOICINGS[type];
            const isSawnOff = kb_config.voicingType === 'sawnoff';

            // Calculate pitch classes
            const lhPitchClasses = voicing.lh.map(i => (root + i) % 12);
            const rhIntervals = isSawnOff ? voicing.rh.slice(0, 2) : voicing.rh;
            const rhPitchClasses = rhIntervals.map(i => (root + i) % 12);

            const allPitchClasses = new Set([...lhPitchClasses, ...rhPitchClasses]);

            // Note names for display
            const lhNotes = lhPitchClasses.map(pc => NOTE_NAMES[pc]);
            const rhNotes = rhPitchClasses.map(pc => NOTE_NAMES[pc]);

            const lhLabels = voicing.lhLabels;
            const rhLabels = isSawnOff ? voicing.rhLabels.slice(0, 2) : voicing.rhLabels;

            return {
                pitchClasses: allPitchClasses,
                lhPitchClasses,
                rhPitchClasses,
                lhNotes,
                rhNotes,
                lhLabels,
                rhLabels,
                chordName: NOTE_NAMES[root] + voicing.name,
                type
            };
        }

        function kbNextChallenge() {
            clearAllHighlights('kb_pianoSvg');
            kb_currentRound++;
            kb_roundHadMistake = false;

            if (kb_currentRound > kb_config.totalRounds) {
                kbGameComplete();
                return;
            }

            // Pick random unused key
            if (kb_usedKeys.size >= 12) kb_usedKeys.clear();
            const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const unusedKeys = allKeys.filter(k => !kb_usedKeys.has(k));
            const key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            kb_usedKeys.add(key);

            // Pick chord type
            let chordType;
            if (kb_config.chordType === 'both') {
                chordType = Math.random() < 0.5 ? 'minor' : 'major';
            } else {
                chordType = kb_config.chordType;
            }

            const voicing = kbGetVoicing(key, chordType);
            kb_challenge = { key, voicing };

            // Update UI
            document.getElementById('kb_roundDisplay').innerText = kb_currentRound;
            document.getElementById('kb_chordDisplay').innerText = voicing.chordName;
            if (kb_config.showHints) {
                document.getElementById('kb_lhNotes').innerText = voicing.lhLabels.join(' - ');
                document.getElementById('kb_rhNotes').innerText = voicing.rhLabels.join(' - ');
            } else {
                const lhDots = voicing.lhLabels.map(() => '•').join('   ');
                const rhDots = voicing.rhLabels.map(() => '•').join('   ');
                document.getElementById('kb_lhNotes').innerText = lhDots;
                document.getElementById('kb_rhNotes').innerText = rhDots;
            }
            document.getElementById('kb_heldNotes').innerText = 'Holding: --';
            document.getElementById('kb_scoreDisplay').innerText = kb_firstTryCorrect;
            document.getElementById('kb_mistakesDisplay').innerText = kb_totalMistakes;

            kbUpdateNoteIndicators();
            kb_startTime = Date.now();
            kb_gameActive = true;
        }

        function kbUpdateNoteIndicators() {
            const container = document.getElementById('kb_noteIndicators');
            const allPitchClasses = [...kb_challenge.voicing.lhPitchClasses, ...kb_challenge.voicing.rhPitchClasses];
            const allNotes = [...kb_challenge.voicing.lhNotes, ...kb_challenge.voicing.rhNotes];

            let html = '';
            allPitchClasses.forEach((pc, i) => {
                const isPlayed = kbGetHeldPitchClasses().has(pc);
                const colorClass = isPlayed ? 'bg-teal-600 border-teal-400' : 'bg-slate-700 border-slate-600';
                // Show checkmark when played
                const content = isPlayed ? '✓' : '';
                html += `<div class="w-8 h-8 rounded-full ${colorClass} flex items-center justify-center text-xs font-bold border-2">${content}</div>`;
            });
            container.innerHTML = html;
        }

        function kbGetHeldPitchClasses() {
            const pitchClasses = new Set();
            heldNotes.forEach(note => pitchClasses.add(note % 12));
            return pitchClasses;
        }

        function kbHandleNoteOn(note) {
            highlightKey('kb_pianoSvg', note, 'key-held');
            if (!kb_gameActive || !kb_challenge) return;

            kbUpdateHeldDisplay();
            kbUpdateNoteIndicators();
            kbCheckVoicing();
        }

        function kbHandleNoteOff(note) {
            highlightKey('kb_pianoSvg', note, 'key-held', false);
            highlightKey('kb_pianoSvg', note, 'key-active', false);
            highlightKey('kb_pianoSvg', note, 'key-wrong', false);
            if (!kb_gameActive || !kb_challenge) return;

            kbUpdateHeldDisplay();
            kbUpdateNoteIndicators();
        }

        function kbUpdateHeldDisplay() {
            const noteNames = [...heldNotes].map(n => NOTE_NAMES[n % 12]).join(', ');
            document.getElementById('kb_heldNotes').innerText = 'Holding: ' + (noteNames || '--');
        }

        function kbCheckVoicing() {
            const heldPitchClasses = kbGetHeldPitchClasses();
            const targetPitchClasses = kb_challenge.voicing.pitchClasses;

            // Check for wrong notes
            for (const pc of heldPitchClasses) {
                if (!targetPitchClasses.has(pc)) {
                    kb_roundHadMistake = true;
                    kb_totalMistakes++;
                    document.getElementById('kb_mistakesDisplay').innerText = kb_totalMistakes;
                    kbShowFeedback('✗', 'text-red-400');
                    return;
                }
            }

            // Check if all notes are played
            if (heldPitchClasses.size === targetPitchClasses.size) {
                let allCorrect = true;
                for (const pc of targetPitchClasses) {
                    if (!heldPitchClasses.has(pc)) {
                        allCorrect = false;
                        break;
                    }
                }

                if (allCorrect) {
                    const elapsed = (Date.now() - kb_startTime) / 1000;
                    kb_gameActive = false;

                    if (!kb_roundHadMistake) kb_firstTryCorrect++;
                    kb_allTimes.push(elapsed);

                    // Track stats by key
                    const keyName = NOTE_NAMES[kb_challenge.key];
                    if (!kb_stats[keyName]) kb_stats[keyName] = { total: 0, firstTry: 0, times: [], slow: 0 };
                    kb_stats[keyName].total++;
                    if (!kb_roundHadMistake) kb_stats[keyName].firstTry++;
                    kb_stats[keyName].times.push(elapsed);

                    // Track slow responses (> 2 seconds)
                    const wasSlow = elapsed > 2;
                    if (wasSlow) {
                        kb_slowCount++;
                        kb_stats[keyName].slow++;
                        document.getElementById('kb_slowDisplay').innerText = kb_slowCount;
                    }

                    // Update response time display
                    const avgTime = kb_allTimes.reduce((a, b) => a + b, 0) / kb_allTimes.length;
                    const timerEl = document.getElementById('kb_responseTime');
                    timerEl.innerText = avgTime.toFixed(1) + 's';
                    timerEl.className = 'text-2xl font-mono ' + (avgTime < 3 ? 'timer-fast' : avgTime < 6 ? 'timer-medium' : 'timer-slow');

                    kbShowFeedback('✓', 'text-green-400');
                    setTimeout(kbNextChallenge, 800);
                }
            }
        }

        function kbShowFeedback(text, colorClass) {
            const area = document.getElementById('kb_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-6xl font-bold ${colorClass} feedback-anim`;
            el.innerText = text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function kbGameComplete() {
            kb_gameActive = false;
            kb_isPlaying = false;

            const accuracy = Math.round((kb_firstTryCorrect / kb_config.totalRounds) * 100);
            const avgTime = kb_allTimes.length > 0 ? kb_allTimes.reduce((a, b) => a + b, 0) / kb_allTimes.length : 0;

            // Save to history
            kb_history.unshift({
                date: new Date().toISOString(),
                accuracy,
                avgTime,
                totalRounds: kb_config.totalRounds,
                firstTry: kb_firstTryCorrect,
                mistakes: kb_totalMistakes,
                slowCount: kb_slowCount,
                config: kb_config
            });
            if (kb_history.length > 50) kb_history = kb_history.slice(0, 50);
            localStorage.setItem('kbGameHistory', JSON.stringify(kb_history));
            kbUpdateCumulativeStats();
            kbRenderHistory();

            // Update final stats display
            document.getElementById('kb_finalScore').innerText = `${kb_firstTryCorrect}/${kb_config.totalRounds}`;
            document.getElementById('kb_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('kb_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('kb_finalMistakes').innerText = kb_totalMistakes;
            document.getElementById('kb_finalAvgTime').innerText = `${avgTime.toFixed(1)}s`;
            document.getElementById('kb_finalSlow').innerText = kb_slowCount;
            document.getElementById('kb_finalSlow').className = `text-3xl font-bold ${kb_slowCount === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            // Show/hide elements
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('kb_stopBtn').classList.add('hidden');
            document.getElementById('kb_playAgainBtn').classList.remove('hidden');
            document.getElementById('kb_newGameBtn').classList.remove('hidden');

            kbShowBreakdown();
        }

        function kbShowBreakdown() {
            const grid = document.getElementById('kb_breakdownGrid');
            grid.innerHTML = '';

            for (const [keyName, data] of Object.entries(kb_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('kb_breakdownSection').classList.remove('hidden');
        }

        function kbPlayAgain() {
            kb_currentRound = 0;
            kb_firstTryCorrect = 0;
            kb_totalMistakes = 0;
            kb_slowCount = 0;
            kb_usedKeys = new Set();
            kb_stats = {};
            kb_allTimes = [];

            document.getElementById('kb_roundDisplay').innerText = '0';
            document.getElementById('kb_scoreDisplay').innerText = '0';
            document.getElementById('kb_mistakesDisplay').innerText = '0';
            document.getElementById('kb_slowDisplay').innerText = '0';
            document.getElementById('kb_responseTime').innerText = '--';

            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.remove('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');
            document.getElementById('kb_stopBtn').classList.remove('hidden');
            document.getElementById('kb_breakdownSection').classList.add('hidden');

            kbRunCountdown(3);
        }

        function kbNewGame() {
            document.getElementById('kb_settingsPanel').classList.remove('hidden');
            document.getElementById('kb_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('kb_challengeDisplay').classList.add('hidden');
            document.getElementById('kb_playAgainBtn').classList.add('hidden');
            document.getElementById('kb_newGameBtn').classList.add('hidden');
            document.getElementById('kb_startBtn').classList.remove('hidden');
            document.getElementById('kb_breakdownSection').classList.add('hidden');
        }

        function kbLoadHistory() {
            const saved = localStorage.getItem('kbGameHistory');
            if (saved) { kb_history = JSON.parse(saved); kbRenderHistory(); }
            const savedCumulative = localStorage.getItem('kbCumulativeStats');
            if (savedCumulative) { kb_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function kbUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(kb_stats)) {
                if (!kb_cumulativeStats[keyName]) {
                    kb_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                kb_cumulativeStats[keyName].attempts += data.total;
                kb_cumulativeStats[keyName].firstTry += data.firstTry;
                kb_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                kb_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('kbCumulativeStats', JSON.stringify(kb_cumulativeStats));
        }

        function kbGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(kb_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function kbClearHistory() {
            if (confirm('Clear Kenny Barron game history?')) {
                kb_history = [];
                localStorage.setItem('kbGameHistory', '[]');
                kbRenderHistory();
            }
        }

        function kbRenderHistory() {
            const content = document.getElementById('kb_historyContent');
            if (kb_history.length === 0) {
                content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>';
                return;
            }

            const totalGames = kb_history.length;
            const avgAccuracy = Math.round(kb_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            // Only games with slow data can qualify for personal best
            const displayedGames = kb_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const typeLabel = game.config?.chordType === 'minor' ? 'min' : game.config?.chordType === 'major' ? 'maj' : 'mix';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span><span class="text-xs text-teal-400 ml-1">${typeLabel}</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = kbGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ JUST THE TWO OF US MODE ============
        // bVImaj7 → V7#9 → im7 progression (in Fm: Dbmaj7 → C7#9 → Fm7)

        let jtou_gameActive = false;
        let jtou_isPlaying = false;
        let jtou_config = {};
        let jtou_challenge = null;
        let jtou_currentRound = 0;
        let jtou_currentStep = 0; // 0=bVI, 1=V, 2=i
        let jtou_usedKeys = new Set();
        let jtou_startTime = null;
        let jtou_stepStartTime = null;
        let jtou_history = [];
        let jtou_cumulativeStats = {}; // Persistent stats across all games
        let jtou_stats = {};
        let jtou_allTimes = [];
        let jtou_stepTimes = [];
        let jtou_firstTryCorrect = 0;
        let jtou_totalMistakes = 0;
        let jtou_slowChords = 0; // Chords taking > 2 seconds
        let jtou_roundHadMistake = false;
        let jtou_attemptHadMistake = false;

        const MINOR_KEY_NAMES = ['Cm', 'C#m', 'Dm', 'D#m', 'Em', 'Fm', 'F#m', 'Gm', 'G#m', 'Am', 'Bbm', 'Bm'];

        function jtouGetProgression(minorRoot, voicing = 'full') {
            // Voice leading magic: the 9th of bVI = #9 of V = b7 of i (common tone!)
            // In Fm: that note is Eb, connecting Dbmaj9 → C7#9 → Fm7

            // bVImaj9: root at (minorRoot + 8) % 12
            // Voicing: R 3 5 7 9 (e.g., Db F Ab C Eb)
            const bVIRoot = (minorRoot + 8) % 12;
            const bVIIntervals = [0, 4, 7, 11, 2]; // R, 3, 5, 7, 9
            const bVIChord = {
                name: NOTE_NAMES[bVIRoot] + 'maj9',
                pitchClasses: new Set(bVIIntervals.map(i => (bVIRoot + i) % 12)),
                notes: bVIIntervals.map(i => NOTE_NAMES[(bVIRoot + i) % 12]),
                label: 'bVImaj9'
            };

            // V7#9: root at (minorRoot + 7) % 12
            const VRoot = (minorRoot + 7) % 12;
            // Full: R 3 5 b7 #9 (e.g., C E G Bb Eb) - 5 notes
            // No5:  R 3 b7 #9 (e.g., C E Bb Eb) - 4 notes, no 5th
            const VIntervals = voicing === 'no5' ? [0, 4, 10, 3] : [0, 4, 7, 10, 3];
            const VChord = {
                name: NOTE_NAMES[VRoot] + '7#9',
                pitchClasses: new Set(VIntervals.map(i => (VRoot + i) % 12)),
                notes: VIntervals.map(i => NOTE_NAMES[(VRoot + i) % 12]),
                label: 'V7#9'
            };

            // im9: root at minorRoot
            // Voicing: R b3 5 b7 9 (e.g., F Ab C Eb G)
            const iIntervals = [0, 3, 7, 10, 2]; // R, b3, 5, b7, 9
            const iChord = {
                name: NOTE_NAMES[minorRoot] + 'm9',
                pitchClasses: new Set(iIntervals.map(i => (minorRoot + i) % 12)),
                notes: iIntervals.map(i => NOTE_NAMES[(minorRoot + i) % 12]),
                label: 'im9'
            };

            return [bVIChord, VChord, iChord];
        }

        function jtouStartGame() {
            saveAllSettings();
            const totalRounds = parseInt(document.getElementById('jtou_roundsSelect').value);
            const showHints = document.getElementById('jtou_showHints').checked;
            const voicing = document.getElementById('jtou_voicingSelect').value;

            jtou_config = { totalRounds, showHints, voicing };
            jtou_currentRound = 0;
            jtou_usedKeys = new Set();
            jtou_stats = {};
            jtou_allTimes = [];
            jtou_firstTryCorrect = 0;
            jtou_totalMistakes = 0;
            jtou_slowChords = 0;

            document.getElementById('jtou_settingsPanel').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_totalRoundsDisplay').innerText = totalRounds;
            document.getElementById('jtou_roundDisplay').innerText = '0';
            document.getElementById('jtou_scoreDisplay').innerText = '0';
            document.getElementById('jtou_mistakesDisplay').innerText = '0';
            document.getElementById('jtou_slowDisplay').innerText = '0';
            document.getElementById('jtou_responseTime').innerText = '--';

            document.getElementById('jtou_startBtn').classList.add('hidden');
            document.getElementById('jtou_stopBtn').classList.remove('hidden');
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');

            jtouRunCountdown(3);
        }

        function jtouRunCountdown(count) {
            if (count > 0) {
                document.getElementById('jtou_keyDisplay').innerText = count;
                document.getElementById('jtou_challengeLabel').innerText = 'Get ready...';
                document.getElementById('jtou_heldNotes').innerText = '';
                jtouResetStepDisplay();
                setTimeout(() => jtouRunCountdown(count - 1), 800);
            } else {
                jtou_isPlaying = true;
                jtouNextChallenge();
            }
        }

        function jtouResetStepDisplay() {
            ['bVI', 'V', 'i'].forEach(step => {
                const stepEl = document.getElementById(`jtou_step_${step}`);
                stepEl.querySelector('div').classList.remove('border-pink-400', 'bg-pink-900/50', 'border-green-400', 'bg-green-900/50');
                stepEl.querySelector('div').classList.add('border-slate-600', 'bg-slate-700');
                document.getElementById(`jtou_time_${step}`).innerText = '--';
                document.getElementById(`jtou_chord_${step}`).innerText = '...';
                document.getElementById(`jtou_notes_${step}`).innerText = '';
            });
        }

        function jtouStopGame() {
            jtou_gameActive = false;
            jtou_isPlaying = false;
            clearAllHighlights('jtou_pianoSvg');
            document.getElementById('jtou_settingsPanel').classList.remove('hidden');
            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_startBtn').classList.remove('hidden');
            document.getElementById('jtou_stopBtn').classList.add('hidden');
        }

        function jtouNextChallenge() {
            clearAllHighlights('jtou_pianoSvg');
            jtou_currentRound++;
            jtou_roundHadMistake = false;
            jtou_currentStep = 0;
            jtou_stepTimes = [];

            if (jtou_currentRound > jtou_config.totalRounds) {
                jtouEndGame();
                return;
            }

            // Pick random unused key
            if (jtou_usedKeys.size >= 12) jtou_usedKeys.clear();
            const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const unusedKeys = allKeys.filter(k => !jtou_usedKeys.has(k));
            const key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            jtou_usedKeys.add(key);

            const progression = jtouGetProgression(key, jtou_config.voicing);
            jtou_challenge = { key, progression, keyName: MINOR_KEY_NAMES[key] };

            // Update UI
            document.getElementById('jtou_roundDisplay').innerText = jtou_currentRound;
            document.getElementById('jtou_challengeLabel').innerText = 'Just the Two of Us in';
            document.getElementById('jtou_keyDisplay').innerText = jtou_challenge.keyName;

            // Reset step styling first, then set chord names/notes
            jtouResetStepDisplay();

            // Update chord names and notes in the progression display
            if (jtou_config.showHints) {
                document.getElementById('jtou_chord_bVI').innerText = progression[0].name;
                document.getElementById('jtou_chord_V').innerText = progression[1].name;
                document.getElementById('jtou_chord_i').innerText = progression[2].name;
                document.getElementById('jtou_notes_bVI').innerText = progression[0].notes.join(' ');
                document.getElementById('jtou_notes_V').innerText = progression[1].notes.join(' ');
                document.getElementById('jtou_notes_i').innerText = progression[2].notes.join(' ');
            } else {
                document.getElementById('jtou_chord_bVI').innerText = '?';
                document.getElementById('jtou_chord_V').innerText = '?';
                document.getElementById('jtou_chord_i').innerText = '?';
            }

            jtouHighlightCurrentStep();

            jtou_startTime = Date.now();
            jtou_stepStartTime = Date.now();
            jtou_gameActive = true;
            jtou_isPlaying = true;
            jtou_attemptHadMistake = false;
        }

        function jtouHighlightCurrentStep() {
            const stepIds = ['bVI', 'V', 'i'];
            stepIds.forEach((id, idx) => {
                const stepEl = document.getElementById(`jtou_step_${id}`);
                const box = stepEl.querySelector('div');
                if (idx === jtou_currentStep) {
                    box.classList.remove('border-slate-600', 'bg-slate-700', 'border-green-400', 'bg-green-900/50');
                    box.classList.add('border-pink-400', 'bg-pink-900/50');
                } else if (idx < jtou_currentStep) {
                    box.classList.remove('border-slate-600', 'bg-slate-700', 'border-pink-400', 'bg-pink-900/50');
                    box.classList.add('border-green-400', 'bg-green-900/50');
                }
            });
        }

        function jtouOnNoteOn(midi) {
            highlightKey('jtou_pianoSvg', midi, 'key-held');
            const pitchClass = midi % 12;
            const noteName = NOTE_NAMES[pitchClass];

            // Debug: Log why we might ignore input
            if (!jtou_isPlaying) {
                console.log(`[JTOU] Ignoring ${noteName} - jtou_isPlaying is false (transition window)`);
                return;
            }
            if (!jtou_challenge) {
                console.log(`[JTOU] Ignoring ${noteName} - no active challenge`);
                return;
            }

            const currentChord = jtou_challenge.progression[jtou_currentStep];

            // Check if this note is correct
            if (!currentChord.pitchClasses.has(pitchClass)) {
                // Wrong note
                if (!jtou_attemptHadMistake) {
                    console.log(`[JTOU] MISTAKE: ${noteName} not in ${currentChord.name} (${[...currentChord.pitchClasses].map(pc => NOTE_NAMES[pc]).join(', ')})`);
                    jtou_attemptHadMistake = true;
                    jtou_roundHadMistake = true;
                    jtou_totalMistakes++;
                    document.getElementById('jtou_mistakesDisplay').innerText = jtou_totalMistakes;
                    jtouShowFeedback('✗', false);
                } else {
                    console.log(`[JTOU] Wrong note ${noteName} but already had mistake this attempt`);
                }
            } else {
                console.log(`[JTOU] Correct note: ${noteName} for ${currentChord.name}`);
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('jtou_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if chord is complete - must be HOLDING all required notes
            const hasAllRequired = [...currentChord.pitchClasses].every(pc => heldPitchClasses.has(pc));
            if (hasAllRequired && heldNotes.size >= currentChord.pitchClasses.size) {
                jtou_isPlaying = false; // Prevent mistakes during transition
                const stepTime = (Date.now() - jtou_stepStartTime) / 1000;
                jtou_stepTimes.push(stepTime);
                jtou_allTimes.push(stepTime);

                // Track slow chords (> 2 seconds)
                if (stepTime > 2) {
                    jtou_slowChords++;
                    document.getElementById('jtou_slowDisplay').innerText = jtou_slowChords;
                }

                // Update time display for this step
                const stepIds = ['bVI', 'V', 'i'];
                document.getElementById(`jtou_time_${stepIds[jtou_currentStep]}`).innerText = stepTime.toFixed(1) + 's';

                // Track first-try correct for this chord
                if (!jtou_attemptHadMistake) {
                    jtou_firstTryCorrect++;
                    document.getElementById('jtou_scoreDisplay').innerText = jtou_firstTryCorrect;
                }

                jtouShowFeedback('✓', true, stepTime);

                // Move to next step or next round
                jtou_currentStep++;
                jtou_attemptHadMistake = false;

                if (jtou_currentStep < 3) {
                    // Next chord in progression
                    jtou_stepStartTime = Date.now();
                    setTimeout(() => {
                        jtou_isPlaying = true;
                        jtouHighlightCurrentStep();
                    }, 400);
                } else {
                    // Progression complete
                    const avgChordTime = jtou_stepTimes.reduce((a, b) => a + b, 0) / jtou_stepTimes.length;
                    jtouUpdateResponseTime(avgChordTime);

                    // Track stats by key
                    const keyName = jtou_challenge.keyName;
                    if (!jtou_stats[keyName]) jtou_stats[keyName] = { total: 0, firstTry: 0, times: [], slow: 0 };
                    jtou_stats[keyName].total += 3;
                    jtou_stats[keyName].firstTry += jtou_stepTimes.length - (jtou_roundHadMistake ? 1 : 0);
                    jtou_stats[keyName].times.push(...jtou_stepTimes);
                    // Count slow chords in this round
                    jtou_stats[keyName].slow += jtou_stepTimes.filter(t => t > 2).length;

                    setTimeout(() => { jtou_isPlaying = true; jtouNextChallenge(); }, 600);
                }
            }
        }

        function jtouOnNoteOff(midi) {
            highlightKey('jtou_pianoSvg', midi, 'key-held', false);
            highlightKey('jtou_pianoSvg', midi, 'key-active', false);
            highlightKey('jtou_pianoSvg', midi, 'key-wrong', false);
            if (!jtou_challenge) return;

            if (jtou_isPlaying) {
                const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
                const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
                document.getElementById('jtou_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
            }
        }

        function jtouUpdateResponseTime(seconds) {
            const el = document.getElementById('jtou_responseTime');
            el.innerText = seconds.toFixed(2) + 's';
            el.className = 'text-2xl font-mono ' + (seconds < 2 ? 'timer-fast' : seconds < 4 ? 'timer-medium' : 'timer-slow');
        }

        function jtouShowFeedback(text, isGood, time = null) {
            const area = document.getElementById('jtou_feedbackArea');
            const el = document.createElement('div');
            el.className = `text-4xl font-bold feedback-anim ${isGood ? 'text-green-400' : 'text-red-400'}`;
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            area.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function jtouEndGame() {
            jtou_isPlaying = false;
            jtou_gameActive = false;
            jtou_challenge = null;

            const totalChords = jtou_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((jtou_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = jtou_allTimes.length > 0 ? jtou_allTimes.reduce((a, b) => a + b, 0) / jtou_allTimes.length : 0;

            jtou_history.unshift({
                date: new Date().toISOString(),
                config: { ...jtou_config },
                score: jtou_firstTryCorrect,
                totalChords,
                accuracy,
                avgTime,
                totalMistakes: jtou_totalMistakes,
                slowChords: jtou_slowChords,
                stats: JSON.parse(JSON.stringify(jtou_stats))
            });
            if (jtou_history.length > 50) jtou_history.pop();
            localStorage.setItem('jtouGameHistory', JSON.stringify(jtou_history));
            jtouUpdateCumulativeStats();

            jtouShowGameComplete();
        }

        function jtouShowGameComplete() {
            const totalChords = jtou_currentRound * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((jtou_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = jtou_allTimes.length > 0 ? jtou_allTimes.reduce((a, b) => a + b, 0) / jtou_allTimes.length : 0;

            document.getElementById('jtou_finalScore').innerText = `${jtou_firstTryCorrect}/${totalChords}`;
            document.getElementById('jtou_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('jtou_finalAccuracy').className = `text-3xl font-bold ${accuracy >= 80 ? 'text-green-400' : accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('jtou_finalMistakes').innerText = jtou_totalMistakes;
            document.getElementById('jtou_finalAvgTime').innerText = avgTime > 0 ? `${avgTime.toFixed(1)}s` : '--';
            document.getElementById('jtou_finalAvgTime').className = `text-3xl font-bold ${avgTime < 2 ? 'text-green-400' : avgTime < 4 ? 'text-yellow-400' : 'text-red-400'}`;
            document.getElementById('jtou_finalSlow').innerText = jtou_slowChords;
            document.getElementById('jtou_finalSlow').className = `text-3xl font-bold ${jtou_slowChords === 0 ? 'text-green-400' : 'text-yellow-400'}`;

            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('jtou_stopBtn').classList.add('hidden');
            document.getElementById('jtou_playAgainBtn').classList.remove('hidden');
            document.getElementById('jtou_newGameBtn').classList.remove('hidden');

            jtouShowBreakdown();
            jtouRenderHistory();
        }

        function jtouShowBreakdown() {
            const grid = document.getElementById('jtou_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(jtou_stats).length === 0) { document.getElementById('jtou_breakdownSection').classList.add('hidden'); return; }

            for (const [keyName, data] of Object.entries(jtou_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;
                const color = pct >= 80 ? 'bg-green-900 border-green-700' : pct >= 50 ? 'bg-yellow-900 border-yellow-700' : 'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';
                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${keyName}</p><p>${pct}% (${data.firstTry}/${data.total})</p><p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('jtou_breakdownSection').classList.remove('hidden');
        }

        function jtouPlayAgain() {
            jtou_currentRound = 0;
            jtou_firstTryCorrect = 0;
            jtou_totalMistakes = 0;
            jtou_slowChords = 0;
            jtou_roundHadMistake = false;
            jtou_attemptHadMistake = false;
            jtou_usedKeys = new Set();
            jtou_stats = {};
            jtou_allTimes = [];
            document.getElementById('jtou_roundDisplay').innerText = '0';
            document.getElementById('jtou_responseTime').innerText = '--';
            document.getElementById('jtou_scoreDisplay').innerText = '0';
            document.getElementById('jtou_mistakesDisplay').innerText = '0';
            document.getElementById('jtou_slowDisplay').innerText = '0';
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');
            document.getElementById('jtou_stopBtn').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.remove('hidden');
            document.getElementById('jtou_breakdownSection').classList.add('hidden');
            jtouRunCountdown(3);
        }

        function jtouNewGame() {
            document.getElementById('jtou_settingsPanel').classList.remove('hidden');
            document.getElementById('jtou_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('jtou_challengeDisplay').classList.add('hidden');
            document.getElementById('jtou_playAgainBtn').classList.add('hidden');
            document.getElementById('jtou_newGameBtn').classList.add('hidden');
            document.getElementById('jtou_startBtn').classList.remove('hidden');
            document.getElementById('jtou_breakdownSection').classList.add('hidden');
        }

        function jtouLoadHistory() {
            const saved = localStorage.getItem('jtouGameHistory');
            if (saved) { jtou_history = JSON.parse(saved); jtouRenderHistory(); }
            const savedCumulative = localStorage.getItem('jtouCumulativeStats');
            if (savedCumulative) { jtou_cumulativeStats = JSON.parse(savedCumulative); }
        }

        function jtouUpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(jtou_stats)) {
                if (!jtou_cumulativeStats[keyName]) {
                    jtou_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                jtou_cumulativeStats[keyName].attempts += data.total;
                jtou_cumulativeStats[keyName].firstTry += data.firstTry;
                jtou_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                jtou_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('jtouCumulativeStats', JSON.stringify(jtou_cumulativeStats));
        }

        function jtouGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(jtou_cumulativeStats)) {
                if (data.attempts >= 5) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, firstTry: data.firstTry, slow: data.slow || 0, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function jtouClearHistory() {
            if (confirm('Clear Just the Two of Us game history?')) {
                jtou_history = [];
                localStorage.setItem('jtouGameHistory', '[]');
                jtouRenderHistory();
            }
        }

        function jtouRenderHistory() {
            const content = document.getElementById('jtou_historyContent');
            if (jtou_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = jtou_history.length;
            const avgAccuracy = Math.min(100, Math.round(jtou_history.reduce((a, g) => a + Math.min(g.accuracy, 100), 0) / totalGames));

            // Only games with slow data can qualify for personal best
            const displayedGames = jtou_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowChords !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.min(100, Math.max(...gamesWithSlowData.map(g => Math.min(g.accuracy, 100)))) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => Math.min(g.accuracy, 100) === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowChords)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowChords === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowChords !== undefined && Math.min(g.accuracy, 100) === bestAccuracy && g.slowChords === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const rounds = game.config?.totalRounds || (game.totalChords / 3);
                const displayAccuracy = Math.min(game.accuracy, 100);
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${rounds}r</span><span class="text-xs text-pink-400 ml-1">JTOU</span></div>
                    <div><span class="font-bold ${displayAccuracy >= 80 ? 'text-green-400' : displayAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${displayAccuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = jtouGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ ROOTLESS VOICINGS MODE ============
        // Rootless voicings: Type A (3-5-7-9) and Type B (7-9-3-5)
        const ROOTLESS_VOICINGS = {
            'maj7': {
                suffix: 'Maj7',
                A: { intervals: [4, 7, 11, 2], formula: '3 - 5 - 7 - 9' },    // maj3, P5, maj7, maj9
                B: { intervals: [11, 2, 4, 7], formula: '7 - 9 - 3 - 5' }     // maj7, maj9, maj3, P5
            },
            'min7': {
                suffix: 'm7',
                A: { intervals: [3, 7, 10, 2], formula: 'b3 - 5 - b7 - 9' },  // min3, P5, min7, maj9
                B: { intervals: [10, 2, 3, 7], formula: 'b7 - 9 - b3 - 5' }   // min7, maj9, min3, P5
            },
            'dom7': {
                suffix: '7',
                A: { intervals: [4, 7, 10, 2], formula: '3 - 5 - b7 - 9' },   // maj3, P5, min7, maj9
                B: { intervals: [10, 2, 4, 7], formula: 'b7 - 9 - 3 - 5' }    // min7, maj9, maj3, P5
            }
        };
        const ROOTLESS_CHORD_TYPES = ['maj7', 'min7', 'dom7'];
        const ROOTLESS_VOICING_TYPES = ['A', 'B'];

        let dom7v_isPlaying = false;
        let dom7v_challenge = null;
        let dom7v_usedChallenges = new Set(); // Track used root+type combinations
        let dom7v_challengeStartTime = null;
        let dom7v_config = null;
        let dom7v_currentRound = 0;
        let dom7v_firstTryCorrect = 0;
        let dom7v_totalMistakes = 0;
        let dom7v_roundHadMistake = false;
        let dom7v_stats = {};
        let dom7v_allTimes = [];
        let dom7v_slowCount = 0;
        let dom7v_history = [];
        let dom7v_cumulativeStats = {};

        function dom7vGetChallenge(root, chordType, voicingType) {
            const chord = ROOTLESS_VOICINGS[chordType];
            const voicing = chord[voicingType];
            const pitchClasses = new Set(voicing.intervals.map(i => (root + i) % 12));
            const noteNames = voicing.intervals.map(i => NOTE_NAMES[(root + i) % 12]);
            return {
                root: root,
                chordType: chordType,
                voicingType: voicingType,
                name: NOTE_NAMES[root] + chord.suffix,
                pitchClasses: pitchClasses,
                noteNames: noteNames,
                formula: voicing.formula
            };
        }

        function dom7vUpdateSettingsHint() {
            const voicingType = document.getElementById('dom7v_voicingTypeSelect').value;
            const hint = document.getElementById('dom7v_settingsHint');
            if (voicingType === 'A') {
                hint.innerText = 'Type A: 3-5-7-9 (from bottom). Standard rootless voicing.';
            } else if (voicingType === 'B') {
                hint.innerText = 'Type B: 7-9-3-5 (from bottom). Inverted voicing, voice-leads smoothly with Type A.';
            } else {
                hint.innerText = 'Both types: Practice alternating between A (3-5-7-9) and B (7-9-3-5) voicings.';
            }
        }

        function dom7vStartGame() {
            saveAllSettings();
            dom7v_config = {
                totalRounds: parseInt(document.getElementById('dom7v_roundsSelect').value),
                showHints: document.getElementById('dom7v_showHints').checked,
                chordType: document.getElementById('dom7v_chordTypeSelect').value,
                voicingType: document.getElementById('dom7v_voicingTypeSelect').value
            };
            dom7v_currentRound = 0;
            dom7v_firstTryCorrect = 0;
            dom7v_totalMistakes = 0;
            dom7v_slowCount = 0;
            dom7v_roundHadMistake = false;
            dom7v_usedChallenges = new Set();
            dom7v_stats = {};
            dom7v_allTimes = [];

            document.getElementById('dom7v_roundDisplay').innerText = '0';
            document.getElementById('dom7v_totalRoundsDisplay').innerText = dom7v_config.totalRounds;
            document.getElementById('dom7v_responseTime').innerText = '--';
            document.getElementById('dom7v_scoreDisplay').innerText = '0';
            document.getElementById('dom7v_mistakesDisplay').innerText = '0';
            document.getElementById('dom7v_slowDisplay').innerText = '0';

            document.getElementById('dom7v_startBtn').classList.add('hidden');
            document.getElementById('dom7v_stopBtn').classList.remove('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            document.getElementById('dom7v_settingsPanel').classList.add('hidden');
            document.getElementById('dom7v_challengeDisplay').classList.remove('hidden');
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_breakdownSection').classList.add('hidden');

            dom7vRunCountdown(3);
        }

        function dom7vRunCountdown(seconds) {
            if (seconds > 0) {
                document.getElementById('dom7v_chordDisplay').innerText = seconds;
                document.getElementById('dom7v_formulaLine').classList.add('hidden');
                document.getElementById('dom7v_noteHint').classList.add('hidden');
                document.getElementById('dom7v_heldNotes').innerText = 'Get ready...';
                setTimeout(() => dom7vRunCountdown(seconds - 1), 1000);
            } else {
                document.getElementById('dom7v_formulaLine').classList.remove('hidden');
                dom7v_isPlaying = true;
                dom7vNextChallenge();
            }
        }

        function dom7vNextChallenge() {
            if (dom7v_currentRound >= dom7v_config.totalRounds) {
                dom7vEndGame();
                return;
            }

            // Determine which chord types and voicing types to use
            const chordTypesToUse = dom7v_config.chordType === 'all' ? ROOTLESS_CHORD_TYPES : [dom7v_config.chordType];
            const voicingTypesToUse = dom7v_config.voicingType === 'both' ? ROOTLESS_VOICING_TYPES : [dom7v_config.voicingType];

            // Build list of available root+chordType+voicingType combinations
            let availableChallenges = [];
            for (let root = 0; root < 12; root++) {
                for (const chordType of chordTypesToUse) {
                    for (const voicingType of voicingTypesToUse) {
                        const key = `${root}-${chordType}-${voicingType}`;
                        if (!dom7v_usedChallenges.has(key)) {
                            availableChallenges.push({ root, chordType, voicingType, key });
                        }
                    }
                }
            }

            // Reset if we've used all combinations
            if (availableChallenges.length === 0) {
                dom7v_usedChallenges.clear();
                for (let root = 0; root < 12; root++) {
                    for (const chordType of chordTypesToUse) {
                        for (const voicingType of voicingTypesToUse) {
                            availableChallenges.push({ root, chordType, voicingType, key: `${root}-${chordType}-${voicingType}` });
                        }
                    }
                }
            }

            // Pick random challenge
            const chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            dom7v_usedChallenges.add(chosen.key);

            dom7v_challenge = dom7vGetChallenge(chosen.root, chosen.chordType, chosen.voicingType);
            dom7v_currentRound++;
            dom7v_roundHadMistake = false;
            dom7v_challengeStartTime = Date.now();

            document.getElementById('dom7v_roundDisplay').innerText = dom7v_currentRound;
            document.getElementById('dom7v_chordDisplay').innerText = dom7v_challenge.name;
            document.getElementById('dom7v_formulaHint').innerText = dom7v_challenge.formula;
            document.getElementById('dom7v_heldNotes').innerText = 'Holding: --';

            // Show voicing type indicator when practicing both types
            const voicingTypeDisplay = document.getElementById('dom7v_voicingTypeDisplay');
            if (dom7v_config.voicingType === 'both') {
                voicingTypeDisplay.innerText = `(${dom7v_challenge.voicingType})`;
            } else {
                voicingTypeDisplay.innerText = '';
            }

            // Show/hide note hint based on settings
            const noteHintEl = document.getElementById('dom7v_noteHint');
            if (dom7v_config.showHints) {
                noteHintEl.innerText = dom7v_challenge.noteNames.join(' - ');
                noteHintEl.classList.remove('hidden');
            } else {
                noteHintEl.classList.add('hidden');
            }

            clearAllHighlights('dom7v_pianoSvg');
        }

        function dom7vOnNoteOn(midi) {
            highlightKey('dom7v_pianoSvg', midi, 'key-held');

            if (!dom7v_isPlaying || !dom7v_challenge) return;

            const notePitchClass = midi % 12;
            const requiredPitchClasses = dom7v_challenge.pitchClasses;

            // Check if note is wrong (not in the voicing)
            const isWrongNote = !requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!dom7v_roundHadMistake) {
                    dom7v_totalMistakes++;
                    dom7v_roundHadMistake = true;
                    dom7vShowFeedback('✗', false);
                    document.getElementById('dom7v_mistakesDisplay').innerText = dom7v_totalMistakes;
                }
                highlightKey('dom7v_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('dom7v_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const hasAllRequired = [...requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= 4) {
                // Voicing complete!
                const responseTime = (Date.now() - dom7v_challengeStartTime) / 1000;

                // Track slow responses
                if (responseTime > 2) {
                    dom7v_slowCount++;
                    document.getElementById('dom7v_slowDisplay').innerText = dom7v_slowCount;
                }

                // Update stats for this chord (include voicing type in key when practicing both)
                const statKey = dom7v_config.voicingType === 'both'
                    ? `${dom7v_challenge.name} (${dom7v_challenge.voicingType})`
                    : dom7v_challenge.name;
                if (!dom7v_stats[statKey]) {
                    dom7v_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                }
                dom7v_stats[statKey].total++;
                if (responseTime > 2) dom7v_stats[statKey].slow++;

                if (!dom7v_roundHadMistake) {
                    dom7v_firstTryCorrect++;
                    dom7v_stats[statKey].firstTry++;
                    dom7v_stats[statKey].times.push(responseTime);
                    dom7v_allTimes.push(responseTime);
                    document.getElementById('dom7v_scoreDisplay').innerText = dom7v_firstTryCorrect;
                    dom7vShowFeedback('✓', true, responseTime);
                } else {
                    dom7vShowFeedback('✓', true);
                }

                // Update average time
                if (dom7v_allTimes.length > 0) {
                    const avg = dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length;
                    dom7vUpdateResponseTime(avg);
                }

                dom7v_isPlaying = false;
                setTimeout(() => {
                    clearAllHighlights('dom7v_pianoSvg');
                    dom7v_isPlaying = true;
                    dom7vNextChallenge();
                }, 600);
            }
        }

        function dom7vOnNoteOff(midi) {
            highlightKey('dom7v_pianoSvg', midi, 'key-held', false);
            highlightKey('dom7v_pianoSvg', midi, 'key-wrong', false);

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('dom7v_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function dom7vShowFeedback(text, isPositive, time = null) {
            const el = document.getElementById('dom7v_feedbackFloat');
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none feedback-anim ' + (isPositive ? 'text-green-400' : 'text-red-400');
            setTimeout(() => { el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none opacity-0'; }, 1000);
        }

        function dom7vUpdateResponseTime(avgTime) {
            const el = document.getElementById('dom7v_responseTime');
            el.innerText = avgTime.toFixed(1) + 's';
            el.className = 'text-2xl font-mono ' + (avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow');
        }

        function dom7vStopGame() {
            dom7v_isPlaying = false;
            dom7v_challenge = null;
            clearAllHighlights('dom7v_pianoSvg');
            document.getElementById('dom7v_startBtn').classList.remove('hidden');
            document.getElementById('dom7v_stopBtn').classList.add('hidden');
            document.getElementById('dom7v_challengeDisplay').classList.add('hidden');
            document.getElementById('dom7v_settingsPanel').classList.remove('hidden');
        }

        function dom7vEndGame() {
            dom7v_isPlaying = false;
            dom7v_challenge = null;
            clearAllHighlights('dom7v_pianoSvg');

            const totalRounds = dom7v_config.totalRounds;
            const accuracy = totalRounds > 0 ? Math.min(100, Math.round((dom7v_firstTryCorrect / totalRounds) * 100)) : 0;
            const avgTime = dom7v_allTimes.length > 0 ? dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length : 0;

            // Save to history
            dom7v_history.unshift({
                date: new Date().toISOString(),
                config: { ...dom7v_config },
                score: dom7v_firstTryCorrect,
                totalRounds,
                accuracy,
                avgTime,
                totalMistakes: dom7v_totalMistakes,
                slowCount: dom7v_slowCount,
                stats: JSON.parse(JSON.stringify(dom7v_stats))
            });
            if (dom7v_history.length > 50) dom7v_history.pop();
            localStorage.setItem('dom7vGameHistory', JSON.stringify(dom7v_history));

            dom7vUpdateCumulativeStats();
            dom7vShowGameComplete();
        }

        function dom7vShowGameComplete() {
            const totalRounds = dom7v_config.totalRounds;
            const accuracy = totalRounds > 0 ? Math.min(100, Math.round((dom7v_firstTryCorrect / totalRounds) * 100)) : 0;
            const avgTime = dom7v_allTimes.length > 0 ? dom7v_allTimes.reduce((a, b) => a + b, 0) / dom7v_allTimes.length : 0;

            document.getElementById('dom7v_finalScore').innerText = `${dom7v_firstTryCorrect}/${totalRounds}`;
            document.getElementById('dom7v_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('dom7v_finalMistakes').innerText = dom7v_totalMistakes;
            document.getElementById('dom7v_finalAvgTime').innerText = avgTime.toFixed(1) + 's';
            document.getElementById('dom7v_finalSlow').innerText = dom7v_slowCount;

            // Identify weak areas from this game
            const weakAreas = Object.entries(dom7v_stats)
                .filter(([_, data]) => data.firstTry < data.total)
                .map(([name, _]) => name);
            document.getElementById('dom7v_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Needs practice: ' + weakAreas.join(', ') : '';

            document.getElementById('dom7v_challengeDisplay').classList.add('hidden');
            document.getElementById('dom7v_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('dom7v_stopBtn').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.remove('hidden');
            document.getElementById('dom7v_newGameBtn').classList.remove('hidden');

            dom7vShowBreakdown();
            dom7vRenderHistory();
        }

        function dom7vPlayAgain() {
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            dom7vStartGame();
        }

        function dom7vNewGame() {
            document.getElementById('dom7v_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('dom7v_breakdownSection').classList.add('hidden');
            document.getElementById('dom7v_playAgainBtn').classList.add('hidden');
            document.getElementById('dom7v_newGameBtn').classList.add('hidden');
            document.getElementById('dom7v_startBtn').classList.remove('hidden');
            document.getElementById('dom7v_settingsPanel').classList.remove('hidden');
        }

        function dom7vShowBreakdown() {
            const grid = document.getElementById('dom7v_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(dom7v_stats).length === 0) {
                document.getElementById('dom7v_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chordName, data] of Object.entries(dom7v_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;

                const color = pct >= 80 ? 'bg-green-900 border-green-700' :
                              pct >= 50 ? 'bg-yellow-900 border-yellow-700' :
                              'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';

                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chordName}</p>
                                 <p>${pct}% (${data.firstTry}/${data.total})</p>
                                 <p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('dom7v_breakdownSection').classList.remove('hidden');
        }

        function dom7vLoadHistory() {
            const saved = localStorage.getItem('dom7vGameHistory');
            if (saved) { dom7v_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('dom7vCumulativeStats');
            if (savedCumulative) { dom7v_cumulativeStats = JSON.parse(savedCumulative); }
            dom7vRenderHistory();
        }

        function dom7vClearHistory() {
            dom7v_history = [];
            dom7v_cumulativeStats = {};
            localStorage.removeItem('dom7vGameHistory');
            localStorage.removeItem('dom7vCumulativeStats');
            dom7vRenderHistory();
        }

        function dom7vUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(dom7v_stats)) {
                if (!dom7v_cumulativeStats[chordName]) {
                    dom7v_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                dom7v_cumulativeStats[chordName].attempts += data.total;
                dom7v_cumulativeStats[chordName].firstTry += data.firstTry;
                dom7v_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                dom7v_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('dom7vCumulativeStats', JSON.stringify(dom7v_cumulativeStats));
        }

        function dom7vGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(dom7v_cumulativeStats)) {
                if (data.attempts >= 3) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function dom7vRenderHistory() {
            const content = document.getElementById('dom7v_historyContent');
            if (dom7v_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = dom7v_history.length;
            const avgAccuracy = Math.round(dom7v_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = dom7v_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalRounds}r</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas from cumulative stats
            const problemAreas = dom7vGetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas <span class="text-slate-500" title="Items where you had the most mistakes or slowest times across all games">(✗=mistake rate, time=avg response, #=attempts)</span></p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ EXTENDED VOICINGS MODE ============
        // Extended voicings: Maj6/9 (3-5-6-9), Min6/9 (b3-5-6-9), Dom13 (3-13-7-9)
        const EXTENDED_VOICINGS = {
            'maj69': { intervals: [4, 7, 9, 2], suffix: 'Maj6/9', formula: '3 - 5 - 6 - 9' },   // maj3, P5, maj6, maj9
            'min69': { intervals: [3, 7, 9, 2], suffix: 'm6/9', formula: 'b3 - 5 - 6 - 9' },    // min3, P5, maj6, maj9
            'dom13': { intervals: [4, 9, 10, 2], suffix: '13', formula: '3 - 13 - 7 - 9' }      // maj3, maj13, min7, maj9
        };
        const EXTENDED_CHORD_TYPES = ['maj69', 'min69', 'dom13'];

        let extv_isPlaying = false;
        let extv_challenge = null;
        let extv_usedChallenges = new Set();
        let extv_challengeStartTime = null;
        let extv_config = null;
        let extv_currentRound = 0;
        let extv_firstTryCorrect = 0;
        let extv_totalMistakes = 0;
        let extv_roundHadMistake = false;
        let extv_stats = {};
        let extv_allTimes = [];
        let extv_slowCount = 0;
        let extv_history = [];
        let extv_cumulativeStats = {};

        function extvGetChallenge(root, chordType) {
            const voicing = EXTENDED_VOICINGS[chordType];
            const pitchClasses = new Set(voicing.intervals.map(i => (root + i) % 12));
            const noteNames = voicing.intervals.map(i => NOTE_NAMES[(root + i) % 12]);
            return {
                root: root,
                chordType: chordType,
                name: NOTE_NAMES[root] + voicing.suffix,
                pitchClasses: pitchClasses,
                noteNames: noteNames,
                formula: voicing.formula
            };
        }

        function extvStartGame() {
            saveAllSettings();
            extv_config = {
                totalRounds: parseInt(document.getElementById('extv_roundsSelect').value),
                showHints: document.getElementById('extv_showHints').checked,
                chordType: document.getElementById('extv_chordTypeSelect').value
            };
            extv_currentRound = 0;
            extv_firstTryCorrect = 0;
            extv_totalMistakes = 0;
            extv_slowCount = 0;
            extv_roundHadMistake = false;
            extv_usedChallenges = new Set();
            extv_stats = {};
            extv_allTimes = [];

            document.getElementById('extv_roundDisplay').innerText = '0';
            document.getElementById('extv_totalRoundsDisplay').innerText = extv_config.totalRounds;
            document.getElementById('extv_responseTime').innerText = '--';
            document.getElementById('extv_scoreDisplay').innerText = '0';
            document.getElementById('extv_mistakesDisplay').innerText = '0';
            document.getElementById('extv_slowDisplay').innerText = '0';

            document.getElementById('extv_startBtn').classList.add('hidden');
            document.getElementById('extv_stopBtn').classList.remove('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            document.getElementById('extv_settingsPanel').classList.add('hidden');
            document.getElementById('extv_challengeDisplay').classList.remove('hidden');
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_breakdownSection').classList.add('hidden');

            extvRunCountdown(3);
        }

        function extvRunCountdown(seconds) {
            if (seconds > 0) {
                document.getElementById('extv_chordDisplay').innerText = seconds;
                document.getElementById('extv_formulaLine').classList.add('hidden');
                document.getElementById('extv_noteHint').classList.add('hidden');
                document.getElementById('extv_heldNotes').innerText = 'Get ready...';
                setTimeout(() => extvRunCountdown(seconds - 1), 1000);
            } else {
                document.getElementById('extv_formulaLine').classList.remove('hidden');
                extv_isPlaying = true;
                extvNextChallenge();
            }
        }

        function extvNextChallenge() {
            if (extv_currentRound >= extv_config.totalRounds) {
                extvEndGame();
                return;
            }

            // Determine which chord types to use
            const chordTypesToUse = extv_config.chordType === 'all' ? EXTENDED_CHORD_TYPES : [extv_config.chordType];

            // Build list of available root+chordType combinations
            let availableChallenges = [];
            for (let root = 0; root < 12; root++) {
                for (const chordType of chordTypesToUse) {
                    const key = `${root}-${chordType}`;
                    if (!extv_usedChallenges.has(key)) {
                        availableChallenges.push({ root, chordType, key });
                    }
                }
            }

            // Reset if we've used all combinations
            if (availableChallenges.length === 0) {
                extv_usedChallenges.clear();
                for (let root = 0; root < 12; root++) {
                    for (const chordType of chordTypesToUse) {
                        availableChallenges.push({ root, chordType, key: `${root}-${chordType}` });
                    }
                }
            }

            // Pick random challenge
            const chosen = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            extv_usedChallenges.add(chosen.key);

            extv_challenge = extvGetChallenge(chosen.root, chosen.chordType);
            extv_currentRound++;
            extv_roundHadMistake = false;
            extv_challengeStartTime = Date.now();

            document.getElementById('extv_roundDisplay').innerText = extv_currentRound;
            document.getElementById('extv_chordDisplay').innerText = extv_challenge.name;
            document.getElementById('extv_formulaHint').innerText = extv_challenge.formula;
            document.getElementById('extv_heldNotes').innerText = 'Holding: --';

            // Show/hide note hint based on settings
            const noteHintEl = document.getElementById('extv_noteHint');
            if (extv_config.showHints) {
                noteHintEl.innerText = extv_challenge.noteNames.join(' - ');
                noteHintEl.classList.remove('hidden');
            } else {
                noteHintEl.classList.add('hidden');
            }

            clearAllHighlights('extv_pianoSvg');
        }

        function extvOnNoteOn(midi) {
            if (!extv_isPlaying || !extv_challenge) return;

            const pc = midi % 12;
            const isCorrect = extv_challenge.pitchClasses.has(pc);

            highlightKey('extv_pianoSvg', midi, isCorrect ? '#22c55e' : '#ef4444');
            heldNotes.add(midi);

            if (!isCorrect) {
                extv_roundHadMistake = true;
                extv_totalMistakes++;
                document.getElementById('extv_mistakesDisplay').innerText = extv_totalMistakes;
                extvShowFeedback('✗', false);
            }

            // Check if all required notes are held
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const allCorrect = [...extv_challenge.pitchClasses].every(pc => heldPitchClasses.has(pc));

            if (allCorrect && heldPitchClasses.size >= extv_challenge.pitchClasses.size) {
                const responseTime = (Date.now() - extv_challengeStartTime) / 1000;

                if (responseTime > 2) {
                    extv_slowCount++;
                    document.getElementById('extv_slowDisplay').innerText = extv_slowCount;
                }

                // Update stats for this chord
                const statKey = extv_challenge.name;
                if (!extv_stats[statKey]) {
                    extv_stats[statKey] = { firstTry: 0, total: 0, times: [], slow: 0 };
                }
                extv_stats[statKey].total++;
                if (responseTime > 2) extv_stats[statKey].slow++;

                if (!extv_roundHadMistake) {
                    extv_firstTryCorrect++;
                    extv_stats[statKey].firstTry++;
                    extv_stats[statKey].times.push(responseTime);
                    extv_allTimes.push(responseTime);
                    document.getElementById('extv_scoreDisplay').innerText = extv_firstTryCorrect;
                    extvShowFeedback('✓', true, responseTime);
                } else {
                    extvShowFeedback('✓', true);
                }

                // Update average time
                if (extv_allTimes.length > 0) {
                    const avg = extv_allTimes.reduce((a, b) => a + b, 0) / extv_allTimes.length;
                    extvUpdateResponseTime(avg);
                }

                setTimeout(() => {
                    clearAllHighlights('extv_pianoSvg');
                    extvNextChallenge();
                }, 500);
            }

            // Update held notes display
            const heldPitchClassesDisplay = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClassesDisplay].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('extv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function extvOnNoteOff(midi) {
            heldNotes.delete(midi);
            clearHighlight('extv_pianoSvg', midi);

            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('extv_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function extvShowFeedback(text, isPositive, time = null) {
            const el = document.getElementById('extv_feedbackFloat');
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none feedback-anim ' + (isPositive ? 'text-green-400' : 'text-red-400');
            setTimeout(() => { el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none opacity-0'; }, 1000);
        }

        function extvUpdateResponseTime(avgTime) {
            const el = document.getElementById('extv_responseTime');
            el.innerText = avgTime.toFixed(1) + 's';
            el.className = 'text-2xl font-mono ' + (avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow');
        }

        function extvStopGame() {
            extv_isPlaying = false;
            extv_challenge = null;
            clearAllHighlights('extv_pianoSvg');
            document.getElementById('extv_startBtn').classList.remove('hidden');
            document.getElementById('extv_stopBtn').classList.add('hidden');
            document.getElementById('extv_challengeDisplay').classList.add('hidden');
            document.getElementById('extv_settingsPanel').classList.remove('hidden');
        }

        function extvEndGame() {
            extv_isPlaying = false;
            extv_challenge = null;

            // Save to history
            const gameResult = {
                date: new Date().toISOString(),
                score: extv_firstTryCorrect,
                total: extv_config.totalRounds,
                accuracy: Math.round((extv_firstTryCorrect / extv_config.totalRounds) * 100),
                avgTime: extv_allTimes.length > 0 ? (extv_allTimes.reduce((a, b) => a + b, 0) / extv_allTimes.length).toFixed(1) : '--',
                mistakes: extv_totalMistakes,
                slow: extv_slowCount,
                chordType: extv_config.chordType
            };
            extv_history.unshift(gameResult);
            if (extv_history.length > 10) extv_history.pop();
            localStorage.setItem('extvGameHistory', JSON.stringify(extv_history));

            extvUpdateCumulativeStats();

            // Update final display
            document.getElementById('extv_finalScore').innerText = `${extv_firstTryCorrect}/${extv_config.totalRounds}`;
            document.getElementById('extv_finalAccuracy').innerText = gameResult.accuracy + '%';
            document.getElementById('extv_finalMistakes').innerText = extv_totalMistakes;
            document.getElementById('extv_finalAvgTime').innerText = gameResult.avgTime + 's';
            document.getElementById('extv_finalSlow').innerText = extv_slowCount;

            const weakAreas = Object.entries(extv_stats)
                .filter(([_, data]) => data.firstTry < data.total)
                .map(([name, _]) => name);
            document.getElementById('extv_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Needs practice: ' + weakAreas.join(', ') : '';

            document.getElementById('extv_challengeDisplay').classList.add('hidden');
            document.getElementById('extv_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('extv_stopBtn').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.remove('hidden');
            document.getElementById('extv_newGameBtn').classList.remove('hidden');

            extvShowBreakdown();
            extvRenderHistory();
        }

        function extvPlayAgain() {
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            extvStartGame();
        }

        function extvNewGame() {
            document.getElementById('extv_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('extv_breakdownSection').classList.add('hidden');
            document.getElementById('extv_playAgainBtn').classList.add('hidden');
            document.getElementById('extv_newGameBtn').classList.add('hidden');
            document.getElementById('extv_startBtn').classList.remove('hidden');
            document.getElementById('extv_settingsPanel').classList.remove('hidden');
        }

        function extvShowBreakdown() {
            const grid = document.getElementById('extv_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(extv_stats).length === 0) {
                document.getElementById('extv_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [chordName, data] of Object.entries(extv_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;

                const color = pct >= 80 ? 'bg-green-900 border-green-700' :
                              pct >= 50 ? 'bg-yellow-900 border-yellow-700' :
                              'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';

                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">${chordName}</p>
                                 <p>${pct}% (${data.firstTry}/${data.total})</p>
                                 <p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }

            document.getElementById('extv_breakdownSection').classList.remove('hidden');
        }

        function extvLoadHistory() {
            const savedHistory = localStorage.getItem('extvGameHistory');
            if (savedHistory) { extv_history = JSON.parse(savedHistory); }
            const savedCumulative = localStorage.getItem('extvCumulativeStats');
            if (savedCumulative) { extv_cumulativeStats = JSON.parse(savedCumulative); }
            extvRenderHistory();
        }

        function extvClearHistory() {
            extv_history = [];
            extv_cumulativeStats = {};
            localStorage.removeItem('extvGameHistory');
            localStorage.removeItem('extvCumulativeStats');
            extvRenderHistory();
        }

        function extvUpdateCumulativeStats() {
            for (const [chordName, data] of Object.entries(extv_stats)) {
                if (!extv_cumulativeStats[chordName]) {
                    extv_cumulativeStats[chordName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                extv_cumulativeStats[chordName].attempts += data.total;
                extv_cumulativeStats[chordName].firstTry += data.firstTry;
                extv_cumulativeStats[chordName].totalTime += data.times.reduce((a, b) => a + b, 0);
                extv_cumulativeStats[chordName].slow += data.slow || 0;
            }
            localStorage.setItem('extvCumulativeStats', JSON.stringify(extv_cumulativeStats));
        }

        function extvGetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(extv_cumulativeStats)) {
                if (data.attempts >= 3) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    if (successRate < 80 || slowRate > 30) {
                        areas.push({ name, successRate: successRate.toFixed(0), slowRate: slowRate.toFixed(0), attempts: data.attempts });
                    }
                }
            }
            return areas.sort((a, b) => parseFloat(a.successRate) - parseFloat(b.successRate)).slice(0, 5);
        }

        function extvRenderHistory() {
            const content = document.getElementById('extv_historyContent');
            if (extv_history.length === 0 && Object.keys(extv_cumulativeStats).length === 0) {
                content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>';
                return;
            }

            let html = '';

            // Problem areas
            const problemAreas = extvGetProblemAreas();
            if (problemAreas.length > 0) {
                html += '<div class="mb-4 p-3 bg-yellow-900/30 border border-yellow-700 rounded">';
                html += '<p class="text-yellow-400 font-semibold mb-2">⚠️ Problem Areas (need practice)</p>';
                html += '<div class="flex flex-wrap gap-2">';
                problemAreas.forEach(area => {
                    const successIndicator = area.successRate < 80 ? `<span class="text-red-400">${area.successRate}%</span>` : `<span class="text-green-400">${area.successRate}%</span>`;
                    const slowIndicator = area.slowRate > 30 ? `<span class="text-orange-400 ml-1">⏱${area.slowRate}%</span>` : '';
                    const indicators = successIndicator + slowIndicator;
                    html += `<div class="bg-slate-800 px-2 py-1 rounded text-sm">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            // Recent games
            if (extv_history.length > 0) {
                html += '<p class="text-slate-400 text-sm mb-2">Recent Games:</p>';
                html += '<div class="space-y-1">';
                extv_history.forEach(game => {
                    const date = new Date(game.date).toLocaleDateString();
                    const typeLabel = game.chordType === 'all' ? 'All' : EXTENDED_VOICINGS[game.chordType]?.suffix || game.chordType;
                    const slowLabel = game.slow > 0 ? ` | <span class="text-orange-400">${game.slow} slow</span>` : '';
                    html += `<div class="text-sm">
                        <span class="text-slate-500">${date}</span>
                        <span class="text-slate-400 ml-2">${typeLabel}</span>
                        <span class="ml-2 ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 50 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span>
                        <span class="text-slate-500">(${game.score}/${game.total})</span>
                        <span class="text-purple-400 ml-2">${game.avgTime}s avg</span>
                        ${slowLabel}
                    </div>`;
                });
                html += '</div>';
            }

            content.innerHTML = html;
        }

        // ============ ROOTLESS ii-V-I MODE ============
        // Voice-led progressions: Type A → Type B → Type A
        // ii (m7 Type A) → V (dom7 Type B) → I (Maj7 Type A)
        const R251_VOICINGS = {
            ii: { type: 'min7', voicing: 'A', intervals: [3, 7, 10, 2], formula: 'b3 - 5 - b7 - 9' },
            V:  { type: 'dom7', voicing: 'B', intervals: [10, 2, 4, 7], formula: 'b7 - 9 - 3 - 5' },
            I:  { type: 'maj7', voicing: 'A', intervals: [4, 7, 11, 2], formula: '3 - 5 - 7 - 9' }
        };

        let r251_isPlaying = false;
        let r251_challenge = null;
        let r251_usedKeys = new Set();
        let r251_challengeStartTime = null;
        let r251_stepStartTime = null;
        let r251_config = null;
        let r251_currentRound = 0;
        let r251_currentStep = 0; // 0=ii, 1=V, 2=I
        let r251_firstTryCorrect = 0;
        let r251_totalMistakes = 0;
        let r251_roundHadMistake = false;
        let r251_attemptHadMistake = false;
        let r251_stats = {};
        let r251_allTimes = [];
        let r251_stepTimes = [];
        let r251_slowCount = 0;
        let r251_history = [];
        let r251_cumulativeStats = {};

        function r251GetProgression(key) {
            // key = root of the I chord (e.g., 0 for C major)
            // ii = minor 7 built on 2nd degree
            // V = dominant 7 built on 5th degree
            // I = major 7 built on root
            const iiRoot = (key + 2) % 12;
            const VRoot = (key + 7) % 12;
            const IRoot = key;

            const iiVoicing = R251_VOICINGS.ii;
            const VVoicing = R251_VOICINGS.V;
            const IVoicing = R251_VOICINGS.I;

            return [
                {
                    root: iiRoot,
                    name: NOTE_NAMES[iiRoot] + 'm7',
                    voicingType: 'A',
                    pitchClasses: new Set(iiVoicing.intervals.map(i => (iiRoot + i) % 12)),
                    noteNames: iiVoicing.intervals.map(i => NOTE_NAMES[(iiRoot + i) % 12]),
                    formula: iiVoicing.formula,
                    degree: 'ii'
                },
                {
                    root: VRoot,
                    name: NOTE_NAMES[VRoot] + '7',
                    voicingType: 'B',
                    pitchClasses: new Set(VVoicing.intervals.map(i => (VRoot + i) % 12)),
                    noteNames: VVoicing.intervals.map(i => NOTE_NAMES[(VRoot + i) % 12]),
                    formula: VVoicing.formula,
                    degree: 'V'
                },
                {
                    root: IRoot,
                    name: NOTE_NAMES[IRoot] + 'Maj7',
                    voicingType: 'A',
                    pitchClasses: new Set(IVoicing.intervals.map(i => (IRoot + i) % 12)),
                    noteNames: IVoicing.intervals.map(i => NOTE_NAMES[(IRoot + i) % 12]),
                    formula: IVoicing.formula,
                    degree: 'I'
                }
            ];
        }

        function r251StartGame() {
            saveAllSettings();
            r251_config = {
                totalRounds: parseInt(document.getElementById('r251_roundsSelect').value),
                showHints: document.getElementById('r251_showHints').checked
            };
            r251_currentRound = 0;
            r251_currentStep = 0;
            r251_firstTryCorrect = 0;
            r251_totalMistakes = 0;
            r251_slowCount = 0;
            r251_roundHadMistake = false;
            r251_attemptHadMistake = false;
            r251_usedKeys = new Set();
            r251_stats = {};
            r251_allTimes = [];

            document.getElementById('r251_roundDisplay').innerText = '0';
            document.getElementById('r251_totalRoundsDisplay').innerText = r251_config.totalRounds;
            document.getElementById('r251_responseTime').innerText = '--';
            document.getElementById('r251_scoreDisplay').innerText = '0';
            document.getElementById('r251_mistakesDisplay').innerText = '0';
            document.getElementById('r251_slowDisplay').innerText = '0';

            document.getElementById('r251_startBtn').classList.add('hidden');
            document.getElementById('r251_stopBtn').classList.remove('hidden');
            document.getElementById('r251_playAgainBtn').classList.add('hidden');
            document.getElementById('r251_newGameBtn').classList.add('hidden');
            document.getElementById('r251_settingsPanel').classList.add('hidden');
            document.getElementById('r251_challengeDisplay').classList.remove('hidden');
            document.getElementById('r251_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('r251_breakdownSection').classList.add('hidden');

            r251RunCountdown(3);
        }

        function r251RunCountdown(seconds) {
            if (seconds > 0) {
                document.getElementById('r251_keyDisplay').innerText = seconds;
                document.getElementById('r251_formulaLine').classList.add('hidden');
                document.getElementById('r251_noteHint').classList.add('hidden');
                document.getElementById('r251_heldNotes').innerText = 'Get ready...';
                r251ResetChordBoxes();
                setTimeout(() => r251RunCountdown(seconds - 1), 1000);
            } else {
                document.getElementById('r251_formulaLine').classList.remove('hidden');
                r251_isPlaying = true;
                r251NextChallenge();
            }
        }

        function r251ResetChordBoxes() {
            for (let i = 1; i <= 3; i++) {
                const box = document.getElementById(`r251_chord${i}Box`);
                box.classList.remove('border-blue-400', 'bg-blue-900/30', 'border-green-400', 'bg-green-900/30');
                box.classList.add('border-slate-600', 'bg-slate-800');
                document.getElementById(`r251_chord${i}Name`).classList.remove('text-white', 'text-green-400');
                document.getElementById(`r251_chord${i}Name`).classList.add('text-slate-500');
            }
        }

        function r251HighlightCurrentChord() {
            for (let i = 1; i <= 3; i++) {
                const box = document.getElementById(`r251_chord${i}Box`);
                const name = document.getElementById(`r251_chord${i}Name`);

                if (i - 1 < r251_currentStep) {
                    // Completed
                    box.classList.remove('border-slate-600', 'bg-slate-800', 'border-blue-400', 'bg-blue-900/30');
                    box.classList.add('border-green-400', 'bg-green-900/30');
                    name.classList.remove('text-slate-500', 'text-white');
                    name.classList.add('text-green-400');
                } else if (i - 1 === r251_currentStep) {
                    // Current
                    box.classList.remove('border-slate-600', 'bg-slate-800', 'border-green-400', 'bg-green-900/30');
                    box.classList.add('border-blue-400', 'bg-blue-900/30');
                    name.classList.remove('text-slate-500', 'text-green-400');
                    name.classList.add('text-white');
                } else {
                    // Upcoming
                    box.classList.remove('border-blue-400', 'bg-blue-900/30', 'border-green-400', 'bg-green-900/30');
                    box.classList.add('border-slate-600', 'bg-slate-800');
                    name.classList.remove('text-white', 'text-green-400');
                    name.classList.add('text-slate-500');
                }
            }
        }

        function r251NextChallenge() {
            if (r251_currentRound >= r251_config.totalRounds) {
                r251EndGame();
                return;
            }

            clearAllHighlights('r251_pianoSvg');
            r251_currentRound++;
            r251_currentStep = 0;
            r251_roundHadMistake = false;
            r251_attemptHadMistake = false;
            r251_stepTimes = [];

            // Pick random unused key
            if (r251_usedKeys.size >= 12) r251_usedKeys.clear();
            const allKeys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const unusedKeys = allKeys.filter(k => !r251_usedKeys.has(k));
            const key = unusedKeys[Math.floor(Math.random() * unusedKeys.length)];
            r251_usedKeys.add(key);

            const progression = r251GetProgression(key);
            r251_challenge = { key, progression, keyName: NOTE_NAMES[key] };

            // Update UI
            document.getElementById('r251_roundDisplay').innerText = r251_currentRound;
            document.getElementById('r251_keyDisplay').innerText = r251_challenge.keyName;

            // Set chord names
            document.getElementById('r251_chord1Name').innerText = progression[0].name;
            document.getElementById('r251_chord2Name').innerText = progression[1].name;
            document.getElementById('r251_chord3Name').innerText = progression[2].name;

            r251ResetChordBoxes();
            r251HighlightCurrentChord();
            r251UpdateCurrentChordDisplay();

            r251_challengeStartTime = Date.now();
            r251_stepStartTime = Date.now();
        }

        function r251UpdateCurrentChordDisplay() {
            if (!r251_challenge) return;
            const currentChord = r251_challenge.progression[r251_currentStep];

            document.getElementById('r251_formulaHint').innerText = currentChord.formula;
            document.getElementById('r251_heldNotes').innerText = 'Holding: --';

            // Show/hide note hint based on settings
            const noteHintEl = document.getElementById('r251_noteHint');
            if (r251_config.showHints) {
                noteHintEl.innerText = currentChord.noteNames.join(' - ');
                noteHintEl.classList.remove('hidden');
            } else {
                noteHintEl.classList.add('hidden');
            }
        }

        function r251OnNoteOn(midi) {
            highlightKey('r251_pianoSvg', midi, 'key-held');

            if (!r251_isPlaying || !r251_challenge) return;

            const currentChord = r251_challenge.progression[r251_currentStep];
            const notePitchClass = midi % 12;
            const requiredPitchClasses = currentChord.pitchClasses;

            // Check if note is wrong
            const isWrongNote = !requiredPitchClasses.has(notePitchClass);

            if (isWrongNote) {
                if (!r251_attemptHadMistake) {
                    r251_totalMistakes++;
                    r251_attemptHadMistake = true;
                    r251_roundHadMistake = true;
                    r251ShowFeedback('✗', false);
                    document.getElementById('r251_mistakesDisplay').innerText = r251_totalMistakes;
                }
                highlightKey('r251_pianoSvg', midi, 'key-wrong');
            }

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('r251_heldNotes').innerText = `Holding: ${heldNames || '--'}`;

            // Check if all required notes are held
            const hasAllRequired = [...requiredPitchClasses].every(pc => heldPitchClasses.has(pc));

            if (hasAllRequired && heldNotes.size >= 4) {
                // Chord complete!
                const stepTime = (Date.now() - r251_stepStartTime) / 1000;
                r251_stepTimes.push(stepTime);

                // Track slow responses (> 2 seconds per chord)
                if (stepTime > 2) {
                    r251_slowCount++;
                    document.getElementById('r251_slowDisplay').innerText = r251_slowCount;
                }

                // Score this chord
                if (!r251_attemptHadMistake) {
                    r251_firstTryCorrect++;
                    document.getElementById('r251_scoreDisplay').innerText = r251_firstTryCorrect;
                }

                r251ShowFeedback('✓', true, stepTime);

                // Highlight correct notes
                heldNotes.forEach(n => {
                    if (requiredPitchClasses.has(n % 12)) {
                        highlightKey('r251_pianoSvg', n, 'key-active');
                    }
                });

                // Move to next step
                r251_currentStep++;
                r251_attemptHadMistake = false;

                if (r251_currentStep >= 3) {
                    // Progression complete!
                    r251_isPlaying = false;
                    const avgTime = r251_stepTimes.reduce((a, b) => a + b, 0) / r251_stepTimes.length;
                    r251_allTimes.push(avgTime);

                    // Track stats by key
                    const keyName = r251_challenge.keyName;
                    if (!r251_stats[keyName]) r251_stats[keyName] = { firstTry: 0, total: 0, times: [], slow: 0 };
                    r251_stats[keyName].total++;
                    if (!r251_roundHadMistake) {
                        r251_stats[keyName].firstTry++;
                        r251_stats[keyName].times.push(avgTime);
                    }
                    // Count slow chords in this round
                    r251_stats[keyName].slow += r251_stepTimes.filter(t => t > 2).length;

                    r251UpdateResponseTime(avgTime);
                    r251HighlightCurrentChord();

                    setTimeout(() => {
                        r251_isPlaying = true;
                        r251NextChallenge();
                    }, 800);
                } else {
                    // Move to next chord
                    r251_stepStartTime = Date.now();
                    setTimeout(() => {
                        clearAllHighlights('r251_pianoSvg');
                        r251HighlightCurrentChord();
                        r251UpdateCurrentChordDisplay();
                    }, 400);
                }
            }
        }

        function r251OnNoteOff(midi) {
            highlightKey('r251_pianoSvg', midi, 'key-held', false);
            highlightKey('r251_pianoSvg', midi, 'key-wrong', false);
            highlightKey('r251_pianoSvg', midi, 'key-active', false);

            // Update held notes display
            const heldPitchClasses = new Set([...heldNotes].map(n => n % 12));
            const heldNames = [...heldPitchClasses].map(pc => NOTE_NAMES[pc]).join(' ');
            document.getElementById('r251_heldNotes').innerText = `Holding: ${heldNames || '--'}`;
        }

        function r251ShowFeedback(text, isPositive, time = null) {
            const el = document.getElementById('r251_feedbackFloat');
            el.innerText = time !== null ? `${text} ${time.toFixed(1)}s` : text;
            el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none feedback-anim ' + (isPositive ? 'text-green-400' : 'text-red-400');
            setTimeout(() => { el.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold pointer-events-none opacity-0'; }, 1000);
        }

        function r251UpdateResponseTime(avgTime) {
            const el = document.getElementById('r251_responseTime');
            el.innerText = avgTime.toFixed(1) + 's';
            el.className = 'text-2xl font-mono ' + (avgTime < 2 ? 'timer-fast' : avgTime < 4 ? 'timer-medium' : 'timer-slow');
        }

        function r251StopGame() {
            r251_isPlaying = false;
            r251_challenge = null;
            clearAllHighlights('r251_pianoSvg');
            document.getElementById('r251_startBtn').classList.remove('hidden');
            document.getElementById('r251_stopBtn').classList.add('hidden');
            document.getElementById('r251_challengeDisplay').classList.add('hidden');
            document.getElementById('r251_settingsPanel').classList.remove('hidden');
        }

        function r251EndGame() {
            r251_isPlaying = false;
            r251_challenge = null;
            clearAllHighlights('r251_pianoSvg');

            const totalProgressions = r251_config.totalRounds;
            const totalChords = totalProgressions * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((r251_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = r251_allTimes.length > 0 ? r251_allTimes.reduce((a, b) => a + b, 0) / r251_allTimes.length : 0;

            // Save to history
            r251_history.unshift({
                date: new Date().toISOString(),
                config: { ...r251_config },
                score: r251_firstTryCorrect,
                totalChords,
                accuracy,
                avgTime,
                totalMistakes: r251_totalMistakes,
                slowCount: r251_slowCount,
                stats: JSON.parse(JSON.stringify(r251_stats))
            });
            if (r251_history.length > 50) r251_history.pop();
            localStorage.setItem('r251GameHistory', JSON.stringify(r251_history));

            r251UpdateCumulativeStats();
            r251ShowGameComplete();
        }

        function r251ShowGameComplete() {
            const totalChords = r251_config.totalRounds * 3;
            const accuracy = totalChords > 0 ? Math.min(100, Math.round((r251_firstTryCorrect / totalChords) * 100)) : 0;
            const avgTime = r251_allTimes.length > 0 ? r251_allTimes.reduce((a, b) => a + b, 0) / r251_allTimes.length : 0;

            document.getElementById('r251_finalScore').innerText = `${r251_firstTryCorrect}/${totalChords}`;
            document.getElementById('r251_finalAccuracy').innerText = `${accuracy}%`;
            document.getElementById('r251_finalMistakes').innerText = r251_totalMistakes;
            document.getElementById('r251_finalAvgTime').innerText = avgTime.toFixed(1) + 's';
            document.getElementById('r251_finalSlow').innerText = r251_slowCount;

            // Identify weak areas
            const weakAreas = Object.entries(r251_stats)
                .filter(([_, data]) => data.firstTry < data.total)
                .map(([name, _]) => name);
            document.getElementById('r251_finalWeakAreas').innerText = weakAreas.length > 0 ? 'Needs practice: ' + weakAreas.join(', ') : '';

            document.getElementById('r251_challengeDisplay').classList.add('hidden');
            document.getElementById('r251_gameCompleteDisplay').classList.remove('hidden');
            document.getElementById('r251_stopBtn').classList.add('hidden');
            document.getElementById('r251_playAgainBtn').classList.remove('hidden');
            document.getElementById('r251_newGameBtn').classList.remove('hidden');

            r251ShowBreakdown();
            r251RenderHistory();
        }

        function r251PlayAgain() {
            document.getElementById('r251_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('r251_playAgainBtn').classList.add('hidden');
            document.getElementById('r251_newGameBtn').classList.add('hidden');
            r251StartGame();
        }

        function r251NewGame() {
            document.getElementById('r251_gameCompleteDisplay').classList.add('hidden');
            document.getElementById('r251_breakdownSection').classList.add('hidden');
            document.getElementById('r251_playAgainBtn').classList.add('hidden');
            document.getElementById('r251_newGameBtn').classList.add('hidden');
            document.getElementById('r251_startBtn').classList.remove('hidden');
            document.getElementById('r251_settingsPanel').classList.remove('hidden');
        }

        function r251ShowBreakdown() {
            const grid = document.getElementById('r251_breakdownGrid');
            grid.innerHTML = '';
            if (Object.keys(r251_stats).length === 0) {
                document.getElementById('r251_breakdownSection').classList.add('hidden');
                return;
            }

            for (const [keyName, data] of Object.entries(r251_stats)) {
                const pct = Math.round((data.firstTry / data.total) * 100);
                const avgT = data.times.length > 0 ? (data.times.reduce((a, b) => a + b, 0) / data.times.length) : 0;
                const avgTStr = avgT > 0 ? avgT.toFixed(1) : '--';
                const isSlow = avgT > 2;

                const color = pct >= 80 ? 'bg-green-900 border-green-700' :
                              pct >= 50 ? 'bg-yellow-900 border-yellow-700' :
                              'bg-red-900 border-red-700';
                const slowIndicator = isSlow ? ' ring-2 ring-orange-500' : '';

                const div = document.createElement('div');
                div.className = `p-2 rounded border ${color}${slowIndicator} text-sm`;
                const timeClass = isSlow ? 'text-orange-400' : 'text-slate-400';
                div.innerHTML = `<p class="font-semibold">Key of ${keyName}</p>
                                 <p>${pct}% (${data.firstTry}/${data.total})</p>
                                 <p class="text-xs ${timeClass}">Avg: ${avgTStr}s${isSlow ? ' ⏱' : ''}</p>`;
                grid.appendChild(div);
            }
            document.getElementById('r251_breakdownSection').classList.remove('hidden');
        }

        function r251LoadHistory() {
            const saved = localStorage.getItem('r251GameHistory');
            if (saved) { r251_history = JSON.parse(saved); }
            const savedCumulative = localStorage.getItem('r251CumulativeStats');
            if (savedCumulative) { r251_cumulativeStats = JSON.parse(savedCumulative); }
            r251RenderHistory();
        }

        function r251ClearHistory() {
            r251_history = [];
            r251_cumulativeStats = {};
            localStorage.removeItem('r251GameHistory');
            localStorage.removeItem('r251CumulativeStats');
            r251RenderHistory();
        }

        function r251UpdateCumulativeStats() {
            for (const [keyName, data] of Object.entries(r251_stats)) {
                if (!r251_cumulativeStats[keyName]) {
                    r251_cumulativeStats[keyName] = { attempts: 0, firstTry: 0, totalTime: 0, slow: 0 };
                }
                r251_cumulativeStats[keyName].attempts += data.total;
                r251_cumulativeStats[keyName].firstTry += data.firstTry;
                r251_cumulativeStats[keyName].totalTime += data.times.reduce((a, b) => a + b, 0);
                r251_cumulativeStats[keyName].slow += data.slow || 0;
            }
            localStorage.setItem('r251CumulativeStats', JSON.stringify(r251_cumulativeStats));
        }

        function r251GetProblemAreas() {
            const areas = [];
            for (const [name, data] of Object.entries(r251_cumulativeStats)) {
                if (data.attempts >= 3) {
                    const successRate = (data.firstTry / data.attempts) * 100;
                    const slowRate = ((data.slow || 0) / data.attempts) * 100;
                    const avgTime = data.totalTime / data.attempts;
                    const problemScore = (100 - successRate) + slowRate;
                    areas.push({ name, successRate, slowRate, avgTime, attempts: data.attempts, problemScore });
                }
            }
            return areas.sort((a, b) => b.problemScore - a.problemScore);
        }

        function r251RenderHistory() {
            const content = document.getElementById('r251_historyContent');
            if (r251_history.length === 0) { content.innerHTML = '<p class="italic text-slate-500">No games played yet.</p>'; return; }

            const totalGames = r251_history.length;
            const avgAccuracy = Math.round(r251_history.reduce((a, g) => a + g.accuracy, 0) / totalGames);

            const displayedGames = r251_history.slice(0, 10);
            const gamesWithSlowData = displayedGames.filter(g => g.slowCount !== undefined);
            const bestAccuracy = gamesWithSlowData.length > 0 ? Math.max(...gamesWithSlowData.map(g => g.accuracy)) : -1;
            const gamesWithBestAccuracy = gamesWithSlowData.filter(g => g.accuracy === bestAccuracy);
            const lowestSlow = gamesWithBestAccuracy.length > 0 ? Math.min(...gamesWithBestAccuracy.map(g => g.slowCount)) : 0;
            const gamesWithLowestSlow = gamesWithBestAccuracy.filter(g => g.slowCount === lowestSlow);
            const bestTime = gamesWithLowestSlow.length > 0 ? Math.min(...gamesWithLowestSlow.map(g => g.avgTime)) : 0;
            const isBest = (g) => g.slowCount !== undefined && g.accuracy === bestAccuracy && g.slowCount === lowestSlow && g.avgTime === bestTime;

            let html = `<div class="mb-4"><div class="grid grid-cols-2 gap-4 text-center mb-3">
                <div><p class="text-slate-400 text-xs">Games</p><p class="text-xl font-bold text-white">${totalGames}</p></div>
                <div><p class="text-slate-400 text-xs">Avg Accuracy</p><p class="text-xl font-bold ${avgAccuracy >= 80 ? 'text-green-400' : avgAccuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${avgAccuracy}%</p></div>
            </div></div><div class="border-t border-slate-700 pt-3"><p class="text-xs text-slate-400 mb-2">Recent: <span class="text-yellow-400">★</span> = best</p><div class="space-y-2 max-h-48 overflow-y-auto">`;

            displayedGames.forEach(game => {
                const date = new Date(game.date);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isTheBest = isBest(game);
                const rowClass = isTheBest ? 'bg-yellow-900/30 border border-yellow-700/50' : 'bg-slate-800';
                const slowCount = game.slowCount || 0;
                const slowStr = slowCount > 0 ? `<span class="text-yellow-400 text-xs ml-1">${slowCount}s</span>` : '';
                html += `<div class="flex justify-between items-center text-sm p-2 ${rowClass} rounded">
                    <div><span class="text-slate-400">${timeStr}</span><span class="text-xs text-slate-500 ml-2">${game.totalChords / 3}r</span></div>
                    <div><span class="font-bold ${game.accuracy >= 80 ? 'text-green-400' : game.accuracy >= 60 ? 'text-yellow-400' : 'text-red-400'}">${game.accuracy}%</span><span class="text-slate-500 text-xs ml-1">(${game.avgTime.toFixed(1)}s)</span>${slowStr}${isTheBest ? '<span class="text-yellow-400 ml-1">★</span>' : ''}</div>
                </div>`;
            });
            html += '</div></div>';

            // Problem areas
            const problemAreas = r251GetProblemAreas();
            if (problemAreas.length > 0) {
                html += `<div class="border-t border-slate-700 pt-3 mt-3">
                    <p class="text-xs text-slate-400 mb-2">Problem Areas</p>
                    <div class="space-y-1 max-h-32 overflow-y-auto">`;
                problemAreas.slice(0, 5).forEach(area => {
                    const mistakeRate = 100 - area.successRate;
                    const avgTime = area.avgTime || 0;
                    const hasMistakes = mistakeRate > 30;
                    let indicators = '';
                    if (hasMistakes) indicators += `<span class="text-red-400">✗${Math.round(mistakeRate)}%</span>`;
                    const timeClass = avgTime > 4 ? 'text-yellow-400' : 'text-slate-500';
                    indicators += `<span class="${timeClass} ml-1">${avgTime.toFixed(1)}s</span>`;
                    html += `<div class="flex justify-between items-center text-xs p-1 bg-slate-800 rounded">
                        <span class="text-slate-300">${area.name}</span>
                        <div>${indicators} <span class="text-slate-500 ml-1">(${area.attempts})</span></div>
                    </div>`;
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
        }

        // ============ SETTINGS PERSISTENCE ============
        function saveAllSettings() {
            const settings = {
                intervals: {
                    intervals: Array.from(document.querySelectorAll('.int-interval-cb:checked')).map(cb => parseInt(cb.value)),
                    direction: document.getElementById('int_directionSelect').value,
                    rounds: document.getElementById('int_roundsSelect').value
                },
                chords: {
                    types: Array.from(document.querySelectorAll('.ch-type-cb:checked')).map(cb => cb.value),
                    hands: document.getElementById('ch_handsSelect').value,
                    rounds: document.getElementById('ch_roundsSelect').value
                },
                iivi: {
                    voicing: document.getElementById('iivi_voicingSelect').value,
                    rounds: document.getElementById('iivi_roundsSelect').value
                },
                scales: {
                    chordType: document.getElementById('sc_chordTypeSelect').value,
                    rounds: document.getElementById('sc_roundsSelect').value,
                    showHints: document.getElementById('sc_showHints').checked
                },
                extensions: {
                    chordType: document.getElementById('ext_chordTypeSelect').value,
                    extension: document.getElementById('ext_extensionSelect').value,
                    rounds: document.getElementById('ext_roundsSelect').value,
                    showHints: document.getElementById('ext_showHints').checked
                },
                altered: {
                    alteration: document.getElementById('alt_alterationSelect').value,
                    voicing: document.getElementById('alt_voicingSelect').value,
                    rounds: document.getElementById('alt_roundsSelect').value
                },
                advanced: {
                    types: Array.from(document.querySelectorAll('.adv-type-cb:checked')).map(cb => cb.value),
                    rounds: document.getElementById('adv_roundsSelect').value,
                    showHints: document.getElementById('adv_showHints').checked
                },
                minorIivi: {
                    rounds: document.getElementById('miivi_roundsSelect').value
                },
                kennyBarron: {
                    chordType: document.getElementById('kb_chordType').value,
                    voicingType: document.getElementById('kb_voicingType').value,
                    rounds: document.getElementById('kb_rounds').value,
                    showHints: document.getElementById('kb_showHints').checked
                },
                jtou: {
                    voicing: document.getElementById('jtou_voicingSelect').value,
                    rounds: document.getElementById('jtou_roundsSelect').value,
                    showHints: document.getElementById('jtou_showHints').checked
                },
                dom7Voicing: {
                    chordType: document.getElementById('dom7v_chordTypeSelect').value,
                    voicingType: document.getElementById('dom7v_voicingTypeSelect').value,
                    rounds: document.getElementById('dom7v_roundsSelect').value,
                    showHints: document.getElementById('dom7v_showHints').checked
                },
                extendedVoicings: {
                    chordType: document.getElementById('extv_chordTypeSelect').value,
                    rounds: document.getElementById('extv_roundsSelect').value,
                    showHints: document.getElementById('extv_showHints').checked
                },
                rootless251: {
                    rounds: document.getElementById('r251_roundsSelect').value,
                    showHints: document.getElementById('r251_showHints').checked
                }
            };
            localStorage.setItem('pianoTutorSettings', JSON.stringify(settings));
        }

        function loadAllSettings() {
            const saved = localStorage.getItem('pianoTutorSettings');
            if (!saved) return;
            try {
                const settings = JSON.parse(saved);

                // Intervals
                if (settings.intervals) {
                    document.querySelectorAll('.int-interval-cb').forEach(cb => {
                        cb.checked = settings.intervals.intervals.includes(parseInt(cb.value));
                    });
                    if (settings.intervals.direction) document.getElementById('int_directionSelect').value = settings.intervals.direction;
                    if (settings.intervals.rounds) document.getElementById('int_roundsSelect').value = settings.intervals.rounds;
                }

                // Chords
                if (settings.chords) {
                    document.querySelectorAll('.ch-type-cb').forEach(cb => {
                        cb.checked = settings.chords.types.includes(cb.value);
                    });
                    if (settings.chords.hands) document.getElementById('ch_handsSelect').value = settings.chords.hands;
                    if (settings.chords.rounds) document.getElementById('ch_roundsSelect').value = settings.chords.rounds;
                }

                // ii-V-I
                if (settings.iivi) {
                    if (settings.iivi.voicing) document.getElementById('iivi_voicingSelect').value = settings.iivi.voicing;
                    if (settings.iivi.rounds) document.getElementById('iivi_roundsSelect').value = settings.iivi.rounds;
                }

                // Scales
                if (settings.scales) {
                    if (settings.scales.chordType) document.getElementById('sc_chordTypeSelect').value = settings.scales.chordType;
                    if (settings.scales.rounds) document.getElementById('sc_roundsSelect').value = settings.scales.rounds;
                    if (settings.scales.showHints !== undefined) document.getElementById('sc_showHints').checked = settings.scales.showHints;
                }

                // Extensions
                if (settings.extensions) {
                    if (settings.extensions.chordType) document.getElementById('ext_chordTypeSelect').value = settings.extensions.chordType;
                    if (settings.extensions.extension) document.getElementById('ext_extensionSelect').value = settings.extensions.extension;
                    if (settings.extensions.rounds) document.getElementById('ext_roundsSelect').value = settings.extensions.rounds;
                    if (settings.extensions.showHints !== undefined) document.getElementById('ext_showHints').checked = settings.extensions.showHints;
                }

                // Altered
                if (settings.altered) {
                    if (settings.altered.alteration) document.getElementById('alt_alterationSelect').value = settings.altered.alteration;
                    if (settings.altered.voicing) document.getElementById('alt_voicingSelect').value = settings.altered.voicing;
                    if (settings.altered.rounds) document.getElementById('alt_roundsSelect').value = settings.altered.rounds;
                }

                // Advanced
                if (settings.advanced) {
                    document.querySelectorAll('.adv-type-cb').forEach(cb => {
                        cb.checked = settings.advanced.types.includes(cb.value);
                    });
                    if (settings.advanced.rounds) document.getElementById('adv_roundsSelect').value = settings.advanced.rounds;
                    if (settings.advanced.showHints !== undefined) document.getElementById('adv_showHints').checked = settings.advanced.showHints;
                }

                // Minor ii-V-i
                if (settings.minorIivi) {
                    if (settings.minorIivi.rounds) document.getElementById('miivi_roundsSelect').value = settings.minorIivi.rounds;
                }

                // Kenny Barron
                if (settings.kennyBarron) {
                    if (settings.kennyBarron.chordType) document.getElementById('kb_chordType').value = settings.kennyBarron.chordType;
                    if (settings.kennyBarron.voicingType) document.getElementById('kb_voicingType').value = settings.kennyBarron.voicingType;
                    if (settings.kennyBarron.rounds) document.getElementById('kb_rounds').value = settings.kennyBarron.rounds;
                    if (settings.kennyBarron.showHints !== undefined) document.getElementById('kb_showHints').checked = settings.kennyBarron.showHints;
                }

                // JTOU
                if (settings.jtou) {
                    if (settings.jtou.voicing) document.getElementById('jtou_voicingSelect').value = settings.jtou.voicing;
                    if (settings.jtou.rounds) document.getElementById('jtou_roundsSelect').value = settings.jtou.rounds;
                    if (settings.jtou.showHints !== undefined) document.getElementById('jtou_showHints').checked = settings.jtou.showHints;
                }

                // Rootless Voicings
                if (settings.dom7Voicing) {
                    if (settings.dom7Voicing.chordType) document.getElementById('dom7v_chordTypeSelect').value = settings.dom7Voicing.chordType;
                    if (settings.dom7Voicing.voicingType) document.getElementById('dom7v_voicingTypeSelect').value = settings.dom7Voicing.voicingType;
                    if (settings.dom7Voicing.rounds) document.getElementById('dom7v_roundsSelect').value = settings.dom7Voicing.rounds;
                    if (settings.dom7Voicing.showHints !== undefined) document.getElementById('dom7v_showHints').checked = settings.dom7Voicing.showHints;
                }

                // Extended Voicings
                if (settings.extendedVoicings) {
                    if (settings.extendedVoicings.chordType) document.getElementById('extv_chordTypeSelect').value = settings.extendedVoicings.chordType;
                    if (settings.extendedVoicings.rounds) document.getElementById('extv_roundsSelect').value = settings.extendedVoicings.rounds;
                    if (settings.extendedVoicings.showHints !== undefined) document.getElementById('extv_showHints').checked = settings.extendedVoicings.showHints;
                }

                // Rootless ii-V-I
                if (settings.rootless251) {
                    if (settings.rootless251.rounds) document.getElementById('r251_roundsSelect').value = settings.rootless251.rounds;
                    if (settings.rootless251.showHints !== undefined) document.getElementById('r251_showHints').checked = settings.rootless251.showHints;
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // ============ INIT ============
        drawPiano('previewPianoSvg');
        drawPiano('pianoSvg');
        drawPiano('ch_pianoSvg');
        drawPiano('iivi_pianoSvg');
        drawPiano('sc_pianoSvg');
        drawPiano('ext_pianoSvg');
        drawPiano('alt_pianoSvg');
        drawPiano('adv_pianoSvg');
        drawPiano('miivi_pianoSvg');
        drawPiano('kb_pianoSvg');
        drawPiano('jtou_pianoSvg');
        drawPiano('dom7v_pianoSvg');
        drawPiano('extv_pianoSvg');
        drawPiano('r251_pianoSvg');
        initMIDI();
        intLoadHistory();
        chLoadHistory();
        document.getElementById('ch_handsSelect').addEventListener('change', function() {
            const hint = document.getElementById('ch_settingsHint');
            if (this.value === 'two') {
                hint.innerText = 'Play the chord in two separate octaves (8 notes total). Same chord, both hands.';
            } else {
                hint.innerText = 'Play all 4 notes of the chord (any octave, any voicing). Root + 3rd + 5th + 7th.';
            }
        });
        iiviLoadHistory();
        scLoadHistory();
        extLoadHistory();
        altLoadHistory();
        advLoadHistory();
        miiviLoadHistory();
        kbLoadHistory();
        jtouLoadHistory();
        dom7vLoadHistory();
        extvLoadHistory();
        r251LoadHistory();
        loadAllSettings();
        document.getElementById('jtou_voicingSelect').addEventListener('change', function() {
            const hint = document.getElementById('jtou_settingsHint');
            if (this.value === 'no5') {
                hint.innerText = 'V chord has no 5th (4 notes: R-3-b7-#9). In Fm: Dbmaj9 → C7#9 (C-E-Bb-Eb) → Fm9';
            } else {
                hint.innerText = 'The classic Grover Washington Jr. / Bill Withers progression. In Fm: Dbmaj9 → C7#9 → Fm9';
            }
        });
        window.addEventListener('resize', () => { drawPiano('previewPianoSvg'); drawPiano('pianoSvg'); drawPiano('ch_pianoSvg'); drawPiano('iivi_pianoSvg'); drawPiano('sc_pianoSvg'); drawPiano('ext_pianoSvg'); drawPiano('alt_pianoSvg'); drawPiano('adv_pianoSvg'); drawPiano('miivi_pianoSvg'); drawPiano('kb_pianoSvg'); drawPiano('jtou_pianoSvg'); drawPiano('dom7v_pianoSvg'); drawPiano('extv_pianoSvg'); drawPiano('r251_pianoSvg'); });
    </script>
</body>
</html>
