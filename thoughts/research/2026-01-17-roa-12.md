---
date: 2026-01-17
author: claude
bead: the-shed-roa.12
topic: "Mode Instrumentation Research - All 20 Modes"
tags: [research, session-logging, instrumentation, modes]
last_updated: 2026-01-17
last_updated_by: claude
last_updated_note: "Added critical review"
review_status: reviewed
---

# Mode Instrumentation Research: All 20 Modes

## Task Context

Add session logging hooks to all 20 practice modes using identical patterns:
- StartGame() calls sessionLogStartSession(mode, config)
- NextChallenge() calls sessionLogStartRound(challenge)
- Correct-answer handler calls sessionLogEndRound(result)
- EndGame() calls sessionLogEndSession()

## Session Logging API (from the-shed-roa.1)

**Location:** `/workspaces/the-shed/.worktrees/auto-fix-roa-12/session-logging.js`

### Core Functions

```javascript
sessionLogStartSession(mode, config)  // Start new session
sessionLogStartRound(challenge)       // Start new round (extracts expectedPitchClasses)
sessionLogEndRound(result)            // End round with result data
sessionLogEndSession()                // End session, save to localStorage
sessionLogRecordEvent(type, midi, velocity)  // Record MIDI event (already in handleMIDI)
```

### Challenge Pitch Class Extraction

The `sessionLogExtractExpectedPitchClasses(challenge)` function handles multiple challenge formats:
- `challenge.expectedPitchClasses` (direct array)
- `challenge.requiredPitchClasses` (Set or Array) - chord modes
- `challenge.targetMidi` (single number) - interval mode
- `challenge.fullPitchClasses` (Set) - tritone, voiceleading
- `challenge.shellPitchClasses` (Set) - shell voicings
- `challenge.targetChord.pitchClasses` - voiceleading target

## MIDI Handler Instrumentation Status

**Already implemented in handleMIDI()** (lines 4466-4500):
```javascript
// Session logging
if (sessionLogEnabled && currentRoundLog) {
    sessionLogRecordEvent('noteOn', note, vel);
}
```

The `sessionLogRecordEvent` function calculates `isCorrect` internally by comparing `midi % 12` against `currentRoundLog.expectedPitchClasses`.

## All 20 Modes - Complete Mapping

| # | Mode ID | Prefix | StartGame Line | NextChallenge Line | EndGame Line | Config Available |
|---|---------|--------|----------------|-------------------|--------------|------------------|
| 1 | intervals | int | 4627 | 4716 | 4870 | int_config |
| 2 | chords | ch | 5095 | 5174 | 5337 | ch_config |
| 3 | iivi | iivi | 5650 | 5769 | 6058 | iivi_config |
| 4 | scales | sc | 6361 | 6471 | 6626 | sc_config |
| 5 | ext | ext | 6844 | 6933 | N/A* | ext_config |
| 6 | alt | alt | 7326 | 7407 | N/A* | alt_config |
| 7 | adv | adv | 7769 | 7858 | 8020 | adv_config |
| 8 | minorIivi | miivi | 8280 | 8385 | 8610 | miivi_config |
| 9 | kb | kb | 8853 | 8966 | N/A* | kb_config |
| 10 | jtou | jtou | 9408 | 9498 | 9701 | jtou_config |
| 11 | dom7v | dom7v | 9972 | 10064 | 10276 | dom7v_config |
| 12 | extv | extv | 10512 | 10594 | 10772 | extv_config |
| 13 | pent | pent | 10990 | 11081 | 11270 | pent_config |
| 14 | bebop | bebop | 11509 | 11598 | 11769 | bebop_config |
| 15 | tritone | tritone | 11987 | 12056** | 12191 | tritone_config |
| 16 | shell | shell | 12420 | 12500** | 12671 | shell_config |
| 17 | upper | upper | 12946 | 13020** | 13188 | upper_config |
| 18 | freestyle | freestyle | 13742 | N/A*** | 14033 | N/A |
| 19 | attya | attya | 14270 | 14360** | 14468 | attya_config |
| 20 | voicelead | vl | 14693 | 14762 | 14961 | N/A (uses DOM) |

*Notes:*
- *Modes 5, 6, 9 (ext, alt, kb) appear to be continuous/endless modes without EndGame
- **Line numbers estimated for NextChallenge based on pattern
- ***freestyle mode has no traditional challenge structure

## Challenge Object Structures by Mode

### Interval Mode (int)
```javascript
int_challenge = {
    startMidi,        // Starting MIDI note
    interval,         // Interval size in semitones
    direction,        // 'up' or 'down'
    targetMidi        // Target MIDI note to play
};
```
**Expected Pitch Classes:** `[targetMidi % 12]`

### Chord Mode (ch)
```javascript
ch_challenge = {
    root,             // Root pitch class (0-11)
    type,             // Chord type string ('maj7', 'min7', etc.)
    requiredPitchClasses, // Set of pitch classes
    name              // Display name like "C maj7"
};
```
**Expected Pitch Classes:** `Array.from(requiredPitchClasses)`

### ii-V-I Mode (iivi)
```javascript
iivi_challenge = {
    key,              // Key pitch class
    chords,           // Array of chord objects for ii, V, I
    currentStep       // 0, 1, or 2
};
// Each chord has:
chord.pitchClasses   // Set of pitch classes
```
**Expected Pitch Classes:** `Array.from(chords[currentStep].pitchClasses)`

### Scales Mode (sc)
```javascript
sc_challenge = {
    rootMidi,         // Root MIDI note
    scaleType,        // Scale type string
    scaleNotes,       // Array of MIDI notes in the scale
    currentNoteIndex  // Current position in scale
};
```
**Expected Pitch Classes:** `[scaleNotes[currentNoteIndex] % 12]`

### Tritone Mode (tritone)
```javascript
tritone_challenge = {
    originalRoot,     // Original dominant root
    subRoot,          // Tritone substitute root
    fullPitchClasses, // Set - full voicing
    shellPitchClasses // Set - shell voicing
};
```
**Expected Pitch Classes:** Based on voicing setting

### Voice Leading Mode (vl)
```javascript
vl_challenge = {
    sourceChord,      // Source chord object
    targetChord,      // Target chord object with .pitchClasses
    sourceNotes,      // Pitch classes for source
    targetNotes,      // Pitch classes for target
    common,           // Common tones
    resolutions       // Voice resolutions
};
```
**Expected Pitch Classes:** Depends on phase (source vs target)

## Config Objects by Mode

Each mode builds a config object at StartGame that should be passed to `sessionLogStartSession`:

### Standard Config Pattern
```javascript
{prefix}_config = {
    totalRounds: parseInt(document.getElementById('{prefix}_roundsSelect').value),
    // Mode-specific settings...
};
```

### Examples of Mode-Specific Config Fields

**intervals (int_config):**
- `intervals` - array of interval sizes
- `direction` - 'up', 'down', or 'both'
- `focusProblemAreas` - boolean

**chords (ch_config):**
- `types` - array of chord types
- `twoHands` - boolean
- `focusProblemAreas` - boolean

**tritone (tritone_config):**
- `voicing` - 'shell' or 'full'
- `rounds` - number
- `showHints` - boolean

## Result Data Available at EndRound

Each correct-answer handler has access to:
- `responseTime` - time since challenge started (calculated as `Date.now() - {prefix}_challengeStartTime`)
- `isFirstTry` - whether answered correctly on first attempt (`!{prefix}_roundHadMistake`)
- `mistakes` - number of mistakes this round

**Standard result object:**
```javascript
{
    responseTime: Date.now() - {prefix}_challengeStartTime,
    isFirstTry: !{prefix}_roundHadMistake,
    mistakes: /* calculated per mode */
}
```

## Summary Data Available at EndGame

All EndGame functions build a history record with consistent fields:

```javascript
{
    date: new Date().toISOString(),
    rounds: {prefix}_config.totalRounds,  // or similar
    avgTime: /* calculated from {prefix}_allTimes */,
    firstTryPct: Math.round(({prefix}_firstTryCorrect / rounds) * 100),
    mistakes: {prefix}_totalMistakes,
    slowCount: {prefix}_slowCount,
    config: { ...{prefix}_config },       // Mode settings
    stats: { ...{prefix}_stats }          // Per-item breakdown
}
```

## Implementation Pattern per Mode

### 1. StartGame Insertion Point

After config is built, before countdown starts:
```javascript
function {prefix}StartGame() {
    // ... build config ...
    {prefix}_config = { ... };

    // ADD: Session logging
    sessionLogStartSession('{modeId}', {prefix}_config);

    // ... reset counters ...
    {prefix}RunCountdown(3);
}
```

### 2. NextChallenge Insertion Point

After challenge object is built:
```javascript
function {prefix}NextChallenge() {
    // ... build challenge ...
    {prefix}_challenge = { ... };
    {prefix}_challengeStartTime = Date.now();

    // ADD: Session logging
    sessionLogStartRound({prefix}_challenge);

    // ... update UI ...
}
```

### 3. Correct-Answer Handler Insertion Point

After incrementing first try count, before calling NextChallenge:
```javascript
if (isCorrect) {
    if (!{prefix}_roundHadMistake) {
        {prefix}_firstTryCorrect++;
        // ...
    }

    // ADD: Session logging
    sessionLogEndRound({
        responseTime: Date.now() - {prefix}_challengeStartTime,
        isFirstTry: !{prefix}_roundHadMistake,
        mistakes: {prefix}_roundMistakes  // if tracked
    });

    // Transition to next challenge
    setTimeout(() => {prefix}NextChallenge(), 600);
}
```

### 4. EndGame Insertion Point

At the start of EndGame, before any cleanup:
```javascript
function {prefix}EndGame() {
    // ADD: Session logging (must be first!)
    sessionLogEndSession();

    {prefix}_isPlaying = false;
    // ... rest of EndGame ...
}
```

## Special Considerations

### Modes Without Traditional EndGame

Some modes (ext, alt, kb) are continuous practice modes without rounds. These may need:
- Alternative session end trigger (Stop button)
- Modified logging approach

### Multi-Phase Challenges (vl, iivi)

Voice leading and ii-V-I modes have multi-step challenges:
- `sessionLogStartRound` should be called once at challenge start
- `sessionLogEndRound` should be called when the full challenge is complete
- Expected pitch classes change between phases - may need custom handling

### Freestyle Mode

Freestyle has no structure - may not need session logging or needs custom approach.

## Files to Modify

1. **index.html** - All 20 mode implementations (lines 4627-15052 approximately)

## Verification Checklist

For each mode, verify:
- [ ] sessionLogStartSession called in StartGame after config built
- [ ] sessionLogStartRound called in NextChallenge after challenge built
- [ ] sessionLogEndRound called in correct-answer handler with result data
- [ ] sessionLogEndSession called at start of EndGame
- [ ] Config object contains all relevant mode settings
- [ ] Challenge object has fields compatible with pitch class extraction
- [ ] StopGame also calls sessionLogEndSession (for early stops)

---

## Review: 2026-01-17

**Reviewer**: claude
**Review commit**: 05dcdba2d4453ce57c7da22f5f5fd7ef6ca6a776
**Research commit**: (not specified in frontmatter)
**Staleness**: 0 commits since research (current)

### Validation Summary

| Metric | Score | Notes |
|--------|-------|-------|
| Accuracy | 85% | Several line numbers and function names incorrect |
| Completeness | 90% | Core modes covered; missing attya challenge structure |
| Actionability | 95% | Clear insertion patterns, ready for implementation |
| Currency | 100% | Research matches current codebase state |
| Relevance | 95% | Focused on task requirements |

**Overall Assessment**: Ready for implementation with minor corrections needed

### Code Reference Validation

| Reference | Status | Notes |
|-----------|--------|-------|
| `intStartGame:4627` | ACCURATE | Verified |
| `intNextChallenge:4716` | ACCURATE | Verified |
| `intEndGame:4870` | ACCURATE | Verified |
| `chStartGame:5095` | ACCURATE | Verified |
| `chNextChallenge:5174` | ACCURATE | Verified |
| `chEndGame:5337` | ACCURATE | Verified |
| `iiviStartGame:5650` | ACCURATE | Verified |
| `iiviNextChallenge:5769` | ACCURATE | Verified |
| `iiviEndGame:6058` | ACCURATE | Verified |
| `bebopNextChallenge:11598` | SHIFTED | Actual: 11604 |
| `tritoneNextChallenge:12056` | INVALID | 12056 is tritoneStopGame; actual: 12067 |
| `shellNextChallenge:12500` | INVALID | 12500 is shellStopGame; actual: 12511 |
| `upperNextChallenge:13020` | SHIFTED | Actual: 13040 |
| `attyaNextChallenge:14360` | INVALID | Function does not exist; uses `attyaShowChallenge:14335` |
| `handleMIDI:4466-4500` | ACCURATE | Session logging instrumentation verified |

### Identified Gaps

#### Critical (Must Address)
- **attya mode**: Uses `attyaShowChallenge` not `attyaNextChallenge` - implementation must use correct function name
- **Voice Leading mode pitch extraction**: Research claims `targetChord.pitchClasses` but code uses `sourceNotes`/`targetNotes` arrays directly - extraction function may need update

#### Minor (Nice to Have)
- Missing challenge structure documentation for attya mode (uses `current.pitchClasses` from voicing objects)
- Missing StopGame line numbers in mapping table

### Incorrect or Outdated Claims

- **Line 77**: "attyaNextChallenge at 14360" - This function does not exist. Attya mode uses `attyaShowChallenge` at line 14335.
- **Line 41**: "challenge.targetChord.pitchClasses - voiceleading target" - Voicelead mode uses `sourceNotes` and `targetNotes` arrays directly, not `targetChord.pitchClasses`.
- **Lines 73-74**: tritone and shell NextChallenge line numbers are actually their StopGame functions.

### Recommendations

1. Update attya mode implementation to call `attyaShowChallenge` instead of non-existent `attyaNextChallenge`
2. Verify `sessionLogExtractExpectedPitchClasses` handles:
   - `current.pitchClasses` for attya mode voicings
   - `sourceNotes`/`targetNotes` for voicelead phases
3. Use verified line numbers from this review during implementation

### Files Changed Since Research

No files changed - research is current.
