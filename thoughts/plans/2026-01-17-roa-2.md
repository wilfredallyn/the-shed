---
date: 2026-01-17
author: claude
bead: the-shed-roa.2
title: "MIDI Handler Instrumentation Plan"
tier: S
status: implemented
depends_on: [the-shed-roa.1]
---

# MIDI Handler Instrumentation

## Goal

Add logging calls to `handleMIDI()` to capture every note played during practice sessions with isCorrect flag.

## Approach

Modify `sessionLogRecordEvent()` to compute isCorrect internally, then add calls in handleMIDI for both noteOn and noteOff events.

## Implementation Steps

### Step 1: Modify sessionLogRecordEvent to compute isCorrect

**File:** `index.html` (sessionLogRecordEvent function from roa.1)

Add isCorrect calculation inside the function:

```javascript
const isCorrect = type === 'noteOn' && currentRoundLog.expectedPitchClasses
    ? currentRoundLog.expectedPitchClasses.includes(midi % 12)
    : null;
```

Include `isCorrect` in the event object.

### Step 2: Add logging calls to handleMIDI noteOn branch

**File:** `index.html:4457-4481`

After line 4461 (`highlightKey('previewPianoSvg', note, 'key-active');`), insert:

```javascript
// Session logging
if (sessionLogEnabled && currentRoundLog) {
    sessionLogRecordEvent('noteOn', note, vel);
}
```

### Step 3: Add logging calls to handleMIDI noteOff branch

**File:** `index.html:4482-4507`

After line 4486 (`highlightKey('previewPianoSvg', note, 'key-active', false);`), insert:

```javascript
// Session logging
if (sessionLogEnabled && currentRoundLog) {
    sessionLogRecordEvent('noteOff', note, vel);
}
```

## Files to Modify

1. `index.html` - handleMIDI function (2 insertions), sessionLogRecordEvent (1 modification)

## Verification

1. Start a game with logging enabled
2. Play correct and incorrect notes
3. Check console/localStorage for logged events
4. Verify isCorrect is true for expected pitch classes, false otherwise, null for noteOff

## Acceptance Criteria

- [x] noteOn events logged with midi, velocity, offsetMs, isCorrect
- [x] noteOff events logged with midi, velocity, offsetMs, isCorrect=null
- [x] isCorrect computed by comparing pitchClass against expectedPitchClasses
- [x] Guards prevent logging when session/round not active

## Implementation Review

**implementation_reviewed**: Approved

**Review Date**: 2026-01-17

**Findings**:
1. handleMIDI correctly calls sessionLogRecordEvent on both noteOn (line 4468) and noteOff (line 4499) events
2. Guards are present in both locations: `if (sessionLogEnabled && currentRoundLog)`
3. Additional guards inside sessionLogRecordEvent: checks sessionLogEnabled, currentSessionLog, currentRoundLog, and roundStartTime
4. isCorrect calculation in session-logging.js (lines 41-47) correctly uses `midi % 12` to compute pitchClass and compares against `currentRoundLog.expectedPitchClasses`
5. isCorrect is set to null for noteOff events and when expectedPitchClasses is not available
6. Browser tests in test-midi-handler-instrumentation.html cover all 10 scenarios; tests could not be executed in CI due to missing system dependencies for Playwright, but static code analysis confirms implementation matches test expectations
